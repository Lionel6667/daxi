<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Julmin Taxis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.8.1/docx.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        .driver-card {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .driver-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        .status-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
        }
        .badge-pending {
            background-color: #fef3c7;
            color: #d97706;
        }
        .badge-confirmed {
            background-color: #dcfce7;
            color: #16a34a;
        }
        .badge-busy {
            background-color: #dbeafe;
            color: #2563eb;
        }
        .badge-offline {
            background-color: #f3f4f6;
            color: #6b7280;
        }
        .driver-photo {
            border: 2px solid #e5e7eb;
            transition: border-color 0.3s ease;
        }
        .driver-card:hover .driver-photo {
            border-color: #ef4444;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .review-stars {
            color: #f59e0b;
        }
        .history-card {
            border-left: 3px solid #ef4444;
        }
        .modal-content {
            max-height: 80vh;
            overflow-y: auto;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 1000;
            transition: all 0.3s ease;
        }
        .notification-success {
            background-color: #10b981;
        }
        .notification-error {
            background-color: #ef4444;
        }
        .tab-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
            z-index: 1200; /* raised so tab bar always overlays maps */
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
        }
        .tab-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 16px;
            border-radius: 16px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            color: #6b7280;
        }
        .tab-item.active {
            color: #ef4444;
        }
        .tab-item .icon {
            font-size: 20px;
            margin-bottom: 4px;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        .tab-item.active .icon {
            transform: translateY(-5px);
        }
        .tab-item .label {
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .tab-item.active .label {
            font-weight: 600;
        }
        .tab-item .indicator {
            position: absolute;
            top: -8px;
            height: 4px;
            width: 30px;
            background: #ef4444;
            border-radius: 4px;
            opacity: 0;
            transform: translateY(5px);
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        .tab-item.active .indicator {
            opacity: 1;
            transform: translateY(0);
        }
        .tab-item:hover .icon {
            transform: scale(1.15);
        }
        .tab-item:hover .indicator {
            opacity: 0.6;
        }
        .tab-item.active:hover .icon {
            transform: translateY(-5px) scale(1.1);
        }
        .main-container {
            padding-bottom: 120px;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .tab-item.active .icon {
            animation: pulse 0.5s ease;
        }
        .driver-photo-marker {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            background-size: cover;
            background-position: center;
            position: relative;
        }
        .assign-driver-btn {
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: #10B981;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        .assign-driver-btn:hover {
            transform: translateX(-50%) scale(1.1);
            background-color: #059669;
        }
        .assign-driver-btn.assigned {
            background-color: #3B82F6;
            pointer-events: none;
        }
        .whatsapp-btn {
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: #25D366;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        @keyframes checkAnimation {
            0% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.3); }
            100% { transform: translateX(-50%) scale(1); }
        }
        .check-animation {
            animation: checkAnimation 0.5s ease;
            background-color: #10B981 !important;
        }
        .long-press-popup {
            position: absolute;
            bottom: 35px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 8px 12px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            white-space: nowrap;
            z-index: 1001;
            font-size: 12px;
        }
        .long-press-popup:after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: white transparent transparent transparent;
        }
        @media (max-width: 768px) {
            .chart-container {
                height: 250px;
            }
            .responsive-grid {
                grid-template-columns: 1fr !important;
            }
        }
        @media (max-width: 640px) {
            .responsive-table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
            .responsive-flex {
                flex-direction: column;
                gap: 10px;
            }
            .tab-item {
                padding: 6px 10px;
            }
            .tab-item .icon {
                font-size: 18px;
            }
            .tab-item .label {
                font-size: 10px;
            }
        }
        .order-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .order-map {
            height: 300px;
            width: 100%;
            border-radius: 8px;
            margin-top: 10px;
            touch-action: none;
        }

        /* Tighter, modern styles for orders */
        .order-card {
            border-radius: 12px;
            padding: 12px;
            overflow: hidden;
            box-shadow: 0 6px 18px rgba(15,23,42,0.06);
            transition: transform 0.18s ease, box-shadow 0.18s ease;
        }
        .order-card:hover { transform: translateY(-4px); box-shadow: 0 10px 30px rgba(15,23,42,0.08); }
        .order-map {
            height: 320px;
            width: 100%;
            max-width: 100%;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 14px rgba(2,6,23,0.06);
        }
        /* Button spinner */
        .btn-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            vertical-align: middle;
            margin-right: 8px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .order-scroll-container { max-height: calc(100vh - 240px); overflow-y: auto; padding-right: 8px; }
        @media (max-width: 768px) {
            .order-map {
                height: 250px;
            }
        }
        .driver-marker {
            background-color: #2563eb;
            border-radius: 50%;
            color: white;
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .client-marker {
            background-color: #ef4444;
            border-radius: 50%;
            color: white;
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .driver-info {
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            min-width: 200px;
        }
        .driver-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        .driver-status.available {
            background-color: #dcfce7;
            color: #16a34a;
        }
        .driver-status.busy {
            background-color: #fee2e2;
            color: #ef4444;
        }
        .notification-bell {
            position: relative;
        }
        .notification-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #ef4444;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }
        #price-modal {
            z-index: 2000;
        }
        .price-status {
            display: inline-flex;
            align-items: center;
            font-size: 14px;
            padding: 4px 8px;
            border-radius: 4px;
            margin-top: 5px;
        }
        .price-pending {
            background-color: #fef3c7;
            color: #d97706;
        }
        .price-confirmed {
            background-color: #dcfce7;
            color: #16a34a;
        }
        .delete-order-btn {
            margin-left: 8px;
            background-color: #ef4444;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        .order-scroll-container {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }
        .drivers-list-container {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }
        .map-container {
            height: 500px;
            width: 100%;
        }
        .assigned-driver-list {
            margin-top: 10px;
            padding: 10px;
            background-color: #f9fafb;
            border-radius: 8px;
        }
        .assigned-driver-item {
            display: flex;
            align-items: center;
            padding: 5px 0;
        }
        .assigned-driver-item i {
            margin-right: 8px;
            color: #10b981;
        }
        .status-indicator {
            position: absolute;
            bottom: -4px;
            right: -4px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
        }
        .status-available {
            background-color: #16a34a;
        }
        .status-busy {
            background-color: #ef4444;
        }

        /* Correction pour les icônes dans les cartes de commande */
        .driver-actions {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px; /* Espacement entre les icônes */
        }
        /* Icône info (œil) placée à gauche */
        .driver-action-btn.info {
            order: 1;
        }
        /* Icône assignation (plus) placée à droite */
        .driver-action-btn.assign-driver-btn {
            order: 2;
        }
        
        /* Nouveaux styles pour les statistiques membres/visiteurs */
        .stat-card {
            transition: all 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .stat-icon {
            border-bottom: 1px solid #e5e7eb;
            padding: 12px 0;
        }
        
        /* Bouton de suppression pour les chauffeurs non confirmés */
        .delete-pending-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: transparent;
            border: none;
            color: #ef4444;
            font-size: 1.25rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .delete-pending-btn:hover {
            transform: scale(1.2);
        }

        /* Nouveaux styles pour la section "Personnes à contacter" */
        .contact-section {
            background-color: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin-bottom: 24px;
        }
        .contact-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f1f5f9;
        }
        .contact-info {
            flex: 1;
        }
        .contact-name {
            font-weight: 600;
            color: #1e293b;
        }
        .contact-phone {
            color: #64748b;
            font-size: 0.875rem;
        }
        .contact-btn {
            background-color: #25D366;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .contact-btn:hover {
            background-color: #128C7E;
            transform: translateY(-2px);
        }

        /* Styles pour la carte améliorée */
        .map-container {
            height: 400px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        /* Styles pour la poubelle dans l'historique */
        .delete-history-btn {
            background-color: #ef4444;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.3s ease;
        }
        .delete-history-btn:hover {
            background-color: #dc2626;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#ef4444',
                        secondary: '#fca5a5',
                        dark: '#1f2937'
                    }
                }
            }
        };
        
        const firebaseConfig = {
            databaseURL: "https://julmin-taxis-default-rtdb.firebaseio.com",
            apiKey: "AIzaSyCdGFcwfzj8b5eJXcmrS0LGRIxnTXZ6zac",
            authDomain: "julmin-taxis.firebaseapp.com",
            projectId: "julmin-taxis",
            storageBucket: "julmin-taxis.appspot.com",
            messagingSenderId: "392925120550",
            appId: "1:392925120550:web:2935808aab4ead6d7d7ee7",
            measurementId: "G-H7SBNVWQ06"
        };
        
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
    </script>
</head>
<body class="bg-gray-50 min-h-screen">
    <section id="login-section" class="min-h-screen bg-gray-50 flex items-center justify-center px-4">
        <div class="bg-white rounded-lg shadow-sm p-6 w-full max-w-md">
            <h2 class="text-2xl font-bold text-gray-800 mb-2 text-center">Connexion Administrateur</h2>
            <p class="text-gray-600 text-center mb-8">Accès sécurisé au tableau de bord</p>
            
            <div class="space-y-4">
                <div>
                    <label for="admin-password" class="block text-sm font-medium text-gray-700 mb-1">Mot de passe</label>
                    <input type="password" id="admin-password" name="password" required class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                    <div id="login-password-error" class="text-red-500 text-sm mt-1 hidden">Veuillez entrer votre mot de passe</div>
                </div>
                
                <button id="admin-login-btn" class="w-full bg-primary text-white px-4 py-3 rounded-lg font-medium">
                    Se connecter
                </button>
            </div>
        </div>
    </section>

    <div id="main-interface" class="hidden">
        <header class="bg-primary text-white">
            <div class="container mx-auto px-4 py-4">
                <div class="flex flex-col sm:flex-row items-center justify-between gap-3">
                    <div>
                        <h1 class="text-xl sm:text-2xl font-bold">Administration Julmin Taxis</h1>
                        <p class="text-white/80 text-sm sm:text-base">Tableau de bord de gestion</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <div id="admin-security-icon" class="cursor-pointer text-white/90 p-2 rounded-full hover:bg-white/10" title="Sécurité administrateur">
                            <i class="fas fa-key"></i>
                        </div>
                        <button id="logout-btn" class="bg-white text-primary px-3 py-2 rounded-full font-medium flex items-center" title="Déconnexion">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <div class="main-container">
            <main class="container mx-auto px-4 py-8">
                <div id="dashboard-section" class="tab-content active">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6 mb-6">
                        <div class="bg-white rounded-xl shadow-sm p-6 stat-card">
                            <div class="flex items-center">
                                <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center mr-4">
                                    <i class="fas fa-user-friends text-blue-600 text-xl"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-medium text-gray-500">Chauffeurs actifs</h3>
                                    <p class="text-3xl font-bold" id="active-drivers-count">0</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-sm p-6 stat-card">
                            <div class="flex items-center">
                                <div class="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center mr-4">
                                    <i class="fas fa-dollar-sign text-green-600 text-xl"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-medium text-gray-500">Revenus totaux</h3>
                                    <p class="text-3xl font-bold" id="total-earnings">0 $</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-sm p-6 stat-card">
                            <div class="flex items-center">
                                <div class="w-12 h-12 rounded-full bg-purple-100 flex items-center justify-center mr-4">
                                    <i class="fas fa-route text-purple-600 text-xl"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-medium text-gray-500">Trajets effectués</h3>
                                    <p class="text-3xl font-bold" id="total-trips">0</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Nouvelle carte pour les membres enregistrés -->
                        <div class="bg-white rounded-xl shadow-sm p-6 stat-card">
                            <div class="flex items-center">
                                <div class="w-12 h-12 rounded-full bg-indigo-100 flex items-center justify-center mr-4">
                                    <i class="fas fa-user-check text-indigo-600 text-xl stat-icon"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-medium text-gray-500">Membres</h3>
                                    <p class="text-3xl font-bold" id="registered-users-count">0</p>
                                </div>
                            </div>
                            <button id="view-registered-users" class="mt-4 w-full bg-indigo-100 text-indigo-700 hover:bg-indigo-200 py-2 rounded-lg font-medium">
                                <i class="fas fa-list mr-2"></i> Voir la liste
                            </button>
                        </div>
                        <!-- admin security card removed (moved to navbar modal) -->
                        
                        <!-- Nouvelle carte pour les visiteurs -->
                        <div class="bg-white rounded-xl shadow-sm p-6 stat-card">
                            <div class="flex items-center">
                                <div class="w-12 h-12 rounded-full bg-yellow-100 flex items-center justify-center mr-4">
                                    <i class="fas fa-user-clock text-yellow-600 text-xl stat-icon"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-medium text-gray-500">Visiteurs</h3>
                                    <p class="text-3xl font-bold" id="visitors-count">0</p>
                                </div>
                            </div>
                            <button id="view-visitors" class="mt-4 w-full bg-yellow-100 text-yellow-700 hover:bg-yellow-200 py-2 rounded-lg font-medium">
                                <i class="fas fa-list mr-2"></i> Voir la liste
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">Revenus des 7 derniers jours</h2>
                        <div class="chart-container">
                            <canvas id="earnings-chart"></canvas>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- SECTION "PERSONNES À CONTACTER" REMPLACE "DERNIERS CHAUFFEURS INSCRITS" -->
                        <div class="contact-section">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-bold text-gray-800">Personnes à contacter</h2>
                            </div>
                            <div class="space-y-2" id="contact-list">
                                <div class="text-center py-8">
                                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-primary"></div>
                                    <p class="mt-3 text-gray-600">Chargement...</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-bold text-gray-800">Derniers trajets effectués</h2>
                                <button id="export-history-dash" class="bg-primary text-white px-3 py-1 rounded-lg font-medium flex items-center text-sm">
                                    <i class="fas fa-download mr-1"></i> Exporter
                                </button>
                            </div>
                            <div class="space-y-4" id="recent-trips">
                                <div class="text-center py-8">
                                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-primary"></div>
                                    <p class="mt-3 text-gray-600">Chargement...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="drivers-section" class="tab-content">
                    <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                        <div class="flex flex-col md:flex-row items-center justify-between mb-6 gap-4">
                            <h2 class="text-xl font-bold text-gray-800">Chauffeurs en attente de confirmation</h2>
                            <div class="relative w-full md:w-auto">
                                <input type="text" id="search-pending" placeholder="Rechercher..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg">
                                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="pending-drivers">
                            <div class="text-center py-10">
                                <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-primary"></div>
                                <p class="mt-3 text-gray-600">Chargement des chauffeurs...</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex flex-col md:flex-row items-center justify-between mb-6 gap-4">
                            <h2 class="text-xl font-bold text-gray-800">Chauffeurs confirmés</h2>
                            <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
                                <div class="relative w-full">
                                    <input type="text" id="search-drivers" placeholder="Rechercher par nom, ville..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg">
                                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                                </div>
                                <button id="export-drivers" class="bg-primary text-white px-4 py-2 rounded-lg font-medium flex items-center justify-center">
                                    <i class="fas fa-download mr-2"></i> Exporter
                                </button>
                            </div>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 responsive-table">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nom</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Statut</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Téléphone</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ville</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Note</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Revenus (total)</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200" id="all-drivers">
                                    <tr>
                                        <td colspan="7" class="px-6 py-4 text-center">
                                            <div class="flex justify-center">
                                                <div class="animate-spin rounded-full h-6 w-6 border-t-2 border-b-2 border-primary"></div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div id="history-section" class="tab-content">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex flex-col md:flex-row items-center justify-between mb-6 gap-4">
                            <h2 class="text-xl font-bold text-gray-800">Historique des trajets</h2>
                            <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
                                <div class="relative w-full">
                                    <input type="text" id="search-history" placeholder="Rechercher..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg">
                                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                                </div>
                                <div class="flex gap-2 w-full sm:w-auto">
                                    <select id="history-filter" class="border border-gray-300 rounded-lg px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                        <option value="all">Tous les trajets</option>
                                        <option value="today">Aujourd'hui</option>
                                        <option value="week">Cette semaine</option>
                                        <option value="month">Ce mois</option>
                                    </select>
                                    <button id="export-history" class="bg-primary text-white px-4 py-2 rounded-lg font-medium flex items-center">
                                        <i class="fas fa-download mr-2"></i> Exporter
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-4" id="history-list">
                            <div class="text-center py-8">
                                <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-primary"></div>
                                <p class="mt-3 text-gray-600">Chargement de l'historique...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="earnings-section" class="tab-content">
                    <!-- MODIFICATION 2: Retrait des revenus hebdomadaires -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <h3 class="text-lg font-medium text-gray-500 mb-2">Revenus aujourd'hui</h3>
                            <p class="text-3xl font-bold text-green-600" id="today-earnings">0 $</p>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <h3 class="text-lg font-medium text-gray-500 mb-2">Revenus ce mois</h3>
                            <p class="text-3xl font-bold text-purple-600" id="month-earnings">0 $</p>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-gray-800">Répartition des revenus par chauffeur</h2>
                            <button id="export-earnings" class="bg-primary text-white px-4 py-2 rounded-lg font-medium flex items-center">
                                <i class="fas fa-download mr-2"></i> Exporter
                            </button>
                        </div>
                        <div class="chart-container">
                            <canvas id="driver-earnings-chart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div id="orders-section" class="tab-content">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="mb-6">
                            <h2 class="text-xl font-bold text-gray-800">Commandes en attente</h2>
                        </div>
                        
                        <!-- MODIFICATION 1: Suppression de l'affichage des commandes confirmées -->
                        <!-- La section "Commandes confirmées" a été supprimée -->
                        
                        <div class="order-scroll-container" id="orders-list">
                            <div class="text-center py-8">
                                <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-primary"></div>
                                <p class="mt-3 text-gray-600">Chargement des commandes...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <div class="tab-bar">
            <div class="tab-item active" data-tab="dashboard">
                <div class="indicator"></div>
                <div class="icon"><i class="fas fa-tachometer-alt"></i></div>
                <div class="label">Dashboard</div>
            </div>
            <div class="tab-item" data-tab="drivers">
                <div class="indicator"></div>
                <div class="icon"><i class="fas fa-users"></i></div>
                <div class="label">Chauffeurs</div>
            </div>
            <div class="tab-item" data-tab="history">
                <div class="indicator"></div>
                <div class="icon"><i class="fas fa-history"></i></div>
                <div class="label">Historique</div>
            </div>
            <div class="tab-item" data-tab="earnings">
                <div class="indicator"></div>
                <div class="icon"><i class="fas fa-chart-line"></i></div>
                <div class="label">Revenus</div>
            </div>
            <div class="tab-item" data-tab="orders">
                <div class="indicator"></div>
                <div class="icon"><i class="fas fa-list"></i></div>
                <div class="label">Commandes</div>
            </div>
        </div>
    </div>

    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-6 w-full max-w-md">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-red-100">
                    <i class="fas fa-user-check text-red-600 text-2xl"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mt-4" id="modal-title">Confirmer ce chauffeur ?</h3>
                <div class="mt-2">
                    <p class="text-sm text-gray-500" id="modal-description">Êtes-vous sûr de vouloir confirmer ce chauffeur ? Il pourra alors accéder à l'application.</p>
                </div>
            </div>
            <div class="mt-5 sm:mt-6 flex space-x-3">
                <button id="modal-cancel" type="button" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 font-medium hover:bg-gray-50 focus:outline-none">
                    Annuler
                </button>
                <button id="modal-confirm" type="button" class="flex-1 px-4 py-2 bg-primary text-white rounded-lg font-medium hover:bg-red-700 focus:outline-none">
                    Confirmer
                </button>
            </div>
        </div>
    </div>

    <!-- Admin password modal -->
    <div id="admin-pass-modal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-60 hidden">
        <div class="bg-white rounded-xl p-6 w-full max-w-sm">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Sécurité administrateur</h3>
                <button id="admin-pass-close" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
            </div>
            <div class="space-y-3">
                <input id="modal-cur-admin-pass" type="password" placeholder="Mot de passe actuel" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                <input id="modal-new-admin-pass" type="password" placeholder="Nouveau mot de passe" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                <input id="modal-confirm-admin-pass" type="password" placeholder="Confirmer le nouveau" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                <div class="flex gap-2">
                    <button id="modal-btn-change-admin-pass" class="bg-primary text-white px-4 py-2 rounded-lg">Changer</button>
                    <div id="modal-change-admin-result" class="text-sm text-green-600 hidden"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="price-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-6 w-full max-w-md">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Définir le prix</h3>
            <input type="number" id="price-input" placeholder="Prix en $" class="w-full px-4 py-3 border border-gray-300 rounded-lg mb-4">
            <div class="flex space-x-3">
                <button id="price-cancel" class="flex-1 bg-gray-200 text-gray-800 py-3 rounded-lg font-medium">Annuler</button>
                <button id="price-submit" class="flex-1 bg-primary text-white py-3 rounded-lg font-medium">Valider</button>
            </div>
        </div>
    </div>

    <!-- Nouvelle modale pour les membres enregistrés -->
    <div id="registered-users-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-6 w-full max-w-3xl max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-800">Membres enregistrés</h3>
                <button id="close-registered-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="registered-users-list" class="space-y-3">
                <div class="text-center py-8">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-primary"></div>
                    <p class="mt-3 text-gray-600">Chargement des membres...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Nouvelle modale pour les visiteurs -->
    <div id="visitors-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-6 w-full max-w-3xl max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-800">Visiteurs</h3>
                <button id="close-visitors-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="visitors-list" class="space-y-3">
                <div class="text-center py-8">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-primary"></div>
                    <p class="mt-3 text-gray-600">Chargement des visiteurs...</p>
                </div>
            </div>
        </div>
    </div>

    <audio id="notification-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3" preload="auto"></audio>

    <script>
        // --- Admin password DB seeding and change handlers will be inserted below ---
        // Admin password will be loaded from Firebase at path 'admin/password'.
        // If missing, seed it with a default value.
        const DEFAULT_ADMIN_PASSWORD = 'Julm1n234';
        let ADMIN_PASSWORD = null;

        async function loadOrSeedAdminPassword() {
            try {
                const snap = await database.ref('admin/password').once('value');
                if (snap.exists() && snap.val()) {
                    ADMIN_PASSWORD = snap.val();
                } else {
                    await database.ref('admin/password').set(DEFAULT_ADMIN_PASSWORD);
                    ADMIN_PASSWORD = DEFAULT_ADMIN_PASSWORD;
                }
            } catch (e) {
                console.error('Erreur lecture/init mot de passe admin:', e);
                ADMIN_PASSWORD = DEFAULT_ADMIN_PASSWORD;
            }
        }
        let currentDriverKey = null;
        let earningsChart = null;
        let driverEarningsChart = null;
        let activeTab = "dashboard";
        let allDrivers = [];
        let allTrips = [];
        let unconfirmedOrders = {};
        let notificationCount = 0;
        let notificationSound = null;
        let drivers = {};
        let currentOrderKey = null;
        let currentPrice = 0;
        let driversListener = null;
        let mapMarkers = {};
    // track which order detail panels are open so re-renders don't close them
    let openDetailsKeys = new Set();
    // track keys that are present in commande_confirmed so duplicates elsewhere are hidden
    let confirmedKeys = new Set();

        function startDriversListener() {
            if (driversListener) {
                driversListener();
            }
            
            const driversRef = database.ref('drivers');
            driversListener = driversRef.on('value', async (snapshot) => {
                drivers = snapshot.val() || {};
                allDrivers = [];
                
                if (!snapshot.exists()) {
                    return;
                }
                
                const driversData = snapshot.val();
                const driverKeys = Object.keys(driversData);
                
                for (const key of driverKeys) {
                    const driver = driversData[key];
                    driver.id = key;
                    
                    try {
                        const earnings = await getDriverEarnings(driver.id);
                        allDrivers.push({...driver, totalEarnings: earnings.totalEarnings});
                    } catch (error) {
                        console.error("Erreur lors du chargement des revenus:", error);
                    }
                }
                
                if (activeTab === 'drivers') {
                    updateDriversTable();
                }
                
                if (activeTab === 'earnings') {
                    loadDriverEarningsChart();
                }
            });
        }

        function updateDriversTable() {
            const driversContainer = document.getElementById('all-drivers');
            driversContainer.innerHTML = '';
            
            if (allDrivers.length === 0) {
                driversContainer.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-4 text-center">
                            <i class="fas fa-user-slash text-gray-300 text-3xl mb-2"></i>
                            <p class="text-gray-600">Aucun chauffeur enregistré</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            allDrivers.forEach(driver => {
                const driverRow = createDriverRow(driver, driver.totalEarnings);
                driversContainer.appendChild(driverRow);
            });
        }

        function loadDashboard() {
            const driversRef = database.ref('drivers');
            driversRef.once('value').then(snapshot => {
                const drivers = snapshot.val() || {};
                const activeDrivers = Object.values(drivers).filter(driver => driver.status === 'available' || driver.status === 'busy');
                document.getElementById('active-drivers-count').textContent = activeDrivers.length;
            });
            
            calculateTotalEarnings().then(total => {
                document.getElementById('total-earnings').textContent = total.toFixed(2) + ' $';
            });
            
            const tripsRef = database.ref('commande_confirmed');
            tripsRef.once('value').then(snapshot => {
                const trips = snapshot.val() || {};
                const finishedTrips = Object.values(trips).filter(trip => trip.status === 'finished');
                document.getElementById('total-trips').textContent = finishedTrips.length;
            });
            
            // Charger les compteurs pour les membres et visiteurs
            const registeredUsersRef = database.ref('save_member');
            registeredUsersRef.once('value').then(snapshot => {
                const users = snapshot.val() || {};
                document.getElementById('registered-users-count').textContent = Object.keys(users).length;
            });
            
            const visitorsRef = database.ref('unsave_member');
            visitorsRef.once('value').then(snapshot => {
                const visitors = snapshot.val() || {};
                document.getElementById('visitors-count').textContent = Object.keys(visitors).length;
            });
            
            loadEarningsChart();
            loadContactList(); // MODIFICATION 2: Charger la liste des personnes à contacter
            loadRecentTrips();
            calculateEarningsByPeriod();
        }
        
        // MODIFICATION 2: Fonction pour charger la liste des personnes à contacter
        // Source: commande_confirmed where adminContacted !== true
        function loadContactList() {
            const contactContainer = document.getElementById('contact-list');
            contactContainer.innerHTML = '';

            const confirmedRef = database.ref('commande_confirmed');

            // Load registered members once and keep a set of their userIds
            const registeredSet = new Set();
            database.ref('save_member').once('value').then(snap => {
                const members = snap.val() || {};
                Object.values(members).forEach(m => {
                    if (!m) return;
                    if (m.userId !== undefined && m.userId !== null) registeredSet.add(String(m.userId));
                    if (m.id !== undefined && m.id !== null) registeredSet.add(String(m.id));
                });
            }).catch(e => { console.warn('Could not load save_member for registered filtering', e); });

            confirmedRef.on('value', (snapshot) => {
                const confirmedOrders = snapshot.val() || {};
                contactContainer.innerHTML = '';

                // Filter orders where adminContacted !== true AND user is registered (has an entry in save_member)
                const entries = Object.entries(confirmedOrders).filter(([k, v]) => {
                    if (!v) return false;
                    if (v.adminContacted === true) return false;
                    // if there's a userId and it's found in registeredSet => show
                    if (v.userId && registeredSet.has(String(v.userId))) return true;
                    // fallback: some orders store user info; prefer to hide guests
                    return false;
                });

                if (entries.length === 0) {
                    contactContainer.innerHTML = `
                        <div class="text-center py-4">
                            <i class="fas fa-user-clock text-gray-300 text-3xl mb-2"></i>
                            <p class="text-gray-500">Aucune personne pour l\'instant.</p>
                        </div>
                    `;
                    return;
                }

                entries.forEach(([key, order]) => {
                    const clientName = order.clientName || order.name || 'Client';
                    const phoneRaw = (order.phone || order.clientPhone || order.clientPhoneNumber || '').toString();
                    const phone = phoneRaw.replace(/\D+/g, '');
                    const pickup = order.pickup || 'Position actuelle';
                    const destination = order.destination || '';
                    const price = typeof order.price !== 'undefined' ? order.price : '';
                    const tripType = order.tripType || 'aller simple';
                    const time = order.confirmedAt || order.finishedAt || order.timestamp || '';
                    const formattedTime = time ? new Date(time).toLocaleString('fr-FR') : '';

                    const contactItem = document.createElement('div');
                    contactItem.className = 'contact-item';
                    contactItem.id = `contact-${key}`;

                    contactItem.innerHTML = `
                        <div class="contact-info">
                            <div class="contact-name">${clientName} <span class="text-xs text-gray-500">(#${key})</span></div>
                            <div class="contact-phone">${phone || 'N° client manquant'}</div>
                            <div class="text-xs text-gray-500">${pickup} → ${destination} • ${price} $ • ${tripType} ${formattedTime ? '• ' + formattedTime : ''}</div>
                        </div>
                        <div>
                            ${phone ? `<button class="contact-btn" data-key="${key}" data-phone="${phone}"><i class="fab fa-whatsapp"></i> Contacter</button>` : `<span class="text-sm text-gray-400">N° client manquant</span>`}
                        </div>
                    `;

                    contactContainer.appendChild(contactItem);
                });

                // Wire contact buttons (set adminContacted=true and open WhatsApp)
                contactContainer.querySelectorAll('.contact-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        e.preventDefault();
                        const key = btn.dataset.key;
                        const phone = btn.dataset.phone;
                        if (!key || !phone) return;
                        // Build message
                        const order = confirmedOrders[key] || {};
                        const pickup = order.pickup || '';
                        const dest = order.destination || '';
                        const price = typeof order.price !== 'undefined' ? order.price : '';
                        const tripType = order.tripType || '';
                        const time = order.confirmedAt || order.finishedAt || order.timestamp || '';
                        const formattedTime = time ? new Date(time).toLocaleString('fr-FR') : '';

                        const message = `Bonjour, votre commande est prête ! Voici les détails de votre course : ${pickup}, ${dest}, ${price} $, ${tripType}, ${formattedTime}`;

                        // Open WhatsApp
                        window.open(`https://wa.me/${phone}?text=${encodeURIComponent(message)}`, '_blank');

                        // Set adminContacted = true
                        try {
                            await database.ref(`commande_confirmed/${key}/adminContacted`).set(true);
                            // remove from UI immediately
                            const el = document.getElementById(`contact-${key}`);
                            if (el) el.remove();
                        } catch (err) {
                            console.error('Erreur setting adminContacted', err);
                            showNotification('Erreur lors de la mise à jour', 'error');
                        }
                    });
                });
            });
        }
        
        async function calculateTotalEarnings() {
            const tripsRef = database.ref('commande_confirmed');
            const snapshot = await tripsRef.once('value');
            const trips = snapshot.val() || {};
            
            let totalEarnings = 0;
            Object.values(trips).forEach(trip => {
                if (trip.status === 'finished' && trip.price) {
                    totalEarnings += parseFloat(trip.price);
                }
            });
            
            return totalEarnings;
        }
        
        async function calculateEarningsByPeriod() {
            const tripsRef = database.ref('commande_confirmed');
            const snapshot = await tripsRef.once('value');
            const trips = snapshot.val() || {};
            
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const thisMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            
            let todayEarnings = 0;
            let monthEarnings = 0;
            
            Object.values(trips).forEach(trip => {
                if (trip.status === 'finished' && trip.price && trip.finishedAt) {
                    const tripDate = new Date(trip.finishedAt);
                    const price = parseFloat(trip.price);
                    
                    if (tripDate >= today) {
                        todayEarnings += price;
                    }
                    
                    if (tripDate >= thisMonth) {
                        monthEarnings += price;
                    }
                }
            });
            
            document.getElementById('today-earnings').textContent = todayEarnings.toFixed(2) + ' HTG';
            document.getElementById('month-earnings').textContent = monthEarnings.toFixed(2) + ' HTG';
        }
        
        function getEarningsLast7Days() {
            const tripsRef = database.ref('commande_confirmed');
            const now = new Date();
            
            // Créer un tableau avec les dates des 7 derniers jours
            const dates = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date(now);
                date.setDate(now.getDate() - i);
                date.setHours(0, 0, 0, 0);
                dates.push(date);
            }
            
            return tripsRef.once('value')
                .then(snapshot => {
                    const trips = snapshot.val() || {};
                    const earningsByDay = Array(7).fill(0);
                    
                    Object.values(trips).forEach(trip => {
                        if (trip.status === 'finished' && trip.price && trip.finishedAt) {
                            const tripDate = new Date(trip.finishedAt);
                            const tripDay = new Date(tripDate.getFullYear(), tripDate.getMonth(), tripDate.getDate()).getTime();
                            
                            // Trouver l'index du jour correspondant
                            const index = dates.findIndex(d => {
                                const dTime = d.getTime();
                                return tripDay === dTime;
                            });
                            
                            if (index !== -1) {
                                earningsByDay[index] += parseFloat(trip.price);
                            }
                        }
                    });
                    
                    return earningsByDay;
                });
        }
        
        function loadEarningsChart() {
            getEarningsLast7Days().then(earningsData => {
                const ctx = document.getElementById('earnings-chart').getContext('2d');
                
                if (earningsChart) {
                    earningsChart.destroy();
                }
                
                earningsChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'],
                        datasets: [{
                            label: 'Revenus ($)',
                            data: earningsData,
                            backgroundColor: '#ef4444',
                            borderColor: '#dc2626',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return value.toLocaleString() + ' $';
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            });
        }
        
        function loadRecentTrips() {
            const tripsRef = database.ref('commande_confirmed');
            const container = document.getElementById('recent-trips');
            container.innerHTML = '';
            
            tripsRef.orderByChild('finishedAt').limitToLast(5).once('value').then(snapshot => {
                const trips = snapshot.val() || {};
                const finishedTrips = Object.values(trips).filter(trip => trip.status === 'finished');
                
                if (finishedTrips.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-8">Aucun trajet récent</p>';
                    return;
                }
                
                finishedTrips.sort((a, b) => (b.finishedAt || 0) - (a.finishedAt || 0));
                
                finishedTrips.slice(0, 5).forEach(trip => {
                    const tripDate = trip.finishedAt ? new Date(trip.finishedAt) : new Date();
                    const formattedDate = tripDate.toLocaleDateString('fr-FR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    const tripElement = document.createElement('div');
                    tripElement.className = 'history-card p-4 bg-white rounded-lg shadow-sm';
                    tripElement.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-medium">${trip.clientName || 'Client'}</h4>
                                <p class="text-sm text-gray-600">${trip.pickup} → ${trip.destination}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-bold text-primary">${trip.price || '0'} $</p>
                                <p class="text-xs text-gray-500">${formattedDate}</p>
                            </div>
                        </div>
                        <div class="mt-2 flex items-center">
                            <div class="text-sm mr-4">
                                <i class="fas fa-user mr-1 text-gray-500"></i>
                                ${trip.driverName || 'Chauffeur inconnu'}
                            </div>
                            ${trip.rating ? 
                                `<div class="text-sm">
                                    <span class="review-stars">
                                        ${'★'.repeat(Math.round(trip.rating))}${'☆'.repeat(5 - Math.round(trip.rating))}
                                    </span>
                                </div>` : ''
                            }
                        </div>
                    `;
                    container.appendChild(tripElement);
                });
            });
        }
        
        function loadPendingDrivers() {
            const pendingDriversContainer = document.getElementById('pending-drivers');
            const unconfirmedRef = database.ref('drivers_unconfirmed');
            
            unconfirmedRef.on('value', (snapshot) => {
                pendingDriversContainer.innerHTML = '';
                
                if (!snapshot.exists()) {
                    pendingDriversContainer.innerHTML = `
                        <div class="col-span-3 py-12 text-center">
                            <i class="fas fa-user-clock text-gray-300 text-5xl mb-4"></i>
                            <h3 class="text-lg font-medium text-gray-700">Aucun chauffeur en attente</h3>
                            <p class="text-gray-500 mt-1">Tous les chauffeurs ont été confirmés.</p>
                        </div>
                    `;
                    return;
                }
                
                snapshot.forEach((child) => {
                    const driver = child.val();
                    const driverCard = createDriverCard(driver, child.key);
                    pendingDriversContainer.appendChild(driverCard);
                });
            });
        }
        
        function createDriverCard(driver, key) {
            const card = document.createElement('div');
            card.className = 'driver-card bg-white rounded-xl p-5 border border-gray-200 relative';
            card.innerHTML = `
                <button class="delete-pending-btn" data-key="${key}" title="Supprimer cette demande">
                    <i class="fas fa-trash"></i>
                </button>
                
                <div class="flex flex-col items-center">
                    <img src="${driver.photoURL}" alt="${driver.firstname} ${driver.lastname}" class="driver-photo w-24 h-24 rounded-full object-cover mb-4">
                    
                    <div class="text-center mb-4">
                        <h3 class="text-lg font-bold text-gray-800">${driver.firstname} ${driver.lastname}</h3>
                        <p class="text-gray-600">${driver.city}</p>
                        <div class="mt-1">
                            <span class="status-badge badge-pending">En attente</span>
                        </div>
                    </div>
                    
                    <div class="w-full bg-gray-50 rounded-lg p-4 mb-4">
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div class="text-left">
                                <p class="text-gray-500">Téléphone</p>
                                <p class="font-medium">${driver.phone}</p>
                            </div>
                            <div class="text-left">
                                <p class="text-gray-500">Date d'inscription</p>
                                <p class="font-medium">${new Date(driver.createdAt).toLocaleDateString('fr-FR')}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex gap-3 w-full">
                        <button class="w-full bg-primary hover:bg-red-700 text-white py-3 rounded-lg font-medium flex items-center justify-center confirm-driver-btn" data-key="${key}">
                            <i class="fas fa-check mr-2"></i> Confirmer
                        </button>
                    </div>
                </div>
            `;
            return card;
        }
        
        function deletePendingDriver(key) {
            if (confirm("Êtes-vous sûr de vouloir supprimer cette demande d'inscription ?")) {
                const unconfirmedRef = database.ref(`drivers_unconfirmed/${key}`);
                unconfirmedRef.remove()
                    .then(() => {
                        showNotification("Demande d'inscription supprimée avec succès", 'success');
                    })
                    .catch(error => {
                        console.error("Erreur lors de la suppression:", error);
                        showNotification("Erreur lors de la suppression", 'error');
                    });
            }
        }
        
        async function getDriverEarnings(driverId) {
            const tripsRef = database.ref('commande_confirmed');
            const snapshot = await tripsRef.orderByChild('driverId').equalTo(driverId).once('value');
            const trips = snapshot.val() || {};
            
            let totalEarnings = 0;
            
            Object.values(trips).forEach(trip => {
                if (trip.status === 'finished' && trip.price) {
                    totalEarnings += parseFloat(trip.price);
                }
            });
            
            return { totalEarnings };
        }
        
        function createDriverRow(driver, totalEarnings) {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 h-10 w-10">
                            <img class="h-10 w-10 rounded-full object-cover" src="${driver.photoURL}" alt="${driver.firstname} ${driver.lastname}">
                        </div>
                        <div class="ml-4">
                            <div class="text-sm font-medium text-gray-900">${driver.firstname} ${driver.lastname}</div>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    ${driver.status === 'available' ? 
                        '<span class="status-badge badge-confirmed">Disponible</span>' : 
                        driver.status === 'busy' ? 
                        '<span class="status-badge badge-busy">Occupé</span>' :
                        driver.status === 'pending' ? 
                        '<span class="status-badge badge-pending">En attente</span>' :
                        '<span class="status-badge badge-offline">Inactif</span>'}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">${driver.phone}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">${driver.city}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">${driver.rating || '0'}/5</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">${totalEarnings.toLocaleString('fr-FR')} $</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    <button class="text-red-600 hover:text-red-900 delete-driver-btn" data-id="${driver.id}">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            return row;
        }
        
        function confirmDriver(key) {
            const unconfirmedRef = database.ref(`drivers_unconfirmed/${key}`);
            
            unconfirmedRef.once('value').then((snapshot) => {
                const driver = snapshot.val();
                
                const driversRef = database.ref('drivers').push();
                driversRef.set(driver)
                    .then(() => {
                        unconfirmedRef.remove()
                            .then(() => {
                                document.getElementById('confirmation-modal').classList.add('hidden');
                                showNotification(`Chauffeur ${driver.firstname} ${driver.lastname} confirmé avec succès!`, 'success');
                            })
                            .catch((error) => {
                                console.error("Erreur lors de la suppression du chauffeur non confirmé:", error);
                                showNotification("Erreur lors de la suppression", 'error');
                            });
                    })
                    .catch((error) => {
                        console.error("Erreur lors de l'ajout du chauffeur confirmé:", error);
                        showNotification("Erreur lors de la confirmation", 'error');
                    });
            });
        }
        
        function deleteDriver(key) {
            if (confirm("Êtes-vous sûr de vouloir supprimer ce chauffeur ? Cette action est irréversible.")) {
                const driversRef = database.ref(`drivers/${key}`);
                driversRef.remove()
                    .then(() => {
                        showNotification("Chauffeur supprimé avec succès", 'success');
                    })
                    .catch(error => {
                        console.error("Erreur lors de la suppression du chauffeur:", error);
                        showNotification("Erreur lors de la suppression", 'error');
                    });
            }
        }
        
        function loadHistory() {
            const historyContainer = document.getElementById('history-list');
            historyContainer.innerHTML = '';
            
            const tripsRef = database.ref('commande_confirmed');
            tripsRef.once('value').then(snapshot => {
                const trips = snapshot.val() || {};
                // preserve keys so we can delete by key
                const finishedTrips = [];
                snapshot.forEach(child => {
                    const t = child.val();
                    if (t && t.status === 'finished') {
                        t.key = child.key;
                        finishedTrips.push(t);
                    }
                });
                allTrips = finishedTrips;
                
                if (finishedTrips.length === 0) {
                    historyContainer.innerHTML = '<p class="text-gray-500 text-center py-8">Aucun trajet dans l\'historique</p>';
                    return;
                }
                
                finishedTrips.sort((a, b) => (b.finishedAt || 0) - (a.finishedAt || 0));
                
                finishedTrips.forEach(trip => {
                    const tripDate = trip.finishedAt ? new Date(trip.finishedAt) : new Date();
                    const formattedDate = tripDate.toLocaleDateString('fr-FR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    const tripElement = document.createElement('div');
                    tripElement.className = 'history-card p-4 bg-white rounded-lg shadow-sm relative';
                    tripElement.setAttribute('data-key', trip.key || '');
                    tripElement.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-medium">${trip.clientName || 'Client'}</h4>
                                <p class="text-sm text-gray-600">${trip.pickup} → ${trip.destination}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-bold text-primary" style="margin-right:36px;">${trip.price || '0'} $</p>
                                <p class="text-xs text-gray-500">${formattedDate}</p>
                            </div>
                        </div>
                        <div class="mt-2 flex items-center">
                            <div class="text-sm mr-4">
                                <i class="fas fa-user mr-1 text-gray-500"></i>
                                ${trip.driverName || 'Chauffeur inconnu'}
                            </div>
                            ${trip.rating ? 
                                `<div class="text-sm">
                                    <span class="review-stars">
                                        ${'★'.repeat(Math.round(trip.rating))}${'☆'.repeat(5 - Math.round(trip.rating))}
                                    </span>
                                </div>` : ''
                            }
                        </div>
                        <!-- MODIFICATION 6: Bouton de suppression pour les commandes terminées -->
                        <button class="delete-history-btn absolute top-4 right-4" data-key="${trip.key || ''}" style="right:8px;">
                            <i class="fas fa-trash"></i>
                            Supprimer
                        </button>
                    `;
                    historyContainer.appendChild(tripElement);
                });
                
                // Ajouter les écouteurs d'événements pour les boutons de suppression
                document.querySelectorAll('.delete-history-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const key = this.getAttribute('data-key');
                        if (key) {
                            deleteHistoryOrder(key);
                        }
                    });
                });
            });
        }
        
        // MODIFICATION 6: Fonction pour supprimer une commande de l'historique
        function deleteHistoryOrder(key) {
            if (confirm("Êtes-vous sûr de vouloir supprimer cette commande de l'historique ? Cette action est irréversible.")) {
                database.ref(`commande_confirmed/${key}`).remove()
                    .then(() => {
                        showNotification("Commande supprimée de l'historique avec succès", 'success');
                        // Recharger l'historique pour mettre à jour l'affichage
                        loadHistory();
                    })
                    .catch(error => {
                        console.error("Erreur lors de la suppression de la commande:", error);
                        showNotification("Erreur lors de la suppression", 'error');
                    });
            }
        }
        
        function exportToWord(data, title, fileName) {
            const now = new Date();
            const formattedDate = now.toLocaleDateString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
            
            let htmlContent = `
                <html xmlns:o='urn:schemas-microsoft-com:office:office' 
                      xmlns:w='urn:schemas-microsoft-com:office:word' 
                      xmlns='http://www.w3.org/TR/REC-html40'>
                <head>
                    <meta charset="UTF-8">
                    <title>${title}</title>
                    <style>
                        body { font-family: Arial, sans-serif; }
                        h1 { color: #ef4444; text-align: center; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th { background-color: #f3f4f6; padding: 10px; text-align: left; border: 1px solid #d1d5db; }
                        td { padding: 10px; border: 1px solid #d1d5db; }
                        .footer { margin-top: 30px; text-align: right; font-size: 0.8em; color: #6b7280; }
                    </style>
                </head>
                <body>
                    <h1>${title}</h1>
                    <p>Exporté le: ${formattedDate}</p>
                    ${data}
                    <div class="footer">Julmin Taxis - Admin Dashboard</div>
                </body>
                </html>
            `;
            
            const blob = new Blob([htmlContent], { type: 'application/msword' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${fileName}_${formattedDate.replace(/\//g, '-')}.doc`;
            link.click();
        }
        
        function exportDrivers() {
            if (allDrivers.length === 0) {
                showNotification("Aucun chauffeur à exporter", 'error');
                return;
            }
            
            let tableContent = `
                <table>
                    <tr>
                        <th>Nom</th>
                        <th>Statut</th>
                        <th>Téléphone</th>
                        <th>Ville</th>
                        <th>Note</th>
                        <th>Revenus (total)</th>
                    </tr>
            `;
            
            allDrivers.forEach(driver => {
                tableContent += `
                    <tr>
                        <td>${driver.firstname} ${driver.lastname}</td>
                        <td>${driver.status}</td>
                        <td>${driver.phone}</td>
                        <td>${driver.city}</td>
                        <td>${driver.rating || '0'}/5</td>
                        <td>${driver.totalEarnings.toLocaleString('fr-FR')} $</td>
                    </tr>
                `;
            });
            
            tableContent += '</table>';
            
            exportToWord(tableContent, 'Liste des Chauffeurs', 'chauffeurs');
        }
        
        function exportHistory() {
            if (allTrips.length === 0) {
                showNotification("Aucun trajet à exporter", 'error');
                return;
            }
            
            let tableContent = `
                <table>
                    <tr>
                        <th>Client</th>
                        <th>Trajet</th>
                        <th>Chauffeur</th>
                        <th>Prix</th>
                        <th>Date</th>
                        <th>Note</th>
                    </tr>
            `;
            
            allTrips.forEach(trip => {
                const tripDate = trip.finishedAt ? new Date(trip.finishedAt) : new Date();
                const formattedDate = tripDate.toLocaleDateString('fr-FR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                tableContent += `
                    <tr>
                        <td>${trip.clientName || 'Client'}</td>
                        <td>${trip.pickup} → ${trip.destination}</td>
                        <td>${trip.driverName || 'Chauffeur inconnu'}</td>
                        <td>${trip.price || '0'} HTG</td>
                        <td>${formattedDate}</td>
                        <td>${trip.rating ? '★'.repeat(Math.round(trip.rating)) : '-'}</td>
                    </tr>
                `;
            });
            
            tableContent += '</table>';
            
            exportToWord(tableContent, 'Historique des Trajets', 'historique_trajets');
        }
        
        function exportEarnings() {
            if (allDrivers.length === 0) {
                showNotification("Aucun revenu à exporter", 'error');
                return;
            }
            
            const sortedDrivers = [...allDrivers].sort((a, b) => b.totalEarnings - a.totalEarnings);
            
            let tableContent = `
                <table>
                    <tr>
                        <th>Chauffeur</th>
                        <th>Revenus total</th>
                        <th>Ville</th>
                        <th>Statut</th>
                    </tr>
            `;
            
            sortedDrivers.forEach(driver => {
                tableContent += `
                    <tr>
                        <td>${driver.firstname} ${driver.lastname}</td>
                        <td>${driver.totalEarnings.toLocaleString('fr-FR')} $</td>
                        <td>${driver.city}</td>
                        <td>${driver.status}</td>
                    </tr>
                `;
            });
            
            tableContent += '</table>';
            
            exportToWord(tableContent, 'Revenus par Chauffeur', 'revenus_chauffeurs');
        }
        
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }
        
        function setupTabs() {
            document.querySelectorAll('.tab-item').forEach(tab => {
                tab.addEventListener('click', function() {
                    const newTab = this.dataset.tab;
                    
                    document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    document.querySelector('.tab-content.active').classList.remove('active');
                    document.getElementById(`${newTab}-section`).classList.add('active');
                    activeTab = newTab;
                    
                    if (newTab === 'dashboard') {
                        loadDashboard();
                    } else if (newTab === 'drivers') {
                        loadPendingDrivers();
                        updateDriversTable();
                    } else if (newTab === 'history') {
                        loadHistory();
                    } else if (newTab === 'earnings') {
                        calculateEarningsByPeriod();
                        loadDriverEarningsChart();
                    } else if (newTab === 'orders') {
                        loadOrders();
                    }
                });
            });
        }
        
        function loadDriverEarningsChart() {
            if (allDrivers.length === 0) return;
            
            const sortedDrivers = [...allDrivers].sort((a, b) => b.totalEarnings - a.totalEarnings);
            const topDrivers = sortedDrivers.slice(0, 10);
            
            const ctx = document.getElementById('driver-earnings-chart').getContext('2d');
            
            if (driverEarningsChart) {
                driverEarningsChart.destroy();
            }
            
            driverEarningsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topDrivers.map(driver => `${driver.firstname} ${driver.lastname}`),
                    datasets: [{
                        label: 'Revenus ($)',
                        data: topDrivers.map(driver => driver.totalEarnings),
                        backgroundColor: '#3b82f6',
                        borderColor: '#2563eb',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + ' $';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        function loadOrders() {
            const ordersRef = database.ref('commande');
            const unconfirmedRef = database.ref('commande_unconfirmed');
            const transferredRef = database.ref('commande_transfered');
            const confirmedRef = database.ref('commande_confirmed');
            const ordersContainer = document.getElementById('orders-list');
            
            ordersContainer.innerHTML = '';

            // MODIFICATION 1: Supprimer l'affichage des commandes confirmées
            // Ne plus appeler renderConfirmedOrders()

            // NOTE: removed automatic admin notification area for priceConfirmed — admins should assign drivers manually
            
            let orders = {};
            
            const updateOrdersList = () => {
                ordersContainer.innerHTML = '';
                // MODIFICATION 1: Filtrer les commandes pour exclure les commandes confirmées
                // Ne montrer que les commandes en attente, en cours, ou non confirmées
                const filteredOrders = Object.entries(orders).filter(([key, order]) => {
                    if (!order) return false;
                    if (confirmedKeys.has(key)) return false;
                    if (order.source === 'commande_confirmed') return false;
                        if (order.status === 'confirmed' || order.status === 'finished') return false;
                    return true;
                });
                
                if (filteredOrders.length === 0) {
                    ordersContainer.innerHTML = `
                        <div class="text-center py-12">
                            <i class="fas fa-box-open text-gray-300 text-5xl mb-4"></i>
                            <h3 class="text-lg font-medium text-gray-700">Aucune commande en attente</h3>
                            <p class="text-gray-500 mt-1">Toutes les commandes ont été traitées.</p>
                        </div>
                    `;
                    return;
                }
                
                filteredOrders.forEach(([key, order]) => {
                    const orderCard = createOrderCard(order, key);
                    ordersContainer.appendChild(orderCard);
                });
            };
            
            unconfirmedRef.on('value', (snapshot) => {
                const unconfirmedOrders = snapshot.val() || {};
                Object.entries(unconfirmedOrders).forEach(([key, order]) => {
                    orders[key] = {...order, source: 'commande_unconfirmed'};
                });
                updateOrdersList();
            });

            // listen for confirmed orders to keep a set of keys (prevents duplicates showing)
            confirmedRef.on('value', (snap) => {
                confirmedKeys.clear();
                const data = snap.val() || {};
                Object.keys(data).forEach(k => confirmedKeys.add(k));
                updateOrdersList();
            });

            // Do NOT automatically notify admin when a client confirms the price.
            // The order will remain in the main list (including priceConfirmed=true) until a driver is assigned and accepts.
            
            ordersRef.on('value', (snapshot) => {
                const commandeOrders = snapshot.val() || {};
                Object.entries(commandeOrders).forEach(([key, order]) => {
                    orders[key] = {...order, source: 'commande'};
                });
                updateOrdersList();
            });
            
            transferredRef.on('value', (snapshot) => {
                const transferredOrders = snapshot.val() || {};
                Object.entries(transferredOrders).forEach(([key, order]) => {
                    orders[key] = {...order, source: 'commande_transfered'};
                });
                updateOrdersList();
            });
        }
        
        function createOrderCard(order, key) {
            const container = document.createElement('div');
            container.className = 'order-card';
            container.setAttribute('data-order-key', key);

            // compact annonce view
            const annonce = document.createElement('div');
            annonce.className = 'order-annonce';

            const statusClass = order.assignedDrivers && order.assignedDrivers.length > 0 ? 'status-assigned' : (order.priceConfirmed ? 'status-pending' : 'status-new');

            annonce.innerHTML = `
                <div class="meta">
                    <div class="status-icon ${statusClass}">
                        <i class="fas ${order.assignedDrivers && order.assignedDrivers.length > 0 ? 'fa-user-check' : (order.priceConfirmed ? 'fa-hourglass-half' : 'fa-bell')}"></i>
                    </div>
                    <div>
                        <div class="text-sm text-gray-700 font-semibold">${order.clientName || 'Client'}</div>
                        <div class="text-xs text-gray-500">${order.pickup || '—'} → ${order.destination || '—'}</div>
                        <div class="text-xs text-blue-600">
                            <i class="fas ${order.roundTrip ? 'fa-exchange-alt' : 'fa-long-arrow-alt-right'} mr-1"></i>
                            ${order.roundTrip ? 'Aller-retour' : 'Aller simple'}
                        </div>
                    </div>
                </div>
                <div class="order-actions">
                    <div class="text-xs text-gray-500">${new Date(order.timestamp).toLocaleString('fr-FR')}</div>
                    ${!order.price ? `<button class="set-price-btn bg-yellow-500 text-white px-3 py-1 rounded-lg ml-2" data-key="${key}" data-source="${order.source || 'commande'}">Proposer prix</button>` : ''}
                    <button class="btn-see-details bg-primary text-white px-3 py-1 rounded-lg ml-2" data-key="${key}">Voir</button>
                </div>
            `;

            container.appendChild(annonce);

            // details panel (hidden by default)
            const details = document.createElement('div');
            details.className = 'order-details hidden';
            details.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <div class="text-sm text-gray-600">Téléphone: <span class="font-medium">${order.phone || order.clientPhone || order.clientPhoneNumber || ''}</span></div>
                        <div class="text-sm text-gray-600">Notes: <span class="font-medium">${order.notes || '—'}</span></div>
                    </div>
                    <div class="flex flex-col items-end">
                        ${order.price ? `<div class="text-sm font-semibold">${order.price} $</div>` : '<div class="text-sm text-gray-500">Prix non fixé</div>'}
                        ${order.priceConfirmed ? '<div class="text-xs text-green-600">Prix confirmé</div>' : ''}
                    </div>
                </div>
                <div class="mt-3" id="map-${key}" style="height:160px;border-radius:8px;overflow:hidden;"></div>
                <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <h4 class="text-sm font-medium mb-2">Liste chauffeurs</h4>
                        <div class="driver-list" id="driver-list-${key}"></div>
                    </div>
                    <div>
                        <h4 class="text-sm font-medium mb-2">Chauffeurs proposés / assignés</h4>
                        <div class="proposed-list" id="proposed-list-${key}"></div>
                        <div class="mt-3 flex items-center justify-end gap-2">
                            <button class="btn-close-details px-3 py-1 border rounded-md text-gray-700">Fermer</button>
                            <button class="btn-confirm-order bg-green-600 text-white px-3 py-1 rounded-lg disabled:opacity-40" data-key="${key}" disabled>Confirmer</button>
                            <button class="btn-delete-order ml-2 text-gray-600" data-key="${key}"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                </div>
            `;

            container.appendChild(details);

            // if this order's details were open before a re-render, keep them open
            if (openDetailsKeys.has(key)) {
                details.classList.remove('hidden');
                setTimeout(() => loadOrderMap(key, order), 100);
            }

            // toggle expand behavior (track open state so re-renders don't close it)
            annonce.addEventListener('click', (e) => {
                // ignore clicks on the buttons inside
                if (e.target.closest('button')) return;
                const wasHidden = details.classList.contains('hidden');
                details.classList.toggle('hidden');
                if (wasHidden) {
                    openDetailsKeys.add(key);
                } else {
                    openDetailsKeys.delete(key);
                }
                // when expanding, ensure map loads
                if (!details.classList.contains('hidden')) {
                    setTimeout(() => loadOrderMap(key, order), 100);
                }
            });

            // See details button opens panel
            annonce.querySelector('.btn-see-details').addEventListener('click', (ev) => {
                ev.stopPropagation();
                details.classList.remove('hidden');
                openDetailsKeys.add(key);
                setTimeout(() => loadOrderMap(key, order), 100);
            });

            // populate driver list with plus icons to propose assignment (doesn't immediately transfer)
            const driverListEl = details.querySelector(`#driver-list-${key}`);
            const proposedListEl = details.querySelector(`#proposed-list-${key}`);
            const confirmBtnEl = details.querySelector('.btn-confirm-order');
            const closeBtnEl = details.querySelector('.btn-close-details');

            function renderDriverList() {
                driverListEl.innerHTML = '';
                // if price not confirmed yet, show notice and disable propose buttons
                if (!order.priceConfirmed) {
                    const note = document.createElement('div');
                    note.className = 'text-sm text-yellow-600 p-3 bg-yellow-50 rounded';
                    note.textContent = 'Attendez la confirmation du prix par le client avant de proposer des chauffeurs.';
                    driverListEl.appendChild(note);
                    // still render list but disabled
                }

                Object.entries(drivers).forEach(([did, d]) => {
                    if (!d) return;
                    const row = document.createElement('div');
                    row.className = 'flex items-center justify-between gap-2 py-2 border-b border-gray-100';
                    row.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-sm">${(d.firstname||'').charAt(0)}${(d.lastname||'').charAt(0)}</div>
                            <div>
                                <div class="text-sm font-medium">${d.firstname || ''} ${d.lastname || ''}</div>
                                <div class="text-xs text-gray-500">${d.phone || ''}</div>
                            </div>
                        </div>
                        <div>
                            <button class="assign-plus-btn inline-flex items-center justify-center bg-primary text-white rounded-full w-7 h-7 text-sm" data-did="${did}" title="Assigner ce chauffeur">+</button>
                        </div>
                    `;
                    driverListEl.appendChild(row);
                    // wire assign '+' button
                    const plusBtn = row.querySelector('.assign-plus-btn');
                    if (plusBtn) {
                        // disable if price not confirmed
                        if (!order.priceConfirmed) {
                            plusBtn.disabled = true;
                            plusBtn.classList.add('opacity-40', 'cursor-not-allowed');
                            plusBtn.title = 'Prix non confirmé par le client';
                        }
                        plusBtn.addEventListener('click', (ev) => {
                            ev.stopPropagation();
                            if (!order.priceConfirmed) {
                                return showNotification('Le client doit confirmer le prix avant dassigner un chauffeur.', 'error');
                            }
                            const driverId = plusBtn.dataset.did;
                            const driverObj = drivers[driverId];
                            if (!driverObj) return showNotification('Chauffeur introuvable', 'error');
                            // call assign flow: assigns driver to order (will keep details open)
                            assignDriverToOrder(driverObj, key, null);
                        });
                    }
                });
            }
            renderDriverList();

            // helper to get the DB ref for this order (commande or commande_unconfirmed)
            async function getOrderRef() {
                const r1 = database.ref(`commande/${key}`);
                const s1 = await r1.once('value');
                if (s1.exists()) return r1;
                const r2 = database.ref(`commande_unconfirmed/${key}`);
                const s2 = await r2.once('value');
                if (s2.exists()) return r2;
                return null;
            }

            // propose driver: add to proposedDrivers with accepted=false
            async function proposeDriver(driverId) {
                // ensure price confirmed before proposing
                const refCheck = await getOrderRef();
                if (refCheck) {
                    const snap = await refCheck.once('value');
                    const od = snap.val() || {};
                    if (!od.priceConfirmed) {
                        return showNotification('Le client doit confirmer le prix avant dassigner des chauffeurs.', 'error');
                    }
                }
                const driver = drivers[driverId];
                if (!driver) return showNotification('Chauffeur introuvable', 'error');
                const ref = await getOrderRef();
                if (!ref) return showNotification('Commande introuvable', 'error');
                const node = await ref.child('proposedDrivers').once('value');
                const existing = node.val() || {};
                existing[driverId] = { id: driverId, name: `${driver.firstname||''} ${driver.lastname||''}`, phone: driver.phone, accepted: false, timestamp: new Date().toISOString() };
                await ref.child('proposedDrivers').set(existing);
                showNotification(`Proposition envoyée à ${driver.firstname}`, 'success');
            }

            // render proposed/assigned drivers for this order
            async function refreshProposedList() {
                const ref = await getOrderRef();
                proposedListEl.innerHTML = '';
                if (!ref) return;
                const snap = await ref.child('proposedDrivers').once('value');
                const proposed = snap.val() || {};
                const assigned = (await ref.child('assignedDrivers').once('value')).val() || [];

                // show proposed
                Object.entries(proposed).forEach(([pid, pd]) => {
                    const chip = document.createElement('div');
                    chip.className = 'inline-flex items-center gap-2 mr-2 mb-2 px-3 py-1 rounded-full bg-gray-100';
                    chip.innerHTML = `${pd.name} <span class="text-xs text-gray-500">${pd.accepted ? ' • accepté' : ' • proposé'}</span>`;
                    proposedListEl.appendChild(chip);
                });

                // show assigned drivers with whatsapp icon
                assigned.forEach(ad => {
                    const chip = document.createElement('div');
                    chip.className = 'inline-flex items-center gap-2 mr-2 mb-2 px-3 py-1 rounded-full bg-green-50';
                    const phone = ad.phone || '';
                    chip.innerHTML = `${ad.name} <span class="text-xs text-green-600"> • assigné</span>`;
                    if (phone) {
                        const wa = document.createElement('a');
                        wa.href = `https://wa.me/${phone.replace(/\s+/g,'')}?text=${encodeURIComponent('Bonjour '+ad.name+', vous êtes assigné à la commande #' + key + '. Veuillez confirmer sur votre espace.')}`;
                        wa.target = '_blank';
                        wa.className = 'ml-2 text-green-600';
                        wa.innerHTML = '<i class="fab fa-whatsapp"></i>';
                        chip.appendChild(wa);
                    }
                    proposedListEl.appendChild(chip);
                });

                // enable confirm only if an assigned driver exists OR a proposed driver has accepted
                const anyAccepted = Object.values(proposed).some(p => p.accepted) || assigned.length > 0;
                confirmBtnEl.disabled = !anyAccepted;
                if (anyAccepted) confirmBtnEl.classList.remove('opacity-40'); else confirmBtnEl.classList.add('opacity-40');
            }

            // poll or refresh on open
            refreshProposedList();
            // also listen to changes to update live
            (async () => {
                const ref = await getOrderRef();
                if (!ref) return;
                ref.child('proposedDrivers').on('value', refreshProposedList);
                ref.child('assignedDrivers').on('value', refreshProposedList);
            })();

            // close details
            closeBtnEl.addEventListener('click', (e) => { e.stopPropagation(); details.classList.add('hidden'); });

            // confirm order -> move to commande_confirmed with status 'confirmed'
            const confirmBtn = container.querySelector('.btn-confirm-order');
            confirmBtn.addEventListener('click', async () => {
                try {
                    const sourceRef = database.ref(`commande_unconfirmed/${key}`);
                    const mainRef = database.ref(`commande/${key}`);
                    const currentRef = (await mainRef.once('value')).exists() ? mainRef : sourceRef;
                    const snapshot = await currentRef.once('value');
                    const data = snapshot.val();
                    if (!data) return showNotification('Commande introuvable', 'error');
                    data.status = 'confirmed';
                    data.confirmedAt = new Date().toISOString();
                    await database.ref(`commande_confirmed/${key}`).set(data);
                    await currentRef.remove();
                    showNotification('Commande confirmée', 'success');
                } catch (err) {
                    console.error(err);
                    showNotification('Erreur lors de la confirmation', 'error');
                }
            });

            // delete order
            const delBtn = container.querySelector('.btn-delete-order');
            delBtn.addEventListener('click', async (e) => {
                e.stopPropagation();
                try {
                    await database.ref(`commande/${key}`).remove();
                    await database.ref(`commande_unconfirmed/${key}`).remove();
                    await database.ref(`commande_transfered/${key}`).remove();
                    showNotification('Commande supprimée', 'success');
                } catch (err) {
                    console.error(err);
                    showNotification('Erreur suppression', 'error');
                }
            });

            return container;
        }

        // Show admin notification for newly confirmed price that prompts admin to inform client
        function showAdminConfirmNotification(key, order) {
            try {
                const notifyArea = document.getElementById('admin-confirm-notifications');
                if (!notifyArea) return;

                const card = document.createElement('div');
                card.className = 'admin-confirm-card';
                const pickup = order.pickup || 'Position actuelle';
                const dest = order.destination || '—';
                const price = typeof order.price !== 'undefined' ? order.price + ' $' : '—';
                const clientPhone = order.phone || order.clientPhone || '';

                // prefilled message for admin to send to client
                const msg = encodeURIComponent(`Bonjour, votre commande (${pickup} → ${dest}) a été acceptée. Le prix: ${price}. Merci de confirmer.`);

                card.innerHTML = `
                    <div class="admin-confirm-card-inner">
                        <div class="admin-confirm-meta">
                            <div><strong>Commande #${key}</strong></div>
                            <div class="text-sm text-gray-600">${pickup} → ${dest} • ${price}</div>
                        </div>
                        <div class="admin-confirm-actions">
                            <button class="btn-inform-client btn btn-sm bg-primary text-white" data-key="${key}" data-phone="${clientPhone}" data-msg="${msg}">Informer le client</button>
                            <button class="btn-dismiss-notif btn btn-sm ml-2">Ignorer</button>
                        </div>
                    </div>
                `;

                notifyArea.insertBefore(card, notifyArea.firstChild);

                const informBtn = card.querySelector('.btn-inform-client');
                const dismissBtn = card.querySelector('.btn-dismiss-notif');

                informBtn.addEventListener('click', async () => {
                    try {
                        const k = informBtn.dataset.key;
                        // Move to confirmed (history) and remove from unconfirmed
                        const mainRef = database.ref(`commande/${k}`);
                        const sourceRef = database.ref(`commande_unconfirmed/${k}`);
                        const snapMain = await mainRef.once('value');
                        const snapSource = await sourceRef.once('value');
                        const data = snapMain.exists() ? snapMain.val() : (snapSource.exists() ? snapSource.val() : null);
                        if (!data) return showNotification('Commande introuvable', 'error');
                        data.status = 'confirmed';
                        data.confirmedAt = new Date().toISOString();
                        await database.ref(`commande_confirmed/${k}`).set(data);
                        // remove original
                        await mainRef.remove();
                        await sourceRef.remove();

                        // Optionally open WhatsApp to client
                        const phone = informBtn.dataset.phone || '';
                        const msgText = decodeURIComponent(informBtn.dataset.msg || '');
                        if (phone) {
                            window.open(`https://wa.me/${phone.replace(/\D+/g,'')}?text=${encodeURIComponent(msgText)}`, '_blank');
                        }

                        // remove card
                        card.remove();
                    } catch (e) {
                        console.error('inform client error', e);
                        showNotification('Erreur lors de l\'information du client', 'error');
                    }
                });

                dismissBtn.addEventListener('click', () => card.remove());
            } catch(e) { console.error('showAdminConfirmNotification error', e); }
        }
        
        // Keep a reference to Leaflet map instances per order key so we can update markers in realtime
        const orderMaps = {};
        function loadOrderMap(key, order) {
            const mapElement = document.getElementById(`map-${key}`);
            if (!mapElement) return;

            // remove previous markers for this key
            if (mapMarkers[key]) {
                mapMarkers[key].forEach(m => {
                    try { m.remove(); } catch(e){}
                });
                mapMarkers[key] = [];
            } else {
                mapMarkers[key] = [];
            }

            // robust coordinate parsing for client
            function parseClientCoords(o) {
                if (!o) return null;
                const candidates = [];
                // common fields
                if (o.latitude !== undefined && o.longitude !== undefined) candidates.push([o.latitude, o.longitude]);
                if (o.lat !== undefined && o.lng !== undefined) candidates.push([o.lat, o.lng]);
                if (o.lat !== undefined && o.long !== undefined) candidates.push([o.lat, o.long]);
                if (o.coordinates && Array.isArray(o.coordinates) && o.coordinates.length >= 2) candidates.push([o.coordinates[0], o.coordinates[1]]);
                if (o.coords && o.coords.lat !== undefined && o.coords.lng !== undefined) candidates.push([o.coords.lat, o.coords.lng]);
                if (o.longitude !== undefined && o.latitude === undefined && typeof o.longitude === 'string') {
                    // maybe stored as 'lat,lng' string
                    const parts = o.longitude.split(',').map(s => s.trim());
                    if (parts.length >= 2) return {lat: parseFloat(parts[0]), lng: parseFloat(parts[1])};
                }
                for (const c of candidates) {
                    const lat = parseFloat(c[0]);
                    const lng = parseFloat(c[1]);
                    if (!isNaN(lat) && !isNaN(lng)) {
                        // sanity: lat should be between -90 and 90
                        if (Math.abs(lat) <= 90 && Math.abs(lng) <= 180) return {lat, lng};
                        // occasionally stored reversed
                        if (Math.abs(lng) <= 90 && Math.abs(lat) <= 180) return {lat: lng, lng: lat};
                    }
                }
                return null;
            }

            const clientCoords = parseClientCoords(order);

            let center = [19.639994, -72.044276];
            let zoom = 13;
            if (clientCoords) {
                center = [clientCoords.lat, clientCoords.lng];
                zoom = 14;
                console.log(`Client loaded: lat=${clientCoords.lat}, lng=${clientCoords.lng}`);
            }

            // create or reuse map instance
            let map = orderMaps[key];
            if (!map) {
                map = L.map(mapElement).setView(center, zoom);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap'
                }).addTo(map);
                orderMaps[key] = map;
            } else {
                try { map.invalidateSize(); map.setView(center, zoom); } catch(e) {}
            }

            // ensure z-index of map panes
            try {
                const container = map.getContainer();
                if (container) container.style.zIndex = 10;
            } catch(e) {}

            // add client marker if coords
            if (clientCoords) {
                const clientMarker = L.marker([clientCoords.lat, clientCoords.lng], {
                    icon: L.divIcon({ html: '<div class="client-marker"><i class="fas fa-user"></i></div>', className: 'dummy', iconSize: [32,32], iconAnchor: [16,16] })
                }).addTo(map);
                mapMarkers[key].push(clientMarker);
                clientMarker.bindPopup(`<div class="driver-info"><strong>Client:</strong> ${order.clientName || 'Non spécifié'}<br><strong>Destination:</strong> ${order.destination || 'Non spécifié'}<br><strong>Lieu de départ:</strong> ${order.pickup || 'Non spécifié'}</div>`);
            }

            // show driver markers (blue) from current drivers state
            function addDriverMarkers() {
                // remove previous driver markers for this map
                // remove previous driver markers only (leave client marker/map references intact)
                mapMarkers[key] = mapMarkers[key].filter(m => {
                    try {
                        if (m && m._isDriverMarker) { m.remove(); return false; }
                    } catch(e) {}
                    return true;
                });

                Object.values(drivers).forEach(driver => {
                    if (!driver) return;
                    const lat = parseFloat(driver.latitude || driver.lat || driver.positionLat || driver.latitud || '');
                    const lng = parseFloat(driver.longitude || driver.lng || driver.positionLng || driver.long || '');
                    if (isNaN(lat) || isNaN(lng)) return;
                    const marker = L.marker([lat, lng], {
                        icon: L.divIcon({ html: `<div class="driver-photo-marker" style="background-image: url(${driver.photoURL||''})"></div>`, className: 'custom-div-icon', iconSize: [36,36], iconAnchor: [18,18] })
                    }).addTo(map);
                    // tag it so we can remove only driver markers next refresh
                    marker._isDriverMarker = true;
                    mapMarkers[key].push(marker);
                    marker.bindPopup(`<div class="driver-info"><strong>Chauffeur:</strong> ${driver.firstname||''} ${driver.lastname||''}<br><strong>Statut:</strong> ${driver.status||''}<br><strong>Téléphone:</strong> ${driver.phone||''}</div>`);
                });
            }

            addDriverMarkers();

            // attach a lightweight drivers listener to update markers when positions change
            // Note: we only attach one global listener in startDriversListener; here we reuse current drivers snapshot updates
            // To support realtime updates of this map when drivers change, we'll listen to the drivers node and refresh markers
            const refreshKey = `drivers_listener_for_map_${key}`;
            if (!window[refreshKey]) {
                window[refreshKey] = database.ref('drivers').on('value', snap => {
                    drivers = snap.val() || drivers;
                    try { addDriverMarkers(); } catch(e) { console.error('Error refreshing driver markers', e); }
                });
            }
        }
        
        function assignDriverToOrder(driver, orderKey, driverMarker) {
            const orderRef = database.ref(`commande/${orderKey}`);
            const unconfirmedRef = database.ref(`commande_unconfirmed/${orderKey}`);
            const transferredRef = database.ref(`commande_transfered/${orderKey}`);
            
            // MODIFICATION 3: Garder la fenêtre d'infos ouverte après assignation
            // Ne pas fermer la fenêtre d'infos après l'assignation
            
            orderRef.once('value').then(orderSnapshot => {
                if (orderSnapshot.exists()) {
                    const orderData = orderSnapshot.val();
                    return processDriverAssignment(orderData, orderKey, driver, transferredRef, orderRef);
                } else {
                    return unconfirmedRef.once('value').then(unconfirmedSnapshot => {
                        if (unconfirmedSnapshot.exists()) {
                            const orderData = unconfirmedSnapshot.val();
                            return processDriverAssignment(orderData, orderKey, driver, transferredRef, unconfirmedRef);
                        }
                    });
                }
            }).catch(error => {
                console.error("Erreur récupération commande:", error);
                showNotification("Erreur lors de l'assignation", 'error');
            });
        }
        
        function processDriverAssignment(orderData, orderKey, driver, transferredRef, sourceRef) {
            if (!orderData.chauffeur) {
                orderData.chauffeur = [];
            }
            if (!orderData.assignedDrivers) {
                orderData.assignedDrivers = [];
            }
            
            const driverName = `${driver.firstname} ${driver.lastname}`;
            if (!orderData.chauffeur.includes(driverName)) {
                orderData.chauffeur.push(driverName);
            }
            
            orderData.assignedDrivers.push({
                name: driverName,
                phone: driver.phone,
                timestamp: new Date().getTime()
            });
            
            transferredRef.set(orderData)
                .then(() => {
                    // MODIFICATION 3: Garder la fenêtre d'infos ouverte après assignation
                    // Ne pas supprimer la source originale pour garder la fenêtre ouverte
                    // sourceRef.remove(); // Cette ligne est commentée pour garder la fenêtre ouverte

                    const assignedDriversList = document.getElementById(`assigned-drivers-${orderKey}`);
                    if (assignedDriversList) {
                        assignedDriversList.innerHTML = orderData.assignedDrivers.map(d => `
                            <div class="assigned-driver-item flex justify-between items-center">
                                <div>
                                    <i class="fas fa-user"></i>
                                    ${d.name} (${d.phone}) - ${new Date(d.timestamp).toLocaleTimeString('fr-FR')}
                                </div>
                                <a href="https://wa.me/${d.phone}?text=Une nouvelle commande vous est attribuée : ${orderData.pickup} → ${orderData.destination} (${orderData.tripType || 'aller simple'}). Veuillez vous rendre sur votre page pour l'accepter le plus rapidement possible." target="_blank" class="text-green-500 ml-2">
                                    <i class="fab fa-whatsapp"></i>
                                </a>
                            </div>
                        `).join('');
                    }

                    // MODIFICATION 3: Garder la fenêtre d'infos ouverte après assignation
                    // Assurer que le panneau de détails reste ouvert
                    if (openDetailsKeys.has(orderKey)) {
                        const orderCard = document.querySelector(`.order-card[data-order-key="${orderKey}"]`);
                        if (orderCard) {
                            const detailsPanel = orderCard.querySelector('.order-details');
                            if (detailsPanel && detailsPanel.classList.contains('hidden')) {
                                detailsPanel.classList.remove('hidden');
                            }
                        }
                    }

                    showNotification(`Chauffeur ${driverName} assigné avec succès!`, 'success');
                })
                .catch(error => {
                    console.error("Erreur transfert commande:", error);
                    showNotification("Erreur lors de l'assignation", 'error');
                });
        }
        
        function setupOrderNotifications() {
            const ordersRef = database.ref('commande');
            const unconfirmedRef = database.ref('commande_unconfirmed');
            
            const updateNotificationCount = () => {
                ordersRef.once('value').then(ordersSnapshot => {
                    const ordersCount = ordersSnapshot.exists() ? ordersSnapshot.numChildren() : 0;
                    unconfirmedRef.once('value').then(unconfirmedSnapshot => {
                        const unconfirmedCount = unconfirmedSnapshot.exists() ? unconfirmedSnapshot.numChildren() : 0;
                        notificationCount = ordersCount + unconfirmedCount;
                        document.getElementById('notification-count').textContent = notificationCount;
                        if (notificationCount > 0) {
                            document.getElementById('notification-count').classList.remove('hidden');
                        } else {
                            document.getElementById('notification-count').classList.add('hidden');
                        }
                    });
                });
            };
            
            ordersRef.on('child_added', (snapshot) => {
                updateNotificationCount();
                const sound = document.getElementById('notification-sound');
                if (sound) {
                    sound.play().catch(e => console.error("Erreur son notification:", e));
                }
            });
            
            ordersRef.on('child_removed', updateNotificationCount);
            unconfirmedRef.on('child_added', updateNotificationCount);
            unconfirmedRef.on('child_removed', updateNotificationCount);
            
            updateNotificationCount();
        }
        
        function setOrderPrice(orderKey, source) {
            currentOrderKey = orderKey;
            currentSource = source;
            document.getElementById('price-input').value = '';
            document.getElementById('price-modal').classList.remove('hidden');
        }
        
        function saveOrderPrice() {
            const price = document.getElementById('price-input').value;
            if (!price) {
                showNotification("Veuillez entrer un prix valide", 'error');
                return;
            }
            
            currentPrice = parseFloat(price);
            const orderRef = database.ref(`${currentSource}/${currentOrderKey}`);
            
            orderRef.update({ 
                price: currentPrice,
                priceConfirmed: false
            })
            .then(() => {
                const unconfirmedRef = database.ref(`commande_unconfirmed/${currentOrderKey}`);
                
                orderRef.once('value').then(snapshot => {
                    const orderData = snapshot.val();
                    unconfirmedRef.set(orderData)
                        .then(() => {
                            if (currentSource !== 'commande_unconfirmed') {
                                orderRef.remove()
                                    .then(() => {
                                        document.getElementById('price-modal').classList.add('hidden');
                                        showNotification("Prix défini et commande déplacée en attente de confirmation client.", 'success');
                                    });
                            } else {
                                document.getElementById('price-modal').classList.add('hidden');
                                showNotification("Prix mis à jour avec succès", 'success');
                            }
                        });
                });
            })
            .catch(error => {
                console.error("Erreur mise à jour prix:", error);
                showNotification("Erreur lors de la mise à jour du prix", 'error');
            });
        }
        
        function deleteOrder(orderKey, source) {
            if (confirm("Êtes-vous sûr de vouloir supprimer cette commande ?")) {
                const orderRef = database.ref(`${source}/${orderKey}`);
                orderRef.remove()
                    .then(() => {
                        // MODIFICATION 1: Suppression immédiate de la carte
                        const orderCard = document.querySelector(`.order-card[data-order-key="${orderKey}"]`);
                        if (orderCard) {
                            orderCard.remove();
                        }
                        showNotification("Commande supprimée avec succès", 'success');
                    })
                    .catch(error => {
                        console.error("Erreur suppression commande:", error);
                        showNotification("Erreur lors de la suppression", 'error');
                    });
            }
        }
        
        // Nouvelle fonction pour charger les membres enregistrés
        function loadRegisteredUsers() {
            const listContainer = document.getElementById('registered-users-list');
            listContainer.innerHTML = '<p class="text-center py-4">Chargement...</p>';
            
            database.ref('save_member').once('value').then(snapshot => {
                const users = snapshot.val() || {};
                listContainer.innerHTML = '';
                
                if (Object.keys(users).length === 0) {
                    listContainer.innerHTML = '<p class="text-center py-4">Aucun utilisateur enregistré</p>';
                    return;
                }
                
                Object.entries(users).forEach(([key, user]) => {
                    const userElement = document.createElement('div');
                    userElement.className = 'user-list-item';
                    userElement.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm">
                            <div>
                                <p class="text-gray-500">Nom</p>
                                <p>${user.nom || 'Non spécifié'}</p>
                            </div>
                            <div>
                                <p class="text-gray-500">Prénom</p>
                                <p>${user.prenom || 'Non spécifié'}</p>
                            </div>
                            <div>
                                <p class="text-gray-500">Âge</p>
                                <p>${user.age || 'Non spécifié'}</p>
                            </div>
                            <div>
                                <p class="text-gray-500">Date d'inscription</p>
                                <p>${new Date(user.date_inscription).toLocaleString('fr-FR')}</p>
                            </div>
                        </div>
                    `;
                    listContainer.appendChild(userElement);
                });
            });
        }
        
        // Nouvelle fonction pour charger les visiteurs
        function loadVisitors() {
            const listContainer = document.getElementById('visitors-list');
            listContainer.innerHTML = '<p class="text-center py-4">Chargement...</p>';
            
            database.ref('unsave_member').once('value').then(snapshot => {
                const visitors = snapshot.val() || {};
                listContainer.innerHTML = '';
                
                if (Object.keys(visitors).length === 0) {
                    listContainer.innerHTML = '<p class="text-center py-4">Aucun visiteur</p>';
                    return;
                }
                
                Object.entries(visitors).forEach(([key, visitor]) => {
                    const date = new Date(visitor.timestamp);
                    const visitorElement = document.createElement('div');
                    visitorElement.className = 'visitor-list-item';
                    visitorElement.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div>
                                <p class="text-gray-500">Date et heure</p>
                                <p>${date.toLocaleString('fr-FR')}</p>
                            </div>
                            <div>
                                <p class="text-gray-500">Type</p>
                                <p>Visiteur</p>
                            </div>
                        </div>
                    `;
                    listContainer.appendChild(visitorElement);
                });
            });
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            notificationSound = document.getElementById('notification-sound');
            
            // ensure admin password is loaded/seeded before attaching login handler
            loadOrSeedAdminPassword().then(() => {
                const adminLoginBtn = document.getElementById('admin-login-btn');
                function setButtonLoading(btn, loading, labelText) {
                    if (!btn) return;
                    if (loading) {
                        btn.disabled = true;
                        btn.setAttribute('aria-busy', 'true');
                        if (!btn.dataset.origHtml) btn.dataset.origHtml = btn.innerHTML;
                        btn.innerHTML = `<span class="btn-spinner" aria-hidden="true"></span>${labelText || btn.dataset.origHtml || ''}`;
                    } else {
                        btn.disabled = false;
                        btn.removeAttribute('aria-busy');
                        if (btn.dataset.origHtml) {
                            btn.innerHTML = btn.dataset.origHtml;
                            delete btn.dataset.origHtml;
                        }
                    }
                }

                adminLoginBtn.addEventListener('click', function() {
                    const password = document.getElementById('admin-password').value;
                    const errorElement = document.getElementById('login-password-error');
                    
                    if (!password) {
                        errorElement.textContent = 'Veuillez entrer votre mot de passe';
                        errorElement.classList.remove('hidden');
                        return;
                    }

                    setButtonLoading(adminLoginBtn, true, 'Connexion...');

                    setTimeout(() => {
                        // simulate slight delay for UX, then check password
                        if (password !== ADMIN_PASSWORD) {
                            errorElement.textContent = 'Mot de passe incorrect';
                            errorElement.classList.remove('hidden');
                            setButtonLoading(adminLoginBtn, false);
                            return;
                        }

                        document.getElementById('login-section').classList.add('hidden');
                        document.getElementById('main-interface').classList.remove('hidden');
                        loadDashboard();
                        setupOrderNotifications();
                        startDriversListener();
                        setButtonLoading(adminLoginBtn, false);
                    }, 350);
                });

                // change password handler (available after login) - keep legacy card handler if present
                const changeBtn = document.getElementById('btn-change-admin-pass');
                if (changeBtn) {
                    changeBtn.addEventListener('click', async function() {
                        const cur = document.getElementById('cur-admin-pass').value;
                        const nw = document.getElementById('new-admin-pass').value;
                        const cf = document.getElementById('confirm-admin-pass').value;
                        const resultEl = document.getElementById('change-admin-result');
                        resultEl.classList.add('hidden');

                        if (!cur || !nw || !cf) {
                            resultEl.textContent = 'Veuillez remplir tous les champs';
                            resultEl.classList.remove('hidden');
                            resultEl.classList.add('text-red-500');
                            return;
                        }
                        if (cur !== ADMIN_PASSWORD) {
                            resultEl.textContent = 'Mot de passe actuel incorrect';
                            resultEl.classList.remove('hidden');
                            resultEl.classList.add('text-red-500');
                            return;
                        }
                        if (nw !== cf) {
                            resultEl.textContent = 'Les nouveaux mots de passe ne correspondent pas';
                            resultEl.classList.remove('hidden');
                            resultEl.classList.add('text-red-500');
                            return;
                        }

                        try {
                            await database.ref('admin/password').set(nw);
                            ADMIN_PASSWORD = nw;
                            resultEl.textContent = 'Mot de passe mis à jour';
                            resultEl.classList.remove('text-red-500');
                            resultEl.classList.remove('hidden');
                            resultEl.classList.add('text-green-600');
                            document.getElementById('cur-admin-pass').value = '';
                            document.getElementById('new-admin-pass').value = '';
                            document.getElementById('confirm-admin-pass').value = '';
                        } catch (e) {
                            console.error('Erreur update admin pass', e);
                            resultEl.textContent = 'Erreur lors de la mise à jour';
                            resultEl.classList.remove('hidden');
                            resultEl.classList.add('text-red-500');
                        }
                    });
                }

                // wire modal admin password controls
                const adminIcon = document.getElementById('admin-security-icon');
                const adminModal = document.getElementById('admin-pass-modal');
                const adminModalClose = document.getElementById('admin-pass-close');
                const modalBtn = document.getElementById('modal-btn-change-admin-pass');
                const modalResult = document.getElementById('modal-change-admin-result');

                if (adminIcon && adminModal) {
                    adminIcon.addEventListener('click', () => { adminModal.classList.remove('hidden'); });
                }
                if (adminModalClose) adminModalClose.addEventListener('click', () => { adminModal.classList.add('hidden'); });
                if (modalBtn) {
                    modalBtn.addEventListener('click', async () => {
                        modalResult.classList.add('hidden');
                        const cur = document.getElementById('modal-cur-admin-pass').value;
                        const nw = document.getElementById('modal-new-admin-pass').value;
                        const cf = document.getElementById('modal-confirm-admin-pass').value;
                        if (!cur || !nw || !cf) {
                            modalResult.textContent = 'Veuillez remplir tous les champs';
                            modalResult.classList.remove('hidden'); modalResult.classList.add('text-red-500'); return;
                        }
                        if (cur !== ADMIN_PASSWORD) { modalResult.textContent = 'Mot de passe actuel incorrect'; modalResult.classList.remove('hidden'); modalResult.classList.add('text-red-500'); return; }
                        if (nw !== cf) { modalResult.textContent = 'Les nouveaux mots de passe ne correspondent pas'; modalResult.classList.remove('hidden'); modalResult.classList.add('text-red-500'); return; }
                        try { await database.ref('admin/password').set(nw); ADMIN_PASSWORD = nw; modalResult.textContent = 'Mot de passe mis à jour'; modalResult.classList.remove('text-red-500'); modalResult.classList.remove('hidden'); modalResult.classList.add('text-green-600'); document.getElementById('modal-cur-admin-pass').value=''; document.getElementById('modal-new-admin-pass').value=''; document.getElementById('modal-confirm-admin-pass').value=''; } catch(e){ console.error(e); modalResult.textContent='Erreur'; modalResult.classList.remove('hidden'); modalResult.classList.add('text-red-500'); }
                    });
                }

                // replace logout button behaviour to icon-only (keep existing click handler elsewhere)
                const logoutBtn = document.getElementById('logout-btn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', () => { window.location.href = 'index.html'; });
                }

                // Notifications: watch order tables and send toasts on changes
                const watchTables = ['commande', 'commande_unconfirmed', 'commande_transfered', 'commande_confirmed'];
                watchTables.forEach(table => {
                    const ref = database.ref(table);
                    ref.on('child_changed', (snap) => {
                        const data = snap.val();
                        handleOrderChange(table, snap.key, data);
                    });
                    ref.on('child_added', (snap) => { const data=snap.val(); handleOrderChange(table, snap.key, data, 'added'); });
                });

                function handleOrderChange(table, key, data, kind='changed') {
                    // send notifications for interesting transitions
                    if (!data) return;
                    // price confirmed
                    if (data.priceConfirmed && !data._notifiedPriceConfirmed) {
                        showNotification('Le client a confirmé le prix pour la commande #' + key, 'info');
                        // set a lightweight flag in DB to avoid duplicate notif (local only)
                        try { database.ref(`${table}/${key}/_notifiedPriceConfirmed`).set(true); } catch(e){}
                    }
                    // driver accepted proposed (driver side should set proposedDrivers/<id>/accepted=true)
                    if (data.proposedDrivers) {
                        const anyAccepted = Object.values(data.proposedDrivers).some(p => p && p.accepted === true);
                        if (anyAccepted && !data._notifiedDriverAccepted) {
                            showNotification('Un chauffeur a accepté la proposition pour commande #' + key, 'success');
                            try { database.ref(`${table}/${key}/_notifiedDriverAccepted`).set(true); } catch(e){}
                        }
                    }
                    // assigned driver(s)
                    if (data.assignedDrivers && data.assignedDrivers.length > 0 && !data._notifiedAssigned) {
                        showNotification('Chauffeur assigné pour commande #' + key, 'success');
                        try { database.ref(`${table}/${key}/_notifiedAssigned`).set(true); } catch(e){}
                    }

                    // update assigned-driver UI: if orders currently rendered, show whatsapp icon next to assigned drivers
                    const assignedListEl = document.getElementById(`assigned-drivers-${key}`);
                    if (assignedListEl) {
                        assignedListEl.innerHTML = (data.assignedDrivers || []).map(d => `
                            <div class="assigned-driver-item flex justify-between items-center">
                                <div>
                                    <i class="fas fa-user"></i>
                                    ${d.name} (${d.phone}) - ${new Date(d.timestamp).toLocaleTimeString('fr-FR')}
                                </div>
                                <div class="flex items-center gap-2">
                                    ${d.phone ? `<a href="https://wa.me/${d.phone}?text=${encodeURIComponent('Bonjour '+d.name+', vous avez été assigné à la commande #' + key + '. Veuillez confirmer sur votre espace.') }" target="_blank" class="text-green-500 ml-2"><i class="fab fa-whatsapp"></i></a>` : ''}
                                </div>
                            </div>
                        `).join('');
                    }
                }
            });
            
            document.getElementById('logout-btn').addEventListener('click', function() {
                document.getElementById('main-interface').classList.add('hidden');
                document.getElementById('login-section').classList.remove('hidden');
                document.getElementById('admin-password').value = '';
                
                if (driversListener) {
                    driversListener();
                    driversListener = null;
                }
            });
            
            setupTabs();
            
            document.addEventListener('click', function(e) {
                if (e.target.closest('.confirm-driver-btn')) {
                    currentDriverKey = e.target.closest('.confirm-driver-btn').dataset.key;
                    document.getElementById('confirmation-modal').classList.remove('hidden');
                }
                
                if (e.target.closest('.delete-driver-btn')) {
                    const driverId = e.target.closest('.delete-driver-btn').dataset.id;
                    deleteDriver(driverId);
                }
                
                if (e.target.closest('#export-drivers') || e.target.closest('#export-drivers-dash')) {
                    exportDrivers();
                }
                
                if (e.target.closest('#export-history') || e.target.closest('#export-history-dash')) {
                    exportHistory();
                }
                
                if (e.target.closest('#export-earnings')) {
                    exportEarnings();
                }
                
                if (e.target.closest('.set-price-btn')) {
                    const btn = e.target.closest('.set-price-btn');
                    const orderKey = btn.dataset.key;
                    const source = btn.dataset.source;
                    setOrderPrice(orderKey, source);
                }
                
                if (e.target.closest('.delete-order-btn')) {
                    const btn = e.target.closest('.delete-order-btn');
                    const orderKey = btn.dataset.key;
                    const source = btn.dataset.source;
                    deleteOrder(orderKey, source);
                }
                
                // Nouveaux écouteurs pour les boutons de membres/visiteurs
                if (e.target.closest('#view-registered-users')) {
                    loadRegisteredUsers();
                    document.getElementById('registered-users-modal').classList.remove('hidden');
                }
                
                if (e.target.closest('#view-visitors')) {
                    loadVisitors();
                    document.getElementById('visitors-modal').classList.remove('hidden');
                }
                
                if (e.target.closest('#close-registered-modal')) {
                    document.getElementById('registered-users-modal').classList.add('hidden');
                }
                
                if (e.target.closest('#close-visitors-modal')) {
                    document.getElementById('visitors-modal').classList.add('hidden');
                }
                
                // Écouteur pour le bouton de suppression des chauffeurs non confirmés
                if (e.target.closest('.delete-pending-btn')) {
                    const key = e.target.closest('.delete-pending-btn').dataset.key;
                    deletePendingDriver(key);
                }
            });
            
            document.getElementById('modal-cancel').addEventListener('click', function() {
                document.getElementById('confirmation-modal').classList.add('hidden');
            });
            
            document.getElementById('modal-confirm').addEventListener('click', function() {
                if (currentDriverKey) {
                    confirmDriver(currentDriverKey);
                }
            });
            
            document.getElementById('price-cancel').addEventListener('click', function() {
                document.getElementById('price-modal').classList.add('hidden');
            });
            
            document.getElementById('price-submit').addEventListener('click', saveOrderPrice);
            
            document.getElementById('search-drivers').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const rows = document.querySelectorAll('#all-drivers tr');
                
                rows.forEach(row => {
                    const name = row.querySelector('td:first-child .text-sm').textContent.toLowerCase();
                    const city = row.querySelector('td:nth-child(4)').textContent.toLowerCase();
                    const phone = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
                    
                    if (name.includes(searchTerm) || city.includes(searchTerm) || phone.includes(searchTerm)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });
            
            document.getElementById('search-history').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const trips = document.querySelectorAll('#history-list > div');
                
                trips.forEach(trip => {
                    const client = trip.querySelector('.font-medium').textContent.toLowerCase();
                    const route = trip.querySelector('.text-gray-600').textContent.toLowerCase();
                    const driver = trip.querySelector('.text-sm').textContent.toLowerCase();
                    
                    if (client.includes(searchTerm) || route.includes(searchTerm) || driver.includes(searchTerm)) {
                        trip.style.display = '';
                    } else {
                        trip.style.display = 'none';
                    }
                });
            });
            
            document.getElementById('history-filter').addEventListener('change', function() {
                const filter = this.value;
                const trips = document.querySelectorAll('#history-list > div');
                
                const now = new Date();
                let startDate;
                
                switch(filter) {
                    case 'today':
                        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                        break;
                    case 'week':
                        startDate = new Date(now);
                        startDate.setDate(now.getDate() - (now.getDay() === 0 ? 6 : now.getDay() - 1));
                        startDate.setHours(0, 0, 0, 0);
                        break;
                    case 'month':
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                        break;
                    default:
                        startDate = null;
                }
                
                trips.forEach(trip => {
                    const dateText = trip.querySelector('.text-xs').textContent;
                    const [day, month, year] = dateText.split('/');
                    const tripDate = new Date(`${year}-${month}-${day}`);
                    
                    if (filter === 'all' || (startDate && tripDate >= startDate)) {
                        trip.style.display = '';
                    } else {
                        trip.style.display = 'none';
                    }
                });
            });
        });
    </script>
</body>
</html>
