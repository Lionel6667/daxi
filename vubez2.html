<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- App icons and PWA manifest -->
    <link rel="apple-touch-icon" sizes="180x180" href="/img20.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/img20.png">
    <link rel="apple-touch-icon" sizes="167x167" href="/img20.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/img20.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/img20.png">
    <link rel="mask-icon" href="/img20.png" color="#ef4444">
    <link rel="shortcut icon" href="/img20.png">
    <!-- Standard favicon for desktop browsers -->
    <link rel="icon" href="/img20.png" />

    <!-- Nom affiché sous l'icône -->
    <meta name="apple-mobile-web-app-title" content="Daxi">
    <meta name="application-name" content="Daxi">

    <!-- Mode application (sans barre Safari) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Lien vers manifest -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#ef4444">
    <title>Daxi - Service de Taxi</title>
    <script src="https://cdn.tailwindcss.com/3.4.16"></script>
    <script>
        // Tailwind is loaded above. No inline configuration is required here.
        // Kept intentionally empty to avoid syntax errors from accidental fragments.
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <!-- PWA Configuration (normalized above) -->
    
    <style>
        :where([class^="ri-"])::before { content: "\f3c2"; }
        
        /* Styles généraux */
        * {
            font-family: 'Poppins', sans-serif;
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Montserrat', sans-serif;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 24px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            border-radius: 34px;
            transition: .4s;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            border-radius: 50%;
            transition: .4s;
        }
        input:checked + .slider {
            background-color: #ef4444;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        /* Modales */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
        }
        
        /* Affichage utilisateur */
        .user-display {
            display: flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.8) 0%, rgba(212, 175, 55, 0.2) 100%);
            border-radius: 8px;
            padding: 6px 12px;
            position: relative;
        }
        .user-id-display {
            background: #f1f5f9;
            padding: 2px 8px;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .user-id-display:hover {
            background: #e2e8f0;
        }
        .id-info-message {
            position: absolute;
            bottom: -40px;
            right: 0;
            background: #1e293b;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            max-width: 250px;
            animation: fadeInOut 5s forwards;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 100;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(10px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(10px); }
        }
        .id-info-icon {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .id-info-icon:hover {
            transform: scale(1.1);
        }
        
        /* Onglets */
        .tab-container {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #e2e8f0;
        }
        .tab {
            flex: 1;
            text-align: center;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .tab.active {
            border-bottom: 3px solid #ef4444;
            color: #ef4444;
            font-weight: 500;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        /* Détails de commande */
        .order-details {
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            margin-top: 10px;
        }
        .order-details p {
            margin: 5px 0;
            font-size: 14px;
        }
        
        /* Éléments de compte */
        .account-item {
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .account-item:hover {
            background-color: #f1f5f9;
            border-color: #cbd5e1;
        }
        .account-item.selected {
            background-color: #eff6ff;
            border-color: #60a5fa;
        }
        
        /* Attractions touristiques */
        .attraction-card {
            height: 300px;
            background-size: cover;
            background-position: center;
            position: relative;
            overflow: hidden;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        .attraction-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8), rgba(0,0,0,0.4));
            padding: 20px;
            color: white;
        }
        .attraction-detail {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 2000;
            padding: 20px;
            overflow-y: auto;
        }
        
        /* Cartes de service */
        .service-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
            min-height: 320px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            overflow-y: auto;
        }
        .service-icon {
            font-size: 48px;
            margin-bottom: 8px;
            color: #4CAF50;
        }
        
        /* Informations chauffeur */
        .driver-info {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 15px;
        }
        .driver-photo {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #D4AF37;
        }
        .driver-details {
            flex: 1;
        }
        .driver-name {
            font-weight: 600;
            color: #1e293b;
        }
        
        /* Conteneurs d'image de fond */
        .background-image-container {
            position: relative;
            background-size: cover;
            background-position: center;
        }
        .background-image-container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
        }
        
        /* Gestion des mots de passe */
        .password-container {
            position: relative;
        }
        .toggle-password {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #666;
            font-size: 18px;
        }
        .password-error {
            color: #ef4444;
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }
        
        /* Évaluation chauffeur */
        .driver-rating {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 4px;
            opacity: 1;
            transform: translateY(0);
            transition: all 0.6s ease;
        }
        .driver-rating i {
            font-size: 14px;
            color: #f59e0b;
        }
        .view-reviews-btn {
            color: #3b82f6;
            font-size: 12px;
            cursor: pointer;
            text-decoration: underline;
            margin-top: 4px;
        }
        
        /* Modale d'avis */
        .reviews-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        .reviews-content {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .review-item {
            padding: 10px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        
        /* Évaluation */
        .rating-input {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }
        .rating-input i {
            cursor: pointer;
            font-size: 20px;
            color: #d1d5db;
        }
        .rating-input i.active {
            color: #f59e0b;
        }
        
        /* Indicateurs de statut */
        .status-indicator {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            margin-top: 8px;
            display: inline-block;
        }
        .status-pending {
            background-color: #fef9c3;
            color: #854d0e;
        }
        .status-here {
            background-color: #dcfce7;
            color: #166534;
        }
        .status-finished {
            background-color: #dbeafe;
            color: #1e40af;
        }
        .status-accepted {
            background-color: #d1fae5;
            color: #065f46;
        }
        .status-transferring {
            background-color: #dbeafe;
            color: #1e40af;
        }
        .status-onway {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        /* Boutons doubles */
        .double-button-container {
            display: flex;
            gap: 12px;
            margin-top: 15px;
        }
        .double-button-container button {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        /* Formulaire d'évaluation */
        .rating-form {
            background-color: #f8fafc;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        /* Boutons de navigation */
        .back-to-main-btn, .visit-btn {
            cursor: pointer;
        }
        
        /* Affichage du temps */
        .time-display {
            font-size: 12px;
            color: #64748b;
            margin-top: 4px;
        }
        
        /* Historique d'évaluation */
        .history-rating {
            display: flex;
            gap: 2px;
            margin-top: 8px;
        }
        .history-rating i {
            font-size: 16px;
            color: #d1d5db;
            cursor: pointer;
        }
        .history-rating i.active {
            color: #f59e0b;
        }
        
        /* Actions d'avis */
        .review-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .review-actions button {
            flex: 1;
            padding: 8px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .review-edit-btn {
            background-color: #f0f9ff;
            color: #0ea5e9;
            border: 1px solid #bae6fd;
        }
        .review-edit-btn:hover {
            background-color: #e0f2fe;
        }
        .review-delete-btn {
            background-color: #fef2f2;
            color: #ef4444;
            border: 1px solid #fecaca;
        }
        .review-delete-btn:hover {
            background-color: #fee2e2;
        }
        
        /* Bouton WhatsApp */
        .whatsapp-icon {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background-color: #25D366;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        .whatsapp-icon:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        .whatsapp-icon i {
            color: white;
            font-size: 32px;
        }
        
        /* Modale d'application */
        .app-modal-content {
            background-color: white;
            padding: 25px;
            border-radius: 15px;
            width: 90%;
            max-width: 450px;
            text-align: center;
            position: relative;
        }
        .app-modal-icon {
            font-size: 64px;
            color: #ef4444;
            margin-bottom: 15px;
        }
        .app-modal-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }
        .app-modal-buttons button {
            flex: 1;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .close-app-modal {
            background-color: #f1f5f9;
            color: #334155;
        }
        .close-app-modal:hover {
            background-color: #e2e8f0;
        }
        .download-app-btn {
            background-color: #ef4444;
            color: white;
        }
        .download-app-btn:hover {
            background-color: #dc2626;
        }
        
        /* Section APK */
        .apk-section {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            margin-top: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }
        .apk-section h3 {
            color: white;
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .apk-section p {
            color: rgba(255,255,255,0.9);
            margin-bottom: 15px;
            font-size: 0.9rem;
        }
        .download-apk-btn {
            background-color: white;
            color: #ef4444;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .download-apk-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        /* Sélecteur de langue */
        .language-selector {
            position: relative;
            margin-right: 10px;
        }
        .language-select {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 5px 10px;
            padding-right: 30px;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        .language-select:focus {
            outline: none;
            border-color: #ef4444;
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2);
        }
        .language-selector::after {
            content: "▼";
            font-size: 10px;
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
        }
        .language-select:hover {
            background-color: #e2e8f0;
            transform: scale(1.05);
        }
        .language-select:focus {
            animation: pulse 0.5s;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* Type de trajet */
        .trip-type-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .trip-type-option {
            flex: 1;
            text-align: center;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background-color: transparent;
        }
        .trip-type-option:hover {
            background-color: rgba(76, 175, 80, 0.1);
        }
        .trip-type-option.active {
            border-color: #4CAF50;
            background-color: rgba(76, 175, 80, 0.2);
        }
        
        /* Pied de page */
        footer {
            background-color: #1a202c;
            color: white;
            padding: 30px 0;
            margin-top: 30px;
        }
        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .footer-logo {
            width: 150px;
            margin-bottom: 20px;
        }
        .footer-contact {
            text-align: center;
            margin-bottom: 20px;
        }
        .footer-contact p {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .footer-bottom {
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            width: 100%;
        }
        .apk-footer {
            margin-top: 12px;
        }
        .social-icons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
        }
        .social-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #2d3748;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        .social-icon:hover {
            transform: translateY(-3px);
            background: #ef4444;
        }
        .social-icon i {
            font-size: 20px;
            color: white;
        }
        
        /* Suggestions d'adresses */
        .suggestions-container {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background: white;
            border: 1px solid #e2e8f0;
            border-top: none;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
        }
        .suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
        }
        .suggestion-item:hover {
            background-color: #f8fafc;
        }

        /* MODIFICATIONS DEMANDEES */
        
        /* 1. Logo agrandi */
        .navbar-logo {
            height: 60px !important;
        }

        /* 2. Navbar: use a light gray (same feel as the tab bar) */
        nav {
            background: #1a202c !important; /* Tailwind gray-100 */
            color: #111;
            border-bottom: 1px solid rgba(0,0,0,0.04);
        }

        /* 3. Boutons avec dégradé or */
        .gold-button {
            background: linear-gradient(135deg, #D4AF37 0%, #FFD700 100%);
            color: #000 !important;
            border: none;
            font-weight: 600;
        }
        .gold-button:hover {
            background: linear-gradient(135deg, #C19C30 0%, #E6C200 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        /* 4. Espace entre navbar et section commander un taxi */
        main {
            padding-top: 100px !important;
        }
        
        /* Boutons de temps */
        .time-selection-btn {
            flex: 1;
            text-align: center;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            background-color: transparent;
            color: black;
        }
        .time-selection-btn:hover {
            background-color: rgba(76, 175, 80, 0.1);
        }
        .time-selection-btn.active {
            border-color: #4CAF50;
            background-color: rgba(76, 175, 80, 0.2);
            color: black;
        }

        /* Sélecteur de pays téléphone */
        .phone-input-container {
            display: flex;
            gap: 10px;
        }
        .country-select-container {
            position: relative;
            width: 30%;
        }
        .country-select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-color: white;
        }
        .country-select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        .country-select-container::after {
            content: "▼";
            font-size: 10px;
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
        }
        .phone-input {
            flex: 1;
            width: 70%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
        }
        .phone-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        /* Modale de vérification email */
        .email-verification-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        .email-verification-content {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 450px;
            text-align: center;
        }
        .verification-icon {
            font-size: 64px;
            color: #3498db;
            margin-bottom: 20px;
        }
        .verification-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 18px;
            text-align: center;
            letter-spacing: 8px;
            margin-bottom: 20px;
            box-sizing: border-box;
        }
        .verification-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        .resend-otp {
            color: #3498db;
            cursor: pointer;
            margin-top: 15px;
            display: inline-block;
        }
        .resend-otp:hover {
            text-decoration: underline;
        }
        
        /* Bannière d'installation iOS */
        #installBanner {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #111;
            color: #fff;
            padding: 15px;
            text-align: center;
            font-size: 16px;
            z-index: 9999;
        }
        #installBanner button {
            margin-top: 8px;
            padding: 10px 20px;
            background: #0a84ff;
            color: #fff;
            border: none;
            border-radius: 8px;
        }

        /* Formulaire responsive */
        @media (max-width: 640px) {
            .modal-content {
                width: 95%;
                margin: 10px;
                padding: 15px;
                max-height: 90vh;
                overflow-y: auto;
            }
            .tab-container {
                flex-direction: column;
            }
            .tab {
                margin-bottom: 5px;
            }
            .input-group {
                margin-bottom: 15px;
            }
            input[type="text"], 
            input[type="email"], 
            input[type="password"], 
            input[type="number"] {
                padding: 10px;
            }
        }

        /* MODAL POUR iOS - NOUVEAU */
        .ios-instruction-step {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8fafc;
            border-radius: 8px;
        }
        .ios-instruction-step i {
            font-size: 24px;
            margin-right: 15px;
            color: #ef4444;
            min-width: 30px;
            text-align: center;
        }
        .ios-instruction-step span {
            flex: 1;
        }
        #iosInstallModal .modal-content {
            max-width: 500px;
        }
        #iosInstallBtn {
            display: none;
        }

        /* NOUVEAUX STYLES POUR LES MODIFICATIONS DEMANDÉES */

        /* 1. Palette de couleurs "Futuriste Tropical" */
        :root {
            --tropical-turquoise: #00CED1;
            --tropical-coral: #FF7F50;
            --tropical-lime: #32CD32;
            --tropical-sunset: #FF6347;
            --tropical-ocean: #1E90FF;
            --tropical-mint: #98FB98;
            --tropical-gold: #FFD700;
        }

        /* 2. Style Glassmorphism */
        .glass-card {
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(14px);
            -webkit-backdrop-filter: blur(14px);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.5);
        }

        /* 3. Animations et micro-interactions */
        .btn-glow {
            transition: all 0.3s ease;
        }

        .btn-glow:hover {
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.7);
            transform: scale(1.05);
        }

        /* 4. Effet Parallaxe */
        .parallax-section {
            background-attachment: fixed;
            background-position: center;
            background-repeat: no-repeat;
            background-size: cover;
            position: relative;
        }

        .parallax-content {
            position: relative;
            z-index: 2;
            padding: 60px 20px;
        }

        .parallax-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1;
        }

        /* Responsive modal adjustments for login */
        .modal .modal-content.responsive {
            width: calc(100% - 32px);
            max-width: 480px;
            padding: 18px;
        }
        @media (max-width: 480px) {
            .modal .modal-content.responsive { width: calc(100% - 20px); padding: 14px; }
            .modal .modal-content.responsive .form-row { display: block; }
            .modal .modal-content.responsive input, .modal .modal-content.responsive button { width: 100%; }
            #loginBtn { padding-left: 14px; padding-right: 14px; }
        }

        /* 5. Section des plans de services */
        .plans-section {
            padding: 40px 0;
            overflow: hidden;
        }

        .plans-container {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            gap: 20px;
            padding: 20px 0;
            scroll-behavior: smooth;
            scroll-padding: 0 50%;
        }

        .plans-container::-webkit-scrollbar {
            display: none;
        }

        .plan-card {
            flex: 0 0 auto;
            width: 300px;
            scroll-snap-align: center;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            height: 500px;
        }

        .plan-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }

        .plan-header {
            background: linear-gradient(135deg, var(--tropical-turquoise), var(--tropical-ocean));
            color: white;
            padding: 20px;
            text-align: center;
        }

        .plan-content {
            padding: 20px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .plan-features {
            flex-grow: 1;
            margin-bottom: 20px;
        }

        .plan-feature {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .plan-feature i {
            margin-right: 10px;
            color: var(--tropical-lime);
        }

        .plan-actions {
            display: flex;
            gap: 10px;
        }

        .plan-actions button {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        /* 6. Carte interactive pour "Dekouvri Ayiti" */
        .interactive-map {
            position: relative;
            width: 100%;
            height: 500px;
            background-image: url('img13.webp.jpg');
            background-size: cover;
            background-position: center;
            border-radius: 12px;
            overflow: hidden;
            margin: 20px 0;
        }

        .map-point {
            position: absolute;
            width: 20px;
            height: 20px;
            background: var(--tropical-coral);
            border-radius: 50%;
            cursor: pointer;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 0 0 rgba(255, 127, 80, 0.7);
            animation: pulse 2s infinite;
        }

        .map-point:hover {
            animation: none;
            transform: translate(-50%, -50%) scale(1.2);
        }

        .map-tooltip {
            position: absolute;
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            width: 200px;
            z-index: 10;
            opacity: 0;
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .map-point:hover .map-tooltip {
            opacity: 1;
            transform: translateY(-10px);
        }

        /* 7. Animations de scroll */
        .fade-in {
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.6s ease;
        }

        .fade-in.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* 8. Transitions de page */
        .page-transition {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* 9. Illustrations minimalistes pour services */
        .service-illustration {
            font-size: 48px;
            margin-bottom: 15px;
            display: inline-block;
            position: relative;
            text-align: center;
            width: 100%;
        }

        .wifi-waves {
            position: relative;
            width: 60px;
            height: 40px;
            margin: 0 auto;
        }

        .wifi-wave {
            position: absolute;
            border: 2px solid var(--tropical-turquoise);
            border-radius: 50%;
            animation: wifiPulse 2s infinite;
        }

        .wifi-wave:nth-child(1) {
            width: 20px;
            height: 20px;
            top: 10px;
            left: 20px;
            animation-delay: 0s;
        }

        .wifi-wave:nth-child(2) {
            width: 30px;
            height: 30px;
            top: 5px;
            left: 15px;
            animation-delay: 0.3s;
        }

        .wifi-wave:nth-child(3) {
            width: 40px;
            height: 40px;
            top: 0;
            left: 10px;
            animation-delay: 0.6s;
        }

        @keyframes wifiPulse {
            0% { opacity: 1; transform: scale(0.8); }
            100% { opacity: 0; transform: scale(1.2); }
        }

        .water-drops {
            position: relative;
            width: 60px;
            height: 40px;
            margin: 0 auto;
        }

        .water-drop {
            position: absolute;
            width: 8px;
            height: 8px;
            background: var(--tropical-ocean);
            border-radius: 50%;
            animation: waterDrop 2s infinite;
        }

        .water-drop:nth-child(1) {
            top: 5px;
            left: 20px;
            animation-delay: 0s;
        }

        .water-drop:nth-child(2) {
            top: 15px;
            left: 30px;
            animation-delay: 0.5s;
        }

        .water-drop:nth-child(3) {
            top: 25px;
            left: 15px;
            animation-delay: 1s;
        }

        @keyframes waterDrop {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(20px); opacity: 0; }
        }

        /* 10. Section des chauffeurs premium */
        .premium-driver {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .premium-driver::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, var(--tropical-gold), var(--tropical-coral));
        }

        .premium-driver:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .driver-stars {
            display: flex;
            align-items: center;
            margin-top: 10px;
            opacity: 1;
            transform: translateY(0);
            transition: all 0.5s ease;
        }

        .premium-driver:hover .driver-stars {
            opacity: 1;
            transform: translateY(0);
        }

        /* 11. Style pour la nouvelle section de services (plans) */
        .services-plans-section {
            padding: 60px 0;
            background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
        }

        .plan-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 3000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .plan-modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
            position: relative;
        }

        .close-plan-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .plan-details {
            margin-bottom: 30px;
        }

        .plan-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
        }

        /* CORRECTIONS POUR L'AFFICHAGE DU CONTENU */
        
        /* Assurer que tout le contenu est visible */
        body {
            opacity: 1 !important;
            visibility: visible !important;
            display: block !important;
        }
        
        main {
            opacity: 1 !important;
            visibility: visible !important;
            position: relative;
            z-index: 1;
            display: block !important;
        }
        
        /* Section de commande avec fond */
        #bookingSection {
            position: relative;
            z-index: 10;
        }
        
        /* Fond pour la section de commande */
        .booking-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('img13.webp.jpg');
            background-size: cover;
            background-position: center;
            filter: blur(20px);
            opacity: 0.2;
            z-index: -1;
            border-radius: 12px;
        }
        
        /* Correction pour les cartes de service */
        .services-section .service-card {
            min-height: 320px;
            height: auto;
        }
        
        /* Animation pour les étoiles des chauffeurs */
        .driver-rating-animation {
            opacity: 1;
            transform: translateY(0);
            transition: all 0.6s ease;
        }
        
        .driver-rating-animation.visible {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* Styles pour la demande de permission de notification */
        .notification-permission-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }
        
        .notification-permission-content {
            background-color: white;
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 450px;
            text-align: center;
        }
        
        /* Correction pour l'affichage des cartes de service */
        .services-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .service-card {
            min-height: 320px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        /* CORRECTIONS SPÉCIFIQUES POUR LES PROBLÈMES MENTIONNÉS */
        
        /* 1. Cartes de service plus longues avec défilement */
        .service-card {
            min-height: 450px;
            overflow-y: auto;
        }
        
        /* 2. Animation de défilement automatique des cartes de service - MODIFIÉE */
        .plans-container {
            animation: none; /* Supprimé l'animation automatique */
            scroll-behavior: auto;
            padding-left: 0;
            width: 100%;
        }
        
        .plans-container.paused {
            animation-play-state: paused;
        }
        
        /* 3. Réduire le flou de l'image dans le formulaire */
        .booking-background {
            filter: blur(1px);
            opacity: 0.5;
        }
        
        /* 4. Supprimer l'image du bas de la partie service */
        .services-section {
            background-image: none !important;
        }
        
        /* 5. Supprimer les points orange */
        .services-section .dots-indicator {
            display: none !important;
        }
        
        /* 6. Animation des cartes Découvrir Haïti */
        .attraction-card {
            transition: all 0.5s ease;
        }
        .attraction-card:hover {
            transform: scale(1.05);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 10px 10px -5px rgba(0, 0, 0, 0.1) !important;
        }
        
        /* 7. Rendre les cartes Découvrir Haïti moins sombres */
        .attraction-overlay {
            background: linear-gradient(to top, rgba(0,0,0,0.4), transparent);
        }
        
        /* 8. Rendre les boutons Découvrir Haïti fonctionnels */
        .learn-more-btn {
            cursor: pointer;
        }
        
        /* Animation pour les cartes des lieux historiques */
        .attraction-card {
            opacity: 0;
            transform: translateY(30px);
            transition: all 0.8s ease;
        }
        
        .attraction-card.visible {
            opacity: 1;
            transform: translateY(0);
        }
        
        .attraction-card h3, .attraction-card p, .attraction-card button {
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.6s ease 0.2s;
        }
        
        .attraction-card.visible h3, 
        .attraction-card.visible p, 
        .attraction-card.visible button {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* CORRECTIONS POUR L'ANIMATION DES CARTES DE SERVICE */
        .plans-section {
            position: relative;
            overflow: hidden;
            width: 100%;
        }
        
        .plans-container-wrapper {
            position: relative;
            overflow: hidden;
            width: 100%;
        }
        
        .plan-card {
            flex: 0 0 auto;
            width: 300px;
            margin-right: 20px;
            height: 550px;
            overflow-y: auto;
        }
        
        .plans-container:hover {
            animation-play-state: running;
        }

        /* CORRECTIONS SPÉCIFIQUES POUR LES DEMANDES */
        
        /* 1. Animation des cartes de service - arrêt automatique */
        .plans-container {
            animation-play-state: running;
        }
        
        /* 2. Cacher le bouton Commander dans les cartes preview */
        .plan-actions .order-plan {
            display: none !important;
        }
        
        /* 3. Enlever les prix des boutons Commander dans les modales */
        .plan-modal-content .gold-button:not(.close-plan-modal) {
            position: relative;
        }
        
        .plan-modal-content .gold-button:not(.close-plan-modal)::after {
            content: "Commander";
        }
        
        .plan-modal-content .gold-button:not(.close-plan-modal) span {
            display: none;
        }
        
        /* 4. Ajustement de l'espacement dans les cartes de service à bord */
        .service-card {
            padding: 15px;
            gap: 10px;
        }
        
        .service-icon {
            margin-bottom: 10px;
        }
        
        /* 5. Animation des étoiles des chauffeurs */
        .driver-stars {
            opacity: 1;
            transform: translateY(0);
            transition: all 0.6s ease;
            animation: fadeInStars 1s ease-in-out forwards;
        }
        
        @keyframes fadeInStars {
            0% { opacity: 0; transform: translateY(10px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        
        .driver-stars.animated {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* 6. Style moderne pour le bouton télécharger */
        .modern-download-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .modern-download-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: all 0.6s ease;
        }
        
        .modern-download-btn:hover::before {
            left: 100%;
        }
        
        .modern-download-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.4);
        }
        
        /* 7. Correction du défilement infini des cartes */
        .plans-container {
            padding-left: 0;
        }
        
        .plans-container::before,
        .plans-container::after {
            content: '';
            flex: 0 0 20px;
        }
        
        /* 8. Ajustement de l'affichage initial des cartes */
        .plans-section {
            display: flex;
            justify-content: center;
        }
        
        .plans-container-wrapper {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }

        /* 9. Images pour les cartes de plans */
        .plan-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
            margin-bottom: 15px;
            border-radius: 8px;
        }
        
        /* 10. Texte court pour les cartes preview */
        .plan-preview-text {
            font-size: 14px;
            line-height: 1.4;
            color: #666;
            margin-bottom: 15px;
            display: -webkit-box;
            /* standard property for compatibility */
            line-clamp: 3;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* 11. Supprimer le scroll des cartes */
        .plan-card {
            overflow-y: visible;
            height: auto;
            min-height: 450px;
        }
        
        /* 12. Espacement réduit dans les cartes de service à bord */
        .services-section .service-card {
            padding: 15px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            gap: 8px;
        }
        
        .services-section .service-icon {
            margin-bottom: 8px;
        }
        
        .services-section .service-card h3 {
            margin-bottom: 8px;
            font-size: 1.25rem;
        }
        
        .services-section .service-card p {
            margin-bottom: 0;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        /* 13. Correction pour l'affichage des étoiles des chauffeurs */
        .driver-stars {
            opacity: 1 !important;
            transform: translateY(0) !important;
        }
        
        /* 14. Masquage des sections vides */
        .section-empty {
            display: none !important;
        }

        /* NOUVEAUX STYLES POUR LES FLÈCHES ET L'ANIMATION DES CARTES */
        
        /* Section des services avec flèches */
        .services-plans-section {
            position: relative;
            padding: 40px 0;
        }
        
        .plans-container-wrapper {
            position: relative;
            overflow: hidden;
            width: 100%;
        }
        
        .plans-container {
            display: flex;
            overflow-x: auto;
            scroll-behavior: smooth;
            scroll-snap-type: x mandatory;
            -ms-overflow-style: none;
            scrollbar-width: none;
            gap: 20px;
            padding: 20px 0;
        }
        
        .plans-container::-webkit-scrollbar {
            display: none;
        }
        
        .plan-card {
            flex: 0 0 auto;
            width: 300px;
            scroll-snap-align: start;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            height: 500px;
            opacity: 0.7;
            filter: blur(1px);
            transform: scale(0.95);
        }
        
        .plan-card.active {
            opacity: 1;
            filter: blur(0);
            transform: scale(1);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            border: 2px solid #FFD700;
        }
        
        /* Flèches de navigation */
        .nav-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.9);
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            font-size: 24px;
            color: #333;
        }
        
        .nav-arrow:hover {
            background: white;
            transform: translateY(-50%) scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        
        .nav-arrow.left {
            left: 10px;
        }
        
        .nav-arrow.right {
            right: 10px;
        }
        
        /* Indicateurs de position */
        .dots-indicator {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ddd;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .dot.active {
            background: #FFD700;
            transform: scale(1.2);
        }

        /* Smooth auto-scroll for plans container */
        .plans-container {
            scroll-behavior: smooth;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .plan-card {
            transition: opacity 300ms ease, transform 300ms ease;
        }
        .plan-card:not(.active) {
            opacity: 0.6;
            transform: scale(0.98);
        }
        
        /* CORRECTIONS IMPORTANTES POUR L'AFFICHAGE */
        /* S'assurer que tout le contenu est visible */
        .content-section {
            display: block !important;
            opacity: 1 !important;
            visibility: visible !important;
        }
        
        /* Réinitialiser les styles qui pourraient cacher le contenu */
        section {
            display: block !important;
        }
        
        /* S'assurer que le body s'affiche correctement */
        body {
            display: block !important;
            overflow-x: hidden;
        }
        
        main {
            display: block !important;
            min-height: 100vh;
        }

        /* CORRECTIONS CRITIQUES POUR L'AFFICHAGE */
        /* Rendre tout le contenu visible */
        body, main, section, div {
            visibility: visible !important;
            opacity: 1 !important;
        }

        /* S'assurer que les sections principales sont affichées */
        #bookingSection,
        #servicePlansSection,
        .services-section,
        .attraction-card {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        /* Correction spécifique pour les cartes Découvrir Haïti */
        .attraction-card .attraction-overlay {
            display: flex !important;
            flex-direction: column;
            justify-content: flex-end;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .attraction-card h3,
        .attraction-card p,
        .attraction-card button {
            visibility: visible !important;
            opacity: 1 !important;
            display: block !important;
        }
        .attraction-card button {
  width: 50%;
  position: relative;
  top: -10px;      /* monte le bouton */
  
}


        /* MODIFICATIONS SPÉCIFIQUES POUR LES DEMANDES */
        
        /* 1. Historique de voyage - affichage quand vide */
        #tripHistorySection.empty {
            display: block !important;
        }
        
        #tripHistoryContainer.empty-message {
            padding: 20px;
            text-align: center;
            color: #666;
        }
        
        /* 2. Commandes en attente - affichage quand vide */
        #all-pending-requests.empty {
            display: block !important;
        }

        /* By default hide the "Commandes en attente" heading until the DB
           confirms there are pending orders. JS will toggle the
           `show-heading` class on #all-pending-requests to reveal it. */
        #all-pending-requests h3 {
            display: none;
        }

        #all-pending-requests.show-heading h3 {
            display: block !important;
        }
        
        #pendingRequestsContainer.empty-message {
            padding: 20px;
            text-align: center;
            color: #666;
        }
        
        /* 3. Animation Wi-Fi améliorée */
        .wifi-icon-animated {
            animation: wifiPulse 2s infinite;
        }
        
        /* 4. Correction du bouton annuler */
        #cancelOrderBtn, .cancel-order-btn {
            cursor: pointer;
        }

        /* Navbar gradient and compact user display */
        .nav-gradient {
            background: linear-gradient(90deg, #f8fafc 0%, #f1f5f9 50%, #eef2ff 100%);
            color: #0f172a;
            border-bottom: 1px solid rgba(15,23,42,0.05);
            backdrop-filter: blur(6px);
        }
        .nav-gradient .navbar-logo { filter: drop-shadow(0 2px 6px rgba(0,0,0,0.06)); height: 44px; }
        .user-display .user-id-display, .user-display .id-info-message, #loginBtn { display: inline-flex; }
        /* new user name gradient area */
        .user-display { background: linear-gradient(90deg,#ffffff 0%, #f8fafc 100%); padding:6px 10px; border-radius:10px; }
        .user-display .user-id-display { display: none !important; }

        /* Frequent routes minimal styles */
        #frequentRoutesSection { margin-top: 12px; }
        .frequent-route-card { background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.75)); border-radius: 12px; padding: 12px; display:flex; gap:12px; align-items:center; box-shadow: 0 6px 18px rgba(16,24,40,0.06); }
        .frequent-route-svg { width: 160px; height: 64px; flex: 0 0 160px; }
        .route-meta { flex: 1 1 auto; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col page-transition">
    <!-- Notification permission banner (hidden by default) -->
    <div id="notifyBanner" style="display:none;position:fixed;top:70px;right:16px;z-index:1200;max-width:320px;">
        <div class="glass-card p-3" style="display:flex;align-items:center;gap:10px;">
            <div style="flex:1">
                <div style="font-weight:600" data-translate="notify_title">Autoriser les notifications</div>
                <div style="font-size:13px;color:#475569" data-translate="notify_desc">Recevez des alertes lorsque votre course est acceptée.</div>
            </div>
            <div style="display:flex;flex-direction:column;gap:6px;">
                <button id="allowNotifyBtn" class="gold-button px-3 py-1 text-sm" data-translate="notify_allow">Autoriser</button>
                <button id="laterNotifyBtn" class="px-3 py-1 text-sm bg-gray-100 rounded">Plus tard</button>
            </div>
        </div>
    </div>
    <!-- Navigation Bar - Modifiée -->
    <nav class="fixed top-0 w-full shadow-sm z-50 nav-gradient">
        <div class="flex items-center justify-between px-4 py-3">
            <div class="flex items-center">
                <!-- Logo agrandi -->
                <img src="img20.png" alt="Daxi Logo" class="navbar-logo">
            </div>
            <div id="userSection" class="flex items-center">
                <!-- Sélecteur de langue avec drapeaux (emojis) -->
                <div class="language-selector">
                    <select id="languageSelect" class="language-select">
                        <option value="ht">🇭🇹 HT</option>
                        <option value="fr">🇫🇷 FR</option>
                        <option value="en">🇬🇧 EN</option>
                        <option value="es">🇪🇸 ES</option>
                    </select>
                </div>
                <div id="loginSection" class="flex gap-2">
                    <!-- Bouton avec nouveau style or -->
                    <button id="loginBtn" class="gold-button px-4 py-2 !rounded-button text-sm font-medium cursor-pointer btn-glow" data-translate="login">
                        Connexion
                    </button>
                </div>
                <div id="userDisplay" class="hidden user-display">
                    <i class="ri-user-line"></i>
                    <span id="userName">Nom</span>
                    <button id="logoutBtn" class="ml-2 bg-white/80 hover:bg-white text-gray-800 px-3 py-1 rounded-button text-sm transition-colors">
                        <i class="ri-logout-box-r-line"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="pt-16 pb-6 px-4 flex-grow">
        <!-- Booking Form Section -->
        <section class="mb-8" id="bookingSection" data-aos="fade-up">
            <div class="glass-card relative overflow-hidden">
                <!-- Fond ajouté pour la section de commande -->
                <div class="booking-background"></div>
                <div class="relative z-10">
                    <h2 class="text-xl font-semibold text-gray-800 mb-6" data-translate="order_taxi">Commander votre taxi</h2>
                    
                    <!-- Destination Input -->
                    <div class="mb-4">
                        <div class="flex items-center mb-2">
                            <label class="flex items-center cursor-pointer mr-4">
                                <span class="text-sm text-gray-700 mr-2" data-translate="different_address">Indiquer une adresse de départ différente</span>
                                <label class="switch">
                                    <input type="checkbox" id="destinationSwitch">
                                    <span class="slider"></span>
                                </label>
                            </label>
                        </div>
                        <p class="text-xs text-gray-500 mb-2" data-translate="address_explanation">Si vous ne souhaitez pas être pris en charge à votre position actuelle, activez ce switch pour indiquer un autre lieu de départ.</p>
                        <div id="destinationField" class="hidden" style="position: relative;">
      
      <!-- Icône -->
      <i class="ri-map-pin-line text-primary"
         style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); font-size: 18px; pointer-events: none;">
      </i>

      <!-- Input -->
      <input 
        type="text" 
        id="destinationAddress" 
        placeholder="Adresse de départ" 
        data-translate="departure_placeholder"
        style="width: 100%; padding: 12px 16px 12px 42px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; outline: none;"
      >

      <div id="destinationAddressSuggestions" class="suggestions-container hidden"></div>
    </div>
                    </div>

                    <!-- Destination Field (Always visible) -->
                    <div class="mb-4" style="position: relative;">
      
      <!-- Icône -->
      <i class="ri-flag-line text-primary" 
         style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); font-size: 18px; pointer-events: none;">
      </i>

      <!-- Input -->
      <input 
        type="text" 
        id="destinationAddressArrival" 
        placeholder="Adresse de destination" 
        required 
        data-translate="destination_placeholder"
        style="width: 100%; padding: 12px 16px 12px 42px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; outline: none;"
      >

      <div id="destinationAddressArrivalSuggestions" class="suggestions-container hidden"></div>
    </div>

                    <!-- Type de trajet -->
                    <div class="trip-type-container mb-4">
                        <div class="trip-type-option active" id="oneWayBtn" data-trip-type="aller simple">
                            <i class="ri-arrow-right-line"></i>
                            <span data-translate="one_way">Allez simple</span>
                        </div>
                        <div class="trip-type-option" id="roundTripBtn" data-trip-type="aller-retour">
                            <i class="ri-arrow-left-right-line"></i>
                            <span data-translate="round_trip">Allez retour</span>
                        </div>
                    </div>

                    <!-- Description -->
                    <div class="mb-4">
                        <textarea id="bookingDescription" placeholder="Description pour aider le chauffeur à vous repérer" rows="3" class="w-full p-4 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent resize-none" data-translate="description_placeholder"></textarea>
                    </div>

                    <!-- Time and Date -->
                    <div id="dateTimeSection" class="hidden grid grid-cols-2 gap-4 mb-4">
                        <div class="relative">
                            <div class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 flex items-center justify-center">
                                <i class="ri-time-line text-gray-400"></i>
                            </div>
                            <input type="time" id="bookingTime" class="w-full pl-12 pr-4 py-3 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        <div class="relative">
                            <div class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 flex items-center justify-center">
                                <i class="ri-calendar-line text-gray-400"></i>
                            </div>
                            <input type="date" id="bookingDate" class="w-full pl-12 pr-4 py-3 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                    </div>

                    <!-- Time Selection Buttons -->
                    <div class="flex gap-4 mb-6">
                        <div class="time-selection-btn active" id="nowBtn" data-translate="now">
                            Maintenant
                        </div>
                        <div class="time-selection-btn" id="laterBtn" data-translate="later">
                            Plus tard
                        </div>
                    </div>
                    
                    <!-- Main CTA Button - Nouveau style or -->
                    <button id="orderTaxiBtn" class="w-full gold-button py-4 !rounded-button font-semibold text-lg shadow-lg cursor-pointer btn-glow" data-translate="order_taxi_btn">
                        Commander un Taxi
                    </button>
                </div>
            </div>
        </section>

        <!-- SECTION DES PLANS DE SERVICES AJOUTÉE ICI -->
        <section class="mb-8 plans-section" id="servicePlansSection" data-aos="fade-up">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center" data-translate="service_plans">Nos Plans de Services</h2>
            
            <div class="plans-container-wrapper">
                <!-- Flèches de navigation -->
                <button class="nav-arrow left">
                    <i class="ri-arrow-left-s-line"></i>
                </button>
                
                <div class="plans-container">
                    <!-- Carte 1 - Course Ville à Ville -->
                    <div class="plan-card active">
                        <div class="plan-header">
                            <h3 class="text-xl font-bold" data-translate="plan1_title">Course Ville à Ville</h3>
                            <p class="text-sm opacity-90" data-translate="plan1_sub">Prix à déterminer</p>
                        </div>
                        <div class="plan-content">
                            <img src="img87.jpg" alt="Course Ville à Ville" class="plan-image">
                            <div class="plan-preview-text" data-translate="plan1_preview">
                                Déplacez-vous en toute sérénité entre les villes avec notre service de transport confortable et sécurisé.
                            </div>
                            <div class="plan-actions">
                                <button class="learn-more-btn gold-button btn-glow" data-plan="1" data-translate="learn_more">
                                    En savoir plus
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Carte 2 - Demi-Journée -->
                    <div class="plan-card">
                        <div class="plan-header">
                            <h3 class="text-xl font-bold" data-translate="plan2_title">Demi-Journée</h3>
                            <p class="text-sm opacity-90" data-translate="plan2_sub">4 heures - Prix fixe</p>
                        </div>
                        <div class="plan-content">
                            <img src="img97.jpg" alt="Demi-Journée" class="plan-image">
                            <div class="plan-preview-text" data-translate="plan2_preview">
                                Idéal pour vos courses, rendez-vous et visites. Votre chauffeur privé disponible pendant 4 heures.
                            </div>
                            <div class="plan-actions">
                                <button class="learn-more-btn gold-button btn-glow" data-plan="2" data-translate="learn_more">
                                    En savoir plus
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Carte 3 - Journée Complète -->
                    <div class="plan-card">
                        <div class="plan-header">
                            <h3 class="text-xl font-bold" data-translate="plan3_title">Journée Complète</h3>
                            <p class="text-sm opacity-90" data-translate="plan3_sub">8 heures - Prix fixe</p>
                        </div>
                        <div class="plan-content">
                            <img src="img47.jpg" alt="Journée Complète" class="plan-image">
                            <div class="plan-preview-text" data-translate="plan3_preview">
                                Service complet pour vos journées chargées. Profitez d'un chauffeur dédié pendant 8 heures.
                            </div>
                            <div class="plan-actions">
                                <button class="learn-more-btn gold-button btn-glow" data-plan="3" data-translate="learn_more">
                                    En savoir plus
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Carte 4 - Élégance Night -->
                    <div class="plan-card">
                        <div class="plan-header">
                            <h3 class="text-xl font-bold" data-translate="plan4_title">Élégance Night</h3>
                            <p class="text-sm opacity-90" data-translate="plan4_sub">Jusqu'à 3h - Uniquement sur réservation</p>
                        </div>
                        <div class="plan-content">
                            <img src="img77.jfif" alt="Élégance Night" class="plan-image">
                            <div class="plan-preview-text" data-translate="plan4_preview">
                                Pour vos soirées spéciales. Service premium avec véhicule haut de gamme pour vos sorties nocturnes.
                            </div>
                            <div class="plan-actions">
                                <button class="learn-more-btn gold-button btn-glow" data-plan="4" data-translate="learn_more">
                                    En savoir plus
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Carte 5 - Business / VIP -->
                    <div class="plan-card">
                        <div class="plan-header">
                            <h3 class="text-xl font-bold" data-translate="plan5_title">Business / VIP</h3>
                            <p class="text-sm opacity-90" data-translate="plan5_sub">Abonnement - Prix à déterminer</p>
                        </div>
                        <div class="plan-content">
                            <img src="img67.jpg" alt="Business / VIP" class="plan-image">
                            <div class="plan-preview-text" data-translate="plan5_preview">
                                Solution idéale pour les clients réguliers. Bénéficiez d'avantages exclusifs et d'un service prioritaire.
                            </div>
                            <div class="plan-actions">
                                <button class="learn-more-btn gold-button btn-glow" data-plan="5" data-translate="learn_more">
                                    En savoir plus
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Flèche droite -->
                <button class="nav-arrow right">
                    <i class="ri-arrow-right-s-line"></i>
                </button>
            </div>
            
            <!-- Indicateurs de position -->
            <div class="dots-indicator">
                <div class="dot active" data-index="0"></div>
                <div class="dot" data-index="1"></div>
                <div class="dot" data-index="2"></div>
                <div class="dot" data-index="3"></div>
                <div class="dot" data-index="4"></div>
            </div>
        </section>
        
        <!-- Section pour afficher toutes les commandes en attente -->
        <section class="mb-8" id="all-pending-requests" data-aos="fade-up" style="display: none;">
            <h3 class="text-lg font-semibold text-gray-800 mb-4" data-translate="pending_orders">Commandes en attente</h3>
            <div id="pendingRequestsContainer" class="space-y-4">
                <!-- Les commandes en attente seront ajoutées ici -->
            </div>
        </section>

        <!-- Pending Request Section -->
        <section class="mb-8" id="pending-request" style="display: none;" data-order-id="" data-interval-id="" data-aos="fade-up">
        </section>

        <!-- Unconfirmed Request Section -->
        <section class="mb-8" id="unconfirmed-request" data-aos="fade-up" style="display: none;">
            <div id="unconfirmedRequestsContainer" class="space-y-4">
                <!-- Les commandes non confirmées seront ajoutées ici -->
            </div>
        </section>

        <!-- Confirmed Request Section -->
        <section class="mb-8" id="confirmed-request" style="display: none;" data-order-id="" data-aos="fade-up">
        </section>

        <!-- Transferring Request Section -->
        <section class="mb-8" id="transferring-request" style="display: none;" data-order-id="" data-aos="fade-up">
        </section>

        <!-- Top Drivers Section -->
        <section class="mb-8" data-aos="fade-up">
            <h3 class="text-lg font-semibold text-gray-800 mb-4" data-translate="top_drivers">Meilleurs Chauffeurs de la Semaine</h3>
            <div id="topDriversContainer" class="grid grid-cols-3 gap-4">
            </div>
        </section>

        <!-- Tourist Attractions Section avec carte interactive -->
        <section class="mb-8" data-aos="fade-up">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center" data-translate="discover_haiti">Découvrez Haïti</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Citadelle La Ferrière -->
                <div class="attraction-card" style="background-image: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), url('img.jpg')" data-aos="fade-up">
                    <div class="attraction-overlay">
                        <h3 class="text-xl font-bold" data-translate="citadelle_name">Citadelle La Ferrière</h3>
                        <p class="text-sm mt-2" data-translate="citadelle_desc">Forteresse historique perchée sur une montagne</p>
                        <button class="mt-4 gold-button px-4 py-2 !rounded-button font-medium learn-more-btn btn-glow" data-attraction="citadelle">
                            <span data-translate="learn_more">En savoir plus</span>
                        </button>
                    </div>
                </div>
                
                <!-- Labadee -->
                <div class="attraction-card" style="background-image: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), url('img7.jpg')" data-aos="fade-up" data-aos-delay="100">
                    <div class="attraction-overlay">
                        <h3 class="text-xl font-bold" data-translate="labadee_name">Labadee</h3>
                        <p class="text-sm mt-2" data-translate="labadee_desc">Plages paradisiaques et eaux cristallines</p>
                        <button class="mt-4 gold-button px-4 py-2 !rounded-button font-medium learn-more-btn btn-glow" data-attraction="labadee">
                            <span data-translate="learn_more">En savoir plus</span>
                        </button>
                    </div>
                </div>
                
                <!-- Monument de Verrières -->
                <div class="attraction-card" style="background-image: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), url('img8.jpg')" data-aos="fade-up" data-aos-delay="200">
                    <div class="attraction-overlay">
                        <h3 class="text-xl font-bold" data-translate="verrieres_name">Monuments de Vertière</h3>
                        <p class="text-sm mt-2" data-translate="verrieres_desc">Mémorial historique de la bataille de Vertière</p>
                        <button class="mt-4 gold-button px-4 py-2 !rounded-button font-medium learn-more-btn btn-glow" data-attraction="verrieres">
                            <span data-translate="learn_more">En savoir plus</span>
                        </button>
                    </div>
                </div>
                
                <!-- Cathédrale de Cap-Haïtien -->
                <div class="attraction-card" style="background-image: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), url('img6.jpg')" data-aos="fade-up" data-aos-delay="300">
                    <div class="attraction-overlay">
                        <h3 class="text-xl font-bold" data-translate="cathedrale_name">Cathédrale de Cap-Haïtien</h3>
                        <p class="text-sm mt-2" data-translate="cathedrale_desc">Joyau architectural du nord d'Haïti</p>
                        <button class="mt-4 gold-button px-4 py-2 !rounded-button font-medium learn-more-btn btn-glow" data-attraction="cathedrale">
                            <span data-translate="learn_more">En savoir plus</span>
                        </button>
                    </div>
                </div>
                
                <!-- Palais Sans Souci -->
                <div class="attraction-card" style="background-image: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), url('img15.webp.jpg')" data-aos="fade-up" data-aos-delay="400">
                    <div class="attraction-overlay">
                        <h3 class="text-xl font-bold" data-translate="palais_name">Palais Sans Souci</h3>
                        <p class="text-sm mt-2" data-translate="palais_desc">Ancien palais royal d'Henri Christophe</p>
                        <button class="mt-4 gold-button px-4 py-2 !rounded-button font-medium learn-more-btn btn-glow" data-attraction="palais">
                            <span data-translate="learn_more">En savoir plus</span>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Attraction Detail Sections -->
        <div id="citadelle-detail" class="attraction-detail">
        </div>
        
        <div id="labadee-detail" class="attraction-detail">
        </div>
        
        <div id="verrieres-detail" class="attraction-detail">
        </div>
        
        <div id="cathedrale-detail" class="attraction-detail">
        </div>
        
        <div id="palais-detail" class="attraction-detail">
        </div>

        <!-- Services Section avec animations -->
        <section class="mb-8 services-section" data-aos="fade-up">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center" data-translate="services">Services à bord</h2>
            <div class="services-grid">
                <div class="service-card glass-card" data-aos="fade-up" data-aos-delay="100">
                    <div class="service-illustration">
                        <i class="ri-wifi-line wifi-icon-animated" style="font-size: 48px; color: #00CED1;"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2" data-translate="wifi_service">Wifi gratuit</h3>
                    <p class="text-gray-600" data-translate="wifi_desc">Vous trouverez internet à bord de nos véhicules pour rester connecté.</p>
                </div>
                
                <div class="service-card glass-card" data-aos="fade-up" data-aos-delay="200">
                    <div class="service-illustration">
                        <div class="water-drops">
                            <div class="water-drop"></div>
                            <div class="water-drop"></div>
                            <div class="water-drop"></div>
                        </div>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2" data-translate="water_service">Bouteille d'eau disponible</h3>
                    <p class="text-gray-600" data-translate="water_desc">Une bouteille d'eau est disponible à bord pour vous rafraîchir durant votre trajet.</p>
                </div>
            </div>
        </section>

        <!-- Itinéraires fréquents — redesign responsive + animation -->
        <section class="mb-6" id="frequentRoutesSection" aria-labelledby="frequentRoutesTitle" data-aos="fade-up">
            <div class="flex items-center justify-between mb-3">
                <h3 id="frequentRoutesTitle" class="text-lg font-semibold text-gray-800" data-translate="frequent_routes">Itinéraires fréquents</h3>
            </div>

            <style>
                /* Frequent routes grid + card styles (responsive) */
                .frequent-routes-grid {
                    display: flex;
                    gap: 12px;
                    align-items: stretch;
                    overflow-x: auto;
                    scroll-snap-type: x mandatory;
                    padding-bottom: 6px;
                }
                .frequent-route-card {
                    background: linear-gradient(180deg,#ffffff,#fffaf0);
                    border-radius: 12px;
                    padding: 12px;
                    box-shadow: 0 6px 14px rgba(16,24,40,0.06);
                    transition: transform .28s ease, box-shadow .28s ease;
                    overflow: hidden;
                    display: flex;
                    flex-direction: column;
                    gap: 8px;
                    min-height: 96px;
                    min-width: 260px;
                    flex: 0 0 260px;
                    scroll-snap-align: center;
                }
                .frequent-route-card .frequent-route-svg { width: 100%; height: 56px; display:block; }
                .frequent-route-card .route-meta { margin-top: 4px; }
                .frequent-route-card .route-meta .font-semibold { font-size: 15px; }
                .frequent-route-card .route-meta .text-sm { font-size: 13px; color: #475569; }
                .frequent-route-card.highlight {
                    transform: translateY(-8px) scale(1.02);
                    box-shadow: 0 10px 30px rgba(16,24,40,0.14);
                }
                /* Active card visual effect (similar to plan-card.active) */
                .frequent-route-card.active {
                    transform: translateY(-8px) scale(1.02);
                    box-shadow: 0 12px 34px rgba(16,24,40,0.18);
                }
                @media (max-width: 640px) {
                    .frequent-route-card { padding:10px; border-radius:10px; }
                    .frequent-route-card .frequent-route-svg { height:48px; }
                    /* Ensure no decorative icons appear before cards */
                    .frequent-route-card > i { display: none !important; }
                }
            </style>

            <div id="frequentRoutesContainer" class="frequent-routes-grid" role="list">
                <article class="frequent-route-card" role="listitem" data-route="Cap-Haïtien → Ouanaminthe" data-duration="66">
                    <div class="route-meta"><div class="font-semibold">Cap-Haïtien → Ouanaminthe</div><div class="text-sm">54 km • environ 1h 6 min</div></div>
                </article>

                <article class="frequent-route-card" role="listitem" data-route="Cap-Haïtien → Fort-Liberté" data-duration="47">
                    <div class="route-meta"><div class="font-semibold">Cap-Haïtien → Fort-Liberté</div><div class="text-sm">39 km • environ 47 min</div></div>
                </article>

                <article class="frequent-route-card" role="listitem" data-route="Cap-Haïtien → Gonaïves" data-duration="73">
                    <div class="route-meta"><div class="font-semibold">Cap-Haïtien → Gonaïves</div><div class="text-sm">60 km • environ 1h 13 min</div></div>
                </article>

                <article class="frequent-route-card" role="listitem" data-route="Cap-Haïtien → Port-de-Paix" data-duration="84">
                    <div class="route-meta"><div class="font-semibold">Cap-Haïtien → Port-de-Paix</div><div class="text-sm">69 km • environ 1h 24 min</div></div>
                </article>

                <article class="frequent-route-card" role="listitem" data-route="Gonaïves → Port-de-Paix" data-duration="69">
                    <div class="route-meta"><div class="font-semibold">Gonaïves → Port-de-Paix</div><div class="text-sm">57 km • environ 1h 9 min</div></div>
                </article>

                <article class="frequent-route-card" role="listitem" data-route="Cap-Haïtien → Hinche" data-duration="80">
                    <div class="route-meta"><div class="font-semibold">Cap-Haïtien → Hinche</div><div class="text-sm">66 km • environ 1h 20 min</div></div>
                </article>

                <article class="frequent-route-card" role="listitem" data-route="Cap-Haïtien → Môle Saint-Nicolas" data-duration="147">
                    <div class="route-meta"><div class="font-semibold">Cap-Haïtien → Môle Saint-Nicolas</div><div class="text-sm">122 km • environ 2h 27 min</div></div>
                </article>
            </div>

            <script>
                (function(){
                    const container = document.getElementById('frequentRoutesContainer');
                    if(!container) return;

                    // Turn grid into horizontal scroll for auto-scroll behavior on wider screens
                    container.style.display = 'flex';
                    container.style.overflowX = 'auto';
                    container.style.scrollBehavior = 'smooth';
                    container.style.gap = '12px';
                    container.style.paddingBottom = '6px';
                    container.style.scrollSnapType = 'x mandatory';
                    const cards = Array.from(container.querySelectorAll('.frequent-route-card'));
                    // Ensure each card is focusable
                    cards.forEach(c => { c.tabIndex = 0; });

                    // helper: update which card is visually 'active' (centered)
                    function updateActiveCard() {
                        const containerCenter = container.scrollLeft + container.clientWidth / 2;
                        let closest = null;
                        let closestDist = Infinity;
                        cards.forEach(card => {
                            const cardLeft = card.offsetLeft;
                            const cardCenter = cardLeft + card.offsetWidth / 2;
                            const dist = Math.abs(cardCenter - containerCenter);
                            if (dist < closestDist) { closestDist = dist; closest = card; }
                        });
                        cards.forEach(c => c.classList.remove('active'));
                        if (closest) closest.classList.add('active');
                    }

                    let auto = true; // whether auto-scroll is active
                    let vx = 0.9; // positive value to scroll visually leftward by increasing scrollLeft

                    // Respect save-data and reduced-motion preference
                    const saveData = navigator.connection && navigator.connection.saveData;
                    const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
                    if (saveData || prefersReduced) { auto = false; }

                    // Auto-scroll loop using rAF
                    let rafId = null;
                    function step() {
                        try {
                            if (!auto) { rafId = requestAnimationFrame(step); return; }
                            // move to the right in DOM which visually scrolls content left
                            container.scrollLeft += vx;
                            updateActiveCard();
                            // wrap when reaching the end
                            if (container.scrollLeft + container.clientWidth >= container.scrollWidth - 1) {
                                // jump back to start smoothly
                                container.scrollLeft = 0;
                            }
                        } catch (e) {}
                        rafId = requestAnimationFrame(step);
                    }

                    // start after layout
                    setTimeout(() => { if (auto) rafId = requestAnimationFrame(step); }, 600);

                    // Pause auto mode and let user control on pointer interaction
                    function pauseAuto() {
                        if (!auto) return; // already manual
                        auto = false;
                        if (rafId) { cancelAnimationFrame(rafId); rafId = null; }
                        updateActiveCard();
                    }


                    // Pause on interactions that originate inside the container and do not auto-resume
                    ['pointerdown','touchstart','wheel','keydown'].forEach(ev => {
                        container.addEventListener(ev, (e) => { 
                            // if keydown and not arrow, ignore
                            if (ev === 'keydown') {
                                if (e.key === 'ArrowRight') { pauseAuto(); container.scrollBy({ left: 260, behavior: 'smooth' }); }
                                else if (e.key === 'ArrowLeft') { pauseAuto(); container.scrollBy({ left: -260, behavior: 'smooth' }); }
                                return;
                            }
                            pauseAuto();
                        }, { passive: true });
                    });

                    // update active card while scrolling
                    container.addEventListener('scroll', () => { updateActiveCard(); }, { passive: true });

                    // If user prefers manual, we don't auto-resume (but scheduleResumeShort handles short resume)
                })();
            </script>
        </section>

        <!-- Trip History Section -->
        <section class="mb-8" id="tripHistorySection" data-aos="fade-up" style="display: none;">
            <h3 class="text-lg font-semibold text-gray-800 mb-4" data-translate="trip_history">Historique des parcours</h3>
            <div id="tripHistoryContainer" class="space-y-4">
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer>
        <div class="footer-content">
            <img src="img20.png" alt="Daxi Logo" class="footer-logo">
            
            <div class="footer-contact">
                <p>
                    <i class="ri-map-pin-line"></i>
                    Adresse zo Vincent #36 Cap-Haïtien
                </p>
                <p>
                    <i class="ri-phone-line"></i>
                    +509 41628178
                </p>
                <p>
                    <i class="ri-mail-line"></i>
                    info@daxipro.com
                </p>
            </div>
            
            <div class="social-icons">
    <a href="https://wa.me/50941628178" target="_blank" class="social-icon">
        <i class="ri-whatsapp-line"></i>
    </a>
    <a href="https://www.facebook.com/share/18ABkYbPm7/" class="social-icon" id="facebookIcon" target="_blank">
        <i class="ri-facebook-fill"></i>
    </a>
    <a href="https://www.instagram.com/taxiokap?igsh=YzljYTk1ODg3Zg==" target="_blank" class="social-icon">
        <i class="ri-instagram-line"></i>
    </a>
    <a href="https://tiktok.com/@julmin.taxi" target="_blank" class="social-icon">
        <i class="ri-tiktok-line"></i>
    </a>
</div>
            
            <div class="apk-footer">
                <button id="downloadApkBtn" class="modern-download-btn gold-button">
                    <i class="ri-download-line"></i> <span data-translate="download_apk">Télécharger l'APK Android</span>
                </button>
                <button id="iosInstallBtn" class="modern-download-btn" style="display: none;">
                    <i class="ri-smartphone-line"></i> <span>Installer sur iPhone</span>
                </button>
            </div>
            
            <div class="footer-bottom">
                <p>&copy; 2025 Daxi. Tous droits réservés.</p>
            </div>
        </div>
    </footer>

    <!-- Floating WhatsApp Icon -->
    <a href="https://wa.me/50941628178" class="whatsapp-icon" target="_blank">
        <i class="ri-whatsapp-line"></i>
    </a>

    <!-- App Download Modal -->
    <div id="appDownloadModal" class="modal">
        <div class="app-modal-content">
            <i class="ri-smartphone-line app-modal-icon"></i>
            <h3 class="text-xl font-semibold text-gray-800 mb-2" data-translate="download_modal_title">Téléchargez notre application android</h3>
            <p class="text-gray-600" data-translate="download_modal_desc">
                Pour une expérience optimale, téléchargez notre application mobile. Commandez vos trajets plus rapidement et bénéficiez de fonctionnalités exclusives !
            </p>
            <div class="app-modal-buttons">
                <button id="closeAppModalBtn" class="close-app-modal" data-translate="close">
                    Fermer
                </button>
                <button id="downloadAppBtn" class="download-app-btn" data-translate="download">
                    Télécharger
                </button>
            </div>
        </div>
    </div>

    <!-- iOS Install Modal -->
    <div id="iosInstallModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-800">Installer l'APK du site sur votre iPhone</h3>
                <button class="close-modal text-gray-500 hover:text-gray-700" id="closeIosModalBtn">
                    <i class="ri-close-line ri-lg"></i>
                </button>
            </div>
            <p class="text-sm text-gray-600 mb-4">Vous pouvez installer l'APK de notre site directement sur votre iPhone pour y accéder plus rapidement, comme une application.</p>
            
            <div class="ios-instruction-step">
                <i class="ri-safari-line"></i>
                <span>1. Ouvrez ce site dans Safari (nécessaire pour l'installation).</span>
            </div>
            
            <div class="ios-instruction-step">
                <i class="ri-share-box-line"></i>
                <span>2. Appuyez sur le bouton Partager (icône carré avec une flèche télécharger).</span>
            </div>
            
            <div class="ios-instruction-step">
                <i class="ri-home-heart-line"></i>
                <span>3. Sélectionnez « Installer l'APK sur l'écran d'accueil ».</span>
            </div>
            
            <div class="ios-instruction-step">
                <i class="ri-add-circle-line"></i>
                <span>4. Appuyez sur Ajouter pour finaliser l'installation.</span>
            </div>
            
            <button id="closeIosModalConfirmBtn" class="w-full gold-button py-3 !rounded-button font-semibold mt-4">
                Fermer
            </button>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content responsive" style="max-height:86vh; display:flex; flex-direction:column;">
            <div class="modal-header" style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid rgba(0,0,0,0.06);position:sticky;top:0;background:rgba(255,255,255,0.96);z-index:50;">
                <h3 class="text-xl font-semibold text-gray-800" data-translate="login">Connexion</h3>
                <button class="close-modal text-gray-500 hover:text-gray-700" aria-label="Fermer">
                    <i class="ri-close-line ri-lg"></i>
                </button>
            </div>
            
            <div class="tab-container">
                <div class="tab active" data-tab="id" data-translate="id_tab">ID</div>
                <div class="tab" data-tab="password" data-translate="password_tab">Mot de passe</div>
                <div class="tab" data-tab="signup" data-translate="signup_tab">Inscription</div>
            </div>
            
            <div class="tab-content active" id="idTab" style="overflow:auto;padding:12px;flex:1 1 auto;">
                <p class="text-sm text-gray-600 mb-4" data-translate="id_login_desc">
                    Connectez-vous avec votre ID unique pour accéder à votre compte permanent.
                </p>
                <div class="mb-4">
                    <label for="userIdInput" class="block text-sm font-medium text-gray-700 mb-1" data-translate="your_id">Votre ID</label>
                    <input type="text" id="userIdInput" data-translate="your_id_placeholder" class="w-full p-3 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Entrez votre ID à 4 chiffres" required>
                </div>
                <button id="loginWithIdBtn" class="w-full gold-button py-3 !rounded-button font-semibold mt-2 btn-glow" data-translate="login_with_id">
                    Se connecter avec mon ID
                </button>
            </div>
            
            <div class="tab-content" id="passwordTab" style="overflow:auto;padding:12px;flex:1 1 auto;">
                <p class="text-sm text-gray-600 mb-4" data-translate="password_login_desc">
                    Connectez-vous avec votre email et mot de passe.
                </p>
                <div class="mb-4">
                    <label for="emailInput" class="block text-sm font-medium text-gray-700 mb-1" data-translate="email">Email</label>
                    <input type="email" id="emailInput" data-translate="email_placeholder" class="w-full p-3 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Votre adresse email" required>
                </div>
                <div class="mb-4">
                    <label for="passwordInput" class="block text-sm font-medium text-gray-700 mb-1" data-translate="password">Mot de passe</label>
                    <div class="password-container">
                        <input type="password" id="passwordInput" data-translate="password_placeholder" class="w-full pl-4 pr-10 py-3 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Votre mot de passe" required>
                        <i class="ri-eye-line toggle-password" id="loginTogglePassword"></i>
                    </div>
                </div>
                <button id="loginWithPasswordBtn" class="w-full gold-button py-3 !rounded-button font-semibold mt-2 btn-glow" data-translate="login">
                    Se connecter
                </button>
            </div>
            
            <div class="tab-content" id="signupTab" style="overflow:auto;padding:12px;flex:1 1 auto;">
                <form id="createAccountForm">
                    <div class="mb-4">
                        <label for="lastName" class="block text-sm font-medium text-gray-700 mb-1" data-translate="last_name">Nom</label>
                        <input type="text" id="lastName" data-translate="last_name_placeholder" placeholder="Ex: Jean" class="w-full p-3 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" required>
                    </div>
                    <div class="mb-4">
                        <label for="firstName" class="block text-sm font-medium text-gray-700 mb-1" data-translate="first_name">Prénom</label>
                        <input type="text" id="firstName" data-translate="first_name_placeholder" placeholder="Ex: Pierre" class="w-full p-3 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" required>
                    </div>
                    <div class="mb-4">
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-1" data-translate="email">Email</label>
                        <input type="email" id="email" data-translate="email_placeholder" placeholder="you@example.com" class="w-full p-3 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" required>
                    </div>
                    <div class="mb-4">
                        <label for="phone" class="block text-sm font-medium text-gray-700 mb-1" data-translate="phone">Téléphone</label>
                        <div class="phone-input-container">
                            <div class="country-select-container">
                                <select id="countryCode" class="country-select">
                                    <option value="+509">HT (+509)</option>
                                    <option value="+33">FR (+33)</option>
                                    <option value="+1">US/CA (+1)</option>
                                    <option value="+44">UK (+44)</option>
                                    <option value="+34">ES (+34)</option>
                                </select>
                            </div>
                            <input type="tel" id="phone" data-translate="phone_placeholder" placeholder="Numéro de téléphone" class="phone-input" required>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-1" data-translate="password">Mot de passe</label>
                        <div class="password-container">
                            <input type="password" id="password" data-translate="password_placeholder" placeholder="********" class="w-full pl-4 pr-10 py-3 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" required>
                            <i class="ri-eye-line toggle-password" id="passwordToggle"></i>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="confirmPassword" class="block text-sm font-medium text-gray-700 mb-1" data-translate="confirm_password">Confirmer le mot de passe</label>
                        <div class="password-container">
                            <input type="password" id="confirmPassword" data-translate="confirm_password_placeholder" placeholder="********" class="w-full pl-4 pr-10 py-3 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" required>
                            <i class="ri-eye-line toggle-password" id="confirmPasswordToggle"></i>
                        </div>
                        <div id="passwordError" class="password-error" data-translate="password_error">Les mots de passe ne correspondent pas</div>
                    </div>
                    <div class="mb-4">
                        <label for="age" class="block text-sm font-medium text-gray-700 mb-1" data-translate="age">Âge</label>
                        <input type="number" id="age" min="18" max="100" data-translate="age_placeholder" placeholder="Votre âge" class="w-full p-3 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" required>
                    </div>
                    <div class="mb-4 bg-blue-50 p-3 rounded-lg">
                        <p class="text-sm text-blue-700 font-medium" data-translate="unique_id">Votre ID unique</p>
                        <div class="flex items-center mt-1">
                            <span id="generatedUserId" class="text-xl font-bold text-primary">Génération en cours...</span>
                            <i class="ri-information-line text-blue-500 ml-2" id="modalIdInfoIcon"></i>
                        </div>
                        <p class="text-xs text-blue-600 mt-1" data-translate="save_id">Conservez cet ID pour accéder à votre compte depuis n'importe quel appareil</p>
                    </div>
                    <button type="submit" class="w-full gold-button py-3 !rounded-button font-semibold mt-2 btn-glow" data-translate="save">
                        Enregistrer
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Email Verification Modal -->
    <div id="emailVerificationModal" class="email-verification-modal">
        <div class="email-verification-content">
            <i class="ri-mail-check-line verification-icon"></i>
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Vérification d'email</h3>
            <p class="text-sm text-gray-600 mb-4">Nous avons envoyé un code de vérification à votre adresse email. Veuillez le saisir ci-dessous.</p>
            <input type="text" id="otpInput" class="verification-input" placeholder="XXXXXX" maxlength="6">
            <button id="verifyOtpBtn" class="w-full gold-button py-3 !rounded-button font-semibold mt-2 btn-glow">Vérifier</button>
            <a href="#" id="resendOtp" class="resend-otp">Renvoyer le code</a>
        </div>
    </div>

    <!-- Location Permission Modal -->
    <div id="locationPermissionModal" class="modal">
        <div class="modal-content">
            <div class="mb-4">
                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="ri-map-pin-line text-blue-600 text-2xl"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-800 text-center mb-2" data-translate="location_access">Accès à votre localisation</h3>
                <p class="text-sm text-gray-600 text-center" data-translate="location_desc">
                    Pour que votre chauffeur puisse vous prendre en charge à votre position exacte, nous avons besoin d'accéder à votre localisation. 
                    <br><br>
                    Si vous préférez ne pas partager votre position, activez l'option "Indiquer une adresse de départ différente" et saisissez manuellement votre adresse.
                </p>
            </div>
            <div class="flex gap-3 mt-6">
                <button id="closeLocationModalBtn" class="flex-1 bg-gray-100 text-gray-700 py-3 !rounded-button font-medium cursor-pointer hover:bg-gray-200 transition-colors" data-translate="close">
                    Fermer
                </button>
                <button id="acceptLocationBtn" class="flex-1 gold-button py-3 !rounded-button font-medium cursor-pointer btn-glow" data-translate="accept">
                    Accepter
                </button>
            </div>
        </div>
    </div>

    <!-- Reviews Modal -->
    <div id="reviewsModal" class="reviews-modal">
        <div class="reviews-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-800" data-translate="driver_reviews">Avis sur le chauffeur</h3>
                <button class="close-reviews-modal text-gray-500 hover:text-gray-700">
                    <i class="ri-close-line ri-lg"></i>
                </button>
            </div>
            <div id="reviewsContainer">
            </div>
        </div>
    </div>

    <!-- Notification Permission Modal -->
    <div id="notificationPermissionModal" class="notification-permission-modal">
        <div class="notification-permission-content">
            <i class="ri-notification-3-line text-4xl text-blue-500 mb-4"></i>
            <h3 class="text-xl font-semibold text-gray-800 mb-2">Notifications</h3>
            <p class="text-sm text-gray-600 mb-4">
                Nous aimerions vous envoyer des notifications pour vous informer du statut de vos commandes, des promotions spéciales et des mises à jour importantes.
            </p>
            <p class="text-sm text-gray-500 mb-6">
                Vous pouvez modifier ces paramètres à tout moment dans les paramètres de votre navigateur.
            </p>
            <div class="flex gap-3">
                <button id="declineNotificationBtn" class="flex-1 bg-gray-100 text-gray-700 py-3 !rounded-button font-medium cursor-pointer hover:bg-gray-200 transition-colors">
                    Non merci
                </button>
                <button id="acceptNotificationBtn" class="flex-1 gold-button py-3 !rounded-button font-medium cursor-pointer btn-glow">
                    Autoriser
                </button>
            </div>
        </div>
    </div>

    <!-- Plan Modals -->
    <!-- Modal Plan 1 - Course Ville à Ville -->
    <div id="planModal1" class="plan-modal">
        <div class="plan-modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-800" data-translate="plan1_title">Course Ville à Ville</h3>
                <button class="close-plan-modal">
                    <i class="ri-close-line ri-lg"></i>
                </button>
            </div>
            
            <div class="plan-details">
                <p class="text-gray-600 mb-4" data-translate="plan1_modal">
                    Dites adieu aux poussières, à la chaleur, au transport en commun et au stress. Bonjour au confort grâce à Daxi, votre parcours est léger, tranquillité d'esprit avec nos chauffeurs privés expérimentés.
                </p>
                
                <h4 class="font-semibold text-gray-800 mb-2" data-translate="plan_features">Caractéristiques :</h4>
                <ul class="list-disc pl-5 text-gray-600 mb-4">
                    <li data-translate="plan1_feat_time">Gagner du temps : Évitez les retards et les tracas des transports en commun</li>
                    <li data-translate="plan1_feat_music">Musique de votre choix : Personnalisez votre ambiance de voyage</li>
                    <li data-translate="plan1_feat_safety">Sécurité garantie : Protection en cas de grève ou problème de sécurité</li>
                    <li data-translate="plan1_feat_peace">Avoir l'esprit tranquille : Voyagez sereinement</li>
                    <li data-translate="plan1_feat_wifi">Travailler en route : Wifi disponible dans la plupart des véhicules</li>
                </ul>
                
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                    <p class="text-sm text-yellow-800">
                        <strong data-translate="note">Note :</strong> <span data-translate="plan1_price_note">Prix à déterminer par l'administrateur selon la distance et la demande.</span>
                    </p>
                </div>
            </div>
            
            <div class="plan-form">
                <h4 class="font-semibold text-gray-800 mb-3" data-translate="order_service">Commander ce service</h4>
                <p class="text-sm text-gray-600 mb-4" data-translate="plan1_order_desc">
                    Ce service est disponible sur demande. Veuillez remplir le formulaire ci-dessous pour une estimation de prix personnalisée.
                </p>
                
                <!-- POINT DE DÉPART AJOUTÉ -->
                <div class="mb-4">
                    <label for="plan1-departure" class="block text-sm font-medium text-gray-700 mb-1" data-translate="departure_label">Point de départ</label>
                    <input type="text" id="plan1-departure" data-translate="departure_placeholder" class="w-full p-3 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Ex: Cap-Haïtien" required>
                </div>
                
                <div class="mb-4">
                    <label for="plan1-destination" class="block text-sm font-medium text-gray-700 mb-1" data-translate="destination_label">Ville de destination</label>
                    <input type="text" id="plan1-destination" data-translate="destination_placeholder" class="w-full p-3 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Ex: Port-au-Prince" required>
                </div>
                
                <button class="w-full gold-button py-3 !rounded-button font-semibold mt-2 btn-glow order-plan-btn" data-plan="1">
                    <span data-translate="order">Commander</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Plan 2 - Demi-Journée -->
    <div id="planModal2" class="plan-modal">
        <div class="plan-modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-800" data-translate="plan2_title">Demi-Journée (4 heures)</h3>
                <button class="close-plan-modal">
                    <i class="ri-close-line ri-lg"></i>
                </button>
            </div>
            
            <div class="plan-details">
                <p class="text-gray-600 mb-4" data-translate="plan2_modal">
                    Vous aimeriez aller à une réunion le matin ? Ou passer faire des courses ? Avec Daxi tout est facile. Profitez d'un chauffeur privé pendant 4 heures pour tous vos déplacements en ville.
                </p>
                
                <h4 class="font-semibold text-gray-800 mb-2">Caractéristiques :</h4>
                <ul class="list-disc pl-5 text-gray-600 mb-4">
                    <li>Chauffeur privé disponible pendant 4 heures</li>
                    <li>Arrêts illimités en ville</li>
                    <li>Temps d'attente inclus</li>
                    <li>Prix fixe garanti</li>
                    <li>Service personnalisé</li>
                </ul>
                
                <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                    <p class="text-lg font-bold text-green-800 text-center" data-translate="plan2_price">Prix : 50 USD</p>
                </div>
            </div>
            
            <div class="plan-form">
                <h4 class="font-semibold text-gray-800 mb-3" data-translate="order_service">Commander ce service</h4>
                <p class="text-sm text-gray-600 mb-4" data-translate="plan2_order_desc">
                    Ce service est disponible immédiatement. Remplissez le formulaire ci-dessous pour réserver votre chauffeur privé pour 4 heures.
                </p>
                
                <!-- POINT DE DÉPART AJOUTÉ -->
                <div class="mb-4">
                    <label for="plan2-departure" class="block text-sm font-medium text-gray-700 mb-1" data-translate="departure_label">Point de départ</label>
                    <input type="text" id="plan2-departure" data-translate="departure_placeholder" class="w-full p-3 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Ex: Cap-Haïtien" required>
                </div>
                
                <div class="mb-4">
                    <label for="plan2-date" class="block text-sm font-medium text-gray-700 mb-1">Date souhaitée</label>
                    <input type="date" id="plan2-date" class="w-full p-3 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" required>
                </div>
                
                <div class="mb-4">
                    <label for="plan2-time" class="block text-sm font-medium text-gray-700 mb-1">Heure de début</label>
                    <input type="time" id="plan2-time" class="w-full p-3 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" required>
                </div>
                
                <button class="w-full gold-button py-3 !rounded-button font-semibold mt-2 btn-glow order-plan-btn" data-plan="2">
                    <span data-translate="order">Commander</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Plan 3 - Journée Complète -->
    <div id="planModal3" class="plan-modal">
        <div class="plan-modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-800" data-translate="plan3_title">Journée Complète (8 heures)</h3>
                <button class="close-plan-modal">
                    <i class="ri-close-line ri-lg"></i>
                </button>
            </div>
            
            <div class="plan-details">
                <p class="text-gray-600 mb-4" data-translate="plan3_modal">
                    Idéal pour les journées chargées, les visites touristiques ou les déplacements professionnels intensifs. Profitez d'un service complet toute la journée avec un chauffeur dédié.
                </p>
                
                <h4 class="font-semibold text-gray-800 mb-2">Caractéristiques :</h4>
                <ul class="list-disc pl-5 text-gray-600 mb-4">
                    <li>Chauffeur privé disponible pendant 8 heures consécutives</li>
                    <li>Arrêts illimités dans la ville et ses environs proches</li>
                    <li>Temps d'attente inclus entre chaque arrêt</li>
                    <li>Prix fixe garanti</li>
                    <li>Service personnalisé</li>
                </ul>
                
                <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                    <p class="text-lg font-bold text-green-800 text-center" data-translate="plan3_price">Prix : 90 USD</p>
                </div>
            </div>
            
            <div class="plan-form">
                <h4 class="font-semibold text-gray-800 mb-3" data-translate="order_service">Commander ce service</h4>
                <p class="text-sm text-gray-600 mb-4" data-translate="plan3_order_desc">
                    Ce service est disponible immédiatement. Remplissez le formulaire ci-dessous pour réserver votre chauffeur privé pour 8 heures.
                </p>
                
                <!-- POINT DE DÉPART AJOUTÉ -->
                <div class="mb-4">
                    <label for="plan3-departure" class="block text-sm font-medium text-gray-700 mb-1" data-translate="departure_label">Point de départ</label>
                    <input type="text" id="plan3-departure" data-translate="departure_placeholder" class="w-full p-3 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Ex: Cap-Haïtien" required>
                </div>
                
                <div class="mb-4">
                    <label for="plan3-date" class="block text-sm font-medium text-gray-700 mb-1">Date souhaitée</label>
                    <input type="date" id="plan3-date" class="w-full p-3 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" required>
                </div>
                
                <div class="mb-4">
                    <label for="plan3-time" class="block text-sm font-medium text-gray-700 mb-1">Heure de début</label>
                    <input type="time" id="plan3-time" class="w-full p-3 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" required>
                </div>
                
                <button class="w-full gold-button py-3 !rounded-button font-semibold mt-2 btn-glow order-plan-btn" data-plan="3">
                    <span data-translate="order">Commander</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Plan 4 - Élégance Night -->
    <div id="planModal4" class="plan-modal">
        <div class="plan-modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-800" data-translate="plan4_title">Élégance Night (Jusqu'à 3h)</h3>
                <button class="close-plan-modal">
                    <i class="ri-close-line ri-lg"></i>
                </button>
            </div>
            
            <div class="plan-details">
                <p class="text-gray-600 mb-4" data-translate="plan4_modal">
                    Pour vos soirées spéciales, sorties entre amis ou événements nocturnes. Un service premium pour vos déplacements de nuit en toute sécurité et élégance.
                </p>
                
                <h4 class="font-semibold text-gray-800 mb-2" data-translate="plan_features">Caractéristiques :</h4>
                <ul class="list-disc pl-5 text-gray-600 mb-4">
                    <li data-translate="plan4_feat_hours">Votre chauffeur privé jusqu'à 3 heures du matin</li>
                    <li data-translate="plan4_feat_city">Uniquement dans la ville</li>
                    <li data-translate="plan4_feat_stops">Arrêts illimités</li>
                    <li data-translate="plan4_feat_vip">Service VIP avec véhicule haut de gamme</li>
                    <li data-translate="plan4_feat_reserve">Réservation préalable uniquement</li>
                </ul>
                
                <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                    <p class="text-lg font-bold text-green-800 text-center" data-translate="plan4_price">Prix : 75 USD</p>
                </div>
            </div>
            
            <div class="plan-form">
                <h4 class="font-semibold text-gray-800 mb-3" data-translate="order_service">Commander ce service</h4>
                <p class="text-sm text-gray-600 mb-4" data-translate="plan4_order_desc">
                    Ce service nécessite une réservation préalable. Remplissez le formulaire ci-dessous pour réserver votre service VIP nocturne.
                </p>
                
                <!-- POINT DE DÉPART AJOUTÉ -->
                <div class="mb-4">
                    <label for="plan4-departure" class="block text-sm font-medium text-gray-700 mb-1" data-translate="departure_label">Point de départ</label>
                    <input type="text" id="plan4-departure" data-translate="departure_placeholder" class="w-full p-3 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Ex: Cap-Haïtien" required>
                </div>
                
                <div class="mb-4">
                    <label for="plan4-date" class="block text-sm font-medium text-gray-700 mb-1" data-translate="plan4_date_label">Date de la soirée</label>
                    <input type="date" id="plan4-date" class="w-full p-3 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" required>
                </div>
                
                <div class="mb-4">
                    <label for="plan4-time" class="block text-sm font-medium text-gray-700 mb-1" data-translate="plan4_time_label">Heure de début</label>
                    <input type="time" id="plan4-time" class="w-full p-3 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" required>
                </div>
                
                <div class="mb-4">
                    <label for="plan4-occasion" class="block text-sm font-medium text-gray-700 mb-1" data-translate="occasion_label">Occasion (optionnel)</label>
                    <input type="text" id="plan4-occasion" data-translate="occasion_placeholder" class="w-full p-3 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Ex: Anniversaire, Soirée entre amis">
                </div>
                
                <button class="w-full gold-button py-3 !rounded-button font-semibold mt-2 btn-glow order-plan-btn" data-plan="4">
                    <span data-translate="order">Commander</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Plan 5 - Business / VIP -->
    <div id="planModal5" class="plan-modal">
        <div class="plan-modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-800" data-translate="plan5_title">Business / VIP</h3>
                <button class="close-plan-modal">
                    <i class="ri-close-line ri-lg"></i>
                </button>
            </div>
            
            <div class="plan-details">
                <p class="text-gray-600 mb-4" data-translate="plan5_modal">
                    Solution idéale pour les clients réguliers ou les entreprises ayant des besoins de transport constants. Bénéficiez d'avantages exclusifs et d'un service prioritaire adapté à vos exigences.
                </p>
                
                <h4 class="font-semibold text-gray-800 mb-2">Caractéristiques :</h4>
                <ul class="list-disc pl-5 text-gray-600 mb-4">
                    <li>Abonnement mensuel ou annuel</li>
                    <li>Trajets programmés par semaine</li>
                    <li>Votre chauffeur privé disponible à tout moment</li>
                    <li>Service dédié avec interlocuteur privilégié</li>
                    <li>Tarifs préférentiels et facturation simplifiée</li>
                </ul>
                
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                    <p class="text-sm text-yellow-800">
                        <strong>Note :</strong> Prix à déterminer par l'administrateur selon la fréquence et les besoins spécifiques.
                    </p>
                </div>
            </div>
            
            <div class="plan-form">
                <h4 class="font-semibold text-gray-800 mb-3" data-translate="plan5_quote_title">Demander un devis personnalisé</h4>
                <p class="text-sm text-gray-600 mb-4" data-translate="plan5_order_desc">
                    Ce service est personnalisé selon vos besoins. Veuillez remplir le formulaire ci-dessous pour recevoir une proposition sur mesure.
                </p>
                
                <!-- POINT DE DÉPART AJOUTÉ -->
                <div class="mb-4">
                    <label for="plan5-departure" class="block text-sm font-medium text-gray-700 mb-1">Point de départ habituel</label>
                    <input type="text" id="plan5-departure" class="w-full p-3 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Ex: Cap-Haïtien" required>
                </div>
                
                <div class="mb-4">
                    <label for="plan5-frequency" class="block text-sm font-medium text-gray-700 mb-1">Fréquence d'utilisation</label>
                    <select id="plan5-frequency" class="w-full p-3 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" required>
                        <option value="">Sélectionnez une fréquence</option>
                        <option value="quotidien">Quotidien</option>
                        <option value="hebdomadaire">Plusieurs fois par semaine</option>
                        <option value="mensuel">Quelques fois par mois</option>
                    </select>
                </div>
                
                <div class="mb-4">
                    <label for="plan5-type" class="block text-sm font-medium text-gray-700 mb-1">Type d'abonnement</label>
                    <select id="plan5-type" class="w-full p-3 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" required>
                        <option value="">Sélectionnez un type</option>
                        <option value="mensuel">Mensuel</option>
                        <option value="trimestriel">Trimestriel</option>
                        <option value="annuel">Annuel</option>
                    </select>
                </div>
                
                <div class="mb-4">
                    <label for="plan5-notes" class="block text-sm font-medium text-gray-700 mb-1">Besoins spécifiques</label>
                    <textarea id="plan5-notes" rows="3" class="w-full p-3 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Décrivez vos besoins en transport..."></textarea>
                </div>
                
                <button class="w-full gold-button py-3 !rounded-button font-semibold mt-2 btn-glow order-plan-btn" data-plan="5">
                    <span data-translate="order">Commander</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    
    <script>
        // ===========================================
        // INITIALISATION ET CONFIGURATION
        // ===========================================
        
        // Service Worker Registration
        // Only attempt registration when the page is served over http(s) or localhost.
        // Avoids: "Failed to register a ServiceWorker: The URL protocol of the current origin ('null') is not supported."
        (function registerSW() {
            try {
                const origin = window.location.origin || '';
                const isLocalOrHttp = origin.startsWith('http://') || origin.startsWith('https://') || origin.startsWith('http://localhost') || origin.startsWith('https://localhost') || origin === 'null' ? false : origin.length > 0;
                // Simpler check: only register when protocol is http or https
                if ((window.location.protocol === 'http:' || window.location.protocol === 'https:') && 'serviceWorker' in navigator) {
                    navigator.serviceWorker.register('sw.js').catch(err => console.warn('ServiceWorker registration failed:', err));
                } else {
                    // skip registration when opened via file:// or other unsupported protocols
                    console.debug('Skipping ServiceWorker registration; protocol:', window.location.protocol);
                }
            } catch (e) {
                console.warn('ServiceWorker registration skipped due to error:', e);
            }
        })();

        // Initialisation de AOS
        AOS.init({
            duration: 500,
            easing: 'ease-in-out',
            once: true
        });

        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCdGFcwfzj8b5eJXcmrS0LGRIxnTXZ6zac",
            authDomain: "julmin-taxis.firebaseapp.com",
            projectId: "julmin-taxis",
            storageBucket: "julmin-taxis.appspot.com",
            messagingSenderId: "392925120550",
            appId: "1:392925120550:web:2935808aab4ead6d7d7ee7",
            measurementId: "G-H7SBNVWQ06"
        };

        // Initialisation Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // --- Debug helpers: in-page panel + global error capture ---
        (function(){
            function createDebugPanel(){
                try {
                    if (document.getElementById('appDebugPanel')) return;
                    const p = document.createElement('div');
                    p.id = 'appDebugPanel';
                    p.style.position = 'fixed';
                    p.style.right = '12px';
                    p.style.bottom = '12px';
                    p.style.maxWidth = '420px';
                    p.style.maxHeight = '45vh';
                    p.style.overflow = 'auto';
                    p.style.zIndex = 99999;
                    p.style.background = 'rgba(17,24,39,0.95)';
                    p.style.color = '#fff';
                    p.style.fontSize = '12px';
                    p.style.padding = '8px';
                    p.style.borderRadius = '8px';
                    p.style.boxShadow = '0 8px 30px rgba(2,6,23,0.6)';
                    p.style.fontFamily = 'ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial';
                    p.innerHTML = '<strong style="display:block;margin-bottom:6px">App debug</strong>';
                    const clearBtn = document.createElement('button');
                    clearBtn.textContent = 'Clear';
                    clearBtn.style.marginRight = '8px';
                    clearBtn.style.padding = '4px 8px';
                    clearBtn.style.fontSize = '11px';
                    clearBtn.addEventListener('click', ()=>{ const list = p.querySelector('.dbg-list'); if (list) list.innerHTML=''; });
                    p.appendChild(clearBtn);
                    const hideBtn = document.createElement('button');
                    hideBtn.textContent = 'Hide';
                    hideBtn.style.padding = '4px 8px';
                    hideBtn.style.fontSize = '11px';
                    hideBtn.addEventListener('click', ()=>{ p.style.display = p.style.display === 'none' ? 'block' : 'none'; });
                    p.appendChild(hideBtn);
                    const list = document.createElement('div');
                    list.className = 'dbg-list';
                    list.style.marginTop = '8px';
                    p.appendChild(list);
                    document.body.appendChild(p);
                } catch(e){ console.warn('createDebugPanel failed', e); }
            }

            function logDebug(msg, level='log'){
                try {
                    createDebugPanel();
                    const p = document.getElementById('appDebugPanel');
                    if (!p) return;
                    const list = p.querySelector('.dbg-list');
                    const item = document.createElement('div');
                    item.style.marginBottom = '6px';
                    item.style.whiteSpace = 'pre-wrap';
                    item.textContent = (new Date()).toLocaleTimeString() + ' - ' + msg;
                    list.insertBefore(item, list.firstChild);
                    // keep only recent 200 chars * ~100 = small
                    while (list.childElementCount > 200) list.removeChild(list.lastChild);
                } catch(e) { console.warn('logDebug err', e); }
            }

            window.__appDebug = {
                log: logDebug
            };

            window.addEventListener('error', function(ev){
                try {
                    const msg = ev && ev.message ? ev.message : String(ev);
                    const src = ev && ev.filename ? ` at ${ev.filename}:${ev.lineno}:${ev.colno}` : '';
                    logDebug('[Error] ' + msg + src);
                    console.error(ev.error || ev.message || ev);
                } catch(e){}
            });

            window.addEventListener('unhandledrejection', function(ev){
                try {
                    const reason = ev && ev.reason ? ev.reason : ev;
                    logDebug('[UnhandledRejection] ' + (reason && reason.message ? reason.message : String(reason)));
                    console.error('UnhandledRejection', reason);
                } catch(e){}
            });

            // expose quick logger
            if (!window.appLog) window.appLog = window.__appDebug.log;
        })();

        // Configuration MailerSend
        const MAILERSEND_API_KEY = "mlsn.0ac0f0d5d4a93633ec7cc8d20eca5effeb23fa8e267fa5f24f27865a789b7ed1";
        const FROM_EMAIL = "info@daxipro.com";
        const FROM_NAME = "Daxi";
        const OTP_VALID_MINUTES = 10;

        // Variables globales
        let currentLanguage = 'ht'; // Langue par défaut : Kreyòl
        const displayedOrders = new Set();
        let unsubscribeUnconfirmedRequests = null;
        let unsubscribePendingRequests = null;

        // Générer ou récupérer un guestId persistant
        function getOrCreateGuestId() {
            try {
                let guestId = localStorage.getItem('guestId');
                if (!guestId) {
                    // uuid-lite
                    guestId = 'guest_' + Date.now().toString(36) + Math.random().toString(36).slice(2,8);
                    localStorage.setItem('guestId', guestId);
                }
                return guestId;
            } catch (e) {
                return null;
            }
        }

        // Variables pour la section des plans de services
        let currentPlanIndex = 0;
        const totalPlans = 5;

        // ===========================================
        // FONCTIONS UTILITAIRES
        // ===========================================

        // Génération d'OTP unique
        async function generateUniqueOTP() {
            let isUnique = false;
            let otp = '';
            
            while (!isUnique) {
                otp = Math.floor(100000 + Math.random() * 900000).toString();
                
                const saveMemberRef = database.ref('save_member');
                const snapshot = await saveMemberRef.orderByChild('otp').equalTo(otp).once('value');
                
                if (!snapshot.exists()) {
                    isUnique = true;
                }
            }
            
            return otp;
        }

        // Fonction pour envoyer l'OTP par email avec MailerSend - CORRIGÉE
        async function sendOTPEmail(email, otp) {
            const payload = {
                from: { email: FROM_EMAIL, name: FROM_NAME },
                to: [{ email: email, name: email.split('@')[0] || "" }],
                subject: "Votre code OTP",
                text: `Votre code OTP est : ${otp} (valable ${OTP_VALID_MINUTES} minutes)`,
                html: `
                  <div style="font-family: Arial, sans-serif; max-width:600px; margin:0 auto;">
                    <h2 style="color:#3498db;">Votre code de vérification</h2>
                    <p>Bonjour,</p>
                    <p>Votre code OTP pour accéder à nos services est :</p>
                    <div style="text-align:center; margin:30px 0;">
                      <span style="font-size:32px; font-weight:bold; letter-spacing:5px; color:#2c3e50; background:#f8f9fa; padding:10px 20px; border-radius:5px;">
                        ${otp}
                      </span>
                    </div>
                    <p>Ce code est valable pendant ${OTP_VALID_MINUTES} minutes.</p>
                    <p>Si vous n'avez pas demandé ce code, ignorez cet email.</p>
                    <hr style="border:none; border-top:1px solid #eee; margin:20px 0;">
                    <p style="font-size:12px; color:#7f8c8d;">© ${new Date().getFullYear()} Daxi</p>
                  </div>`
            };

            const res = await fetch("https://api.mailersend.com/v1/email", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + MAILERSEND_API_KEY
                },
                body: JSON.stringify(payload)
            });

            // Lire le body une seule fois
            const rawText = await res.text();
            let data;
            try {
                data = JSON.parse(rawText);
            } catch {
                data = rawText;
            }

            if (!res.ok) {
                throw new Error(`Erreur ${res.status}: ${JSON.stringify(data)}`);
            }

            return data;
        }

        // Fonction pour afficher l'interface de vérification
        function showEmailVerification(email) {
            document.getElementById('signupTab').style.display = 'none';
            document.getElementById('emailVerificationModal').style.display = 'flex';
            
            // Stocker l'email temporairement
            document.getElementById('emailVerificationModal').dataset.email = email;
        }

        // Fonction pour revenir au formulaire d'inscription
        function hideEmailVerification() {
            document.getElementById('signupTab').style.display = 'block';
            document.getElementById('emailVerificationModal').style.display = 'none';
        }

        // Récupérer l'IP utilisateur
        async function getUserIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                // Sauvegarder localement pour retrouver l'IP si l'utilisateur revient
                try { localStorage.setItem('guestIp', data.ip); } catch(e) {}
                return data.ip;
            } catch (error) {
                console.error("Erreur lors de la récupération de l'IP :", error);
                return null;
            }
        }

        // Sauvegarder l'IP en base de données
        async function saveIPToDatabase() {
            const ip = await getUserIP();
            if (ip) {
                try { localStorage.setItem('guestIp', ip); } catch(e) {}
                // Vérifier si cette IP existe déjà dans la base de données
                const unsaveMemberRef = database.ref('unsave_member');
                const snapshot = await unsaveMemberRef.orderByChild('ip').equalTo(ip).once('value');
                
                if (!snapshot.exists()) {
                    // Si l'IP n'existe pas, on crée un nouvel enregistrement
                    const newMemberRef = unsaveMemberRef.push();
                    newMemberRef.set({
                        ip: ip,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    });
                }
            }
        }

        // Générer un ID utilisateur unique
        async function generateUniqueId() {
            let isUnique = false;
            let userId = '';
            
            while (!isUnique) {
                userId = Math.floor(1000 + Math.random() * 9000).toString();
                
                const saveMemberRef = database.ref('save_member');
                const snapshot = await saveMemberRef.orderByChild('userId').equalTo(userId).once('value');
                
                if (!snapshot.exists()) {
                    isUnique = true;
                }
            }
            
            return userId;
        }

        // Initialiser la date
        function initDate() {
            const today = new Date();
            const formattedDate = today.toISOString().split('T')[0];
            document.getElementById('bookingDate').value = formattedDate;
        }

        // Normaliser une chaîne pour les suggestions
        function normalizeString(str) {
            return str
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "")
                .toLowerCase();
        }

        // Générer une clé/empreinte (fingerprint) stable pour une commande
        // Ne pas utiliser la clé push Firebase ici car la même commande logique peut
        // exister dans plusieurs tables (transit, confirmed, etc.).
        // On compose une empreinte à partir des champs stables: guestId/userId/ip, timestamp,
        // pickup, destination, phone, description.
        function generateOrderKey(order) {
            const owner = order.guestId || order.userId || order.ip || 'anon';
            let ts = order.timestamp || '';
            // Normalize numeric timestamps into minute buckets to collapse near-duplicates
            if (typeof ts === 'number') {
                ts = Math.floor(ts / 60000).toString(); // minutes since epoch
            } else if (typeof ts === 'string' && !isNaN(Number(ts))) {
                ts = Math.floor(Number(ts) / 60000).toString();
            } else {
                ts = ts || '';
            }
            const pickup = normalizeString(order.pickup || '');
            const dest = normalizeString(order.destination || '');
            // Try a few possible phone field names
            const phoneRaw = order.phone || order.clientPhone || order.telephone || '';
            const phone = (phoneRaw + '').replace(/\s+/g, '');
            const desc = normalizeString(order.description || '');
            return `${owner}|${ts}|${pickup}|${dest}|${phone}|${desc}`;
        }

        // Afficher les étoiles selon la note
        function renderStars(rating) {
            let stars = '';
            const fullStars = Math.floor(rating);
            const halfStar = rating % 1 >= 0.5;
            
            for (let i = 0; i < 5; i++) {
                if (i < fullStars) {
                    stars += '<i class="ri-star-fill"></i>';
                } else if (i === fullStars && halfStar) {
                    stars += '<i class="ri-star-half-fill"></i>';
                } else {
                    stars += '<i class="ri-star-line"></i>';
                }
            }
            return stars;
        }

        // Calculer la note moyenne
        function calculateAverageRating(reviews) {
            if (!reviews || Object.keys(reviews).length === 0) {
                return 2.5;
            }
            
            let total = 0;
            let count = 0;
            
            for (const key in reviews) {
                total += reviews[key].rating;
                count++;
            }
            
            return total / count;
        }

        // ===========================================
        // GESTION DES TRADUCTIONS
        // ===========================================

        const translations = {
            fr: {
                order_taxi: "Commander votre taxi",
                different_address: "Indiquer une adresse de départ différente",
                address_explanation: "Si vous ne souhaitez pas être pris en charge à votre position actuelle, activez ce switch pour indiquer un autre lieu de départ.",
                one_way: "Allez simple",
                round_trip: "Allez retour",
                now: "Maintenant",
                later: "Plus tard",
                order_taxi_btn: "Commander un Taxi",
                top_drivers: "Meilleurs Chauffeurs de la Semaine",
                pending_orders: "Commandes en attente",
                discover_haiti: "Découvrez Haïti",
                citadelle_name: "Citadelle La Ferrière",
                citadelle_desc: "Forteresse historique perchée sur une montagne",
                labadee_name: "Labadee",
                labadee_desc: "Plages paradisiaques et eaux cristallines",
                verrieres_name: "Monuments de Vertière",
                verrieres_desc: "Mémorial historique de la bataille de Vertière",
                cathedrale_name: "Cathédrale de Cap-Haïtien",
                cathedrale_desc: "Joyau architectural du nord d'Haïti",
                palais_name: "Palais Sans Souci",
                palais_desc: "Ancien palais royal d'Henri Christophe",
                learn_more: "En savoir plus",
                services: "Services à bord",
                wifi_service: "Wifi gratuit",
                wifi_desc: "Vous trouverez internet à bord de nos véhicules pour rester connecté.",
                water_service: "Bouteille d'eau disponible",
                water_desc: "Une bouteille d'eau est disponible à bord pour vous rafraîchir durant votre trajet.",
                trip_history: "Historique des parcours",
                history_login_required: "Cette fonctionnalité est réservée aux utilisateurs enregistrés. Veuillez vous connecter pour voir votre historique.",
                download_app: "Téléchargez notre application mobile",
                apk_description: "Disponible sur Android, téléchargez l'APK pour une expérience complète.",
                download_apk: "Télécharger l'APK",
                login: "Connexion",
                id_tab: "ID",
                password_tab: "Mot de passe",
                signup_tab: "Inscription",
                id_login_desc: "Connectez-vous avec votre unique ID pour accéder à votre compte permanent.",
                your_id: "Votre ID",
                login_with_id: "Se connecter avec mon ID",
                password_login_desc: "Connectez-vous avec votre email et mot de passe.",
                email: "Email",
                password: "Mot de passe",
                login: "Log in",
                create_account: "Créer un compte",
                last_name: "Nom",
                first_name: "Prénom",
                confirm_password: "Confirmer le mot de passe",
                age: "Âge",
                unique_id: "Votre Unique ID",
                save_id: "Conservez cet ID pour accéder à votre compte depuis n'importe quel appareil",
                save: "Enregistrer",
                password_error: "Passwords do not match",
                your_id_placeholder: "Entrez votre ID à 4 chiffres",
                email_placeholder: "Votre adresse email",
                password_placeholder: "Votre mot de passe",
                last_name_placeholder: "Ex: Jean",
                first_name_placeholder: "Ex: Pierre",
                phone_placeholder: "Numéro de téléphone",
                confirm_password_placeholder: "********",
                age_placeholder: "Votre âge",
                location_access: "Location Access",
                location_desc: "For your driver to pick you up at your exact location, we need access to your location. If you prefer not to share your location, enable the 'Specify a different pickup address' option and enter your address manually.",
                close: "Fermer",
                accept: "Accepter",
                driver_reviews: "Driver Reviews",
                download_modal_title: "Download our app",
                download_modal_desc: "For an optimal experience, download our mobile app. Order your rides faster and enjoy exclusive features!",
                download: "Télécharger",
                price_accepted: "Price accepted",
                waiting_driver: "Waiting for driver",
                driver_onway: "Driver on the way",
                accepted_message: "Vous avez accepté le prix pour votre trajet. Veuillez patienter pendant que l'administrateur vous réfère à un chauffeur.",
                transferring_message: "L'administrateur est en train de vous transférer à un chauffeur. Veuillez patienter.",
                onway_message: "Votre chauffeur sera là.",
                departure_placeholder: "Adresse de départ",
                destination_placeholder: "Adresse de destination",
                back: "Retour",
                order: "Commander",
                description: "Description",
                history: "Histoire",
                visit: "Visiter",
                visit_desc: "Commandez un taxi pour visiter ce lieu historique :",
                description_placeholder: "Description pour aider le chauffeur à vous repérer",
                no_pending: "Aucune commande en attente",
                no_history: "Vous n'avez encore terminé aucun trajet",
                phone: "Téléphone",
                service_plans: "Nos Plans de Services",
                plan1_title: "Course Ville à Ville",
                plan1_sub: "Prix à déterminer",
                plan1_preview: "Déplacez-vous en toute sérénité entre les villes avec notre service de transport confortable et sécurisé.",
                plan2_title: "Demi-Journée",
                plan2_sub: "4 heures - Prix fixe",
                plan2_preview: "Idéal pour vos courses, rendez-vous et visites. Votre chauffeur privé disponible pendant 4 heures.",
                plan3_title: "Journée Complète",
                plan3_sub: "8 heures - Prix fixe",
                plan3_preview: "Service complet pour vos journées chargées. Profitez d'un chauffeur dédié pendant 8 heures.",
                plan4_title: "Élégance Night",
                plan4_sub: "Jusqu'à 3h - Uniquement sur réservation",
                plan4_preview: "Pour vos soirées spéciales. Service premium avec véhicule haut de gamme pour vos sorties nocturnes.",
                plan5_title: "Business / VIP",
                plan5_sub: "Abonnement - Prix à déterminer",
                plan5_preview: "Solution idéale pour les clients réguliers. Bénéficiez d'avantages exclusifs et d'un service prioritaire.",
                plan1_modal: "Dites adieu aux poussières, à la chaleur, au transport en commun et au stress. Bonjour au confort grâce à Daxi, votre parcours est léger, tranquillité d'esprit avec nos chauffeurs privés expérimentés.",
                plan1_order_desc: "Ce service est disponible sur demande. Veuillez remplir le formulaire ci-dessous pour une estimation de prix personnalisée.",
                plan1_full: "Course Ville à Ville\nDites adieu aux poussières, à la chaleur, au transport en commun et au stress. Bonjour au confort grâce à Daxi, votre parcours est léger, tranquillité d'esprit avec nos chauffeurs privés expérimentés.\n\nCaractéristiques :\nGagner du temps : Évitez les retards et les tracas des transports en commun\nMusique de votre choix : Personnalisez votre ambiance de voyage\nSécurité garantie : Protection en cas de grève ou problème de sécurité\nAvoir l'esprit tranquille : Voyagez sereinement\nTravailler en route : Wifi disponible dans la plupart des véhicules\nNote : Prix à déterminer par l'administrateur selon la distance et la demande.\n\nCommander ce service\nCe service est disponible sur demande. Veuillez remplir le formulaire ci-dessous pour une estimation de prix personnalisée.\n\nPoint de départ\nVille de destination",
                plan1_feat_time: "Gagner du temps : Évitez les retards et les tracas des transports en commun",
                plan1_feat_music: "Musique de votre choix : Personnalisez votre ambiance de voyage",
                plan1_feat_safety: "Sécurité garantie : Protection en cas de grève ou problème de sécurité",
                plan1_feat_peace: "Avoir l'esprit tranquille : Voyagez sereinement",
                plan1_feat_wifi: "Travailler en route : Wifi disponible dans la plupart des véhicules",
                plan1_price_note: "Prix à déterminer par l'administrateur selon la distance et la demande.",
                plan2_modal: "Vous aimeriez aller à une réunion le matin ? Ou passer faire des courses ? Avec Daxi tout est facile. Profitez d'un chauffeur privé pendant 4 heures pour tous vos déplacements en ville.",
                plan2_price: "Prix : 50 USD",
                plan3_modal: "Idéal pour les journées chargées, les visites touristiques ou les déplacements professionnels intensifs. Profitez d'un service complet toute la journée avec un chauffeur dédié.",
                plan3_price: "Prix : 90 USD",
                plan4_modal: "Pour vos soirées spéciales. Service premium avec véhicule haut de gamme pour vos sorties nocturnes.",
                plan4_feat_hours: "Votre chauffeur privé jusqu'à 3 heures du matin",
                plan4_feat_city: "Uniquement dans la ville",
                plan4_feat_stops: "Arrêts illimités",
                plan4_feat_vip: "Service VIP avec véhicule haut de gamme",
                plan4_feat_reserve: "Réservation préalable uniquement",
                plan4_price: "Prix : 75 USD",
                plan4_date_label: "Date de la soirée",
                plan4_time_label: "Heure de début",
                plan4_order_desc: "Ce service nécessite une réservation préalable. Remplissez le formulaire ci-dessous pour réserver votre service VIP nocturne.",
                plan4_feat_hours: "Chofè prive w jiska 3è nan maten",
                plan4_feat_city: "Sèlman nan vil la",
                plan4_feat_stops: "Arè san limit",
                plan4_feat_vip: "Sèvis VIP ak machin haut de gamme",
                plan4_feat_reserve: "Rezèvasyon avan sèlman",
                plan4_price: "Pri : 75 USD",
                plan4_date_label: "Dat swar la",
                plan4_time_label: "Lè kòmanse",
                plan4_order_desc: "Sèvis sa a mande rezèvasyon davans. Ranpli fòmilè anba a pou rezève sèvis VIP nocturne ou.",
                plan5_modal: "Solution idéale pour les clients réguliers. Bénéficiez d'avantages exclusifs et d'un service prioritaire adapté à vos exigences.",
                plan5_order_desc: "Ce service est personnalisé selon vos besoins. Veuillez remplir le formulaire ci-dessous pour recevoir une proposition sur mesure.",
                frequent_routes: "Itinéraires fréquents",
                notify_title: "Autoriser les notifications",
                notify_desc: "Recevez des alertes lorsque votre course est acceptée.",
                notify_allow: "Autoriser"
            },
            ht: {
                order_taxi: "Kòmande taksi ou",
                different_address: "Endike yon adrès diferan pou depa",
                address_explanation: "Si ou pa vle chofè a vini chèche ou kote ou ye, aktive switch sa a pou endike yon lòt kote depa.",
                one_way: "Ale senp",
                round_trip: "Ale retou",
                now: "Kounye a",
                later: "Pita",
                order_taxi_btn: "Kòmande Taksi",
                top_drivers: "Pi bon Chofè nan Semèn nan",
                pending_orders: "Kòmand ki ap tann",
                discover_haiti: "Dekouvri Ayiti",
                citadelle_name: "Sitadèl Laferyè",
                citadelle_desc: "Fò istorik sou tèt yon mòn",
                labadee_name: "Labadee",
                labadee_desc: "Plaj sab blan li yo, dlo tèk li yo ak aktivite nòtik li yo. Li se yon destinasyon popilè pou pasaje bato kwazyè ak vakansye.",
                verrieres_name: "Moniman Vètyè",
                verrieres_desc: "Memoryal istorik batay Vètyè",
                cathedrale_name: "Katredal Okap",
                cathedrale_desc: "Bijou achitekti nan nò Ayiti",
                palais_name: "Palè San Souci",
                palais_desc: "Ansyen palè wa Henri Christophe",
                learn_more: "Plis enfòmasyon",
                services: "Sèvis abò",
                wifi_service: "Wifi gratis",
                wifi_desc: "Ou jwenn entènèt nan machin nou yo pou rete konekte.",
                water_service: "Boutey dlo disponib",
                water_desc: "Gen yon boutey dlo nan machin pou rafrechi w pandan wap vwayaje.",
                trip_history: "Istwa vwayaj",
                history_login_required: "Fonksyonalite sa a rezève pou itilizatè ki anrejistre. Tanpri konekte pou wè istwa vwayaj ou.",
                download_app: "Telechaje aplikasyon mobil nou an",
                apk_description: "Disponib sou Android, telechaje APK la pou yon eksperyans konplè.",
                download_apk: "Telechaje APK",
                login: "Koneksyon",
                id_tab: "ID",
                password_tab: "Modpas",
                signup_tab: "Enskripsyon",
                id_login_desc: "Konekte ak ID inik ou pou jwenn aksè nan kont pèmanan ou.",
                your_id: "ID ou",
                login_with_id: "Konekte ak ID mwen",
                password_login_desc: "Konekte ak imèl ou ak modpas ou.",
                email: "Imèl",
                password: "Modpas",
                login: "Konekte",
                create_account: "Kreye yon kont",
                last_name: "Non",
                first_name: "Siyati",
                confirm_password: "Konfime modpas la",
                age: "Laj",
                unique_id: "ID inik ou",
                save_id: "Sere ID sa a pou jwenn aksè nan kont ou depi nenpòt aparèy",
                save: "Anrejistre",
                password_error: "Modpas yo pa matche",
                location_access: "Aksè nan kote ou ye",
                location_desc: "Pou chofè a ka vin chèche ou egzakteman kote ou ye, nou bezwen aksè nan pozisyon ou. Si ou pito pa pataje pozisyon ou, aktive opsyon 'Endike yon adrès diferan pou depa' epi antre adrès ou manyèlman.",
                close: "Fèmen",
                accept: "Aksepte",
                driver_reviews: "Avi sou chofè a",
                download_modal_title: "Telechaje aplikasyon nou an",
                download_modal_desc: "Pou yon eksperyans pi bon, telechaje aplikasyon mobil nou an. Kòmande wout ou pi vit epi benefisye de fonksyonalite eksklizif!",
                download: "Telechaje",
                price_accepted: "Pri aksepte",
                waiting_driver: "Ap tann chofè",
                driver_onway: "Chofè an aksepte, li ap vini",
                accepted_message: "Ou te aksepte pri pou vwayaj ou. Tanpri rete pasyan pandan administrate a ap refere w ak yon chofè.",
                transferring_message: "Administrate a ap transfere w ak yon chofè. Tanpri rete pasyan.",
                onway_message: "Chofè w la an wout pou vin jwenn ou.",
                departure_placeholder: "Adrès depa",
                destination_placeholder: "Adrès destinasyon",
                back: "Retounen",
                order: "Kòmande",
                description: "Deskripsyon",
                history: "Istwa",
                visit: "Vizite",
                visit_desc: "Kòmande yon taksi pou vizite kote istorik sa a :",
                description_placeholder: "Deskripsyon pou ede chofè a rekonèt ou",
                no_pending: "Pa gen kòmand ki ap tann",
                no_history: "Ou poko fini okenn vwayaj",
                phone: "Telefòn",
                service_plans: "Plan Sèvis Nou Yo",
                plan1_title: "Course Ville à Ville",
                plan1_sub: "Pri pou detèmine",
                plan1_preview: "Vwayaje ant vil yo san tèt chaje ak sèvis konfòtab ak sekirize nou an.",
                plan2_title: "Demi-Journée",
                plan2_sub: "4 èdtan - Pri fikse",
                plan2_preview: "Ideyal pou kouri, randevou ak vizit. Chofè prive ou disponib pandan 4 èdtan.",
                plan3_title: "Journée Complète",
                plan3_sub: "8 èdtan - Pri fikse",
                plan3_preview: "Sèvis konplè pou jou chaje ou. Jwi yon chofè dedye pandan 8 èdtan.",
                plan4_title: "Élégance Night",
                plan4_sub: "Jiska 3 èdtan - Rezèvasyon sèlman",
                plan4_preview: "Pou sware espesyal ou yo. Sèvis prim ak machin segondè pou sòti nocturne ou.",
                plan5_title: "Business / VIP",
                plan5_sub: "Abònman - Pri pou detèmine",
                plan5_preview: "Solisyon ideyal pou kliyan regilye. Jwenn avantaj eksklizif ak sèvis priyorite.",
                plan1_modal: "Dites adieu aux poussières, à la chaleur, au transport en commun et au stress. Bonjour au confort grâce à Daxi, votre parcours est léger, tranquillité d'esprit avec nos chauffeurs privés expérimentés.",
                plan2_modal: "Ou ta renmen ale nan yon reyinyon maten? Oswa fè kèk kouri? Avèk Daxi tout vin fasil. Jwi yon chofè prive pandan 4 èdtan pou tout deplasman ou nan vil la.",
                plan2_order_desc: "Sèvis sa a disponib imedyatman. Tanpri ranpli fòm anba a pou rezève chofè prive ou pou 4 èdtan.",
                plan1_full: "Kous ant vil yo\nDi orevwa ak pousyè, chalè, transpò piblik ak estrès. Byenvini nan konfò gras ak Daxi, vwayaj ou vin lejè, ak lapè nan tèt ou avèk chofè prive ki gen eksperyans.\n\nKarakteristik :\nEkonomize tan : Evite reta ak pwoblèm transpò piblik\nMizik ou renmen : Chwazi anbyans vwayaj ou\nSekirite garanti : Pwoteksyon an ka gen grèv oswa pwoblèm sekirite\nLapè nan tèt ou : Vwayaje san estrès\nTravay pandan w ap vwayaje : Wifi disponib nan pifò machin yo\nNòt : Pri a fikse pa administratè a selon distans ak demann lan.\n\nKòmande sèvis sa a\nSèvis sa a disponib sou demann. Tanpri ranpli fòm ki anba a pou yon estimasyon pèsonalize.\n\nPwen depa\nVil destinasyon",
                plan5_order_desc: "Sèvis sa a pèrsonalize selon bezwen ou. Tanpri ranpli fòm anba a pou resevwa yon òf pèsonalize.",
                plan3_modal: "Ideyal pou jou chaje, vizit touristik oswa deplasman pwofesyonèl entansif. Jwi sèvis konplè pandan tout jounen an ak yon chofè dedye.",
                plan4_modal: "Pou sware espesyal ou yo, sòti ak zanmi oswa evènman nwit. Sèvis prim pou deplasman nwit an sekirite ak élégance.",
                plan5_modal: "Solisyon ideyal pou kliyan regilye. Jwenn avantaj eksklizif ak sèvis priyorite adapte a bezwen ou yo.",
                frequent_routes: "Itinéraires fréquents",
                notify_title: "Otorizasyon notifikasyon",
                notify_desc: "Resevwa alèt lè vwayaj ou aksepte.",
                notify_allow: "Otorizasyon"
            ,
            your_id_placeholder: "Antre ID ou a (4 chif)",
            email_placeholder: "Anten imel ou",
            password_placeholder: "Modpas ou",
            last_name_placeholder: "Eg: Jean",
            first_name_placeholder: "Eg: Pierre",
            phone_placeholder: "Nimewo telefòn",
            confirm_password_placeholder: "********",
            age_placeholder: "Laj ou"
            },
            en: {
                order_taxi: "Order your taxi",
                different_address: "Specify a different pickup address",
                address_explanation: "If you don't want to be picked up at your current location, toggle this switch to specify another pickup location.",
                one_way: "One way",
                round_trip: "Round trip",
                now: "Now",
                later: "Later",
                order_taxi_btn: "Order Taxi",
                top_drivers: "Top Drivers of the Week",
                pending_orders: "Pending Orders",
                discover_haiti: "Discover Haiti",
                citadelle_name: "Citadelle La Ferrière",
                citadelle_desc: "Historic fortress perched on a mountain",
                labadee_name: "Labadee",
                labadee_desc: "Paradise beaches and crystal clear waters",
                verrieres_name: "Vertières Monuments",
                verrieres_desc: "Historic memorial of the Battle of Vertières",
                cathedrale_name: "Cathedral of Cap-Haïtien",
                cathedrale_desc: "Architectural jewel of northern Haiti",
                palais_name: "Sans-Souci Palace",
                palais_desc: "Former royal palace of Henri Christophe",
                learn_more: "Learn more",
                services: "Onboard Services",
                wifi_service: "Free Wifi",
                wifi_desc: "You'll find internet in our vehicles to stay connected.",
                water_service: "Water bottle available",
                water_desc: "A water bottle is available on board to refresh you during your trip.",
                trip_history: "Trip History",
                history_login_required: "This feature is reserved for registered users. Please log in to view your trip history.",
                download_app: "Download our mobile app",
                apk_description: "Available on Android, download the APK for a complete experience.",
                download_apk: "Download APK",
                login: "Login",
                id_tab: "ID",
                password_tab: "Password",
                signup_tab: "Sign Up",
                id_login_desc: "Log in with your unique ID to access your permanent account.",
                your_id: "Your ID",
                login_with_id: "Log in with my ID",
                password_login_desc: "Log in with your email and password.",
                email: "Email",
                password: "Password",
                login: "Log in",
                create_account: "Create Account",
                last_name: "Last Name",
                first_name: "First Name",
                confirm_password: "Confirm Password",
                age: "Age",
                unique_id: "Your Unique ID",
                save_id: "Keep this ID to access your account from any device",
                save: "Save",
                password_error: "Passwords do not match",
                location_access: "Location Access",
                location_desc: "For your driver to pick you up at your exact location, we need access to your location. If you prefer not to share your location, enable the 'Specify a different pickup address' option and enter your address manually.",
                close: "Close",
                accept: "Accept",
                driver_reviews: "Driver Reviews",
                download_modal_title: "Download our app",
                download_modal_desc: "For an optimal experience, download our mobile app. Order your rides faster and enjoy exclusive features!",
                download: "Download",
                price_accepted: "Price accepted",
                waiting_driver: "Waiting for driver",
                driver_onway: "Driver on the way",
                accepted_message: "You have accepted the price for your trip. Please wait while the administrator refers you to a driver.",
                transferring_message: "The administrator is transferring you to a driver. Please wait.",
                onway_message: "Your driver will be there.",
                departure_placeholder: "Pickup address",
                destination_placeholder: "Destination address",
                back: "Back",
                order: "Order",
                description: "Description",
                history: "History",
                visit: "Visit",
                visit_desc: "Order a taxi to visit this historic site:",
                description_placeholder: "Description to help the driver recognize you",
                no_pending: "No pending orders",
                no_history: "You haven't completed any trips yet",
                phone: "Phone",
                service_plans: "Our Service Plans",
                plan1_title: "Inter-city Ride",
                plan1_sub: "Price on request",
                plan1_preview: "Travel between cities comfortably with our secure and comfortable transportation service.",
                plan2_title: "Half-Day",
                plan2_sub: "4 hours - Fixed price",
                plan2_preview: "Ideal for errands, appointments and visits. Your private driver available for 4 hours.",
                plan3_title: "Full Day",
                plan3_sub: "8 hours - Fixed price",
                plan3_preview: "Full service for busy days. Enjoy a dedicated driver for 8 hours.",
                plan4_title: "Élégance Night",
                plan4_sub: "Up to 3h - Reservation only",
                plan4_preview: "For your special evenings. Premium service with upscale vehicle for your night outs.",
                plan5_title: "Business / VIP",
                plan5_sub: "Subscription - Price on request",
                plan5_preview: "Ideal solution for regular customers. Enjoy exclusive benefits and priority service.",
                plan1_modal: "Say goodbye to dust, heat, public transport and stress. Hello comfort with Daxi — light journeys and peace of mind with our experienced private drivers.",
                plan1_order_desc: "This service is available on request. Please fill out the form below for a personalized price estimate.",
                plan1_full: "City-to-City Ride\nDi adiós al polvo, al calor, al transporte público y al estrés. Bienvenido al confort con Daxi — su viaje es suave y tranquilo con nuestros conductores privados experimentados.\n\nCaracterísticas:\nAhorre tiempo: Evite retrasos y molestias del transporte público\nMúsica a su elección: Personalice el ambiente de su viaje\nSeguridad garantizada: Protección en caso de huelga o problemas de seguridad\nTranquilidad: Viaje con calma\nTrabaje en el camino: Wifi disponible en la mayoría de los vehículos\nNota: Precio establecido por el administrador según la distancia y la demanda.\n\nReserve este servicio\nEste servicio está disponible a pedido. Complete el formulario a continuación para una estimación de precio personalizada.\n\nPunto de partida\nCiudad de destino",
                plan5_order_desc: "Este servicio se adapta a sus necesidades. Por favor complete el formulario para recibir una propuesta personalizada.",
                plan1_full: "City-to-City Ride\nSay goodbye to dust, heat, public transport, and stress. Welcome comfort with Daxi — your trip is smooth and peaceful with our experienced private drivers.\n\nFeatures:\nSave time: Avoid delays and public transport hassles\nMusic of your choice: Customize your travel mood\nGuaranteed safety: Protection in case of strike or security issues\nPeace of mind: Travel calmly\nWork on the go: Wifi available in most vehicles\nNote: Price set by the admin depending on distance and demand.\n\nBook this service\nThis service is available on request. Please fill out the form below for a personalized price estimate.\n\nDeparture point\nDestination city",
                plan5_order_desc: "This service is tailored to your needs. Please fill out the form below to receive a personalized proposal.",
                plan2_modal: "Need to attend a morning meeting or run errands? With Daxi it's easy. Enjoy a private driver for 4 hours for city travel.",
                plan3_modal: "Perfect for busy days, tourist visits or intensive business travel. Enjoy full-day service with a dedicated driver.",
                plan4_modal: "For your special evenings and night outs. Premium service with an upscale vehicle for safe and elegant night travel.",
                plan4_feat_hours: "Your private driver up to 3AM",
                plan4_feat_city: "Only within the city",
                plan4_feat_stops: "Unlimited stops",
                plan4_feat_vip: "VIP service with upscale vehicle",
                plan4_feat_reserve: "Advance reservation only",
                plan4_price: "Price: 75 USD",
                plan4_date_label: "Evening date",
                plan4_time_label: "Start time",
                plan4_order_desc: "This service requires advance booking. Fill the form below to reserve your night VIP service.",
                plan5_modal: "Ideal solution for regular customers and businesses with ongoing transport needs. Enjoy priority service and exclusive benefits.",
                frequent_routes: "Frequent routes",
                notify_title: "Enable notifications",
                notify_desc: "Get alerts when your ride is accepted.",
                notify_allow: "Allow"
            ,
            your_id_placeholder: "Enter your 4-digit ID",
            email_placeholder: "Your email address",
            password_placeholder: "Your password",
            last_name_placeholder: "Eg: Jean",
            first_name_placeholder: "Eg: Pierre",
            phone_placeholder: "Phone number",
            confirm_password_placeholder: "********",
            age_placeholder: "Your age"
            },
            es: {
                order_taxi: "Ordenar su taxi",
                different_address: "Especificar una dirección de recogida diferente",
                address_explanation: "If you don't want to be picked up at your current location, toggle this switch to specify another pickup location.",
                one_way: "Solo ida",
                round_trip: "Ida y vuelta",
                now: "Ahora",
                later: "Más tarde",
                order_taxi_btn: "Ordenar Taxi",
                top_drivers: "Mejores Conductores de la Semana",
                pending_orders: "Órdenes Pendientes",
                discover_haiti: "Descubrir Haití",
                citadelle_name: "Ciudadela La Ferrière",
                citadelle_desc: "Fortaleza histórica en la cima de una montaña",
                labadee_name: "Labadee",
                labadee_desc: "Playas paradisíacas and aguas cristalinas",
                verrieres_name: "Monumentos de Vertières",
                verrieres_desc: "Memorial histórico de la Batalla de Vertières",
                cathedrale_name: "Catedral de Cap-Haïtien",
                cathedrale_desc: "Joya arquitectónica del norte de Haití",
                palais_name: "Palacio Sans Souci",
                palais_desc: "Antiguo palacio real de Henri Christophe",
                learn_more: "Saber más",
                services: "Servicios a bordo",
                wifi_service: "Wifi gratis",
                wifi_desc: "Encontrará internet en nuestros vehículos para mantenerse conectado.",
                water_service: "Botella de agua disponible",
                water_desc: "Una botella de agua está disponible a bordo para refrescarse durante su viaje.",
                trip_history: "Historial de Viajes",
                history_login_required: "Esta función está reservada para usuarios registrados. Inicie sesión para ver su historial de viajes.",
                download_app: "Descargue nuestra aplicación móvil",
                apk_description: "Disponible en Android, descargue el APK para una experiencia completa.",
                download_apk: "Descargar APK",
                login: "Iniciar sesión",
                id_tab: "ID",
                password_tab: "Contraseña",
                signup_tab: "Registro",
                id_login_desc: "Inicie sesión con su ID único para acceder à su cuenta permanente.",
                your_id: "Su ID",
                login_with_id: "Iniciar sesión con mi ID",
                password_login_desc: "Inicie sesión con su correo electrónico and contraseña.",
                email: "Correo electrónico",
                password: "Contraseña",
                login: "Iniciar sesión",
                create_account: "Crear cuenta",
                last_name: "Apellido",
                first_name: "Nombre",
                confirm_password: "Confirmar contraseña",
                age: "Edad",
                unique_id: "Su ID único",
                save_id: "Guarde este ID para acceder a su cuenta desde cualquier dispositivo",
                save: "Guardar",
                password_error: "Las contraseñas no coinciden",
                location_access: "Acceso a la ubicación",
                location_desc: "Para que su conductor lo recoja en su ubicación exacta, necesitamos acceso a su ubicación. Si prefiere no compartir su ubicación, active la opción 'Especificar una dirección de recogida diferente' e ingrese su dirección manualmente.",
                close: "Cerrar",
                accept: "Aceptar",
                driver_reviews: "Opiniones del conductor",
                download_modal_title: "Descargue nuestra aplicación",
                download_modal_desc: "Para una experiencia óptima, descargue nuestra aplicación móvil. ¡Ordene sus viajes más rápido and disfrute de funciones exclusivas!",
                download: "Descargar",
                price_accepted: "Precio aceptado",
                waiting_driver: "Esperando al conductor",
                driver_onway: "Conductor en camino",
                accepted_message: "Ha aceptado el precio de su viaje. Por favor, espere mientras el administrador lo refiere a un conductor.",
                transferring_message: "El administrador lo está transfiriendo a un conductor. Por favor espere.",
                onway_message: "Su conductor está en camino a su ubicación.",
                departure_placeholder: "Dirección de recogida",
                destination_placeholder: "Dirección de destino",
                back: "Volver",
                order: "Ordenar",
                description: "Descripción",
                history: "Historia",
                visit: "Visitar",
                visit_desc: "Ordene un taxi para visitar este sitio histórico:",
                description_placeholder: "Descripción para ayudar al conductor a reconocerlo",
                no_pending: "No hay pedidos pendientes",
                no_history: "Aún no ha completado ningún viaje",
                phone: "Teléfono",
                service_plans: "Nuestros Planes de Servicio",
                plan1_title: "Viaje Interurbano",
                plan1_sub: "Precio a determinar",
                plan1_preview: "Viaja entre ciudades con comodidad con nuestro servicio de transporte seguro y cómodo.",
                plan2_title: "Medio Día",
                plan2_sub: "4 horas - Precio fijo",
                plan2_preview: "Ideal para diligencias, citas y visitas. Su chofer privado disponible por 4 horas.",
                plan3_title: "Día Completo",
                plan3_sub: "8 horas - Precio fijo",
                plan3_preview: "Servicio completo para tus días ocupados. Disfruta de un conductor dedicado durante 8 horas.",
                plan4_title: "Élégance Night",
                plan4_sub: "Hasta 3h - Solo con reserva",
                plan4_preview: "Para tus noches especiales. Servicio premium con vehículo de alta gama para tus salidas nocturnas.",
                plan5_title: "Business / VIP",
                plan5_sub: "Suscripción - Precio a determinar",
                plan5_preview: "Solución ideal para clientes habituales. Benefíciate de ventajas exclusivas y servicio prioritario.",
                plan1_modal: "Di adiós al polvo, el calor, el transporte público y el estrés. Hola comodidad con Daxi: viajes ligeros y tranquilidad con nuestros conductores privados experimentados.",
                plan2_modal: "¿Necesita asistir a una reunión por la mañana o hacer recados? Con Daxi es fácil. Disfrute de un conductor privado durante 4 horas para desplazamientos urbanos.",
                plan3_modal: "Perfecto para días ocupados, visitas turísticas o viajes de negocios intensivos. Disfrute de un servicio de jornada completa con un conductor dedicado.",
                plan4_modal: "Para sus noches especiales y salidas nocturnas. Servicio premium con vehículo de alta gama para viajes nocturnos seguros y elegantes.",
                plan4_feat_hours: "Su conductor privado hasta las 3AM",
                plan4_feat_city: "Solo dentro de la ciudad",
                plan4_feat_stops: "Paradas ilimitadas",
                plan4_feat_vip: "Servicio VIP con vehículo de alta gama",
                plan4_feat_reserve: "Reserva previa solamente",
                plan4_price: "Precio: 75 USD",
                plan4_date_label: "Fecha de la noche",
                plan4_time_label: "Hora de inicio",
                plan4_order_desc: "Este servicio requiere reserva previa. Complete el formulario a continuación para reservar su servicio VIP nocturno.",
                plan5_modal: "Solución ideal para clientes habituales o empresas con necesidades de transporte continuas. Disfrute de servicio prioritario y beneficios exclusivos.",
                frequent_routes: "Rutas frecuentes",
                notify_title: "Permitir notificaciones",
                notify_desc: "Reciba alertas cuando su viaje sea aceptado.",
                notify_allow: "Permitir"
            ,
            your_id_placeholder: "Ingrese su ID de 4 dígitos",
            email_placeholder: "Su correo electrónico",
            password_placeholder: "Su contraseña",
            last_name_placeholder: "Ej: Jean",
            first_name_placeholder: "Ej: Pierre",
            phone_placeholder: "Número de teléfono",
            confirm_password_placeholder: "********",
            age_placeholder: "Su edad"
            },
            fr_extra: {
                order_service: "Commander ce service",
                order: "Commander",
                plan1_modal: "Pour vos trajets interurbains en toute tranquillité. Ce service est destiné à ceux qui souhaitent voyager d’une ville à une autre en toute sécurité et confort.",
                plan1_order_desc: "Indiquez votre ville de départ, d’arrivée et l’heure souhaitée pour le trajet.",
                plan1_full: "Course Ville à Ville\nPour vos trajets interurbains en toute tranquillité. Ce service est destiné à ceux qui souhaitent voyager d’une ville à une autre en toute sécurité et confort.\n\nCaractéristiques :\nChauffeur privé pour trajets interurbains\nDépart et arrivée personnalisés\nVéhicule confortable et climatisé\nPrix selon la destination\nRéservation recommandée\n\nCommander ce service\nIndiquez votre ville de départ, d’arrivée et l’heure souhaitée pour le trajet.",
                plan2_modal: "Pour vos rendez-vous ou déplacements de la journée. Ce service vous offre un chauffeur privé pendant 4 heures avec une grande flexibilité.",
                plan2_order_desc: "Choisissez votre heure de départ et précisez vos arrêts si besoin.",
                plan3_modal: "Pour vos journées bien remplies, en toute liberté. Ce service met à votre disposition un chauffeur privé pendant 8 heures.",
                plan3_order_desc: "Indiquez l’heure de début et les lieux à visiter.",
                plan4_modal: "Pour vos soirées spéciales ou événements de nuit. Service premium pour des déplacements nocturnes sécurisés et élégants.",
                plan4_order_desc: "Remplissez le formulaire ci-dessous pour réserver votre service VIP.",
                plan5_modal: "Pour les clients réguliers et les besoins particuliers. Ce service est conçu pour ceux qui recherchent un chauffeur dédié avec tous les avantages VIP.",
                plan5_order_desc: "Contactez le service client pour choisir votre formule."
            },
            ht_extra: {
                order_service: "Kòmande sèvis sa a",
                order: "Kòmande",
                plan1_modal: "Pou vwayaj ant vil yo, san tèt chaje. Sèvis sa a fèt pou moun k ap deplase soti nan yon vil pou ale nan yon lòt, ak tout sekirite ak konfò.",
                plan1_order_desc: "Antre vil depa ak vil arive w, ansanm ak lè ou swete pati.",
                plan1_full: "Course Ville à Ville\nPou vwayaj ant vil yo, san tèt chaje. Sèvis sa a fèt pou moun k ap deplase soti nan yon vil pou ale nan yon lòt, ak tout sekirite ak konfò.\n\nKarakteristik :\nChofè prive pou vwayaj ant vil\nDepa ak arive pèsonalize\nMachin konfòtab ak klim\nPri depann de destinasyon an\nRekòmande pou fè rezèvasyon\n\nKòmande sèvis sa a\nAntre vil depa ak vil arive w, ansanm ak lè ou swete pati.",
                plan2_modal: "Pou randevou, vizit oswa kouri pandan jounen an. Sèvis sa a ofri w yon chofè prive pou 4 èdtan, ak fleksibilite sou kote ou vle ale.",
                plan2_order_desc: "Chwazi lè depa w epi bay detay sou kote ou pral si sa nesesè.",
                plan3_modal: "Pou jounen chaje w yo, ak tout libète. Sèvis sa a mete yon chofè a dispozisyon ou pandan 8 èdtan pou tout aktivite w.",
                plan3_order_desc: "Bay lè ou vle kòmanse ak kote ou pral vizite.",
                plan4_modal: "Pou sware espesyal ou yo, sòti oswa evènman nwit. Sèvis prim sa a asire ou deplase nan sekirite ak élégance.",
                plan4_order_desc: "Ranpli fòm ki anba a pou fè rezèvasyon VIP ou.",
                plan5_modal: "Pou kliyan regilye ak bezwen espesyal. Sèvis sa a fèt pou moun ki bezwen yon chofè sou baz regilye ak tout avantaj VIP.",
                plan5_order_desc: "Kontakte sèvis kliyan pou diskite sou plan ki adapte ak bezwen ou."
            },
            en_extra: {
                order_service: "Book this service",
                order: "Book",
                plan1_modal: "For smooth travel between cities. This service is designed for people who need to move from one city to another safely and comfortably.",
                plan1_order_desc: "Enter your departure city, destination, and preferred departure time.",
                plan1_full: "Inter-city Ride\nFor smooth travel between cities. This service is designed for people who need to move from one city to another safely and comfortably.\n\nFeatures:\nPrivate driver for intercity trips\nPersonalized pickup and drop-off\nComfortable, air-conditioned vehicle\nPrice depends on destination\nBooking recommended\n\nBook this service\nEnter your departure city, destination, and preferred departure time.",
                plan2_modal: "For meetings or errands during the day. This service gives you a private driver for 4 hours with complete flexibility.",
                plan2_order_desc: "Choose your start time and provide stops if necessary.",
                plan3_modal: "For your busy days, with total freedom. This service gives you a private driver for 8 hours for any type of activity.",
                plan3_order_desc: "Enter your start time and the places you plan to visit.",
                plan4_modal: "For your special nights or evening events. A premium service for safe and elegant night rides.",
                plan4_order_desc: "Fill out the form below to book your VIP night ride.",
                plan5_modal: "For regular clients and special needs. This service is designed for those who need a dedicated driver with full VIP benefits.",
                plan5_order_desc: "Contact customer support to customize your subscription."
            },
            es_extra: {
                order_service: "Reservar este servicio",
                order: "Reservar",
                plan1_modal: "Para tus viajes entre ciudades sin estrés. Este servicio está diseñado para quienes necesitan trasladarse de una ciudad a otra con total seguridad y comodidad.",
                plan1_order_desc: "Indica tu ciudad de salida, destino y hora deseada del viaje.",
                plan1_full: "Viaje Interurbano\nPara tus viajes entre ciudades sin estrés. Este servicio está diseñado para quienes necesitan trasladarse de una ciudad a otra con total seguridad y comodidad.\n\nCaracterísticas:\nConductor privado para viajes interurbanos\nSalida y llegada personalizadas\nVehículo cómodo y con aire acondicionado\nPrecio según destino\nSe recomienda reservar\n\nReservar este servicio\nIndica tu ciudad de salida, destino y hora deseada del viaje.",
                plan2_modal: "Para tus citas o gestiones durante el día. Este servicio te ofrece un conductor privado por 4 horas con total flexibilidad.",
                plan2_order_desc: "Elige la hora de inicio e indica las paradas si es necesario.",
                plan3_modal: "Para tus días ocupados, con total libertad. Este servicio te ofrece un conductor privado durante 8 horas.",
                plan3_order_desc: "Indica la hora de inicio y los lugares que deseas visitar.",
                plan4_modal: "Para tus noches especiales o eventos nocturnos. Servicio premium para desplazamientos seguros y elegantes.",
                plan4_order_desc: "Completa el formulario a continuación para reservar tu servicio VIP nocturno.",
                plan5_modal: "Para clientes habituales y necesidades especiales. Este servicio está diseñado para quienes necesitan un conductor dedicado con beneficios VIP.",
                plan5_order_desc: "Contacta con atención al cliente para personalizar tu plan."
            }
        };

        // Mettre à jour les traductions
        function updateLanguage(lang) {
            currentLanguage = lang;
            // Merge any extra groups (like en_extra/fr_extra) into the main translations for lookup convenience
            const merged = Object.assign({}, translations[lang] || {});
            Object.keys(translations).forEach(k => {}); // noop to avoid linter concerns
            // copy any lang_extra keys
            const extraKey = lang + '_extra';
            if (translations[extraKey]) {
                // merge into the local merged view used for DOM updates
                Object.assign(merged, translations[extraKey]);
                // also persist the extra keys into translations[lang] so other
                // code that directly reads translations[currentLanguage].key
                // (for example modal builders) will find these keys too.
                translations[lang] = Object.assign(translations[lang] || {}, translations[extraKey]);
            }

            document.querySelectorAll('[data-translate]').forEach(el => {
                const key = el.getAttribute('data-translate');
                if (merged && merged[key]) {
                    if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                        el.placeholder = merged[key];
                    } else {
                        el.textContent = merged[key];
                    }
                }
            });
            
            localStorage.setItem('preferredLanguage', lang);
        }

        // Notification banner handling
        function showNotificationBannerIfNeeded() {
            try {
                const stored = localStorage.getItem('notifyPermission');
                if (stored === 'granted' || stored === 'denied') return; // nothing to do
                const banner = document.getElementById('notifyBanner');
                if (!banner) return;
                banner.style.display = 'block';
                document.getElementById('allowNotifyBtn').addEventListener('click', function(){
                    Notification.requestPermission().then(p => {
                        localStorage.setItem('notifyPermission', p);
                        banner.style.display = 'none';
                        if (p === 'granted') {
                            try { new Notification('Daxi', { body: 'Notifications activées. Vous recevrez des alertes.' }); } catch(e){}
                        }
                    }).catch(e=>{ localStorage.setItem('notifyPermission','denied'); banner.style.display='none'; });
                });
                document.getElementById('laterNotifyBtn').addEventListener('click', function(){ banner.style.display='none'; });
            } catch(e) { /* ignore on insecure contexts */ }
        }

        // ===========================================
        // GESTION DE L'INTERFACE UTILISATEUR
        // ===========================================

        // Afficher le nom d'utilisateur
        function displayUserName() {
            const userName = localStorage.getItem('userName');
            const userId = localStorage.getItem('userId');
            const userType = localStorage.getItem('userType');
            
            if (userName && userId) {
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('userDisplay').classList.remove('hidden');
                // Show only the given/first name to keep navbar compact
                const firstName = (userName || '').split(' ')[0] || userName;
                document.getElementById('userName').textContent = firstName;
                // Keep full id available in dataset for modals/tools but hide visually
                document.getElementById('userDisplay').dataset.userid = userId;
                
                if (userType === 'unsave') {
                    document.getElementById('userName').textContent = 'Invité';
                }
                
                // Charger les commandes non confirmées après connexion
                loadUnconfirmedRequests();
                loadAllPendingRequests();
                loadTripHistory();
            }
        }

        // Déconnexion de l'utilisateur
        function logoutUser() {
            const userId = localStorage.getItem('userId');
            const userType = localStorage.getItem('userType');
            
            if (userType === 'unsave') {
                const unsaveMemberRef = database.ref('unsave_member');
                unsaveMemberRef.orderByChild('userId').equalTo(userId).once('value', snapshot => {
                    if (snapshot.exists()) {
                        snapshot.forEach(child => {
                            child.ref.remove();
                        });
                    }
                });
            }
            
            localStorage.removeItem('userName');
            localStorage.removeItem('userId');
            localStorage.removeItem('userType');
            
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('userDisplay').classList.add('hidden');
            
            // Vider les commandes non confirmées
            document.getElementById('unconfirmedRequestsContainer').innerHTML = '';
            document.getElementById('unconfirmed-request').style.display = 'none';
            
            // Cacher les sections historiques
            document.getElementById('all-pending-requests').style.display = 'none';
            document.getElementById('tripHistorySection').style.display = 'none';
        }

        // ===========================================
        // GÉNÉRATION DE CONTENU DYNAMIQUE
        // ===========================================

        // Générer le contenu pour une demande en attente
        function generatePendingContent(orderId, pickup, destination) {
            return `
                <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-8 h-8 flex items-center justify-center">
                                <i class="ri-time-line text-orange-500 ri-lg"></i>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-orange-800" data-translate="pending_request">Demande en attente</p>
                                <p class="text-xs text-orange-600" data-translate="searching_driver">Recherche d'un chauffeur disponible...</p>
                            </div>
                        </div>
                        <div>
                            <button class="cancel-order-btn bg-orange-500 text-white px-4 py-1 !rounded-button text-sm font-medium cursor-pointer btn-glow" data-order-id="${orderId}" data-translate="cancel">
                                Annuler
                            </button>
                        </div>
                    </div>
                    <div class="order-details">
                        <p><strong data-translate="departure">Départ:</strong> ${pickup || 'Position actuelle'}</p>
                        <p><strong data-translate="destination">Destination:</strong> ${destination}</p>
                    </div>
                </div>
            `;
        }

        // Générer le contenu pour un prix proposé
        function generatePriceContent(orderId, price, pickup, destination) {
            return `
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-8 h-8 flex items-center">
                                                           <i class="ri-money-euro-circle-line text-blue-500 ri-lg"></i>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-blue-800" data-translate="proposed_price">Prix proposé</p>
                                <p class="text-lg font-bold text-blue-700">${price} $</p>
                            </div>
                        </div>
                            <div class="flex gap-2">
                            <button type="button" data-action="accept-price" data-order-id="${orderId}" class="gold-button px-4 py-1 !rounded-button font-medium cursor-pointer btn-glow" data-translate="accept">
                                Accepter
                            </button>
                            <button type="button" data-action="reject-price" data-order-id="${orderId}" class="bg-gray-200 text-gray-800 px-4 py-1 !rounded-button font-medium cursor-pointer" data-translate="reject">
                                Refuser
                            </button>
                        </div>
                    </div>
                    <div class="order-details mt-3">
                        <p class="mt-3"><strong data-translate="departure">Départ:</strong> ${pickup || 'Position actuelle'}</p>
                        <p><strong data-translate="destination">Destination:</strong> ${destination}</p>
                        <p class="text-sm text-gray-500 mt-2" data-translate="price_explanation">Un administrateur a fixé ce prix pour votre trajet.</p>
                    </div>
                </div>
            `;
        }

        // Générer le contenu pour une commande acceptée (prix confirmé) mais sans
        // chauffeur attribué encore. This is different from fully confirmed/assigned.
        function generateAcceptedContent(orderId, price, pickup, destination) {
            return `
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-8 h-8 flex items-center">
                                <i class="ri-check-double-line text-blue-500 ri-lg"></i>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-blue-800">Commande acceptée</p>
                                <p class="text-xs text-blue-600">Prix confirmé — en attente d'attribution d'un chauffeur</p>
                            </div>
                        </div>
                    </div>
                    <div class="order-details mt-3">
                        <p><strong data-translate="departure">Départ:</strong> ${pickup || 'Position actuelle'}</p>
                        <p><strong data-translate="destination">Destination:</strong> ${destination}</p>
                        <p class="text-lg font-bold text-blue-700 mt-2">${price} $</p>
                    </div>
                </div>
            `;
        }

        // Générer le contenu pour un transfert en cours
        function generateTransferringContent(orderId, pickup, destination) {
            return `
                <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-8 h-8 flex items-center justify-center">
                                <i class="ri-user-search-line text-purple-500 ri-lg"></i>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-purple-800" data-translate="transferring_request">Transfert en cours</p>
                                <p class="text-xs text-purple-600" data-translate="transferring_driver">Recherche d'un chauffeur disponible...</p>
                            </div>
                        </div>
                    </div>
                    <div class="order-details mt-3">
                        <p><strong data-translate="departure">Départ:</strong> ${pickup || 'Position actuelle'}</p>
                        <p><strong data-translate="destination">Destination:</strong> ${destination}</p>
                        <p class="text-sm text-purple-500 mt-2" data-translate="transferring_message">L'administrateur est en train de vous transférer à un chauffeur.</p>
                    </div>
                </div>
            `;
        }

        // Générer le contenu pour une commande confirmée
        function generateConfirmedContent(orderId, pickup, destination, driverName, driverPhoto, driverPhone, status = 'pending', orderObj = null) {
            let statusText, statusClass, statusIcon, statusDescription;
            
            switch (status) {
                case 'here':
                    statusText = 'Chauffeur arrivé !';
                    statusClass = 'status-here';
                    statusIcon = 'ri-checkbox-circle-line text-green-500';
                    statusDescription = 'Votre chauffeur est arrivé à votre position.';
                    break;
                case 'finished':
                    statusText = 'Trajet terminé';
                    statusClass = 'status-finished';
                    statusIcon = 'ri-checkbox-circle-line text-blue-500';
                    statusDescription = 'Votre trajet est terminé.';
                    break;
                case 'accepted':
                    statusText = 'Prix accepté';
                    statusClass = 'status-accepted';
                    statusIcon = 'ri-check-double-line text-green-500';
                    statusDescription = 'Vous avez accepté le prix. Nous vous référons à un chauffeur.';
                    break;
                case 'transferring':
                    statusText = 'Transfert en cours';
                    statusClass = 'status-transferring';
                    statusIcon = 'ri-user-search-line text-purple-500';
                    statusDescription = 'L\'administrateur est en train de vous transférer à un chauffeur.';
                    break;
                case 'onway':
                    statusText = 'Chauffeur en route';
                    statusClass = 'status-onway';
                    statusIcon = 'ri-roadster-line text-orange-500';
                    statusDescription = 'Votre chauffeur sera là.';
                    break;
                default: // 'pending'
                    statusText = 'Commande confirmée !';
                    statusClass = 'status-pending';
                    statusIcon = 'ri-check-line text-green-500';
                    // Use a neutral message when the driver has not yet been assigned.
                    statusDescription = 'Commande acceptée — en attente d\'attribution d\'un chauffeur.';
            }

            // If a driver is already attached to this confirmed order, show a
            // clear assigned/accepted message instead of "en attente". If the
            // order has a scheduled time in the future, tell the client when
            // the chauffeur will arrive; if it's for now, indicate the driver
            // is en route.
            if (driverName) {
                // Determine scheduled timestamp from available order fields
                function getScheduledTimestamp(o) {
                    try {
                        if (!o) return null;
                        if (typeof o.scheduledAt === 'number') return Number(o.scheduledAt);
                        if (o.date && o.time) {
                            const dt = new Date(o.date + ' ' + o.time);
                            if (!isNaN(dt.getTime())) return dt.getTime();
                        }
                        if (o.time && !isNaN(Date.parse(o.time))) {
                            const dt = new Date(o.time);
                            if (!isNaN(dt.getTime())) return dt.getTime();
                        }
                        // Try to parse from description (simple hh:mm capture)
                        if (o.description && typeof o.description === 'string') {
                            const m = o.description.match(/(\d{1,2}:\d{2})/);
                            if (m && m[1]) {
                                const parts = m[1].split(':').map(x => parseInt(x,10));
                                const now = new Date();
                                const dt = new Date(now.getFullYear(), now.getMonth(), now.getDate(), parts[0], parts[1] || 0, 0, 0);
                                if (!isNaN(dt.getTime())) return dt.getTime();
                            }
                        }
                        return null;
                    } catch(e) { return null; }
                }

                const scheduledAt = getScheduledTimestamp(orderObj);
                const now = Date.now();
                if (scheduledAt && scheduledAt > now + 60*1000) {
                    // Future pickup: tell the user when the driver will arrive
                    const d = new Date(scheduledAt);
                    const hh = String(d.getHours()).padStart(2,'0');
                    const mm = String(d.getMinutes()).padStart(2,'0');
                    statusText = 'Chauffeur assigné';
                    statusClass = 'status-onway';
                    statusIcon = 'ri-user-check-line text-green-500';
                    statusDescription = `Le chauffeur sera là à ${hh}:${mm}.`;
                } else {
                    // Immediate or near-immediate pickup: driver en route
                    statusText = 'Chauffeur en route';
                    statusClass = 'status-onway';
                    statusIcon = 'ri-roadster-line text-orange-500';
                    statusDescription = 'Votre chauffeur est en route.';
                }
            }
            
            return `
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-8 h-8 flex items-center justify-center">
                                <i class="${statusIcon} ri-lg"></i>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-green-800">${statusText}</p>
                                <p class="text-xs text-green-600">${statusDescription}</p>
                            </div>
                        </div>
                        <div class="${statusClass} status-indicator">${statusText}</div>
                    </div>
                    <div class="order-details mt-3">
                        ${driverName ? `
                            <div class="driver-info">
                                <img src="${driverPhoto}" alt="Photo du chauffeur" class="driver-photo">
                                <div class="driver-details">
                                    <p class="driver-name">${driverName}</p>
                                    <p><strong data-translate="phone">Téléphone:</strong> ${driverPhone || "06 12 34 56 78"}</p>
                                </div>
                            </div>
                        ` : ''}
                        ${driverPhone ? `
                            <div class="mt-3">
                                <a class="w-full block text-center green-button py-2 rounded-lg font-semibold" href="https://wa.me/${String(driverPhone).replace(/\D+/g,'').replace(/^0+/, '')}" target="_blank" rel="noopener noreferrer">Contacter le chauffeur</a>
                            </div>
                        ` : ''}
                        <p class="mt-3"><strong data-translate="departure">Départ:</strong> ${pickup || 'Position actuelle'}</p>
                        <p><strong data-translate="destination">Destination:</strong> ${destination || 'Destination inconnue'}</p>
                        <p class="text-sm text-gray-500 mt-2">${statusDescription}</p>
                        ${status === 'finished' ? `
                            <div class="mt-4">
                                <button id="closeFinishedBtn" class="w-full gold-button py-3 !rounded-button font-semibold btn-glow" data-translate="close_finished">
                                    Fermer
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // ===========================================
        // GESTION DES COMMANDES
    // Empreinte de la dernière commande créée localement pour éviter les doublons
    let lastLocalOrderFingerprint = null;
    let lastLocalOrderTimestamp = 0;
        // ===========================================

        // Charger toutes les commandes en attente
    // Plans that have a known fixed price and therefore can be
    // auto-accepted (priceConfirmed = true) when created or when a price
    // appears. Non-fixed plans require the client to explicitly accept
    // the admin-set price.
    const FIXED_PLAN_IDS = ['2','3','4'];

    async function loadAllPendingRequests() {
            const userId = localStorage.getItem('userId');
            const userType = localStorage.getItem('userType');
            const guestId = localStorage.getItem('guestId') || null;
            // Prefer guestIp stored locally (persists across sessions) otherwise fetch
            let ip = localStorage.getItem('guestIp') || null;
            if (!ip) {
                ip = await getUserIP();
            }

            const pendingRequestsContainer = document.getElementById('pendingRequestsContainer');
            const allPendingSection = document.getElementById('all-pending-requests');
            pendingRequestsContainer.innerHTML = '';

            // Si aucune info disponible pour retrouver des commandes, masquer la section
            if (!userId && !userType && !guestId && !ip) {
                allPendingSection.style.display = 'none';
                pendingRequestsContainer.innerHTML = '';
                return;
            }

            const tables = ['commande', 'commande_unconfirmed', 'commande_transfered', 'commande_confirmed'];
            // Utiliser un Map pour stocker les commandes par leur clé unique
            const pendingRequestsMap = new Map();
            
            const promises = tables.map(table => {
                let query;
                if (userType === 'save') {
                    query = database.ref(table).orderByChild('userId').equalTo(userId);
                } else if (userType === 'unsave') {
                    // 'unsave' users have a saved userId mapping in unsave_member
                    query = database.ref(table).orderByChild('userId').equalTo(userId);
                } else {
                    // Pour les invités, on préfère guestId si existant, sinon on utilise l'IP
                    if (guestId) {
                        query = database.ref(table).orderByChild('guestId').equalTo(guestId);
                    } else {
                        query = database.ref(table).orderByChild('ip').equalTo(ip);
                    }
                }
                return query.once('value');
            });
            
            try {
                const snapshots = await Promise.all(promises);
                
                // Each snapshot corresponds to the table in the same index as `tables`
                // Collect snapshots into the map with deduplication.
                // We iterate in order of `tables` so earlier tables get priority when duplicates exist.
                snapshots.forEach((snapshot, idx) => {
                    const table = tables[idx];
                    if (snapshot && snapshot.exists()) {
                        snapshot.forEach(child => {
                            const order = child.val();
                            // Skip finished orders
                            if (order.status === 'finished') return;

                            // Treat orders in commande_unconfirmed that already have a price
                            // as accepted (priceConfirmed=true). Do NOT move them to
                            // 'commande_confirmed' — they should remain unassigned until
                            // an admin actually assigns a driver. We'll render them using
                            // the accepted UI when appropriate.
                            try {
                                if (table === 'commande_unconfirmed' && order && typeof order.price === 'number' && !order.priceConfirmed) {
                                    // Only auto-confirm prices for known fixed-price plans.
                                    // If the admin set a price for a non-fixed plan, leave
                                    // it unconfirmed so the client can accept/reject.
                                    const svcPlan = order.servicePlan || order.planId || null;
                                    const isFixed = svcPlan && FIXED_PLAN_IDS.includes(String(svcPlan));
                                    if (isFixed) {
                                        try { database.ref('commande_unconfirmed/' + child.key).update({ priceConfirmed: true }); } catch(e){}
                                        order.priceConfirmed = true;
                                    }
                                    order.table = 'commande_unconfirmed';
                                } else if (table === 'commande_unconfirmed' && order && order.priceConfirmed) {
                                    order.table = 'commande_unconfirmed';
                                }
                            } catch(e) { /* non-fatal */ }

                            // Attach the firebase key if available so we can use it later
                            const firebaseKey = child.key || '';

                            // Create a stable fingerprint for deduplication
                            const orderKey = generateOrderKey({ ...order, key: firebaseKey });

                            // If we already have an entry for this fingerprint, keep the one from
                            // the earlier table (since we iterate in priority order)
                            if (!pendingRequestsMap.has(orderKey)) {
                                pendingRequestsMap.set(orderKey, { ...order, key: firebaseKey, table });
                            }
                        });
                    }
                });
                
                if (pendingRequestsMap.size > 0) {
                    // Afficher la section (et la classe qui révèle le titre) et vider avant insertion
                    allPendingSection.style.display = 'block';
                    allPendingSection.classList.add('show-heading');
                    pendingRequestsContainer.innerHTML = '';
                    // Afficher chaque commande du Map
                    // Identify currently shown single pendingRequest (top of page) to avoid duplicate
                    const pendingSection = document.getElementById('pending-request');
                    const topDisplayedOrderId = pendingSection ? pendingSection.dataset.orderId : null;
                    // Compute a simple short key for the top displayed order based on pickup/destination
                    let topShortKey = null;
                    if (pendingSection) {
                        try {
                            const details = pendingSection.querySelector('.order-details');
                            if (details) {
                                const ps = details.querySelectorAll('p');
                                let pickupText = '';
                                let destText = '';
                                ps.forEach(p => {
                                    const txt = (p.textContent || '').trim();
                                    if (/depart|départ|departure/i.test(txt)) {
                                        pickupText = txt.split(':').slice(1).join(':').trim();
                                    }
                                    if (/destination/i.test(txt)) {
                                        destText = txt.split(':').slice(1).join(':').trim();
                                    }
                                });
                                topShortKey = `${normalizeString(pickupText)}|${normalizeString(destText)}`;
                            }
                        } catch(e) { topShortKey = null; }
                    }

                    // Before rendering: remove any stale DOM nodes whose firebase key
                    // is not present in the current combined snapshot. This ensures
                    // that when admin moves an order between tables the old
                    // representation is removed.
                    const presentKeys = new Set();
                    pendingRequestsMap.forEach((o) => { if (o && o.key) presentKeys.add(o.key); });
                    // Remove stale nodes
                    pendingRequestsContainer.querySelectorAll('[data-order-id]').forEach(node => {
                        const k = node.getAttribute('data-order-id');
                        if (k && !presentKeys.has(k)) {
                            node.remove();
                        }
                    });

                    pendingRequestsMap.forEach((order, orderKey) => {
                        // ensure data-table is available on the order object for rendering
                        // so action buttons can target the correct DB table later
                        if (!order.table) order.table = 'commande';
                        // Skip if this order is the same currently shown in the single pending area by firebase key
                        if (order.key && topDisplayedOrderId && order.key === topDisplayedOrderId) return;
                        // Skip if this fingerprint matches a very recent local order (we already display it)
                        if (lastLocalOrderFingerprint && orderKey === lastLocalOrderFingerprint) return;
                        // Skip if the pickup+destination match the top single pending display (avoid duplicate visual)
                        if (topShortKey) {
                            const orderShortKey = `${normalizeString(order.pickup || '')}|${normalizeString(order.destination || '')}`;
                            if (orderShortKey === topShortKey) return;
                        }
                        let card;
                        if (order.table === 'commande') {
                            card = generatePendingContent(
                                order.key,
                                order.pickup,
                                order.destination
                            );
                        } else if (order.table === 'commande_unconfirmed') {
                            // If the unconfirmed entry has a confirmed price, render it as
                            // an accepted order; otherwise render the price proposal UI.
                            if (order.priceConfirmed) {
                                card = generateAcceptedContent(
                                    order.key,
                                    order.price,
                                    order.pickup,
                                    order.destination
                                );
                            } else {
                                card = generatePriceContent(
                                    order.key, 
                                    order.price,
                                    order.pickup,
                                    order.destination
                                );
                            }
                        } else if (order.table === 'commande_transfered') {
                            card = generateTransferringContent(
                                order.key,
                                order.pickup,
                                order.destination
                            );
                        } else if (order.table === 'commande_confirmed') {
                            // If the confirmed section is already showing this same order
                            // (for example loadUnconfirmedRequests rendered it), skip adding
                            // a duplicate to the pending list.
                            const confirmedSection = document.getElementById('confirmed-request');
                            const confirmedSectionOrderKey = confirmedSection ? confirmedSection.dataset.orderKey : null;
                            if (confirmedSectionOrderKey && confirmedSectionOrderKey === orderKey) {
                                // already rendered in the top confirmed section
                                return;
                            }

                            // Decide status to display: prefer explicit order.status, otherwise
                            // if priceConfirmed is true show 'accepted' (waiting driver), else 'pending'.
                            const displayStatus = order.status || (order.priceConfirmed ? 'accepted' : 'pending');

                            card = generateConfirmedContent(
                                order.key,
                                order.pickup,
                                order.destination,
                                order.driverName,
                                order.driverPhoto,
                                order.driverPhone || "06 12 34 56 78",
                                displayStatus,
                                order
                            );
                        }
                        
                        // Avoid duplicated DOM entries: if an element with the same fingerprint
                        // already exists, update it instead of appending a new one.
                        const existing = pendingRequestsContainer.querySelector(`[data-order-key="${orderKey}"]`);
                        // If this order was just created locally and we don't yet have a DOM node,
                        // skip appending to avoid duplicates from immediate DB-read race.
                        const isRecentLocal = lastLocalOrderFingerprint && orderKey === lastLocalOrderFingerprint && (Date.now() - lastLocalOrderTimestamp) < 6000;
                        if (existing) {
                            existing.setAttribute('data-order-id', order.key);
                            existing.setAttribute('data-table', order.table);
                            existing.innerHTML = card;
                        } else if (!isRecentLocal) {
                            const div = document.createElement('div');
                            div.setAttribute('data-order-id', order.key);
                            div.setAttribute('data-order-key', orderKey);
                            div.setAttribute('data-table', order.table);
                            div.innerHTML = card;
                            pendingRequestsContainer.appendChild(div);
                        } else {
                            // If it's a very recent local order and DOM entry not present yet,
                            // we skip adding it here. The local UI already shows it.
                            // Clear the local recent fingerprint after skipping to avoid permanent suppression.
                            lastLocalOrderFingerprint = null;
                            lastLocalOrderTimestamp = 0;
                        }
                    });
                } else {
                    // Ne rien afficher si aucune commande : masquer complètement la section
                    allPendingSection.style.display = 'none';
                    allPendingSection.classList.remove('show-heading');
                    pendingRequestsContainer.innerHTML = '';
                }
            } catch (error) {
                console.error("Erreur lors du chargement des commandes en attente :", error);
                allPendingSection.style.display = 'block';
                pendingRequestsContainer.innerHTML = `
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-6 text-center">
                        <i class="ri-inbox-line text-gray-400 text-4xl mb-4"></i>
                        <p class="text-gray-600" data-translate="no_pending">${translations[currentLanguage].no_pending}</p>
                    </div>
                `;
            }
        }

        // Subscribe to realtime changes on order tables and refresh UI when changes occur
        async function subscribeToOrderChanges() {
            try {
                const userId = localStorage.getItem('userId');
                const userType = localStorage.getItem('userType');
                const guestId = localStorage.getItem('guestId') || null;
                let ip = localStorage.getItem('guestIp') || null;
                if (!ip) ip = await getUserIP();

                const tables = ['commande', 'commande_unconfirmed', 'commande_transfered', 'commande_confirmed'];

                tables.forEach(table => {
                    let query = null;
                    if (userType === 'save' || userType === 'unsave') {
                        if (userId) query = database.ref(table).orderByChild('userId').equalTo(userId);
                    } else {
                        if (guestId) query = database.ref(table).orderByChild('guestId').equalTo(guestId);
                        else if (ip) query = database.ref(table).orderByChild('ip').equalTo(ip);
                    }

                    // If no specific query could be built, skip
                    if (!query) return;

                    // Use realtime listeners to react to changes
                    query.on('child_added', () => {
                        // small debounce to avoid rapid re-renders
                        setTimeout(loadAllPendingRequests, 150);
                    });
                    query.on('child_changed', () => setTimeout(loadAllPendingRequests, 150));
                    query.on('child_removed', () => setTimeout(loadAllPendingRequests, 150));
                });
            } catch (e) {
                console.error('subscribeToOrderChanges error', e);
            }
        }

        // Watch commande_unconfirmed for price proposals and confirmations in realtime
        async function subscribePriceProposals() {
            try {
                const userId = localStorage.getItem('userId');
                const userType = localStorage.getItem('userType');
                const guestId = localStorage.getItem('guestId') || null;
                let ip = localStorage.getItem('guestIp') || null;
                if (!ip) {
                    try { ip = await getUserIP(); } catch(e) { ip = null; }
                }

                let query = null;
                if (userType === 'save' || userType === 'unsave') {
                    if (userId) query = database.ref('commande_unconfirmed').orderByChild('userId').equalTo(userId);
                } else {
                    if (guestId) query = database.ref('commande_unconfirmed').orderByChild('guestId').equalTo(guestId);
                    else if (ip) query = database.ref('commande_unconfirmed').orderByChild('ip').equalTo(ip);
                }

                if (!query) return;

                query.on('child_changed', snapshot => {
                    try {
                        const key = snapshot.key;
                        const data = snapshot.val() || {};
                        const confirmedSection = document.getElementById('confirmed-request');
                        const unconfirmedContainer = document.getElementById('unconfirmedRequestsContainer');
                        const pendingContainer = document.getElementById('pendingRequestsContainer');

                        let fp = '';
                        try { fp = generateOrderKey(Object.assign({}, data, { key })); } catch(e) { fp = key; }

                        if (data.priceConfirmed) {
                            // Remove duplicates in lists
                            [pendingContainer, unconfirmedContainer].forEach(c => {
                                if (!c) return;
                                c.querySelectorAll('[data-order-key]').forEach(el => {
                                    if (el.getAttribute('data-order-key') === fp && el.getAttribute('data-order-id') !== key) {
                                        try { el.remove(); } catch(e){}
                                    }
                                });
                            });

                            // Render confirmed section if not already
                            try {
                                if (confirmedSection && confirmedSection.dataset.orderKey !== fp) {
                                    confirmedSection.style.display = 'block';
                                    confirmedSection.dataset.orderId = key;
                                    confirmedSection.dataset.orderKey = fp;
                                    confirmedSection.innerHTML = generateConfirmedContent(
                                        key,
                                        data.pickup,
                                        data.destination,
                                        data.driverName || null,
                                        data.driverPhoto || null,
                                        data.driverPhone || null,
                                        data.status || 'accepted',
                                        data
                                    );
                                    if (confirmedSection.dataset.intervalId) try { clearInterval(parseInt(confirmedSection.dataset.intervalId)); } catch(e){}
                                    confirmedSection.dataset.intervalId = setInterval(() => checkConfirmedOrderStatus(key), 2000);
                                    try { confirmedSection.scrollIntoView({ behavior: 'smooth' }); } catch(e){}
                                    try { notifyUser('Prix confirmé', `Le prix de votre course a été confirmé (${data.price}).`); } catch(e){}
                                }
                            } catch(e) { console.error('render confirmed error', e); }
                        } else if (typeof data.price === 'number') {
                            // show price proposal card if missing
                            try {
                                const exists = unconfirmedContainer && unconfirmedContainer.querySelector(`[data-order-id="${key}"]`);
                                const inPending = pendingContainer && pendingContainer.querySelector(`[data-order-key="${fp}"]`);
                                if (!exists && !inPending && unconfirmedContainer) {
                                    const div = document.createElement('div');
                                    div.setAttribute('data-order-id', key);
                                    div.setAttribute('data-order-key', fp);
                                    div.setAttribute('data-table', 'commande_unconfirmed');
                                    div.innerHTML = generatePriceContent(key, data.price, data.pickup, data.destination);
                                    unconfirmedContainer.appendChild(div);
                                    document.getElementById('unconfirmed-request').style.display = 'block';
                                    try { notifyUser('Nouveau prix proposé', `Un prix de ${data.price} a été proposé pour votre course.`); } catch(e){}
                                }
                            } catch(e) {}
                        }
                    } catch (e) {
                        console.error('subscribePriceProposals child_changed error', e);
                    }
                });
            } catch (e) {
                console.error('subscribePriceProposals error', e);
            }
        }

        // Charger les demandes non confirmées
        function loadUnconfirmedRequests() {
            const userId = localStorage.getItem('userId');
            const userType = localStorage.getItem('userType');
            
            if (!userId && !userType) {
                document.getElementById('unconfirmed-request').style.display = 'none';
                return;
            }

            const unconfirmedRequestsContainer = document.getElementById('unconfirmedRequestsContainer');
            unconfirmedRequestsContainer.innerHTML = '';
            let hasUnconfirmed = false;

            let query;
            if (userType === 'save') {
                query = database.ref('commande_unconfirmed').orderByChild('userId').equalTo(userId);
            } else if (userType === 'unsave') {
                query = database.ref('commande_unconfirmed').orderByChild('userId').equalTo(userId);
            } else {
                // Pour les invités, on utilise l'IP
                getUserIP().then(ip => {
                    if (ip) {
                        query = database.ref('commande_unconfirmed').orderByChild('ip').equalTo(ip);
                        executeQuery();
                    }
                });
                return;
            }

            function executeQuery() {
                query.once('value', snapshot => {
                    if (snapshot.exists()) {
                        snapshot.forEach(child => {
                            const commandeData = child.val();
                            // If a price exists, consider it auto-accepted for fixed-price plans
                            // only: mark priceConfirmed and render in the confirmed section so
                            // admin can assign a driver. For non-fixed plans, leave the
                            // order unconfirmed so the client must accept/reject the price.
                            if (typeof commandeData.price === 'number') {
                                const svcPlan = commandeData.servicePlan || commandeData.planId || null;
                                const isFixed = svcPlan && FIXED_PLAN_IDS.includes(String(svcPlan));
                                if (isFixed) {
                                    // Persist priceConfirmed to true if not already set.
                                    try { if (!commandeData.priceConfirmed) database.ref('commande_unconfirmed/' + child.key).update({ priceConfirmed: true }); } catch(e){}

                                    // Render as confirmed (accepted price)
                                    const confirmedSection = document.getElementById('confirmed-request');
                                    try {
                                        confirmedSection.style.display = 'block';
                                        confirmedSection.dataset.orderId = child.key;
                                        // Attach an orderKey fingerprint so the general list won't duplicate it
                                        try {
                                            const fp = generateOrderKey(Object.assign({}, commandeData, { key: child.key }));
                                            confirmedSection.dataset.orderKey = fp;
                                        } catch(e) { confirmedSection.dataset.orderKey = '' }

                                        confirmedSection.innerHTML = generateConfirmedContent(
                                            child.key,
                                            commandeData.pickup,
                                            commandeData.destination,
                                            commandeData.driverName || null,
                                            commandeData.driverPhoto || null,
                                            commandeData.driverPhone || null,
                                            'accepted'
                                        );
                                        const statusIntervalId = setInterval(() => checkConfirmedOrderStatus(child.key), 2000);
                                        confirmedSection.dataset.intervalId = statusIntervalId;
                                    } catch(e) { /* non-fatal */ }
                                    hasUnconfirmed = true;
                                    // Do not append a duplicate unconfirmed card — the confirmed section
                                    // is the single source of truth for fixed-price accepted orders.
                                }
                            }
                        });
                    }
                    
                    if (hasUnconfirmed) document.getElementById('unconfirmed-request').style.display = 'block';
                    else document.getElementById('unconfirmed-request').style.display = 'none';
                });
            }

            if (query) executeQuery();
        }

        // Vérifier le statut d'une commande
        function checkOrderStatus(orderId) {
            const pendingSection = document.getElementById('pending-request');
            const userId = localStorage.getItem('userId');
            
            if (!userId) return;
            
            // Vérifier si la commande a été déplacée vers commande_unconfirmed
            database.ref('commande_unconfirmed').orderByChild('userId').equalTo(userId).once('value', snapshot => {
                if (snapshot.exists()) {
                    snapshot.forEach(child => {
                        const commandeData = child.val();
                        
                        // Vérifier si le prix a été ajouté par l'administrateur
                        if (commandeData.price) {
                            clearInterval(parseInt(pendingSection.dataset.intervalId));
                            
                            pendingSection.style.display = 'none';
                            
                            loadUnconfirmedRequests();
                            loadAllPendingRequests();
                        }
                    });
                }
            });
        }

        // Minimal notifications helper (in-app toast + browser notification)
        function showToast(msg, t = 5000) {
            const el = document.createElement('div');
            el.className = 'tmp-toast';
            el.style.position = 'fixed';
            el.style.right = '20px';
            el.style.bottom = '20px';
            el.style.background = 'rgba(0,0,0,0.8)';
            el.style.color = '#fff';
            el.style.padding = '10px 14px';
            el.style.borderRadius = '8px';
            el.style.zIndex = 99999;
            el.textContent = msg;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), t);
        }

        async function notifyUser(title, message) {
            // try browser notification
            try {
                if ('Notification' in window && Notification.permission !== 'denied') {
                    if (Notification.permission !== 'granted') {
                        await Notification.requestPermission();
                    }
                    if (Notification.permission === 'granted') {
                        const n = new Notification(title || 'Mise à jour', { body: message });
                        n.onclick = () => window.focus();
                        return;
                    }
                }
            } catch(e) {}
            // fallback
            showToast((title ? title + ': ' : '') + message, 6000);
        }

        // Subscribe to child events on commande tables for the current user/guest
        // This sets up realtime listeners (recommended). It also exposes a lightweight
        // polling fallback (startPollingOrders) if you prefer per-second checks.
        const __orderListeners = [];
        let __orderPollTimer = null;
        let __lastPollSnapshot = {};

        function debounce(fn, wait) {
            let t = null;
            return function(...args) {
                clearTimeout(t);
                t = setTimeout(() => fn.apply(this, args), wait);
            };
        }

        async function subscribeToOrderChanges({debounceMs = 500} = {}) {
            // Attach child_added/child_changed/child_removed listeners per-table
            const userId = localStorage.getItem('userId');
            const userType = localStorage.getItem('userType');
            const guestId = localStorage.getItem('guestId') || null;
            let ip = localStorage.getItem('guestIp') || null;
            if (!ip) {
                try { ip = await getUserIP(); } catch(e) { ip = null; }
            }

            if (!userId && !userType && !guestId && !ip) return;

            const tables = ['commande', 'commande_unconfirmed', 'commande_transfered', 'commande_confirmed'];

            const triggerRefresh = debounce(() => {
                try { loadUnconfirmedRequests(); } catch(e){}
                try { loadAllPendingRequests(); } catch(e){}
            }, debounceMs);

            const notifyDebounced = debounce((data) => {
                try {
                    if (!data) return;
                    if (data.price) notifyUser('Prix proposé', `Un prix de ${data.price} a été proposé pour votre commande.`);
                    if (data.status) {
                        if (data.status === 'confirmed') notifyUser('Commande confirmée', 'Votre commande a été confirmée.');
                        else if (data.status === 'finished') notifyUser('Course terminée', 'Votre course est terminée.');
                        else if (data.status === 'here') {
                            // Driver has arrived — make sure user sees it immediately
                            const title = 'Votre chauffeur est arrivé';
                            const body = 'Le chauffeur a indiqué qu\'il est arrivé à votre position.';
                            try { notifyUser(title, body); } catch(e){}
                        }
                    }
                } catch(e) { console.error('notify handler error', e); }
            }, 300);

            tables.forEach(table => {
                let query;
                try {
                    if (userType === 'save' || userType === 'unsave') query = database.ref(table).orderByChild('userId').equalTo(userId);
                    else if (guestId) query = database.ref(table).orderByChild('guestId').equalTo(guestId);
                    else query = database.ref(table).orderByChild('ip').equalTo(ip);
                } catch(e) { return; }

                if (!query) return;

                // Handlers
                const onAdded = () => triggerRefresh();
                const onChanged = snapshot => { try { notifyDebounced(snapshot.val()); triggerRefresh(); } catch(e){} };
                const onRemoved = () => triggerRefresh();

                query.on('child_added', onAdded);
                query.on('child_changed', onChanged);
                query.on('child_removed', onRemoved);

                __orderListeners.push({ query, event: 'child_added', handler: onAdded });
                __orderListeners.push({ query, event: 'child_changed', handler: onChanged });
                __orderListeners.push({ query, event: 'child_removed', handler: onRemoved });
            });
        }

        function unsubscribeOrderChanges() {
            try {
                __orderListeners.forEach(l => {
                    try { l.query.off(l.event, l.handler); } catch(e){}
                });
            } finally {
                __orderListeners.length = 0;
            }
            stopPollingOrders();
        }

        // Optional polling fallback — polls the same tables every intervalMs and triggers UI refresh when any raw snapshot changes.
        function startPollingOrders({intervalMs = 1000, tables = ['commande','commande_unconfirmed','commande_transfered','commande_confirmed'] } = {}) {
            stopPollingOrders();
            __lastPollSnapshot = {};
            __orderPollTimer = setInterval(async () => {
                try {
                    const userId = localStorage.getItem('userId');
                    const userType = localStorage.getItem('userType');
                    const guestId = localStorage.getItem('guestId') || null;
                    let ip = localStorage.getItem('guestIp') || null;
                    if (!ip) {
                        try { ip = await getUserIP(); } catch(e) { ip = null; }
                    }

                    let changed = false;
                    for (const table of tables) {
                        let query;
                        try {
                            if (userType === 'save' || userType === 'unsave') query = database.ref(table).orderByChild('userId').equalTo(userId);
                            else if (guestId) query = database.ref(table).orderByChild('guestId').equalTo(guestId);
                            else query = database.ref(table).orderByChild('ip').equalTo(ip);
                        } catch(e) { query = null; }
                        if (!query) continue;
                        const snap = await query.once('value');
                        const raw = snap.exists() ? JSON.stringify(snap.val()) : null;
                        if (__lastPollSnapshot[table] !== raw) {
                            __lastPollSnapshot[table] = raw;
                            changed = true;
                        }
                    }
                    if (changed) {
                        try { loadUnconfirmedRequests(); } catch(e){}
                        try { loadAllPendingRequests(); } catch(e){}
                    }
                } catch(e) { console.error('polling orders error', e); }
            }, intervalMs);
        }

        function stopPollingOrders() { if (__orderPollTimer) { clearInterval(__orderPollTimer); __orderPollTimer = null; } }

        // Commander un taxi
        function handleTaxiOrder() {
            const orderBtn = document.getElementById('orderTaxiBtn');
            const destinationSwitch = document.getElementById('destinationSwitch');
            const destinationAddress = document.getElementById('destinationAddress');
            const destinationArrival = document.getElementById('destinationAddressArrival');
            const description = document.getElementById('bookingDescription');
            const pendingSection = document.getElementById('pending-request');
            const locationModal = document.getElementById('locationPermissionModal');
            const nowBtn = document.getElementById('nowBtn');
            const laterBtn = document.getElementById('laterBtn');
            const oneWayBtn = document.getElementById('oneWayBtn');
            const roundTripBtn = document.getElementById('roundTripBtn');
            
            orderBtn.addEventListener('click', async function() {
                if (!destinationArrival.value.trim()) {
                    alert('Veuillez saisir une adresse de destination');
                    return;
                }
                
                if (destinationSwitch.checked && !destinationAddress.value.trim()) {
                    alert('Veuillez saisir une adresse de départ');
                    return;
                }
                
                const isNow = nowBtn.classList.contains('active');
                const tripType = oneWayBtn.classList.contains('active') ? 
                    oneWayBtn.dataset.tripType : 
                    roundTripBtn.dataset.tripType;
                
                if (isNow && !destinationSwitch.checked) {
                    locationModal.style.display = 'flex';
                    
                    const userResponse = await new Promise((resolve) => {
                        document.getElementById('acceptLocationBtn').onclick = () => {
                            try { locationModal.style.display = 'none'; } catch(e){}
                            resolve(true);
                        };
                        document.getElementById('closeLocationModalBtn').onclick = () => {
                            try { locationModal.style.display = 'none'; } catch(e){}
                            resolve(false);
                        };
                    });
                    
                    if (!userResponse) {
                        destinationSwitch.checked = true;
                        document.getElementById('destinationField').classList.remove('hidden');
                        return;
                    }
                }
                
                if (isNow) {
                    if (navigator.geolocation && !destinationSwitch.checked) {
                        navigator.geolocation.getCurrentPosition(
                            async function(position) {
                                const ip = await getUserIP();
                                const userId = localStorage.getItem('userId') || 'guest';
                                const userType = localStorage.getItem('userType') || 'guest';
                                const guestId = userId === 'guest' ? getOrCreateGuestId() : null;
                                // Ensure unsave_member mapping exists for guest
                                if (guestId) {
                                    try {
                                        const unsaveMemberRef = database.ref('unsave_member');
                                        unsaveMemberRef.orderByChild('guestId').equalTo(guestId).once('value', snapshot => {
                                            if (!snapshot.exists()) {
                                                const newMemberRef = unsaveMemberRef.push();
                                                newMemberRef.set({ guestId: guestId, ip: ip, timestamp: firebase.database.ServerValue.TIMESTAMP });
                                            }
                                        });
                                    } catch(e) {}
                                }
                                const pickupAddress = destinationSwitch.checked ? destinationAddress.value : "Position actuelle";
                                
                                // Enregistrement dans la table 'commande'
                                const commandeRef = database.ref('commande').push();
                                const orderId = commandeRef.key;
                                commandeRef.set({
                                    userId: userId,
                                    guestId: guestId || null,
                                    userType: userType,
                                    ip: ip,
                                    pickup: pickupAddress,
                                    destination: destinationArrival.value,
                                    description: description.value,
                                    tripType: tripType,
                                    latitude: position.coords.latitude,
                                    longitude: position.coords.longitude,
                                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                                    status: 'pending'
                                });

                                // Store a local fingerprint to avoid an immediate duplicate when
                                // loadAllPendingRequests reads the DB a moment later.
                                try {
                                    const localFingerprint = generateOrderKey({ guestId: guestId || null, userId: userId, ip: ip, pickup: pickupAddress, destination: destinationArrival.value, description: description.value, timestamp: Date.now() });
                                    lastLocalOrderFingerprint = localFingerprint;
                                    lastLocalOrderTimestamp = Date.now();
                                } catch(e) {}
                                
                                pendingSection.style.display = 'block';
                                pendingSection.dataset.orderId = orderId;
                                pendingSection.innerHTML = generatePendingContent(
                                    orderId,
                                    pickupAddress,
                                    destinationArrival.value
                                );
                                
                                const intervalId = setInterval(() => checkOrderStatus(orderId), 2000);
                                pendingSection.dataset.intervalId = intervalId;
                                
                                pendingSection.scrollIntoView({ behavior: 'smooth' });
                                
                                // Mettre à jour la liste des commandes en attente
                                loadAllPendingRequests();
                            },
                            function(error) {
                                alert('Erreur de géolocalisation : ' + error.message);
                            }
                        );
                    } else {
                        const ip = await getUserIP();
                        const userId = localStorage.getItem('userId') || 'guest';
                        const userType = localStorage.getItem('userType') || 'guest';
                        const guestId = userId === 'guest' ? getOrCreateGuestId() : null;
                        if (guestId) {
                            try {
                                const unsaveMemberRef = database.ref('unsave_member');
                                unsaveMemberRef.orderByChild('guestId').equalTo(guestId).once('value', snapshot => {
                                    if (!snapshot.exists()) {
                                        const newMemberRef = unsaveMemberRef.push();
                                        newMemberRef.set({ guestId: guestId, ip: ip, timestamp: firebase.database.ServerValue.TIMESTAMP });
                                    }
                                });
                            } catch(e) {}
                        }
                        const pickupAddress = destinationAddress.value;
                        
                        // Enregistrement dans la table 'commande'
                        const commandeRef = database.ref('commande').push();
                        const orderId = commandeRef.key;
                        commandeRef.set({
                            userId: userId,
                            guestId: guestId || null,
                            userType: userType,
                            ip: ip,
                            pickup: pickupAddress,
                            destination: destinationArrival.value,
                            description: description.value,
                            tripType: tripType,
                            timestamp: firebase.database.ServerValue.TIMESTAMP,
                            status: 'pending'
                        });

                        try {
                            const localFingerprint = generateOrderKey({ guestId: guestId || null, userId: userId, ip: ip, pickup: pickupAddress, destination: destinationArrival.value, description: description.value, timestamp: Date.now() });
                            lastLocalOrderFingerprint = localFingerprint;
                            lastLocalOrderTimestamp = Date.now();
                        } catch(e) {}
                        
                        pendingSection.style.display = 'block';
                        pendingSection.dataset.orderId = orderId;
                        pendingSection.innerHTML = generatePendingContent(
                            orderId,
                            pickupAddress,
                            destinationArrival.value
                        );
                        
                        const intervalId = setInterval(() => checkOrderStatus(orderId), 2000);
                        pendingSection.dataset.intervalId = intervalId;
                        
                        pendingSection.scrollIntoView({ behavior: 'smooth' });
                        
                        // Mettre à jour la liste des commandes en attente
                        loadAllPendingRequests();
                    }
                } else {
                    const bookingDate = document.getElementById('bookingDate').value;
                    const bookingTime = document.getElementById('bookingTime').value;
                    
                    if (!bookingDate || !bookingTime) {
                        alert('Veuillez sélectionner une date et une heure');
                        return;
                    }
                    
                    const ip = await getUserIP();
                    const userId = localStorage.getItem('userId') || 'guest';
                    const userType = localStorage.getItem('userType') || 'guest';
                    const guestId = userId === 'guest' ? getOrCreateGuestId() : null;
                    if (guestId) {
                        try {
                            const unsaveMemberRef = database.ref('unsave_member');
                            unsaveMemberRef.orderByChild('guestId').equalTo(guestId).once('value', snapshot => {
                                if (!snapshot.exists()) {
                                    const newMemberRef = unsaveMemberRef.push();
                                    newMemberRef.set({ guestId: guestId, ip: ip, timestamp: firebase.database.ServerValue.TIMESTAMP });
                                }
                            });
                        } catch(e) {}
                    }
                    const pickupAddress = destinationSwitch.checked ? destinationAddress.value : "Position actuelle";
                    
                    // Enregistrement dans la table 'commande'
                    const commandeRef = database.ref('commande').push();
                    commandeRef.set({
                        userId: userId,
                        guestId: guestId || null,
                        userType: userType,
                        ip: ip,
                        pickup: pickupAddress,
                        destination: destinationArrival.value,
                        description: description.value,
                        tripType: tripType,
                        date: bookingDate,
                        time: bookingTime,
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        status: 'scheduled'
                    });
                    
                    alert('Votre réservation a été enregistrée!');
                }
            });
        }

        // Mettre à jour l'évaluation d'un chauffeur
        function updateDriverRating(driverId) {
            const reviewsRef = database.ref(`drivers/${driverId}/reviews`);
            reviewsRef.once('value', snapshot => {
                if (snapshot.exists()) {
                    let totalRating = 0;
                    let count = 0;
                    snapshot.forEach(child => {
                        const review = child.val();
                        totalRating += review.rating;
                        count++;
                    });

                    if (count > 0) {
                        const averageRating = totalRating / count;
                        database.ref('drivers/' + driverId).update({
                            rating: averageRating.toFixed(1)
                        });
                    }
                }
            });
        }

        // Gérer les actions sur les commandes
        function handleOrderActions() {
            // Gestion du bouton annuler dans la section pending-request
            const pendingSection = document.getElementById('pending-request');
            pendingSection.addEventListener('click', function(event) {
                const orderId = this.dataset.orderId;
                if (!orderId) return;
                
                if (event.target.classList.contains('cancel-order-btn')) {
                    const orderIdToCancel = event.target.dataset.orderId;
                    database.ref('commande/' + orderIdToCancel).remove()
                        .then(() => {
                            if (this.dataset.intervalId) {
                                clearInterval(parseInt(this.dataset.intervalId));
                            }
                            this.style.display = 'none';
                            loadAllPendingRequests();
                        })
                        .catch(error => {
                            console.error("Erreur lors de l'annulation de la commande:", error);
                            alert("Erreur lors de l'annulation de la commande");
                        });
                }
            });
            
            // Gestion du bouton annuler dans all-pending-requests
            const allPendingSection = document.getElementById('all-pending-requests');
            allPendingSection.addEventListener('click', function(event) {
                if (event.target.classList.contains('cancel-order-btn')) {
                    const orderId = event.target.dataset.orderId;
                    
                    // Supprimer la commande de toutes les tables possibles
                    const tables = ['commande', 'commande_unconfirmed', 'commande_transfered', 'commande_confirmed'];
                    
                    const deletePromises = tables.map(table => {
                        return database.ref(table + '/' + orderId).remove();
                    });
                    
                    Promise.all(deletePromises)
                        .then(() => {
                            // Recharger les commandes en attente
                            loadAllPendingRequests();
                            
                            // Masquer les sections individuelles si nécessaire
                            document.getElementById('pending-request').style.display = 'none';
                            document.getElementById('unconfirmed-request').style.display = 'none';
                            document.getElementById('confirmed-request').style.display = 'none';
                            document.getElementById('transferring-request').style.display = 'none';
                        })
                        .catch(error => {
                            console.error("Erreur lors de l'annulation de la commande:", error);
                            alert("Erreur lors de l'annulation de la commande");
                        });
                }
            });
            
            const unconfirmedRequestsContainer = document.getElementById('unconfirmedRequestsContainer');
            const pendingRequestsContainer = document.getElementById('pendingRequestsContainer');

            // Shared handler for accept/reject price actions. Attach to any container that may host
            // unconfirmed price cards so clicks are always captured regardless of where the card is rendered.
            async function handlePriceActionEvent(event) {
                const actionBtn = event.target && event.target.closest ? event.target.closest('[data-action]') : null;
                if (!actionBtn) return;

                const action = actionBtn.dataset.action;
                const orderId = actionBtn.dataset.orderId || (event.target.closest('[data-order-id]') && event.target.closest('[data-order-id]').dataset.orderId);
                // Find the wrapper card element (the container div that holds the card)
                let cardWrapper = actionBtn.closest('[data-order-id]');
                if (!orderId) return;

                if (action === 'accept-price') {
                    // Only update DB to set priceConfirmed; let the realtime listener
                    // render the confirmed UI to avoid duplicate cards.
                    try {
                        await database.ref('commande_unconfirmed/' + orderId).update({ priceConfirmed: true });
                    } catch (err) {
                        console.error('Error confirming price', err);
                    }

                    // Remove the local unconfirmed card to avoid visual duplicate while
                    // the realtime listener re-renders the confirmed UI.
                    try { if (cardWrapper && cardWrapper.parentNode) cardWrapper.parentNode.removeChild(cardWrapper); } catch(e){}
                    try { if (unconfirmedRequestsContainer && unconfirmedRequestsContainer.children.length === 0) document.getElementById('unconfirmed-request').style.display = 'none'; } catch(e){}

                    try { loadAllPendingRequests(); } catch(e){}
                }

                if (action === 'reject-price') {
                    database.ref('commande_unconfirmed/' + orderId).remove()
                        .then(() => {
                            try { if (cardWrapper && cardWrapper.parentNode) cardWrapper.parentNode.removeChild(cardWrapper); } catch(e){}
                            try { if (unconfirmedRequestsContainer && unconfirmedRequestsContainer.children.length === 0) document.getElementById('unconfirmed-request').style.display = 'none'; } catch(e){}
                            loadAllPendingRequests();
                        })
                        .catch(err => console.error('Error removing unconfirmed order', err));
                }
            }

            // Attach the shared handler to both containers where price cards may appear.
            try { if (unconfirmedRequestsContainer) unconfirmedRequestsContainer.addEventListener('click', handlePriceActionEvent); } catch(e) {}
            try { if (pendingRequestsContainer) pendingRequestsContainer.addEventListener('click', handlePriceActionEvent); } catch(e) {}
            
            const confirmedSection = document.getElementById('confirmed-request');
            confirmedSection.addEventListener('click', function(event) {
                const orderId = this.dataset.orderId;
                if (!orderId) return;
                
                if (event.target.id === 'closeFinishedBtn') {
                    this.style.display = 'none';
                    loadAllPendingRequests();
                }
            });
        }

        // Vérifier le statut d'une commande confirmée
        function checkConfirmedOrderStatus(orderId) {
            const confirmedSection = document.getElementById('confirmed-request');
            if (!confirmedSection || confirmedSection.dataset.orderId !== orderId) return;
            
            // Vérifier si la commande a été déplacée vers commande_transfered
            database.ref('commande_transfered/' + orderId).once('value', transferedSnapshot => {
                if (transferedSnapshot.exists()) {
                    const commandeData = transferedSnapshot.val();
                    
                    // Vérifier si la commande a été supprimée de commande_unconfirmed
                    database.ref('commande_unconfirmed/' + orderId).once('value', unconfirmedSnapshot => {
                        if (!unconfirmedSnapshot.exists()) {
                            // Mettre à jour l'affichage pour indiquer que l'administrateur est en train de transférer
                            confirmedSection.innerHTML = generateTransferringContent(
                                orderId,
                                commandeData.pickup,
                                commandeData.destination
                            );
                            
                            // Vérifier si la commande a été déplacée vers commande_confirmed
                            const transferIntervalId = setInterval(() => checkTransferedOrderStatus(orderId), 2000);
                            confirmedSection.dataset.intervalId = transferIntervalId;
                            
                            loadAllPendingRequests();
                        }
                    });
                }
            });
        }

        // Vérifier le statut d'une commande en transfert
        function checkTransferedOrderStatus(orderId) {
            const confirmedSection = document.getElementById('confirmed-request');
            if (!confirmedSection || confirmedSection.dataset.orderId !== orderId) return;
            
            // Vérifier si la commande a été déplacée vers commande_confirmed
            database.ref('commande_confirmed/' + orderId).once('value', confirmedSnapshot => {
                if (confirmedSnapshot.exists()) {
                    const commandeData = confirmedSnapshot.val();
                    
                    // Vérifier si la commande a été supprimée de commande_transfered
                    database.ref('commande_transfered/' + orderId).once('value', transferedSnapshot => {
                        if (!transferedSnapshot.exists()) {
                            clearInterval(parseInt(confirmedSection.dataset.intervalId));
                            
                            // Mettre à jour l'affichage pour indiquer que le chauffeur est en route
                            confirmedSection.innerHTML = generateConfirmedContent(
                                orderId,
                                commandeData.pickup,
                                commandeData.destination,
                                commandeData.driverName,
                                commandeData.driverPhoto,
                                commandeData.driverPhone || "06 12 34 56 78",
                                'onway',
                                commandeData
                            );
                            
                            loadAllPendingRequests();
                        }
                    });
                }
            });
        }

        // ===========================================
        // GESTION DES CHAUFFEURS ET AVIS
        // ===========================================

        // Afficher les avis d'un chauffeur
        function showDriverReviews(driverId) {
            const modal = document.getElementById('reviewsModal');
            const container = document.getElementById('reviewsContainer');
            
            database.ref('drivers/' + driverId).once('value', snapshot => {
                if (snapshot.exists()) {
                    const driver = snapshot.val();
                    const rating = driver.rating || 0;
                    
                    container.innerHTML = `
                        <div class="flex items-center mb-6">
                            <img src="${driver.photoURL || 'https://via.placeholder.com/60x60?text=Driver'}" alt="Photo du chauffeur" class="w-16 h-16 rounded-full object-cover">
                            <div class="ml-4">
                                <h4 class="text-lg font-semibold">${driver.firstname} ${driver.lastname}</h4>
                                <div class="driver-rating mt-1">
                                    ${renderStars(rating)}
                                    <span class="text-sm text-gray-600 ml-2">${rating.toFixed(1)}</span>
                                </div>
                            </div>
                        </div>
                        <h5 class="font-medium text-gray-700 mb-3" data-translate="customer_reviews">Avis des clients :</h5>
                        <div id="reviewsList" class="space-y-4 mb-6">
                            <p class="text-gray-500 text-center py-4" data-translate="no_reviews">Aucun avis pour le moment</p>
                        </div>
                    `;
                    
                    database.ref(`drivers/${driverId}/reviews`).once('value', reviewsSnapshot => {
                        const reviewsList = document.getElementById('reviewsList');
                        reviewsList.innerHTML = '';
                        
                        if (reviewsSnapshot.exists()) {
                            reviewsSnapshot.forEach(review => {
                                const data = review.val();
                                reviewsList.innerHTML += `
                                    <div class="review-item">
                                        <div class="flex justify-between">
                                            <div class="font-medium">${data.userName || 'Anonyme'}</div>
                                            <div class="flex text-yellow-400">
                                                ${renderStars(data.rating)}
                                            </div>
                                        </div>
                                        <p class="text-gray-600 mt-2">${data.comment || 'Aucun commentaire'}</p>
                                        <div class="text-xs text-gray-400 mt-2">${new Date(data.timestamp).toLocaleDateString()}</div>
                                    </div>
                                `;
                            });
                        } else {
                            reviewsList.innerHTML = '<p class="text-gray-500 text-center py-4" data-translate="no_reviews">Aucun avis pour le moment</p>';
                        }
                    });
                    
                    modal.style.display = 'flex';
                }
            });
            
            document.querySelector('.close-reviews-modal').addEventListener('click', function() {
                modal.style.display = 'none';
            });
        }

        // Charger les chauffeurs
        function loadDrivers() {
            const driversRef = database.ref('drivers');
            driversRef.once('value', snapshot => {
                const drivers = snapshot.val() || {};
                const topDriversContainer = document.getElementById('topDriversContainer');
                
                if (drivers) {
                    const driversArray = [];
                    for (const key in drivers) {
                        driversArray.push({
                            id: key,
                            ...drivers[key]
                        });
                    }
                    
                    driversArray.forEach(driver => {
                        driver.averageRating = calculateAverageRating(driver.reviews);
                    });
                    
                    driversArray.sort((a, b) => b.averageRating - a.averageRating);
                    
                    topDriversContainer.innerHTML = '';
                    for (let i = 0; i < Math.min(3, driversArray.length); i++) {
                        const driver = driversArray[i];
                        const rating = driver.averageRating;
                        
                        topDriversContainer.innerHTML += `
                            <div class="bg-white rounded-lg p-4 text-center shadow-sm premium-driver">
                                <div class="relative mb-3">
                                    <img src="${driver.photoURL}" alt="Chauffeur" class="w-16 h-16 rounded-full mx-auto object-cover">
                                    <div class="absolute -top-1 -right-1 ${i === 0 ? 'bg-yellow-400' : i === 1 ? 'bg-gray-400' : 'bg-orange-400'} text-white text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center">${i + 1}</div>
                                </div>
                                <h4 class="font-medium text-sm text-gray-800">${driver.lastname}</h4>
                                <h4 class="font-medium text-sm text-gray-800">${driver.firstname}</h4>
                                <div class="driver-stars driver-rating-animation animated">
                                    <div class="flex items-center justify-center mt-1">
                                        <div class="flex text-yellow-400 text-xs">
                                            ${renderStars(rating)}
                                        </div>
                                        <span class="text-xs text-gray-500 ml-1">${rating.toFixed(1)}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                } else {
                    topDriversContainer.innerHTML = '<p class="text-gray-500 text-center" data-translate="no_drivers">Aucun chauffeur disponible</p>';
                }
            });
        }

        // Charger l'historique des trajets
        function loadTripHistory() {
            const tripHistoryContainer = document.getElementById('tripHistoryContainer');
            const tripHistorySection = document.getElementById('tripHistorySection');
            const userId = localStorage.getItem('userId');
            const userType = localStorage.getItem('userType');
            
            // Si l'utilisateur n'est pas connecté, afficher un message réservé aux utilisateurs enregistrés
            if (!userId && !userType) {
                tripHistorySection.style.display = 'block';
                tripHistoryContainer.innerHTML = `
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-6 text-center">
                        <i class="ri-lock-line text-gray-400 text-4xl mb-4"></i>
                        <p class="text-gray-600 mb-4">${translations[currentLanguage].history_login_required}</p>
                        <div class="flex items-center justify-center gap-3">
                            <button id="openLoginFromHistory" class="gold-button px-4 py-2 !rounded-button font-medium">${translations[currentLanguage].login || 'Login'}</button>
                        </div>
                    </div>
                `;

                // Attach click handler to open the login modal
                setTimeout(() => {
                    const btn = document.getElementById('openLoginFromHistory');
                    if (btn) btn.addEventListener('click', () => {
                        const loginModal = document.getElementById('loginModal');
                        if (loginModal) loginModal.style.display = 'flex';
                        // Focus the login tab (ID tab) if available
                        const idTab = document.querySelector('.tab[data-tab="id"]');
                        if (idTab) idTab.click();
                    });
                }, 40);

                return;
            }
            
            let query;
            if (userType === 'save') {
                query = database.ref('commande_confirmed').orderByChild('userId').equalTo(userId);
            } else if (userType === 'unsave') {
                query = database.ref('commande_confirmed').orderByChild('userId').equalTo(userId);
            } else {
                // Pour les invités, on utilise l'IP
                getUserIP().then(ip => {
                    if (ip) {
                        query = database.ref('commande_confirmed').orderByChild('ip').equalTo(ip);
                        executeQuery();
                    }
                });
                return;
            }

            function executeQuery() {
                query.once('value', snapshot => {
                    const trips = snapshot.val();
                    const finishedTrips = {};
                    let hasHistory = false;
                    
                    // Filtrer uniquement les trajets terminés (statut 'finished')
                    if (trips) {
                        for (const key in trips) {
                            if (trips[key].status === 'finished') {
                                finishedTrips[key] = trips[key];
                            }
                        }
                    }
                    
                    // Éviter les doublons avec des informations identiques
                    const uniqueTrips = new Map();
                    for (const key in finishedTrips) {
                        const trip = finishedTrips[key];
                        const tripKey = `${trip.pickup || ''}-${trip.destination || ''}-${trip.timestamp}-${trip.finishedAt || ''}`;
                        
                        if (!uniqueTrips.has(tripKey)) {
                            uniqueTrips.set(tripKey, { key, trip });
                        }
                    }
                    
                    const uniqueTripArray = Array.from(uniqueTrips.values()).slice(0, 3);
                    
                    if (uniqueTripArray.length > 0) {
                        hasHistory = true;
                        tripHistoryContainer.innerHTML = '';
                        const reviewPromises = [];
                        
                        for (const item of uniqueTripArray) {
                            const key = item.key;
                            const trip = item.trip;
                            const tripDate = new Date(trip.timestamp);
                            const finishDate = trip.finishedAt ? new Date(trip.finishedAt) : new Date();
                            const duration = Math.floor((finishDate - tripDate) / 60000);
                            
                            if (trip.driverId) {
                                const promise = new Promise(resolve => {
                                    database.ref(`drivers/${trip.driverId}/reviews`)
                                        .orderByChild('tripId')
                                        .equalTo(key)
                                        .once('value', reviewSnapshot => {
                                            let userReview = null;
                                            if (reviewSnapshot.exists()) {
                                                reviewSnapshot.forEach(review => {
                                                    const data = review.val();
                                                    if (data.userId === userId) {
                                                        userReview = {
                                                            rating: data.rating,
                                                            reviewId: review.key,
                                                            comment: data.comment
                                                        };
                                                    }
                                                });
                                            }
                                            resolve({ tripId: key, review: userReview });
                                        });
                                });
                                reviewPromises.push(promise);
                            }
                            
                            const card = document.createElement('div');
                            card.className = 'bg-white rounded-lg p-4 shadow-sm';
                            card.setAttribute('data-trip-id', key);
                            card.innerHTML = `
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center">
                                        <img src="${trip.driverPhoto || 'https://via.placeholder.com/50x50'}" alt="Chauffeur" class="w-10 h-10 rounded-full object-cover">
                                        <div class="ml-3">
                                            <h4 class="font-medium text-sm text-gray-800">${trip.driverName || 'Chauffeur #' + Math.floor(Math.random() * 100)}</h4>
                                            <p class="text-xs text-gray-500">${tripDate.toLocaleDateString()} • ${tripDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm font-medium text-gray-800">${trip.price || (Math.random() * 30 + 10).toFixed(2)} $</p>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="flex items-center text-sm text-gray-600">
                                        <div class="w-3 h-3 flex items-center justify-center">
                                            <i class="ri-record-circle-fill text-green-500 text-xs"></i>
                                        </div>
                                        <span class="ml-2">${trip.pickup || 'Position actuelle'}</span>
                                    </div>
                                    <div class="flex items-center text-sm text-gray-600 mt-1">
                                        <div class="w-3 h-3 flex items-center justify-center">
                                            <i class="ri-map-pin-fill text-primary text-xs"></i>
                                        </div>
                                        <span class="ml-2">${trip.destination || 'Destination inconnue'}</span>
                                    </div>
                                </div>
                                <div id="ratingContainer-${key}">
                                    <!-- Contenu dynamique pour l'évaluation -->
                                </div>
                            `;
                            
                            tripHistoryContainer.appendChild(card);
                        }
                        
                        Promise.all(reviewPromises).then(reviewResults => {
                            const reviewsMap = {};
                            reviewResults.forEach(result => {
                                reviewsMap[result.tripId] = result.review;
                            });
                            
                            for (const item of uniqueTripArray) {
                                const key = item.key;
                                const trip = item.trip;
                                const userReview = reviewsMap[key] || null;
                                const hasRated = userReview !== null;
                                const userRating = userReview ? userReview.rating : null;
                                const reviewId = userReview ? userReview.reviewId : null;
                                
                                const ratingContainer = document.querySelector(`#ratingContainer-${key}`);
                                
                                if (ratingContainer) {
                                    if (hasRated || userRating) {
                                        ratingContainer.innerHTML = `
                                            <div class="mt-3">
                                                <p class="text-sm text-gray-700 mb-2" data-translate="your_rating">Votre note :</p>
                                                <div class="history-rating" data-trip-id="${key}" data-review-id="${reviewId}">
                                                    <i class="${userRating >= 1 ? 'ri-star-fill active' : 'ri-star-line'}" data-value="1"></i>
                                                    <i class="${userRating >= 2 ? 'ri-star-fill active' : 'ri-star-line'}" data-value="2"></i>
                                                    <i class="${userRating >= 3 ? 'ri-star-fill active' : 'ri-star-line'}" data-value="3"></i>
                                                    <i class="${userRating >= 4 ? 'ri-star-fill active' : 'ri-star-line'}" data-value="4"></i>
                                                    <i class="${userRating >= 5 ? 'ri-star-fill active' : 'ri-star-line'}" data-value="5"></i>
                                                </div>
                                                <div class="review-actions">
                                                    <button class="review-edit-btn" data-trip-id="${key}" data-review-id="${reviewId}">
                                                        <i class="ri-edit-line"></i> <span data-translate="edit">Modifier</span>
                                                    </button>
                                                </div>
                                            </div>
                                        `;
                                    } else {
                                        ratingContainer.innerHTML = `
                                            <div class="mt-3">
                                                <p class="text-sm text-gray-700 mb-2" data-translate="rate_trip">Notez ce trajet :</p>
                                                <div class="history-rating" data-trip-id="${key}">
                                                    <i class="ri-star-line" data-value="1"></i>
                                                    <i class="ri-star-line" data-value="2"></i>
                                                    <i class="ri-star-line" data-value="3"></i>
                                                    <i class="ri-star-line" data-value="4"></i>
                                                    <i class="ri-star-line" data-value="5"></i>
                                                </div>
                                            </div>
                                        `;
                                    }
                                }
                            }
                            
                            // Gestion des événements pour les étoiles
                            document.querySelectorAll('.history-rating:not([data-review-id])').forEach(ratingContainer => {
                                const stars = ratingContainer.querySelectorAll('i');
                                const tripId = ratingContainer.dataset.tripId;
                                
                                stars.forEach(star => {
                                    star.addEventListener('click', function() {
                                        const value = parseInt(this.dataset.value);
                                        
                                        stars.forEach((s, index) => {
                                            if (index < value) {
                                                s.classList.remove('ri-star-line');
                                                s.classList.add('ri-star-fill', 'active');
                                            } else {
                                                s.classList.remove('ri-star-fill', 'active');
                                                s.classList.add('ri-star-line');
                                            }
                                        });
                                        
                                        const driverId = trips[tripId].driverId;
                                        if (driverId) {
                                            const reviewRef = database.ref(`drivers/${driverId}/reviews`).push();
                                            const userName = localStorage.getItem('userName') || 'Anonyme';
                                            
                                            reviewRef.set({
                                                driverId: driverId,
                                                userName: userName,
                                                userId: userId,
                                                rating: value,
                                                tripId: tripId,
                                                timestamp: firebase.database.ServerValue.TIMESTAMP
                                            }).then(() => {
                                                updateDriverRating(driverId);
                                                
                                                localStorage.setItem(`rated-${tripId}`, 'true');
                                                
                                                loadTripHistory();
                                            });
                                        }
                                    });
                                });
                            });
                            
                            // Gestion de l'édition des avis
                            document.querySelectorAll('.review-edit-btn').forEach(btn => {
                                btn.addEventListener('click', function() {
                                    const tripId = this.dataset.tripId;
                                    const reviewId = this.dataset.reviewId;
                                    const driverId = trips[tripId].driverId;
                                    
                                    if (driverId && reviewId) {
                                        database.ref(`drivers/${driverId}/reviews/${reviewId}`).once('value', reviewSnapshot => {
                                            if (reviewSnapshot.exists()) {
                                                const review = reviewSnapshot.val();
                                                const rating = review.rating;
                                                
                                                const tripElement = document.querySelector(`[data-trip-id="${tripId}"]`);
                                                tripElement.innerHTML += `
                                                    <div class="rating-form mt-4">
                                                        <h4 class="text-sm font-medium mb-2" data-translate="edit_review">Modifier votre avis</h4>
                                                        <div class="rating-input">
                                                            <i class="${rating >= 1 ? 'ri-star-fill active' : 'ri-star-line'}" data-value="1"></i>
                                                            <i class="${rating >= 2 ? 'ri-star-fill active' : 'ri-star-line'}" data-value="2"></i>
                                                            <i class="${rating >= 3 ? 'ri-star-fill active' : 'ri-star-line'}" data-value="3"></i>
                                                            <i class="${rating >= 4 ? 'ri-star-fill active' : 'ri-star-line'}" data-value="4"></i>
                                                            <i class="${rating >= 5 ? 'ri-star-fill active' : 'ri-star-line'}" data-value="5"></i>
                                                        </div>
                                                        <div class="flex gap-2 mt-3">
                                                            <button class="flex-1 bg-gray-100 text-gray-700 py-2 rounded-button cancel-edit-btn" data-translate="cancel">Annuler</button>
                                                            <button class="flex-1 gold-button py-2 rounded-button save-review-btn" data-review-id="${reviewId}" data-driver-id="${driverId}" data-translate="save">Enregistrer</button>
                                                        </div>
                                                    </div>
                                                `;
                                                
                                                const ratingInput = tripElement.querySelector('.rating-input');
                                                const stars = ratingInput.querySelectorAll('i');
                                                let selectedRating = rating;
                                                
                                                stars.forEach(star => {
                                                    star.addEventListener('click', function() {
                                                        const value = parseInt(this.dataset.value);
                                                        selectedRating = value;
                                                        
                                                        stars.forEach((s, index) => {
                                                            if (index < value) {
                                                                s.classList.remove('ri-star-line');
                                                                s.classList.add('ri-star-fill', 'active');
                                                            } else {
                                                                s.classList.remove('ri-star-fill', 'active');
                                                                s.classList.add('ri-star-line');
                                                            }
                                                        });
                                                    });
                                                });
                                                
                                                tripElement.querySelector('.cancel-edit-btn').addEventListener('click', function() {
                                                    loadTripHistory();
                                                });
                                                
                                                tripElement.querySelector('.save-review-btn').addEventListener('click', function() {
                                                    const reviewId = this.dataset.reviewId;
                                                    const driverId = this.dataset.driverId;
                                                    
                                                    database.ref(`drivers/${driverId}/reviews/${reviewId}`).update({
                                                        rating: selectedRating
                                                    }).then(() => {
                                                        updateDriverRating(driverId);
                                                        
                                                        loadTripHistory();
                                                    });
                                                });
                                            }
                                        });
                                    }
                                });
                            });
                        });
                    } else {
                        tripHistoryContainer.innerHTML = `
                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-6 text-center">
                                <i class="ri-history-line text-gray-400 text-4xl mb-4"></i>
                                <p class="text-gray-600" data-translate="no_history">${translations[currentLanguage].no_history}</p>
                            </div>
                        `;
                    }
                    
                    // Afficher la section
                    tripHistorySection.style.display = 'block';
                });
            }

            if (query) executeQuery();
        }

        // ===========================================
        // GESTION DES ATTRACTIONS TOURISTIQUES
        // ===========================================

        function handleTouristAttractions() {
            const attractions = {
                citadelle: {
                    fr: {
                        name: "Citadelle La Ferrière",
                        description: "La Citadelle La Ferrière est une forteresse monumentale située au sommet de la montagne Bonnet à l'Évêque, dans le Nord d'Haiti. Construite entre 1805 et 1820 sous les ordres du roi Henri Christophe, elle représente l'un des plus beaux exemples d'architecture militaire du XIXe siècle.",
                        history: "Érigée après l'indépendance d'Haiti, la Citadelle avait pour but de défendre la nouvelle nation contre un éventuel retour des Français. With its walls over 40 meters high and 365 cannons, it is the largest fortress in the Americas, classified as a UNESCO World Heritage Site."
                    },
                    ht: {
                        name: "Sitadèl Laferyè",
                        description: "Sitadèl Laferyè se yon fò monimantal ki chita sou tèt mòn Bonnet a l'Evek, nan Nò Ayiti. Li te konstwi ant 1805 ak 1820 sou lòd wa Henri Christophe, e li reprezante youn nan pi bèl egzanp achitekti militè nan syèk la 19.",
                        history: "Li te bati apre endepandans Ayiti, Sitadèl la te gen objektif pou defann nouvo nasyon an kont yon evantyèl retounen Fransè yo. Avèk mi ki pi wo pase 40 mèt ak 365 kanon, li se pi gwo fò nan Amerik yo, klase nan patrimwàn mondyal UNESCO."
                    },
                    en: {
                        name: "Citadelle La Ferrière",
                        description: "The Citadelle La Ferrière is a monumental fortress located atop Bonnet à l'Évêque mountain in northern Haiti. Built between 1805 and 1820 under King Henri Christophe, it represents one of the finest examples of 19th-century military architecture.",
                        history: "Erected after Haiti's independence, the Citadel was intended to defend the new nation against a possible French return. With walls over 40 meters high and 365 cannons, it is the largest fortress in the Americas, classified as a UNESCO World Heritage Site."
                    },
                    es: {
                        name: "Ciudadela La Ferrière",
                        description: "La Ciudadela La Ferrière es una fortaleza monumental ubicada en la cima de la montaña Bonnet à l'Évêque, en el norte de Haití. Construida entre 1805 and 1820 bajo las órdenes del rey Henri Christophe, representa uno de los mejores ejemplos de arquitectura militar del siglo XIX.",
                        history: "Erigida después de la independencia de Haití, la Ciudadela tenía como objetivo defender la nueva nación contra un posible regreso de los franceses. Con sus muros de más de 40 metros de altura and sus 365 cañones, es la fortaleza más grande de las Américas, clasificada como Patrimonio de la Humanidad por la UNESCO."
                    }
                },
                labadee: {
                    fr: {
                        name: "Labadee",
                        description: "Labadee est une station balnéaire privée située sur la côte nord d'Haïti. Connue pour ses plages de sable blanc, ses eaux turquoises et ses activités nautiques, c'est une destination de choix pour les croisiéristes et les vacanciers.",
                        history: "Nommée d'après le marquis de La Badie, un colon français du XVIIe siècle, la région a été développée en station touristique dans les années 1980. Aujourd'hui, elle offre une combinaison unique de paysages paradisiaques et de culture haïtienne authentique."
                    },
                    ht: {
                        name: "Labadee",
                        description: "Labadee se yon estasyon balyè prive ki sitiye sou kòt nò Ayiti. Li konnen pou plaj sab blan li yo, dlo tèk li yo ak aktivite nòtik li yo. Li se yon destinasyon popilè pou pasaje bato kwazyè ak vakansye.",
                        history: "Yo te rele li apre Markis La Badie, yon kolon franse nan syèk la 17, rejyon an te devlope kòm estasyon touris nan ane 1980 yo. Jodi a, li ofri yon konbinezon inik nan peyizaj paradi ak kilti ayisyèn otantik."
                    },
                    en: {
                        name: "Labadee",
                        description: "Labadee is a private beach resort located on Haiti's northern coast. Known for its white sand beaches, turquoise waters and water activities, it's a popular destination for cruise passengers and vacationers.",
                        history: "Named after the Marquis de La Badie, a 17th-century French colonist, the area was developed as a tourist resort in the 1980s. Today, it offers a unique combination of paradise landscapes and authentic Haitian culture."
                    },
                    es: {
                        name: "Labadee",
                        description: "Labadee es un complejo turístico privado ubicado en la costa norte de Haití. Conocido por sus playas de arena blanca, aguas turquesas and actividades acuáticas, es un destino popular para pasajeros de cruceros and vacacionistas.",
                        history: "Nombrado en honor al Marqués de La Badie, un colono francés del siglo XVII, el área se desarrolló como complejo turístico en la década de 1980. Hoy ofrece una combinación única de paisajes paradisíacos and cultura haitiana auténtica."
                    }
                },
                verrieres: {
                    fr: {
                        name: "Monument de Vertières",
                        description: "Le Monument de Vertières commémore la célèbre bataille de Vertières qui a scellé l'indépendance d'Haïti le 18 novembre 1803. Situé près de Cap-Haïtien, il rend hommage aux héros de la révolution haïtienne.",
                        history: "Érigé en 1953 pour le 150e anniversaire de la bataille, ce monument symbolise la résistance et la victoire des esclaves insurgés contre l'armée napoléonienne. C'est un lieu de pèlerinage historique pour tous les Haïtiens."
                    },
                    ht: {
                        name: "Moniman Vètyè",
                        description: "Moniman Vètyè komemore batay Vètyè ki te sele endepandans Ayiti sou 18 novanm 1803. Li sitiye toupre Okap, e li rann omaj bay ewo revolisyon ayisyèn yo.",
                        history: "Li te bati an 1953 pou 150yèm anivèsè batay la, moniman sa a senbolize rezistans ak viktwa esklav rebèl yo kont lame Napoleon an. Li se yon kote pelrenaj istorik pou tout Ayisyen."
                    },
                    en: {
                        name: "Vertières Monument",
                        description: "The Vertières Monument commemorates the famous Battle of Vertières that sealed Haiti's independence on November 18, 1803. Located near Cap-Haïtien, it pays tribute to the heroes of the Haitian revolution.",
                        history: "Erected in 1953 for the 150th anniversary of the battle, this monument symbolizes the resistance and victory of insurgent slaves against Napoleon's army. It is a historical pilgrimage site for all Haitians."
                    },
                    es: {
                        name: "Monumento de Vertières",
                        description: "El Monumento de Vertières conmemora la famosa Batalla de Vertières que selló la independencia de Haití el 18 de noviembre de 1803. Ubicado cerca de Cap-Haïtien, rinde homenaje a los héroes de la revolución haitiana.",
                        history: "Erigido en 1953 para el 150 aniversario de la batalla, este monumento simboliza la resistencia and victoria de los esclavos insurgentes contra el ejército napoleónico. Es un lugar de peregrinación histórica para todos los haitianos."
                    }
                },
                cathedrale: {
                    fr: {
                        name: "Cathédrale de Cap-Haïtien",
                        description: "La Cathédrale Notre-Dame de l'Assomption de Cap-Haïtien est un joyau architectural de style néo-classique. Construite au XVIIIe siècle, elle domine la place d'Armes avec son imposante façade blanche.",
                        history: "Édifiée pendant la période coloniale, la cathédrale a survécu au tremblement de terre de 1842 et a été restaurée plusieurs fois. Elle témoigne de la riche histoire religieuse et culturelle de la région."
                    },
                    ht: {
                        name: "Katredal Okap",
                        description: "Katredal Notre-Dame de l'Assomption nan Okap se yon bijou achitekti nan style neo-klasik. Li te konstwi nan syèk la 18, e li domine Plas d'Armes ak fasad blan enpòtan li.",
                        history: "Bati pandan peryòd kolonyal la, katredal la te siviv tranbleman tè 1842 la e li te retabli plizyè fwa. Li temwaye rich istwa relijye ak kiltirèl rejyon an."
                    },
                    en: {
                        name: "Cathedral of Cap-Haïtien",
                        description: "The Notre-Dame de l'Assomption Cathedral in Cap-Haïtien is an architectural gem in neoclassical style. Built in the 18th century, it dominates Place d'Armes with its imposing white facade.",
                        history: "Built during the colonial period, the cathedral survived the 1842 earthquake and has been restored several times. It testifies to the region's rich religious and cultural history."
                    },
                    es: {
                        name: "Catedral de Cap-Haïtien",
                        description: "La Catedral de Notre-Dame de l'Assomption en Cap-Haïtien es una joya arquitectónica de estilo neoclásico. Construida en el siglo XVIII, domina la Place d'Armes con su imponente fachada blanca.",
                        history: "Edificada durante el período colonial, la catedral sobrevivió al terremoto de 1842 and ha sido restaurada varias veces. Testimonia la rica historia religiosa and cultural de la región."
                    }
                },
                palais: {
                    fr: {
                        name: "Palais Sans Souci",
                        description: "Le Palais Sans Souci fut la résidence royale du roi Henri Christophe au début du XIXe siècle. Situé à Milot, près de la Citadelle, ce palais somptueux était surnommé le 'Versailles des Caraïbes'.",
                        history: "Construit entre 1810 et 1813, le palais fut le centre du royaume d'Haïti jusqu'au suicide du roi en 1820. Détruit par un tremblement de terre en 1842, ses ruines majestueuses sont aujourd'hui classées au patrimoine mondial de l'UNESCO."
                    },
                    ht: {
                        name: "Palè San Souci",
                        description: "Palè San Souci te rezidans wa Henri Christophe nan kòmansman syèk la 19. Li sitiye nan Milò, toupre Sitadèl la. Yo te rele li 'Vèsay Karayib la'.",
                        history: "Konstwi ant 1810 ak 1813, palè a te sant wayòm Ayiti jouk lè wa a te komèt swisid an 1820. Detwi pa yon tranbleman tè an 1842, demajè li yo klasè kòm patrimwàn mondyal UNESCO jodi a."
                    },
                    en: {
                        name: "Sans-Souci Palace",
                        description: "The Sans-Souci Palace was the royal residence of King Henri Christophe in the early 19th century. Located in Milot near the Citadel, this sumptuous palace was nicknamed the 'Versailles of the Caribbean'.",
                        history: "Built between 1810 and 1813, the palace was the center of the Kingdom of Haiti until the king's suicide in 1820. Destroyed by an earthquake in 1842, its majestic ruins are now classified as a UNESCO World Heritage Site."
                    },
                    es: {
                        name: "Palacio Sans Souci",
                        description: "El Palacio Sans Souci fue la residencia real del rey Henri Christophe a principios del siglo XIX. Ubicado en Milot, cerca de la Ciudadela, este suntuoso palacio fue apodado el 'Versalles del Caribe'.",
                        history: "Construido entre 1810 and 1813, el palacio fue el centro del Reino de Haití hasta el suicidio del rey en 1820. Destruido por un terremoto en 1842, sus majestuosas ruinas están clasificadas hoy como Patrimonio de la Humanidad por la UNESCO."
                    }
                }
            };
            
            function showMainPage() {
                document.querySelectorAll('main > section, main > div').forEach(el => {
                    if (!el.classList.contains('attraction-detail')) {
                        el.style.display = 'block';
                    }
                });
                
                document.querySelectorAll('.attraction-detail').forEach(detail => {
                    detail.style.display = 'none';
                });
            }

            // Only bind attraction detail listeners to buttons that have a data-attraction attribute
            document.querySelectorAll('.learn-more-btn[data-attraction]').forEach(button => {
                button.addEventListener('click', function() {
                    const attractionId = this.dataset.attraction;
                    if (!attractionId || !attractions[attractionId]) return; // defensive
                    const attraction = attractions[attractionId][currentLanguage] || attractions[attractionId]['fr'];
                    const detailContainer = document.getElementById(`${attractionId}-detail`);
                    if (!detailContainer) return;

                    document.querySelectorAll('main > section, main > div').forEach(el => {
                        if (!el.classList.contains('attraction-detail')) {
                            el.style.display = 'none';
                        }
                    });

                    detailContainer.style.display = 'block';
                    detailContainer.innerHTML = `
                        <button id="backToMain" class="mb-6 bg-gray-100 text-gray-700 px-4 py-2 !rounded-button font-medium cursor-pointer back-to-main-btn btn-glow">
                            <i class="ri-arrow-left-line"></i> <span data-translate="back">Retour</span>
                        </button>
                        
                        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                            <div class="h-64 bg-cover bg-center" style="background-image: url('${attractionId === 'citadelle' ? 'img12.jpg' : 
                                                                                          attractionId === 'labadee' ? 'img9.webp.jpg' : 
                                                                                          attractionId === 'verrieres' ? 'img11.jpg' : 
                                                                                          attractionId === 'cathedrale' ? 'img4.jpg' : 'img10.jpg'}')"></div>
                            <div class="p-6">
                                <h2 class="text-3xl font-bold text-gray-800 mb-4">${attraction.name}</h2>
                                
                                <div class="mb-6">
                                    <h3 class="text-xl font-semibold text-gray-800 mb-2" data-translate="description">Description</h3>
                                    <p class="text-gray-600">${attraction.description}</p>
                                </div>
                                
                                <div class="mb-6">
                                    <h3 class="text-xl font-semibold text-gray-800 mb-2" data-translate="history">Histoire</h3>
                                    <p class="text-gray-600">${attraction.history}</p>
                                </div>
                                
                                <div class="mb-6">
                                    <h3 class="text-xl font-semibold text-gray-800 mb-2" data-translate="visit">Visiter</h3>
                                    <p class="text-gray-600 mb-4" data-translate="visit_desc">Commandez un taxi pour visiter ce lieu historique :</p>
                                    <div class="double-button-container">
                                        <button id="backToMainBottom" class="bg-gray-100 text-gray-700 px-6 py-3 !rounded-button font-medium cursor-pointer back-to-main-btn">
                                            <i class="ri-arrow-left-line"></i> <span data-translate="back">Retour</span>
                                        </button>
                                        <button class="gold-button px-6 py-3 !rounded-button font-semibold visit-btn btn-glow" data-attraction="${attraction.name}">
                                            <span data-translate="order">Commander</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Traduire les éléments dynamiques dans la page de détail
                    updateLanguage(currentLanguage);

                    document.querySelectorAll('.back-to-main-btn').forEach(btn => {
                        btn.addEventListener('click', showMainPage);
                    });

                    const visitButton = detailContainer.querySelector('.visit-btn');
                    visitButton.addEventListener('click', function() {
                        const attractionName = this.dataset.attraction;
                        
                        document.getElementById('destinationAddressArrival').value = attractionName;
                        
                        document.getElementById('destinationSwitch').checked = false;
                        document.getElementById('destinationField').classList.add('hidden');
                        document.getElementById('nowBtn').classList.add('active');
                        document.getElementById('laterBtn').classList.remove('active');
                        document.getElementById('dateTimeSection').classList.add('hidden');
                        document.getElementById('bookingDescription').value = '';
                        
                        showMainPage();
                        
                        document.getElementById('bookingSection').scrollIntoView({ behavior: 'smooth' });
                    });
                });
            });
        }

        // ===========================================
        // GESTION DES INTERACTIONS UTILISATEUR
        // ===========================================

        // Gérer la visibilité des mots de passe
        function handlePasswordVisibility() {
            const togglePassword = (inputId, iconId) => {
                const passwordInput = document.getElementById(inputId);
                const icon = document.getElementById(iconId);
                if (!passwordInput || !icon) return;

                // Ensure icon is visible (in case previous logic hid it)
                icon.style.display = '';
                icon.setAttribute('role', 'button');
                icon.setAttribute('aria-label', 'Toggle password visibility');

                // Remove any existing listener by replacing the node with a clone
                const newIcon = icon.cloneNode(true);
                icon.parentNode.replaceChild(newIcon, icon);

                newIcon.addEventListener('click', function(e) {
                    try {
                        if (passwordInput.type === 'password') {
                            passwordInput.type = 'text';
                            newIcon.classList.remove('ri-eye-line');
                            newIcon.classList.add('ri-eye-off-line');
                        } else {
                            passwordInput.type = 'password';
                            newIcon.classList.remove('ri-eye-off-line');
                            newIcon.classList.add('ri-eye-line');
                        }
                    } catch(err) {
                        // Fallback: toggle input 'data-visible' attribute
                        const v = passwordInput.getAttribute('data-visible') === '1';
                        passwordInput.setAttribute('data-visible', v ? '0' : '1');
                    }
                });
            };

            // Attach to known toggles
            togglePassword('passwordInput', 'loginTogglePassword');
            togglePassword('password', 'passwordToggle');
            togglePassword('confirmPassword', 'confirmPasswordToggle');

            // Safety: delegated handler for any future toggle-password icons inserted dynamically
            document.addEventListener('click', function(e) {
                const t = e.target.closest && e.target.closest('.toggle-password');
                if (!t) return;
                // find the nearest input sibling in the same container
                const container = t.parentNode;
                if (!container) return;
                const input = container.querySelector('input[type="password"], input[type="text"]');
                if (!input) return;
                // toggle
                if (input.type === 'password') {
                    input.type = 'text';
                    t.classList.remove('ri-eye-line');
                    t.classList.add('ri-eye-off-line');
                } else {
                    input.type = 'password';
                    t.classList.remove('ri-eye-off-line');
                    t.classList.add('ri-eye-line');
                }
            });
        }

        // Vérifier le statut de téléchargement de l'application
        async function checkAppDownloadStatus() {
            const appDownloadModal = document.getElementById('appDownloadModal');
            
            const userId = localStorage.getItem('userId');
            const ip = await getUserIP();
            
            let hasDownloaded = false;
            
            if (userId) {
                const userRef = database.ref(`app_download/users/${userId}`);
                const snapshot = await userRef.once('value');
                if (snapshot.exists() && snapshot.val().apk_downloaded) {
                    hasDownloaded = true;
                }
            }
            
            if (!hasDownloaded && ip) {
                const ipRef = database.ref(`app_download/ips/${ip.replace(/\./g, '_')}`);
                const snapshot = await ipRef.once('value');
                if (snapshot.exists() && snapshot.val().apk_downloaded) {
                    hasDownloaded = true;
                }
            }
            
            if (!hasDownloaded) {
                appDownloadModal.style.display = 'flex';
            }
        }

        // Marquer l'application comme téléchargée
        async function markAppAsDownloaded() {
            const userId = localStorage.getItem('userId');
            const ip = await getUserIP();
            
            if (userId) {
                const userRef = database.ref(`app_download/users/${userId}`);
                userRef.set({
                    apk_downloaded: true,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
            }
            
            if (ip) {
                const ipKey = ip.replace(/\./g, '_');
                const ipRef = database.ref(`app_download/ips/${ipKey}`);
                ipRef.set({
                    apk_downloaded: true,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
            }
        }

        // Gérer la modale de téléchargement d'application
        function handleAppDownloadModal() {
            const modal = document.getElementById('appDownloadModal');
            const closeBtns = document.querySelectorAll('.close-app-modal, #closeAppModalBtn');
            const downloadBtn = document.getElementById('downloadAppBtn');
            const downloadApkBtn = document.getElementById('downloadApkBtn');
            
            closeBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    modal.style.display = 'none';
                });
            });
            
            downloadBtn.addEventListener('click', async function() {
                await markAppAsDownloaded();
                modal.style.display = 'none';
            });
            
            downloadApkBtn.addEventListener('click', function() {
                window.location.href = 'Julmin Taxi.apk';
                markAppAsDownloaded();
            });
        }

        // Gérer le changement de langue
        function handleLanguageChange() {
            const languageSelect = document.getElementById('languageSelect');
            
            // Charger la langue préférée depuis localStorage
            const savedLanguage = localStorage.getItem('preferredLanguage');
            if (savedLanguage) {
                languageSelect.value = savedLanguage;
                updateLanguage(savedLanguage);
            } else {
                // Définir la langue par défaut sur Kreyòl si aucune préférence
                languageSelect.value = 'ht';
                updateLanguage('ht');
            }
            
            languageSelect.addEventListener('change', function() {
                updateLanguage(this.value);
            });
        }

        // Configurer les suggestions d'adresses
        function setupAddressSuggestions(inputId) {
            const inputElement = document.getElementById(inputId);
            const suggestionsContainer = document.getElementById(`${inputId}Suggestions`);
            
            // Liste de tous les lieux disponibles
            const allPlaces = [];
            
            // Génération des rues
            for (let i = 0; i <= 24; i++) {
                for (let j = 0; j < 16; j++) {
                    const letter = String.fromCharCode(65 + j);
                    allPlaces.push(`Rue ${i} ${letter}`);
                }
            }
            
            // Ajout des autres lieux
            allPlaces.push(
                'Collège Notre-Dame du Perpétuel Secours',
                'Lycée Philippe Guerrier',
                'Collège Regina Assumpta',
                'École des Frères de l’Instruction Chrétienne',
                'École Saint‑Joseph de Cluny',
                'Université Publique du Nord (UPNCH)',
                'Université Chrétienne du Nord (UCN)',
                'Campus Henri-Christophe (Limonade)',
                'Académie Chrétienne du Cap‑Haïtien',
                'École Universelle de Jésus‑Christ',
                'Centre de Formation Classique (CFC)',
                'Faculté d’Agronomie (UPNCH campus)',
                'École Mixte Classique',
                'École Mixte de la Grâce',
                'École Professionnelle INUKA',
                'École Technique Sobenaire',
                'École Sainte‑Catherine',
                'Collège Pierre‐Lussier',
                'Institut Technique Saint‑Louis',
                'Académie du Peuple',
                'Fondation Culturelle Cap‑Haïtien',
                'Cathédrale Notre‑Dame de l’Assomption',
                'Église Baptiste de la Foi',
                'Temple Adventiste du 7ᵉ jour',
                'Église Synagogue de Jésus‑Christ',
                'Église de L’Espoir',
                'Église Méthodiste Libre',
                'Église Evangélique des Frères Unis',
                'Église de Dieu',
                'Église Tabernacle de Gloire',
                'Église Wesleyenne',
                'Église Saint‑Pierre (quartier)',
                'Centre Spirituel Gospel',
                'Chapelle Sainte‑Marie',
                'Temple Pentecôte de Cap‑Haïtien',
                'Assemblée de Dieu Cap‑Haïtien',
                'Église zioniste des Nations',
                'Église de la Jérémie Divine',
                'Place d’Armes (place de la cathédrale)',
                'Parc Saint‑Victor (stade)',
                'Square Dessalines / statue Dessalines',
                'Palindrome José Martí Square',
                'Parc central du boulevard',
                'Jardins publics près du port',
                'Stade scolaire Collège Notre-Dame',
                'Parc municipal des sports',
                'Espaces verts du quartier La Fossette',
                'Aire de jeux Plaine‑du‑Nord',
                'Morne Jean (promontoire naturel)',
                'Satama Hôtel',
                'Hôtel Cormier Plage',
                'Residence Royale Hotel',
                'Les Alizés Hotel',
                'Auberge du Picolet (hôtel + restaurant)',
                'Hotel Hostellerie du Roi Henri',
                'Hôtel Mont‑Fort',
                'Mont-Joli Hôtel',
                'Hôtel Imperial',
                'Résidence Royale (villa/hôtel)',
                'Visa Lodge',
                'Karibe',
                'El Rancho Luxembourg',
                'Habitation Des Lauriers',
                'Du Roi Christophe',
                'Le Paradis S. Hotel',
                'J&G Villa Hotel',
                'Vue Apartment Hotel',
                'Metro Residences Hotel',
                'Three Kings Hotel (Vertières)',
                'Villa Prosper Guest House',
                'Lakay Restaurant (Boulevard du Carénage)',
                'Cap Deli',
                'Boukanye',
                'Auberge du Picolet Restaurant',
                'Café colonial centre-ville',
                'Snack Riz & Pois La Fossette',
                'Restaurant Panorama (Vue port)',
                'Le Petit Café du Rivière',
                'La Terrasse du Carré',
                'Le Griot du Cap',
                'Café Vertières',
                'Brasserie Place d’Armes',
                'Snack Pâtisserie Cap‑Haïtien',
                'Restaurant l’Ananas',
                'Bar‑restaurant Rivière',
                'Citadelle Laferrière (Milot)',
                'Palais Sans‑Souci (Milot)',
                'Fort Picolet (cap‑haïtien)',
                'Fort Saint‑Joseph',
                'Monument des Héros de Vertières (statue)',
                'Musée des Beaux‑Arts du Cap‑Haïtien',
                'Cathédrale Notre‑Dame',
                'Palais de Justice de Cap‑Haïtien',
                'Bois Caïman (lieu révolutionnaire)',
                'Plage de Labadee',
                'Plage de Cormier',
                'Plage du Camp-Louise',
                'Plage de Rival',
                'Plage de la Ducrroix (ou Du Croix Est)'
            );
            
            inputElement.addEventListener('input', function() {
                const value = this.value.trim();
                suggestionsContainer.innerHTML = '';
                
                if (value.length > 0) {
                    const normalizedValue = normalizeString(value);
                    const filteredPlaces = allPlaces.filter(place => 
                        normalizeString(place).includes(normalizedValue)
                    );
                    
                    const topSuggestions = filteredPlaces.slice(0, 5);
                    
                    if (topSuggestions.length > 0) {
                        suggestionsContainer.classList.remove('hidden');
                        topSuggestions.forEach(place => {
                            const suggestionItem = document.createElement('div');
                            suggestionItem.className = 'suggestion-item';
                            suggestionItem.textContent = place;
                            suggestionsContainer.appendChild(suggestionItem);
                        });
                    } else {
                        suggestionsContainer.classList.add('hidden');
                    }
                } else {
                    suggestionsContainer.classList.add('hidden');
                }
            });
            
            suggestionsContainer.addEventListener('click', function(e) {
                if (e.target.classList.contains('suggestion-item')) {
                    inputElement.value = e.target.textContent;
                    suggestionsContainer.classList.add('hidden');
                }
            });
            
            document.addEventListener('click', function(e) {
                if (e.target !== inputElement) {
                    suggestionsContainer.classList.add('hidden');
                }
            });
        }

        // Détection iOS et affichage de la bannière d'installation
        function handleIOSInstallBanner() {
            const isIOS = /iphone|ipad|ipod/.test(window.navigator.userAgent.toLowerCase());
            const isInStandaloneMode = ('standalone' in window.navigator) && window.navigator.standalone;
            
            if (isIOS && !isInStandaloneMode) {
                document.getElementById("installBanner").style.display = "block";
                
                document.getElementById("installBtn").addEventListener("click", () => {
                    alert("Pour installer l'app :\n\n Cliquez sur le bouton PARTAGER (icône en bas au milieu)\n Choisissez 'Ajouter à l'écran d'accueil'");
                });
            }
        }

        // Gérer la destination switch
        function handleDestinationSwitch() {
            const destinationSwitch = document.getElementById('destinationSwitch');
            const destinationField = document.getElementById('destinationField');
            
            destinationSwitch.addEventListener('change', function() {
                if (this.checked) {
                    destinationField.classList.remove('hidden');
                } else {
                    destinationField.classList.add('hidden');
                }
            });
        }

        // Gérer les boutons de sélection de temps
        function handleTimeSelectionButtons() {
            const nowBtn = document.getElementById('nowBtn');
            const laterBtn = document.getElementById('laterBtn');
            const dateTimeSection = document.getElementById('dateTimeSection');
            const destinationSwitch = document.getElementById('destinationSwitch');
            
            nowBtn.addEventListener('click', function() {
                nowBtn.classList.add('active');
                laterBtn.classList.remove('active');
                dateTimeSection.classList.add('hidden');
            });
            
            laterBtn.addEventListener('click', function() {
                laterBtn.classList.add('active');
                nowBtn.classList.remove('active');
                dateTimeSection.classList.remove('hidden');
                
                destinationSwitch.checked = true;
                document.getElementById('destinationField').classList.remove('hidden');
            });
        }

        // Gérer les boutons de type de trajet
        function handleTripTypeButtons() {
            const oneWayBtn = document.getElementById('oneWayBtn');
            const roundTripBtn = document.getElementById('roundTripBtn');
            
            oneWayBtn.addEventListener('click', function() {
                oneWayBtn.classList.add('active');
                roundTripBtn.classList.remove('active');
            });
            
            roundTripBtn.addEventListener('click', function() {
                roundTripBtn.classList.add('active');
                oneWayBtn.classList.remove('active');
            });
        }

        // Gérer la modale de connexion
        function handleLoginModal() {
            const modal = document.getElementById('loginModal');
            const openBtn = document.getElementById('loginBtn');
            const closeBtns = document.querySelectorAll('.close-modal, #closeAppModalBtn');
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            openBtn.addEventListener('click', function() {
                modal.style.display = 'flex';
            });
            
            closeBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.modal').forEach(modal => {
                        modal.style.display = 'none';
                    });
                });
            });
            
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.dataset.tab;
                    
                    tabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    tabContents.forEach(content => content.classList.remove('active'));
                    document.getElementById(`${tabId}Tab`).classList.add('active');
                    
                    // Générer un ID unique si on est sur l'onglet inscription
                    if (tabId === 'signup') {
                        generateUniqueId().then(userId => {
                            document.getElementById('generatedUserId').textContent = userId;
                        });
                    }
                });
            });
            
            document.getElementById('loginWithIdBtn').addEventListener('click', function() {
                const userId = document.getElementById('userIdInput').value.trim();
                
                if (!userId || userId.length !== 4 || isNaN(userId)) {
                    alert('Veuillez entrer un ID valide à 4 chiffres');
                    return;
                }
                
                const saveMemberRef = database.ref('save_member');
                saveMemberRef.orderByChild('userId').equalTo(userId).once('value', snapshot => {
                    if (snapshot.exists()) {
                        snapshot.forEach(child => {
                            const user = child.val();
                            
                            const fullName = `${user.prenom} ${user.nom}`;
                            localStorage.setItem('userName', fullName);
                            localStorage.setItem('userId', userId);
                            localStorage.setItem('userType', 'save');
                            
                            displayUserName();
                            modal.style.display = 'none';
                        });
                    } else {
                        alert('Aucun compte trouvé avec cet ID');
                    }
                });
            });
            
            document.getElementById('loginWithPasswordBtn').addEventListener('click', function() {
                const email = document.getElementById('emailInput').value.trim();
                const password = document.getElementById('passwordInput').value;
                
                if (!email || !password) {
                    alert('Veuillez remplir tous les champs');
                    return;
                }
                
                const saveMemberRef = database.ref('save_member');
                saveMemberRef.orderByChild('email').equalTo(email).once('value', snapshot => {
                    if (snapshot.exists()) {
                        let userFound = false;
                        snapshot.forEach(child => {
                            const user = child.val();
                            if (user.password === password) {
                                userFound = true;
                                
                                const fullName = `${user.prenom} ${user.nom}`;
                                localStorage.setItem('userName', fullName);
                                localStorage.setItem('userId', user.userId);
                                localStorage.setItem('userType', 'save');
                                
                                displayUserName();
                                modal.style.display = 'none';
                            }
                        });
                        
                        if (!userFound) {
                            alert('Mot de passe incorrect');
                        }
                    } else {
                        alert('Aucun compte trouvé avec cet email');
                    }
                });
            });
            
            // Gestion de la création de compte dans la modale
            const form = document.getElementById('createAccountForm');
            const modalIdInfoIcon = document.getElementById('modalIdInfoIcon');
            
            modalIdInfoIcon.addEventListener('click', function() {
                alert("Votre ID unique est nécessaire pour accéder à votre compte depuis un autre appareil. Conservez-le précieusement.");
            });
            
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const lastName = document.getElementById('lastName').value;
                const firstName = document.getElementById('firstName').value;
                const email = document.getElementById('email').value;
                const countryCode = document.getElementById('countryCode').value;
                const phone = document.getElementById('phone').value;
                const fullPhone = countryCode + phone;
                const password = document.getElementById('password').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                const age = document.getElementById('age').value;
                const ip = await getUserIP();
                const userId = document.getElementById('generatedUserId').textContent;
                
                if (password !== confirmPassword) {
                    document.getElementById('passwordError').style.display = 'block';
                    return;
                } else {
                    document.getElementById('passwordError').style.display = 'none';
                }
                
                // Générer un OTP
                const otp = await generateUniqueOTP();
                
                if (ip) {
                    // Sauvegarder l'utilisateur avec email non vérifié
                    const saveMemberRef = database.ref('save_member').push();
                    const orderId = saveMemberRef.key;
                    saveMemberRef.set({
                        nom: lastName,
                        prenom: firstName,
                        email: email,
                        phone: fullPhone,
                        password: password,
                        age: age,
                        ip: ip,
                        userId: userId,
                        emailVerified: false,
                        otp: otp,
                        date_inscription: new Date().toISOString()
                    });
                    
                    // Envoyer l'email avec l'OTP
                    try {
                        await sendOTPEmail(email, otp);
                        
                        // Afficher la modale de vérification
                        showEmailVerification(email);
                        document.getElementById('loginModal').style.display = 'none';
                        
                        // Stocker temporairement les infos utilisateur
                        sessionStorage.setItem('tempUser', JSON.stringify({
                            nom: lastName,
                            prenom: firstName,
                            email: email,
                            phone: fullPhone,
                            password: password,
                            age: age,
                            ip: ip,
                            userId: userId
                        }));
                        
                    } catch (error) {
                        console.error("Erreur lors de l'envoi de l'email:", error);
                        alert("Erreur lors de l'envoi de l'email de vérification. Veuillez réessayer.");
                    }
                } else {
                    alert('Erreur lors de la création du compte. Veuillez réessayer.');
                }
            });
        }

        // Gérer la vérification d'email
        function handleEmailVerification() {
            const verifyBtn = document.getElementById('verifyOtpBtn');
            const resendLink = document.getElementById('resendOtp');
            const otpInput = document.getElementById('otpInput');
            
            verifyBtn.addEventListener('click', async function() {
                const otp = otpInput.value.trim();
                const tempUser = JSON.parse(sessionStorage.getItem('tempUser'));
                
                if (!otp || otp.length !== 6) {
                    alert('Veuillez entrer un code de vérification valide');
                    return;
                }
                
                // Vérifier l'OTP dans la base de données
                const saveMemberRef = database.ref('save_member');
                const snapshot = await saveMemberRef.orderByChild('userId').equalTo(tempUser.userId).once('value');
                
                if (snapshot.exists()) {
                    let otpValid = false;
                    snapshot.forEach(child => {
                        const user = child.val();
                        if (user.otp === otp) {
                            otpValid = true;
                            
                            // Mettre à jour le statut de vérification
                            child.ref.update({
                                emailVerified: true,
                                otp: null
                            });
                            
                            const fullName = `${tempUser.prenom} ${tempUser.nom}`;
                            localStorage.setItem('userName', fullName);
                            localStorage.setItem('userId', tempUser.userId);
                            localStorage.setItem('userType', 'save');
                            
                            displayUserName();
                            document.getElementById('emailVerificationModal').style.display = 'none';
                            sessionStorage.removeItem('tempUser');
                            
                            alert('Compte créé et vérifié avec succès!');
                        }
                    });
                    
                    if (!otpValid) {
                        alert('Code de vérification incorrect');
                    }
                } else {
                    alert('Erreur de vérification. Veuillez réessayer.');
                }
            });
            
            resendLink.addEventListener('click', async function() {
                const tempUser = JSON.parse(sessionStorage.getItem('tempUser'));
                
                // Générer un nouveau OTP
                const newOtp = await generateUniqueOTP();
                
                // Mettre à jour l'OTP dans la base de données
                const saveMemberRef = database.ref('save_member');
                const snapshot = await saveMemberRef.orderByChild('userId').equalTo(tempUser.userId).once('value');
                
                if (snapshot.exists()) {
                    snapshot.forEach(child => {
                        child.ref.update({
                            otp: newOtp
                        });
                    });
                    
                    // Renvoyer l'email
                    try {
                        await sendOTPEmail(tempUser.email, newOtp);
                        alert('Nouveau code de vérification envoyé!');
                    } catch (error) {
                        console.error("Erreur lors de l'envoi de l'email:", error);
                        alert("Erreur lors de l'envoi de l'email de vérification. Veuillez réessayer.");
                    }
                }
            });
        }

        // Gérer le bouton de déconnexion
        function handleLogoutButton() {
            document.getElementById('logoutBtn').addEventListener('click', function() {
                logoutUser();
            });
        }

        // Gérer l'icône d'information sur l'ID
        function handleIdInfoIcon() {
            const infoIcon = document.getElementById('idInfoIcon');
            const infoMessage = document.getElementById('idInfoMessage');

            if (!infoIcon) {
                console.debug('handleIdInfoIcon: #idInfoIcon not found; skipping');
                return;
            }

            if (!infoMessage) {
                console.debug('handleIdInfoIcon: #idInfoMessage not found; skipping');
                return;
            }

            infoIcon.addEventListener('click', function() {
                infoMessage.classList.remove('hidden');

                setTimeout(() => {
                    infoMessage.classList.add('hidden');
                }, 5000);
            });
        }

        // Gérer la modale de permission de localisation
        function handleLocationPermissionModal() {
            const modal = document.getElementById('locationPermissionModal');
            const closeBtn = document.getElementById('closeLocationModalBtn');
            const acceptBtn = document.getElementById('acceptLocationBtn');
            const hideModal = () => {
                modal.style.display = 'none';
            };

            const onClose = function handler() {
                hideModal();
                // detach to prevent duplicates
                closeBtn.removeEventListener('click', handler);
            };

            const onAccept = function handlerAccept() {
                hideModal();
                acceptBtn.removeEventListener('click', handlerAccept);
            };

            closeBtn.addEventListener('click', onClose);
            acceptBtn.addEventListener('click', onAccept);

            return modal;
        }

        // ===========================================
        // GESTION SPÉCIALE iOS
        // ===========================================

        // Détecter si l'utilisateur est sur iOS
        function isIOS() {
            return [
                'iPad Simulator',
                'iPhone Simulator',
                'iPod Simulator',
                'iPad',
                'iPhone',
                'iPod'
            ].includes(navigator.platform) || 
            (navigator.userAgent.includes("Mac") && "ontouchend" in document);
        }

        // Gérer l'affichage des boutons de téléchargement selon l'appareil
        function handleDownloadButtons() {
            const downloadApkBtn = document.getElementById('downloadApkBtn');
            const iosInstallBtn = document.getElementById('iosInstallBtn');
            
            if (isIOS()) {
                // Cacher le bouton APK Android et afficher le bouton iOS
                downloadApkBtn.style.display = 'none';
                iosInstallBtn.style.display = 'inline-flex';
                
                // Gérer le clic sur le bouton iOS
                iosInstallBtn.addEventListener('click', function() {
                    document.getElementById('iosInstallModal').style.display = 'flex';
                });
            } else {
                // Cacher le bouton iOS et afficher le bouton APK Android
                downloadApkBtn.style.display = 'inline-flex';
                iosInstallBtn.style.display = 'none';
            }
        }

        // Gérer la modale d'installation iOS
        function handleIOSInstallModal() {
            const modal = document.getElementById('iosInstallModal');
            const closeBtns = document.querySelectorAll('#closeIosModalBtn, #closeIosModalConfirmBtn');
            
            closeBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    modal.style.display = 'none';
                });
            });
        }

        // ===========================================
        // GESTION DE LA SECTION DES PLANS DE SERVICES
        // ===========================================

        // Initialiser la section des plans de services
        function initServicePlansSection() {
            const plansContainer = document.querySelector('.plans-container');
            const planCards = document.querySelectorAll('.plan-card');
            const dots = document.querySelectorAll('.dot');
            const leftArrow = document.querySelector('.nav-arrow.left');
            const rightArrow = document.querySelector('.nav-arrow.right');
            if (!plansContainer || !planCards || planCards.length === 0) return;
            
            // Mettre à jour l'affichage des cartes et indicateurs
            function updateActivePlan(index) {
                // Mettre à jour les cartes
                planCards.forEach((card, i) => {
                    if (i === index) {
                        card.classList.add('active');
                    } else {
                        card.classList.remove('active');
                    }
                });
                
                // Mettre à jour les indicateurs de points
                dots.forEach((dot, i) => {
                    if (i === index) {
                        dot.classList.add('active');
                    } else {
                        dot.classList.remove('active');
                    }
                });
                
                // Faire défiler la carte active au centre
                // Defensive card width calculation (fallback to 300)
                const cardEl = planCards[0];
                const computedGap = parseInt(getComputedStyle(cardEl).marginRight || 20, 10) || 20;
                const cardWidth = (cardEl.offsetWidth || 280) + computedGap;
                plansContainer.scrollLeft = Math.round(index * cardWidth);
            }
            
            // Auto-scroll state
            let autoScrollTimer = null;
            const autoScrollDelay = 3000; // milliseconds
            let autoScrollRunning = false;

            function startAutoScroll() {
                if (autoScrollRunning) return;
                autoScrollRunning = true;
                autoScrollTimer = setInterval(() => {
                    currentPlanIndex = (currentPlanIndex + 1) % totalPlans;
                    updateActivePlan(currentPlanIndex);
                }, autoScrollDelay);
            }

            function stopAutoScroll() {
                if (!autoScrollRunning) return;
                autoScrollRunning = false;
                if (autoScrollTimer) {
                    clearInterval(autoScrollTimer);
                    autoScrollTimer = null;
                }
            }

            // Gestion des flèches de navigation — arrêtent l'auto-scroll puis effectuent
            // la navigation manuelle dans la direction choisie.
            if (leftArrow) {
                leftArrow.addEventListener('click', function() {
                    stopAutoScroll();
                    currentPlanIndex = (currentPlanIndex - 1 + totalPlans) % totalPlans;
                    updateActivePlan(currentPlanIndex);
                });
            }

            if (rightArrow) {
                rightArrow.addEventListener('click', function() {
                    stopAutoScroll();
                    currentPlanIndex = (currentPlanIndex + 1) % totalPlans;
                    updateActivePlan(currentPlanIndex);
                });
            }
            
            // Gestion des indicateurs de points
            dots.forEach((dot, index) => {
                dot.addEventListener('click', function() {
                    stopAutoScroll();
                    currentPlanIndex = index;
                    updateActivePlan(currentPlanIndex);
                });
            });

            // Start auto-scroll by default (will stop when user clicks an arrow)
            startAutoScroll();
            
            // Gestion des boutons "En savoir plus" (bind only if data-plan present)
            document.querySelectorAll('.learn-more-btn[data-plan]').forEach(button => {
                button.addEventListener('click', function() {
                    const planId = this.dataset.plan;
                    if (!planId) return;
                    const modal = document.getElementById(`planModal${planId}`);
                    if (modal) {
                        modal.style.display = 'flex';
                    }
                });
            });
            
            // Gestion de la fermeture des modales de plans
            document.querySelectorAll('.close-plan-modal').forEach(button => {
                button.addEventListener('click', function() {
                    document.querySelectorAll('.plan-modal').forEach(modal => {
                        modal.style.display = 'none';
                    });
                });
            });
            
            // Fermer les modales en cliquant à l'extérieur
            document.querySelectorAll('.plan-modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.style.display = 'none';
                    }
                });
            });
            
            // Gestion des formulaires dans les modales de plans
            document.querySelectorAll('.order-plan-btn').forEach(button => {
                button.addEventListener('click', async function() {
                    const planId = this.dataset.plan;
                    const modal = document.getElementById(`planModal${planId}`);
                    const modalContent = modal.querySelector('.plan-form');
                    
                    // Récupérer les données du formulaire
                    let formData = {};
                    const inputs = modalContent.querySelectorAll('input, select, textarea');
                    
                    inputs.forEach(input => {
                        if (input.id && input.value) {
                            formData[input.id] = input.value;
                        }
                    });
                    
                    // Préparer les données pour la commande
                    const ip = await getUserIP();
                    const userId = localStorage.getItem('userId') || 'guest';
                    const userType = localStorage.getItem('userType') || 'guest';
                    const guestId = userId === 'guest' ? getOrCreateGuestId() : null;
                    if (guestId) {
                        try {
                            const unsaveMemberRef = database.ref('unsave_member');
                            unsaveMemberRef.orderByChild('guestId').equalTo(guestId).once('value', snapshot => {
                                if (!snapshot.exists()) {
                                    const newMemberRef = unsaveMemberRef.push();
                                    newMemberRef.set({ guestId: guestId, ip: ip, timestamp: firebase.database.ServerValue.TIMESTAMP });
                                }
                            });
                        } catch(e) {}
                    }
                    
                    // Fixed-price map for service plans that have a known price and
                    // therefore skip client price confirmation (admin already set price)
                    const planPrices = { '2': 50, '3': 90, '4': 75 };

                    // Choose the table to write to.
                    // For fixed-price plans we write into 'commande_unconfirmed' but set
                    // priceConfirmed=true so admins can assign a driver. This keeps the
                    // order in the "unconfirmed/accepted" workflow until a driver is
                    // actually assigned, avoiding premature 'confirmed' UX.
                    let commandeRef;
                    if (planPrices[planId]) {
                        commandeRef = database.ref('commande_unconfirmed').push();
                    } else {
                        commandeRef = database.ref('commande').push();
                    }
                    const orderId = commandeRef.key;
                    
                    // Déterminer le type de service en fonction du plan
                    let serviceType = '';
                    let description = '';
                    
                    switch(planId) {
                        case '1':
                            serviceType = 'Course Ville à Ville';
                            description = `Départ: ${formData['plan1-departure'] || 'Non spécifié'}, Destination: ${formData['plan1-destination'] || 'Non spécifié'}`;
                            break;
                        case '2':
                            serviceType = 'Demi-Journée (4 heures)';
                            description = `Départ: ${formData['plan2-departure'] || 'Non spécifié'}, Date: ${formData['plan2-date'] || 'Non spécifié'}, Heure: ${formData['plan2-time'] || 'Non spécifié'}`;
                            break;
                        case '3':
                            serviceType = 'Journée Complète (8 heures)';
                            description = `Départ: ${formData['plan3-departure'] || 'Non spécifié'}, Date: ${formData['plan3-date'] || 'Non spécifié'}, Heure: ${formData['plan3-time'] || 'Non spécifié'}`;
                            break;
                        case '4':
                            serviceType = 'Élégance Night';
                            description = `Départ: ${formData['plan4-departure'] || 'Non spécifié'}, Date: ${formData['plan4-date'] || 'Non spécifié'}, Heure: ${formData['plan4-time'] || 'Non spécifié'}, Occasion: ${formData['plan4-occasion'] || 'Non spécifié'}`;
                            break;
                        case '5':
                            serviceType = 'Business / VIP';
                            description = `Départ: ${formData['plan5-departure'] || 'Non spécifié'}, Fréquence: ${formData['plan5-frequency'] || 'Non spécifié'}, Type: ${formData['plan5-type'] || 'Non spécifié'}, Notes: ${formData['plan5-notes'] || 'Non spécifié'}`;
                            break;
                    }
                    
                    // Déterminer pickup et destination en fonction du plan
                    let pickup = formData[`plan${planId}-departure`] || "À définir";
                    let destination = serviceType;

                    if (planId === '1') {
                        destination = formData['plan1-destination'] || "À définir";
                    }

                    // Build payload — include price and priceConfirmed for fixed-price plans
                    const payload = {
                        userId: userId,
                        guestId: guestId || null,
                        userType: userType,
                        ip: ip,
                        pickup: pickup,
                        destination: destination,
                        description: description,
                        tripType: 'service_plan',
                        servicePlan: planId,
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        status: 'pending'
                    };

                    if (planPrices[planId]) {
                        // Known fixed price — treat as already accepted by the user
                        // but keep the record in 'commande_unconfirmed' until a driver is assigned.
                        payload.price = planPrices[planId];
                        payload.priceConfirmed = true;
                        payload.status = 'pending';
                    }

                    // Store a local fingerprint to avoid showing a duplicate when
                    // loadAllPendingRequests reads across multiple tables right after creation
                    try {
                        const fp = generateOrderKey(Object.assign({}, payload, { key: commandeRef.key }));
                        lastLocalOrderFingerprint = fp;
                        lastLocalOrderTimestamp = Date.now();
                    } catch(e) {}

                    commandeRef.set(payload).then(async () => {
                        // If we created a fixed-price confirmed order, remove any duplicate
                        // representations that may exist in other tables (commande, commande_unconfirmed,
                        // commande_transfered) by comparing the logical fingerprint.
                        if (payload.priceConfirmed) {
                            try {
                                const fp = lastLocalOrderFingerprint || generateOrderKey(Object.assign({}, payload, { key: orderId }));
                                const cleanupTables = ['commande','commande_unconfirmed','commande_transfered'];
                                for (const t of cleanupTables) {
                                    try {
                                        const snap = await database.ref(t).once('value');
                                        if (!snap.exists()) continue;
                                        snap.forEach(child => {
                                            try {
                                                const childData = child.val() || {};
                                                const childKey = child.key;
                                                if (!childKey || childKey === orderId) return;
                                                const childFp = generateOrderKey(Object.assign({}, childData, { key: childKey }));
                                                if (childFp === fp) {
                                                    // remove the duplicate entry
                                                    try { database.ref(`${t}/${childKey}`).remove(); } catch(e){}
                                                }
                                            } catch(e) {}
                                        });
                                    } catch(e) {}
                                }
                            } catch(e) { console.error('cleanup duplicates error', e); }
                        }
                        // Fermer la modale
                        modal.style.display = 'none';

                        if (payload.priceConfirmed) {
                            // For fixed-price plans, directly show confirmed section and
                            // treat order as accepted and waiting admin driver assignment.
                            const confirmedSection = document.getElementById('confirmed-request');
                            try {
                                confirmedSection.style.display = 'block';
                                confirmedSection.dataset.orderId = orderId;
                                confirmedSection.innerHTML = generateConfirmedContent(
                                    orderId,
                                    pickup,
                                    destination,
                                    null,
                                    null,
                                    null,
                                    'accepted',
                                    payload
                                );

                                const statusIntervalId = setInterval(() => checkConfirmedOrderStatus(orderId), 2000);
                                confirmedSection.dataset.intervalId = statusIntervalId;
                                confirmedSection.scrollIntoView({ behavior: 'smooth' });
                            } catch(e) { /* non-fatal */ }
                        } else {
                            // Afficher la section de commande en attente (normal flow)
                            const pendingSection = document.getElementById('pending-request');
                            pendingSection.style.display = 'block';
                            pendingSection.dataset.orderId = orderId;
                            pendingSection.innerHTML = generatePendingContent(
                                orderId,
                                pickup,
                                destination
                            );

                            const intervalId = setInterval(() => checkOrderStatus(orderId), 2000);
                            pendingSection.dataset.intervalId = intervalId;

                            pendingSection.scrollIntoView({ behavior: 'smooth' });
                        }

                        // Mettre à jour la liste des commandes en attente
                        loadAllPendingRequests();

                        alert('Votre commande de service a été enregistrée!');
                    }).catch(error => {
                        console.error("Erreur lors de l'enregistrement de la commande:", error);
                        alert("Erreur lors de l'enregistrement de la commande. Veuillez réessayer.");
                    });
                });
            });
            
            // Initialiser le scroll snap pour centrer la première carte
            updateActivePlan(currentPlanIndex);
        }

        // ===========================================
        // INITIALISATION DE L'APPLICATION
        // ===========================================

        // --- Itinéraires fréquents (computed from lat/lon) ---
        const _rawRoutes = [
            { id: 'r1', name: 'Cap-Haïtien → Ouanaminthe', A: [19.737050, -72.206792], B: [19.551396, -71.725539] },
            { id: 'r2', name: 'Cap-Haïtien → Fort-Liberté', A: [19.737050, -72.206792], B: [19.662329, -71.836902] },
            { id: 'r3', name: 'Cap-Haïtien → Gonaïves', A: [19.737050, -72.206792], B: [19.446064, -72.689355] },
            { id: 'r4', name: 'Cap-Haïtien → Port-de-Paix', A: [19.737050, -72.206792], B: [19.939532, -72.829959] },
            { id: 'r5', name: 'Gonaïves → Port-de-Paix', A: [19.446064, -72.689355], B: [19.939532, -72.829959] },
            { id: 'r6', name: 'Cap-Haïtien → Hinche', A: [19.737050, -72.206792], B: [19.1667, -72.0167] },
            { id: 'r7', name: 'Cap-Haïtien → Môle Saint-Nicolas', A: [19.737050, -72.206792], B: [19.804655, -73.375422] }
        ];

        function computeRoutes(raw, w=160, h=64, pad=8){
            const pts = [];
            raw.forEach(r=>{ pts.push(r.A); pts.push(r.B); });
            const lats = pts.map(p=>p[0]); const lons = pts.map(p=>p[1]);
            const minLat = Math.min(...lats), maxLat = Math.max(...lats);
            const minLon = Math.min(...lons), maxLon = Math.max(...lons);
            const latRange = (maxLat-minLat)||0.01; const lonRange = (maxLon-minLon)||0.01;
            const map = (lat,lon)=>{
                const x = pad + ((lon-minLon)/lonRange)*(w-pad*2);
                const y = pad + ((maxLat-lat)/latRange)*(h-pad*2);
                return [x,y];
            };
            return raw.map(r=>{
                const [ax,ay] = map(r.A[0], r.A[1]);
                const [bx,by] = map(r.B[0], r.B[1]);
                const cx = (ax+bx)/2; const cy = (ay+by)/2 - 6;
                const path = `M ${ax.toFixed(1)} ${ay.toFixed(1)} Q ${cx.toFixed(1)} ${cy.toFixed(1)} ${bx.toFixed(1)} ${by.toFixed(1)}`;
                // distance via haversine (km)
                const R=6371; const toR=d=>d*Math.PI/180; const dLat=toR(r.B[0]-r.A[0]); const dLon=toR(r.B[1]-r.A[1]);
                const a=Math.sin(dLat/2)**2 + Math.cos(toR(r.A[0]))*Math.cos(toR(r.B[0]))*Math.sin(dLon/2)**2;
                const c=2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); const dist=R*c;
                const duration = Math.max(5, Math.round((dist/50)*60));
                return { id: r.id, name: r.name, path, A:{x:ax,y:ay}, B:{x:bx,y:by}, distance: `${dist.toFixed(1)} km`, duration: `${duration} min` };
            });
        }

        const frequentRoutesData = computeRoutes(_rawRoutes);

        let frequentRoutesInitialized = false;
        function renderFrequentRoutes() {
            if (frequentRoutesInitialized) return;
            frequentRoutesInitialized = true;
            const container = document.getElementById('frequentRoutesContainer');
            if (!container) return;
            // make sure section visible
            try { container.style.display = ''; } catch(e) {}
            console.log && console.log('renderFrequentRoutes: container found, rendering...');
            const preferStatic = navigator.connection && navigator.connection.saveData;
            const animatePref = localStorage.getItem('freqRoutesAnimate') !== '0';
            // defensive: ensure we have route data
            if (!window.frequentRoutesData || !Array.isArray(window.frequentRoutesData) || window.frequentRoutesData.length === 0) {
                // try to compute from raw if available
                try { window.frequentRoutesData = computeRoutes ? computeRoutes(_rawRoutes) : [];
                } catch(e) { window.frequentRoutesData = []; }
            }

            // Remove any existing cards that contain decorative SVG curves (we prefer the static plain cards)
            Array.from(container.querySelectorAll('.frequent-route-card')).forEach(el => {
                if (el.querySelector && el.querySelector('svg.frequent-route-svg')) {
                    try { el.remove(); } catch(e) { el.parentNode && el.parentNode.removeChild(el); }
                }
            });

            // Build a set of already-present route names (from static markup) to avoid duplicates
            const existing = new Set();
            Array.from(container.querySelectorAll('[data-route]')).forEach(el => {
                const n = (el.getAttribute('data-route') || '').trim();
                if (n) existing.add(n);
            });

            frequentRoutesData.forEach(route => {
                // If the route data explicitly marks an icon presence, skip it to satisfy "only show cards without icons"
                if (route.hasIcon === true) return;
                // Skip if a card with same route name already exists (avoid duplicates between static and dynamic)
                if (existing.has(route.name)) return;
                // mark as seen to prevent duplicates from data itself
                existing.add(route.name);

                const card = document.createElement('div');
                card.className = 'frequent-route-card';
                card.tabIndex = 0;
                const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                svg.setAttribute('viewBox', '0 0 160 64');
                svg.classList.add('frequent-route-svg');
                const path = document.createElementNS(svg.namespaceURI, 'path');
                path.setAttribute('d', route.path);
                path.setAttribute('stroke', '#b8860b');
                path.setAttribute('stroke-width', '3');
                path.setAttribute('fill', 'none');
                svg.appendChild(path);
                // small taxi circle
                const taxi = document.createElementNS(svg.namespaceURI, 'circle');
                taxi.setAttribute('r', '3');
                taxi.setAttribute('fill', '#FFC107');
                taxi.setAttribute('cx', '5');
                taxi.setAttribute('cy', '40');
                svg.appendChild(taxi);

                const meta = document.createElement('div');
                meta.className = 'route-meta';
                meta.innerHTML = `<div class="font-semibold">${route.name}</div><div class="text-sm text-gray-600">${route.distance} • ${route.duration}</div>`;

                card.appendChild(svg);
                card.appendChild(meta);
                // set data-route attribute so future renders won't duplicate
                try { card.setAttribute('data-route', route.name); } catch(e){}
                container.appendChild(card);
                // ensure horizontal layout sizing (matches lazy initializer behavior)
                try { card.style.flex = '0 0 260px'; card.style.scrollSnapAlign = 'center'; } catch(e) {}

                // animate if allowed by connection and user preference
                if (!preferStatic && animatePref) {
                    let t = 0;
                    function frame() {
                        t = (t + 2) % 160;
                        taxi.setAttribute('cx', 5 + (t/160)*145);
                        if (route._animate !== false) requestAnimationFrame(frame);
                    }
                    requestAnimationFrame(frame);
                }
            });
            // If for some reason nothing appended, show a small fallback message so the section isn't empty
            if (!container.querySelector('.frequent-route-card')) {
                const fallback = document.createElement('div');
                fallback.className = 'bg-white border border-gray-200 rounded-lg p-4 text-center';
                fallback.textContent = 'Itinéraires fréquents momentanément indisponibles.';
                container.appendChild(fallback);
            }
        }

        function initFrequentRoutesLazy() {
            const sentinel = document.getElementById('frequentRoutesSection');
            if (!sentinel) return;
            if (navigator.connection && navigator.connection.saveData) {
                // render static only
                renderFrequentRoutes();
                return;
            }
            const io = new IntersectionObserver((entries, obs) => {
                entries.forEach(e => {
                    if (e.isIntersecting) {
                        renderFrequentRoutes();
                        obs.disconnect();
                    }
                });
            }, { rootMargin: '200px' });
            io.observe(sentinel);
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Initialisation des différentes fonctionnalités
            saveIPToDatabase();
            initDate();
            handleDestinationSwitch();
            handleTimeSelectionButtons();
            handleTripTypeButtons();
            displayUserName();
            // Wrapped initialization calls with debug logging so we can see where JS stops
            (function runInit(){
                const steps = [
                    'handleLoginModal', 'handleEmailVerification', 'handleTaxiOrder', 'handleOrderActions',
                    'handleLogoutButton', 'handleAppDownloadModal', 'loadDrivers', 'loadTripHistory',
                    'handleTouristAttractions', 'handlePasswordVisibility', 'handleIdInfoIcon', 'checkAppDownloadStatus',
                    'handleLanguageChange', 'handleIOSInstallBanner', 'handleDownloadButtons', 'handleIOSInstallModal'
                ];
                steps.forEach(name => {
                    try {
                        window.appLog && window.appLog('init: calling ' + name);
                        const fn = window[name] || (typeof eval === 'function' && eval(name));
                        if (typeof fn === 'function') {
                            fn();
                            window.appLog && window.appLog('init: completed ' + name);
                        } else {
                            window.appLog && window.appLog('init: SKIPPED ' + name + ' (not defined)');
                        }
                    } catch (e) {
                        window.appLog && window.appLog('init: ERROR in ' + name + ' -> ' + (e && e.message ? e.message : String(e)));
                        console.error('Init error in', name, e);
                    }
                });
            })();
            
            // Initialiser les suggestions d'adresses
            setupAddressSuggestions('destinationAddress');
            setupAddressSuggestions('destinationAddressArrival');
            
            // Initialiser la section des plans de services
            initServicePlansSection();
            // Re-apply translations after plans are rendered so dynamic plan text gets localized
            try { if (typeof updateLanguage === 'function') updateLanguage(currentLanguage); } catch(e) {}

            // Show notification banner if we should ask the user
            try { if (typeof showNotificationBannerIfNeeded === 'function') showNotificationBannerIfNeeded(); } catch(e) {}
            
            // Initialiser les écouteurs
            const userId = localStorage.getItem('userId');
            try { subscribeToOrderChanges(); } catch(e) {}
            if (userId) {
                if (unsubscribeUnconfirmedRequests) {
                    unsubscribeUnconfirmedRequests();
                }
                
                if (unsubscribePendingRequests) {
                    unsubscribePendingRequests();
                }
            }
            
            // Charger les données initiales
            loadAllPendingRequests();
            // Ask for notification permission once (if not already decided)
            try {
                const stored = localStorage.getItem('notifyPermission');
                if (!stored && 'Notification' in window) {
                    Notification.requestPermission().then(p => {
                        localStorage.setItem('notifyPermission', p);
                    }).catch(e => { localStorage.setItem('notifyPermission', 'denied'); });
                }
            } catch(e) {}
            // Souscrire aux changements pour notifier l'utilisateur
            subscribeToOrderChanges();

            // Initialize frequent routes lazy loader and toggle
            const freqToggle = document.getElementById('freqRoutesToggle');
            if (freqToggle) {
                const pref = localStorage.getItem('freqRoutesAnimate');
                freqToggle.textContent = (pref === '0') ? 'Off' : 'On';
                freqToggle.addEventListener('click', () => {
                    const cur = localStorage.getItem('freqRoutesAnimate');
                    if (cur === '0') {
                        localStorage.setItem('freqRoutesAnimate', '1');
                        freqToggle.textContent = 'On';
                        // if container already rendered, allow animations
                        renderFrequentRoutes();
                    } else {
                        localStorage.setItem('freqRoutesAnimate', '0');
                        freqToggle.textContent = 'Off';
                    }
                });
            }
            initFrequentRoutesLazy();
            // Ensure the container is rendered immediately (keeps section from appearing empty)
            try { renderFrequentRoutes(); } catch(e) { /* ignore if already rendered */ }
            
            // Intervalle global pour les mises à jour
            setInterval(() => {
                const userId = localStorage.getItem('userId');
                if (!userId) return;
                
                database.ref('commande').orderByChild('userId').equalTo(userId).once('value', snapshot => {
                    if (snapshot.exists()) {
                        snapshot.forEach(child => {
                            const pendingSection = document.getElementById('pending-request');
                            
                            if (pendingSection.dataset.orderId !== child.key) {
                                pendingSection.style.display = 'block';
                                pendingSection.dataset.orderId = child.key;
                                pendingSection.innerHTML = generatePendingContent(
                                    child.key,
                                    child.val().pickup,
                                    child.val().destination
                                );
                                
                                if (pendingSection.dataset.intervalId) {
                                    clearInterval(parseInt(pendingSection.dataset.intervalId));
                                }
                                
                                const intervalId = setInterval(() => checkOrderStatus(child.key), 2000);
                                pendingSection.dataset.intervalId = intervalId;
                            }
                        });
                    }
                });
                
                loadDrivers();
            }, 2000);
        });
    </script>
</body>
</html>