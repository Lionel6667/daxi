<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Icônes iOS pour l'écran d'accueil -->
<link rel="apple-touch-icon" sizes="180x180" href="img20.png">
<link rel="apple-touch-icon" sizes="152x152" href="img20.png">
<link rel="apple-touch-icon" sizes="167x167" href="img20.png">

<!-- Icônes Android/Chrome -->
<link rel="icon" type="image/png" sizes="192x192" href="/img20.png">
<link rel="icon" type="image/png" sizes="512x512" href="/img20.png">

<!-- Nom affiché sous l'icône -->
<meta name="apple-mobile-web-app-title" content="Julmin Taxi">

<!-- Mode application (sans barre Safari) -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<!-- Lien vers manifest -->
<link rel="manifest" href="manifest.json">
    <title> Daxi - Service de Taxi</title>
    <script src="https://cdn.tailwindcss.com/3.4.16"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#ef4444',
                        secondary: '#fca5a5',
                        'primary-green': '#4CAF50'
                    },
                    borderRadius: {
                        'none': '0px',
                        'sm': '4px',
                        DEFAULT: '8px',
                        'md': '12px',
                        'lg': '16px',
                        'xl': '20px',
                        '2xl': '24px',
                        '3xl': '32px',
                        'full': '9999px',
                        'button': '8px'
                    }
                }
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <!-- PWA Configuration -->
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Julmin Taxi">
    <link rel="apple-touch-icon" href="/icons/icon-192.png">
    <style>
        :where([class^="ri-"])::before { content: "\f3c2"; }
        
        /* Styles généraux */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 24px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            border-radius: 34px;
            transition: .4s;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            border-radius: 50%;
            transition: .4s;
        }
        input:checked + .slider {
            background-color: #ef4444;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        /* Modales */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
        }
        
        /* Affichage utilisateur */
        .user-display {
            display: flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.8) 0%, rgba(212, 175, 55, 0.2) 100%);
            border-radius: 8px;
            padding: 6px 12px;
            position: relative;
        }
        .user-id-display {
            background: #f1f5f9;
            padding: 2px 8px;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .user-id-display:hover {
            background: #e2e8f0;
        }
        .id-info-message {
            position: absolute;
            bottom: -40px;
            right: 0;
            background: #1e293b;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            max-width: 250px;
            animation: fadeInOut 5s forwards;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 100;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(10px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(10px); }
        }
        .id-info-icon {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .id-info-icon:hover {
            transform: scale(1.1);
        }
        
        /* Onglets */
        .tab-container {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #e2e8f0;
        }
        .tab {
            flex: 1;
            text-align: center;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .tab.active {
            border-bottom: 3px solid #ef4444;
            color: #ef4444;
            font-weight: 500;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        /* Détails de commande */
        .order-details {
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            margin-top: 10px;
        }
        .order-details p {
            margin: 5px 0;
            font-size: 14px;
        }
        
        /* Éléments de compte */
        .account-item {
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .account-item:hover {
            background-color: #f1f5f9;
            border-color: #cbd5e1;
        }
        .account-item.selected {
            background-color: #eff6ff;
            border-color: #60a5fa;
        }
        
        /* Attractions touristiques */
        .attraction-card {
            height: 300px;
            background-size: cover;
            background-position: center;
            position: relative;
            overflow: hidden;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        .attraction-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .attraction-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            padding: 20px;
            color: white;
        }
        .attraction-detail {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 2000;
            padding: 20px;
            overflow-y: auto;
        }
        
        /* Cartes de service */
        .service-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }
        .service-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .service-icon {
            font-size: 48px;
            margin-bottom: 15px;
            color: #4CAF50;
        }
        
        /* Informations chauffeur */
        .driver-info {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 15px;
        }
        .driver-photo {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #D4AF37;
        }
        .driver-details {
            flex: 1;
        }
        .driver-name {
            font-weight: 600;
            color: #1e293b;
        }
        
        /* Conteneurs d'image de fond */
        .background-image-container {
            position: relative;
            background-size: cover;
            background-position: center;
        }
        .background-image-container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
        }
        
        /* Gestion des mots de passe */
        .password-container {
            position: relative;
        }
        .toggle-password {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #666;
            font-size: 18px;
        }
        .password-error {
            color: #ef4444;
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }
        
        /* Évaluation chauffeur */
        .driver-rating {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 4px;
        }
        .driver-rating i {
            font-size: 14px;
            color: #f59e0b;
        }
        .view-reviews-btn {
            color: #3b82f6;
            font-size: 12px;
            cursor: pointer;
            text-decoration: underline;
            margin-top: 4px;
        }
        
        /* Modale d'avis */
        .reviews-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        .reviews-content {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .review-item {
            padding: 10px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        
        /* Évaluation */
        .rating-input {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }
        .rating-input i {
            cursor: pointer;
            font-size: 20px;
            color: #d1d5db;
        }
        .rating-input i.active {
            color: #f59e0b;
        }
        
        /* Indicateurs de statut */
        .status-indicator {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            margin-top: 8px;
            display: inline-block;
        }
        .status-pending {
            background-color: #fef9c3;
            color: #854d0e;
        }
        .status-here {
            background-color: #dcfce7;
            color: #166534;
        }
        .status-finished {
            background-color: #dbeafe;
            color: #1e40af;
        }
        .status-accepted {
            background-color: #d1fae5;
            color: #065f46;
        }
        .status-transferring {
            background-color: #dbeafe;
            color: #1e40af;
        }
        .status-onway {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        /* Boutons doubles */
        .double-button-container {
            display: flex;
            gap: 12px;
            margin-top: 15px;
        }
        .double-button-container button {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        /* Formulaire d'évaluation */
        .rating-form {
            background-color: #f8fafc;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        /* Boutons de navigation */
        .back-to-main-btn, .visit-btn {
            cursor: pointer;
        }
        
        /* Affichage du temps */
        .time-display {
            font-size: 12px;
            color: #64748b;
            margin-top: 4px;
        }
        
        /* Historique d'évaluation */
        .history-rating {
            display: flex;
            gap: 2px;
            margin-top: 8px;
        }
        .history-rating i {
            font-size: 16px;
            color: #d1d5db;
            cursor: pointer;
        }
        .history-rating i.active {
            color: #f59e0b;
        }
        
        /* Actions d'avis */
        .review-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .review-actions button {
            flex: 1;
            padding: 8px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .review-edit-btn {
            background-color: #f0f9ff;
            color: #0ea5e9;
            border: 1px solid #bae6fd;
        }
        .review-edit-btn:hover {
            background-color: #e0f2fe;
        }
        .review-delete-btn {
            background-color: #fef2f2;
            color: #ef4444;
            border: 1px solid #fecaca;
        }
        .review-delete-btn:hover {
            background-color: #fee2e2;
        }
        
        /* Bouton WhatsApp */
        .whatsapp-icon {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background-color: #25D366;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        .whatsapp-icon:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        .whatsapp-icon i {
            color: white;
            font-size: 32px;
        }
        
        /* Modale d'application */
        .app-modal-content {
            background-color: white;
            padding: 25px;
            border-radius: 15px;
            width: 90%;
            max-width: 450px;
            text-align: center;
            position: relative;
        }
        .app-modal-icon {
            font-size: 64px;
            color: #ef4444;
            margin-bottom: 15px;
        }
        .app-modal-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }
        .app-modal-buttons button {
            flex: 1;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .close-app-modal {
            background-color: #f1f5f9;
            color: #334155;
        }
        .close-app-modal:hover {
            background-color: #e2e8f0;
        }
        .download-app-btn {
            background-color: #ef4444;
            color: white;
        }
        .download-app-btn:hover {
            background-color: #dc2626;
        }
        
        /* Section APK */
        .apk-section {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            margin-top: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }
        .apk-section h3 {
            color: white;
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .apk-section p {
            color: rgba(255,255,255,0.9);
            margin-bottom: 15px;
            font-size: 0.9rem;
        }
        .download-apk-btn {
            background-color: white;
            color: #ef4444;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .download-apk-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        /* Sélecteur de langue */
        .language-selector {
            position: relative;
            margin-right: 10px;
        }
        .language-select {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 5px 10px;
            padding-right: 30px;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        .language-select:focus {
            outline: none;
            border-color: #ef4444;
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2);
        }
        .language-selector::after {
            content: "▼";
            font-size: 10px;
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
        }
        .language-select:hover {
            background-color: #e2e8f0;
            transform: scale(1.05);
        }
        .language-select:focus {
            animation: pulse 0.5s;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* Type de trajet */
        .trip-type-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .trip-type-option {
            flex: 1;
            text-align: center;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background-color: transparent;
        }
        .trip-type-option:hover {
            background-color: rgba(76, 175, 80, 0.1);
        }
        .trip-type-option.active {
            border-color: #4CAF50;
            background-color: rgba(76, 175, 80, 0.2);
        }
        
        /* Pied de page */
        footer {
            background-color: #1a202c;
            color: white;
            padding: 30px 0;
            margin-top: 30px;
        }
        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .footer-logo {
            width: 150px;
            margin-bottom: 20px;
        }
        .footer-contact {
            text-align: center;
            margin-bottom: 20px;
        }
        .footer-contact p {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .footer-bottom {
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            width: 100%;
        }
        .apk-footer {
            margin-top: 12px;
        }
        .social-icons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
        }
        .social-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #2d3748;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        .social-icon:hover {
            transform: translateY(-3px);
            background: #ef4444;
        }
        .social-icon i {
            font-size: 20px;
            color: white;
        }
        
        /* Suggestions d'adresses */
        .suggestions-container {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background: white;
            border: 1px solid #e2e8f0;
            border-top: none;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
        }
        .suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
        }
        .suggestion-item:hover {
            background-color: #f8fafc;
        }

        /* MODIFICATIONS DEMANDEES */
        
        /* 1. Logo agrandi */
        .navbar-logo {
            height: 60px !important;
        }

        /* 2. Navbar avec la même couleur que le footer */
        nav {
            background-color: #1a202c !important;
        }

        /* 3. Boutons avec dégradé or */
        .gold-button {
            background: linear-gradient(135deg, #D4AF37 0%, #FFD700 100%);
            color: #000 !important;
            border: none;
            font-weight: 600;
        }
        .gold-button:hover {
            background: linear-gradient(135deg, #C19C30 0%, #E6C200 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        /* 4. Espace entre navbar et section commander un taxi */
        main {
            padding-top: 80px !important;
        }
        
        /* Boutons de temps */
        .time-selection-btn {
            flex: 1;
            text-align: center;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            background-color: transparent;
            color: black;
        }
        .time-selection-btn:hover {
            background-color: rgba(76, 175, 80, 0.1);
        }
        .time-selection-btn.active {
            border-color: #4CAF50;
            background-color: rgba(76, 175, 80, 0.2);
            color: black;
        }

        /* Sélecteur de pays téléphone */
        .phone-input-container {
            display: flex;
            gap: 10px;
        }
        .country-select-container {
            position: relative;
            width: 30%;
        }
        .country-select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-color: white;
        }
        .country-select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        .country-select-container::after {
            content: "▼";
            font-size: 10px;
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
        }
        .phone-input {
            flex: 1;
            width: 70%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
        }
        .phone-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        /* Modale de vérification email */
        .email-verification-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        .email-verification-content {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 450px;
            text-align: center;
        }
        .verification-icon {
            font-size: 64px;
            color: #3498db;
            margin-bottom: 20px;
        }
        .verification-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 18px;
            text-align: center;
            letter-spacing: 8px;
            margin-bottom: 20px;
            box-sizing: border-box;
        }
        .verification-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        .resend-otp {
            color: #3498db;
            cursor: pointer;
            margin-top: 15px;
            display: inline-block;
        }
        .resend-otp:hover {
            text-decoration: underline;
        }
        
        /* Bannière d'installation iOS */
        #installBanner {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #111;
            color: #fff;
            padding: 15px;
            text-align: center;
            font-size: 16px;
            z-index: 9999;
        }
        #installBanner button {
            margin-top: 8px;
            padding: 10px 20px;
            background: #0a84ff;
            color: #fff;
            border: none;
            border-radius: 8px;
        }

        /* Formulaire responsive */
        @media (max-width: 640px) {
            .modal-content {
                width: 95%;
                margin: 10px;
                padding: 15px;
                max-height: 90vh;
                overflow-y: auto;
            }
            .tab-container {
                flex-direction: column;
            }
            .tab {
                margin-bottom: 5px;
            }
            .input-group {
                margin-bottom: 15px;
            }
            input[type="text"], 
            input[type="email"], 
            input[type="password"], 
            input[type="number"] {
                padding: 10px;
            }
        }

        /* MODAL POUR iOS - NOUVEAU */
        .ios-instruction-step {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8fafc;
            border-radius: 8px;
        }
        .ios-instruction-step i {
            font-size: 24px;
            margin-right: 15px;
            color: #ef4444;
            min-width: 30px;
            text-align: center;
        }
        .ios-instruction-step span {
            flex: 1;
        }
        #iosInstallModal .modal-content {
            max-width: 500px;
        }
        #iosInstallBtn {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
    <!-- Navigation Bar - Modifiée -->
    <nav class="fixed top-0 w-full shadow-sm z-50">
        <div class="flex items-center justify-between px-4 py-3">
            <div class="flex items-center">
                <!-- Logo agrandi -->
                <img src="img20.png" alt="Julmin Taxis Logo" class="navbar-logo">
            </div>
            <div id="userSection" class="flex items-center">
                <!-- Sélecteur de langue avec drapeaux (emojis) -->
                <div class="language-selector">
                    <select id="languageSelect" class="language-select">
                        <option value="ht">🇭🇹 HT</option>
                        <option value="fr">🇫🇷 FR</option>
                        <option value="en">🇬🇧 EN</option>
                        <option value="es">🇪🇸 ES</option>
                    </select>
                </div>
                <div id="loginSection" class="flex gap-2">
                    <!-- Bouton avec nouveau style or -->
                    <button id="loginBtn" class="gold-button px-4 py-2 !rounded-button text-sm font-medium cursor-pointer">
                        Connexion
                    </button>
                </div>
                <div id="userDisplay" class="hidden user-display">
                    <i class="ri-user-line"></i>
                    <span id="userName">Nom Utilisateur</span>
                    <div class="user-id-display">
                        <span id="userIdDisplay">ID: <span id="userId">0000</span></span>
                        <i class="ri-information-line id-info-icon" id="idInfoIcon"></i>
                    </div>
                    <button id="logoutBtn" class="ml-2 bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-1 rounded-button text-sm transition-colors">
                        <i class="ri-logout-box-r-line"></i>
                    </button>
                    <div class="id-info-message hidden" id="idInfoMessage">
                        Votre ID unique est nécessaire pour accéder à votre compte depuis un autre appareil. Conservez-le précieusement.
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="pt-16 pb-6 px-4 flex-grow">
        <!-- Booking Form Section -->
        <section class="mb-8" id="bookingSection" data-aos="fade-up">
            <div class="bg-white rounded-lg shadow-sm p-6 relative overflow-hidden background-image-container" style="background-image: url('img13.webp.jpg')">
                <div class="relative z-10">
                    <h2 class="text-xl font-semibold text-gray-800 mb-6" data-translate="order_taxi">Commander votre taxi</h2>
                    
                    <!-- Destination Input -->
                    <div class="mb-4">
                        <div class="flex items-center mb-2">
                            <label class="flex items-center cursor-pointer mr-4">
                                <span class="text-sm text-gray-700 mr-2" data-translate="different_address">Indiquer une adresse de départ différente</span>
                                <label class="switch">
                                    <input type="checkbox" id="destinationSwitch">
                                    <span class="slider"></span>
                                </label>
                            </label>
                        </div>
                        <p class="text-xs text-gray-500 mb-2" data-translate="address_explanation">Si vous ne souhaitez pas être pris en charge à votre position actuelle, activez ce switch pour indiquer un autre lieu de départ.</p>
                        <div id="destinationField" class="hidden" style="position: relative;">
  
  <!-- Icône -->
  <i class="ri-map-pin-line text-primary"
     style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); font-size: 18px; pointer-events: none;">
  </i>

  <!-- Input -->
  <input 
    type="text" 
    id="destinationAddress" 
    placeholder="Adresse de départ" 
    data-translate="departure_placeholder"
    style="width: 100%; padding: 12px 16px 12px 42px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; outline: none;"
  >

  <div id="destinationAddressSuggestions" class="suggestions-container hidden"></div>
</div>
                    </div>

                    <!-- Destination Field (Always visible) -->
                    <div class="mb-4" style="position: relative;">
  
  <!-- Icône -->
  <i class="ri-flag-line text-primary" 
     style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); font-size: 18px; pointer-events: none;">
  </i>

  <!-- Input -->
  <input 
    type="text" 
    id="destinationAddressArrival" 
    placeholder="Adresse de destination" 
    required 
    data-translate="destination_placeholder"
    style="width: 100%; padding: 12px 16px 12px 42px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; outline: none;"
  >

  <div id="destinationAddressArrivalSuggestions" class="suggestions-container hidden"></div>
</div>

                    <!-- Type de trajet -->
                    <div class="trip-type-container mb-4">
                        <div class="trip-type-option active" id="oneWayBtn" data-trip-type="aller simple">
                            <i class="ri-arrow-right-line"></i>
                            <span data-translate="one_way">Allez simple</span>
                        </div>
                        <div class="trip-type-option" id="roundTripBtn" data-trip-type="aller-retour">
                            <i class="ri-arrow-left-right-line"></i>
                            <span data-translate="round_trip">Allez retour</span>
                        </div>
                    </div>

                    <!-- Description -->
                    <div class="mb-4">
                        <textarea id="bookingDescription" placeholder="Description pour aider le chauffeur à vous repérer" rows="3" class="w-full p-4 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent resize-none" data-translate="description_placeholder"></textarea>
                    </div>

                    <!-- Time and Date -->
                    <div id="dateTimeSection" class="hidden grid grid-cols-2 gap-4 mb-4">
                        <div class="relative">
                            <div class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 flex items-center justify-center">
                                <i class="ri-time-line text-gray-400"></i>
                            </div>
                            <input type="time" id="bookingTime" class="w-full pl-12 pr-4 py-3 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        <div class="relative">
                            <div class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 flex items-center justify-center">
                                <i class="ri-calendar-line text-gray-400"></i>
                            </div>
                            <input type="date" id="bookingDate" class="w-full pl-12 pr-4 py-3 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                    </div>

                    <!-- Time Selection Buttons -->
                    <div class="flex gap-4 mb-6">
                        <div class="time-selection-btn active" id="nowBtn" data-translate="now">
                            Maintenant
                        </div>
                        <div class="time-selection-btn" id="laterBtn" data-translate="later">
                            Plus tard
                        </div>
                    </div>
                    
                    <!-- Main CTA Button - Nouveau style or -->
                    <button id="orderTaxiBtn" class="w-full gold-button py-4 !rounded-button font-semibold text-lg shadow-lg cursor-pointer" data-translate="order_taxi_btn">
                        Commander un Taxi
                    </button>
                </div>
            </div>
        </section>
        
        <!-- Section pour afficher toutes les commandes en attente -->
        <section class="mb-8" id="all-pending-requests" data-aos="fade-up" style="display: none;">
            <h3 class="text-lg font-semibold text-gray-800 mb-4" data-translate="pending_orders">Commandes en attente</h3>
            <div id="pendingRequestsContainer" class="space-y-4">
                <!-- Les commandes en attente seront ajoutées ici -->
            </div>
        </section>

        <!-- Pending Request Section -->
        <section class="mb-8" id="pending-request" style="display: none;" data-order-id="" data-interval-id="" data-aos="fade-up">
        </section>

        <!-- Unconfirmed Request Section -->
        <section class="mb-8" id="unconfirmed-request" data-aos="fade-up" style="display: none;">
            <div id="unconfirmedRequestsContainer" class="space-y-4">
                <!-- Les commandes non confirmées seront ajoutées ici -->
            </div>
        </section>

        <!-- Confirmed Request Section -->
        <section class="mb-8" id="confirmed-request" style="display: none;" data-order-id="" data-aos="fade-up">
        </section>

        <!-- Transferring Request Section -->
        <section class="mb-8" id="transferring-request" style="display: none;" data-order-id="" data-aos="fade-up">
        </section>

        <!-- Top Drivers Section -->
        <section class="mb-8" data-aos="fade-up">
            <h3 class="text-lg font-semibold text-gray-800 mb-4" data-translate="top_drivers">Meilleurs Chauffeurs de la Semaine</h3>
            <div id="topDriversContainer" class="grid grid-cols-3 gap-4">
            </div>
        </section>

        <!-- Tourist Attractions Section -->
        <section class="mb-8" data-aos="fade-up">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center" data-translate="discover_haiti">Découvrez Haïti</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-colds-3 gap-6">
                <!-- Citadelle La Ferrière -->
                <div class="attraction-card" style="background-image: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), url('img.jpg')" data-aos="fade-up">
                    <div class="attraction-overlay">
                        <h3 class="text-xl font-bold" data-translate="citadelle_name">Citadelle La Ferrière</h3>
                        <p class="text-sm mt-2" data-translate="citadelle_desc">Forteresse historique perchée sur une montagne</p>
                        <button class="mt-4 gold-button px-4 py-2 !rounded-button font-medium learn-more-btn" data-attraction="citadelle">
                            <span data-translate="learn_more">En savoir plus</span>
                        </button>
                    </div>
                </div>
                
                <!-- Labadee -->
                <div class="attraction-card" style="background-image: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), url('img7.jpg')" data-aos="fade-up" data-aos-delay="100">
                    <div class="attraction-overlay">
                        <h3 class="text-xl font-bold" data-translate="labadee_name">Labadee</h3>
                        <p class="text-sm mt-2" data-translate="labadee_desc">Plages paradisiaques et eaux cristallines</p>
                        <button class="mt-4 gold-button px-4 py-2 !rounded-button font-medium learn-more-btn" data-attraction="labadee">
                            <span data-translate="learn_more">En savoir plus</span>
                        </button>
                    </div>
                </div>
                
                <!-- Monument de Verrières -->
                <div class="attraction-card" style="background-image: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), url('img8.jpg')" data-aos="fade-up" data-aos-delay="200">
                    <div class="attraction-overlay">
                        <h3 class="text-xl font-bold" data-translate="verrieres_name">Monuments de Vertière</h3>
                        <p class="text-sm mt-2" data-translate="verrieres_desc">Mémorial historique de la bataille de Vertière</p>
                        <button class="mt-4 gold-button px-4 py-2 !rounded-button font-medium learn-more-btn" data-attraction="verrieres">
                            <span data-translate="learn_more">En savoir more</span>
                        </button>
                    </div>
                </div>
                
                <!-- Cathédrale de Cap-Haïtien -->
                <div class="attraction-card" style="background-image: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), url('img6.jpg')" data-aos="fade-up" data-aos-delay="300">
                    <div class="attraction-overlay">
                        <h3 class="text-xl font-bold" data-translate="cathedrale_name">Cathédrale de Cap-Haïtien</h3>
                        <p class="text-sm mt-2" data-translate="cathedrale_desc">Joyau architectural du nord d'Haïti</p>
                        <button class="mt-4 gold-button px-4 py-2 !rounded-button font-medium learn-more-btn" data-attraction="cathedrale">
                            <span data-translate="learn_more">En savoir plus</span>
                        </button>
                    </div>
                </div>
                
                <!-- Palais Sans Souci -->
                <div class="attraction-card" style="background-image: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), url('img15.webp.jpg')" data-aos="fade-up" data-aos-delay="400">
                    <div class="attraction-overlay">
                        <h3 class="text-xl font-bold" data-translate="palais_name">Palais Sans Souci</h3>
                        <p class="text-sm mt-2" data-translate="palais_desc">Ancien palais royal d'Henri Christophe</p>
                        <button class="mt-4 gold-button px-4 py-2 !rounded-button font-medium learn-more-btn" data-attraction="palais">
                            <span data-translate="learn_more">En savoir plus</span>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Attraction Detail Sections -->
        <div id="citadelle-detail" class="attraction-detail">
        </div>
        
        <div id="labadee-detail" class="attraction-detail">
        </div>
        
        <div id="verrieres-detail" class="attraction-detail">
        </div>
        
        <div id="cathedrale-detail" class="attraction-detail">
        </div>
        
        <div id="palais-detail" class="attraction-detail">
        </div>

        <!-- Services Section -->
        <section class="mb-8" data-aos="fade-up">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center" data-translate="services">Services à bord</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">                             
                <div class="service-card" data-aos="fade-up" data-aos-delay="100">
                    <i class="ri-wifi-fill service-icon"></i>
                    <h3 class="text-xl font-bold text-gray-800 mb-2" data-translate="wifi_service">Wifi gratuit</h3>
                    <p class="text-gray-600" data-translate="wifi_desc">Vous trouverez internet à bord de nos véhicules pour rester connecté.</p>
                </div>
                
                <div class="service-card" data-aos="fade-up" data-aos-delay="200">
                <i class="ri-water-flash-fill service-icon"></i>
                <h3 class="text-xl font-bold text-gray-800 mb-2" data-translate="water_service">Bouteille d'eau disponible</h3>
                <p class="text-gray-600" data-translate="water_desc">Une bouteille d'eau est disponible à bord pour vous rafraîchir durant votre trajet.</p>
                </div>
            </div>
        </section>

        <!-- Trip History Section -->
        <section class="mb-8" id="tripHistorySection" data-aos="fade-up" style="display: none;">
            <h3 class="text-lg font-semibold text-gray-800 mb-4" data-translate="trip_history">Historique des parcours</h3>
            <div id="tripHistoryContainer" class="space-y-4">
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer>
        <div class="footer-content">
            <img src="img20.png" alt="Julmin Taxis Logo" class="footer-logo">
            
            <div class="footer-contact">
                <p>
                    <i class="ri-map-pin-line"></i>
                    Adresse zo Vincent #36 Cap-Haïtien
                </p>
                <p>
                    <i class="ri-phone-line"></i>
                    +509 41628178
                </p>
                <p>
                    <i class="ri-mail-line"></i>
                    Julmintaxi@gmail.com
                </p>
            </div>
            
            <div class="social-icons">
    <a href="https://wa.me/50941628178" target="_blank" class="social-icon">
        <i class="ri-whatsapp-line"></i>
    </a>
    <a href="https://www.facebook.com/share/18ABkYbPm7/" class="social-icon" id="facebookIcon" target="_blank">
        <i class="ri-facebook-fill"></i>
    </a>
    <a href="https://www.instagram.com/taxiokap?igsh=YzljYTk1ODg3Zg==" target="_blank" class="social-icon">
        <i class="ri-instagram-line"></i>
    </a>
    <a href="https://tiktok.com/@julmin.taxi" target="_blank" class="social-icon">
        <i class="ri-tiktok-line"></i>
    </a>
</div>
            
            <div class="apk-footer">
                <button id="downloadApkBtn" class="download-apk-btn gold-button">
                    <i class="ri-download-line"></i> <span data-translate="download_apk">Télécharger l'APK Android</span>
                </button>
                <button id="iosInstallBtn" class="download-apk-btn gold-button" style="display: none;">
                    <i class="ri-smartphone-line"></i> <span>Installer sur iPhone</span>
                </button>
            </div>
            
            <div class="footer-bottom">
                <p>&copy; 2025 Julmin Taxis. Tous droits réservés.</p>
            </div>
        </div>
    </footer>

    <!-- Floating WhatsApp Icon -->
    <a href="https://wa.me/50941628178" class="whatsapp-icon" target="_blank">
        <i class="ri-whatsapp-line"></i>
    </a>

    <!-- App Download Modal -->
    <div id="appDownloadModal" class="modal">
        <div class="app-modal-content">
            <i class="ri-smartphone-line app-modal-icon"></i>
            <h3 class="text-xl font-semibold text-gray-800 mb-2" data-translate="download_modal_title">Téléchargez notre application android</h3>
            <p class="text-gray-600" data-translate="download_modal_desc">
                Pour une expérience optimale, téléchargez notre application mobile. Commandez vos trajets plus rapidement et bénéficiez de fonctionnalités exclusives !
            </p>
            <div class="app-modal-buttons">
                <button id="closeAppModalBtn" class="close-app-modal" data-translate="close">
                    Fermer
                </button>
                <button id="downloadAppBtn" class="download-app-btn" data-translate="download">
                    Télécharger
                </button>
            </div>
        </div>
    </div>

    <!-- iOS Install Modal -->
    <div id="iosInstallModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-800">Installer l'APK du site sur votre iPhone</h3>
                <button class="close-modal text-gray-500 hover:text-gray-700" id="closeIosModalBtn">
                    <i class="ri-close-line ri-lg"></i>
                </button>
            </div>
            <p class="text-sm text-gray-600 mb-4">Vous pouvez installer l'APK de notre site directement sur votre iPhone pour y accéder plus rapidement, comme une application.</p>
            
            <div class="ios-instruction-step">
                <i class="ri-safari-line"></i>
                <span>1. Ouvrez ce site dans Safari (nécessaire pour l'installation).</span>
            </div>
            
            <div class="ios-instruction-step">
                <i class="ri-share-box-line"></i>
                <span>2. Appuyez sur le bouton Partager (icône carré avec une flèche télécharger).</span>
            </div>
            
            <div class="ios-instruction-step">
                <i class="ri-home-heart-line"></i>
                <span>3. Sélectionnez « Installer l'APK sur l'écran d'accueil ».</span>
            </div>
            
            <div class="ios-instruction-step">
                <i class="ri-add-circle-line"></i>
                <span>4. Appuyez sur Ajouter pour finaliser l'installation.</span>
            </div>
            
            <button id="closeIosModalConfirmBtn" class="w-full gold-button py-3 !rounded-button font-semibold mt-4">
                Fermer
            </button>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-800" data-translate="login">Connexion</h3>
                <button class="close-modal text-gray-500 hover:text-gray-700">
                    <i class="ri-close-line ri-lg"></i>
                </button>
            </div>
            
            <div class="tab-container">
                <div class="tab active" data-tab="id" data-translate="id_tab">ID</div>
                <div class="tab" data-tab="password" data-translate="password_tab">Mot de passe</div>
                <div class="tab" data-tab="signup" data-translate="signup_tab">Inscription</div>
            </div>
            
            <div class="tab-content active" id="idTab">
                <p class="text-sm text-gray-600 mb-4" data-translate="id_login_desc">
                    Connectez-vous avec votre ID unique pour accéder à votre compte permanent.
                </p>
                <div class="mb-4">
                    <label for="userIdInput" class="block text-sm font-medium text-gray-700 mb-1" data-translate="your_id">Votre ID</label>
                    <input type="text" id="userIdInput" class="w-full p-3 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Entrez votre ID à 4 chiffres" required>
                </div>
                <button id="loginWithIdBtn" class="w-full gold-button py-3 !rounded-button font-semibold mt-2" data-translate="login_with_id">
                    Se connecter avec mon ID
                </button>
            </div>
            
            <div class="tab-content" id="passwordTab">
                <p class="text-sm text-gray-600 mb-4" data-translate="password_login_desc">
                    Connectez-vous avec votre email et mot de passe.
                </p>
                <div class="mb-4">
                    <label for="emailInput" class="block text-sm font-medium text-gray-700 mb-1" data-translate="email">Email</label>
                    <input type="email" id="emailInput" class="w-full p-3 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Votre adresse email" required>
                </div>
                <div class="mb-4">
                    <label for="passwordInput" class="block text-sm font-medium text-gray-700 mb-1" data-translate="password">Mot de passe</label>
                    <div class="password-container">
                        <input type="password" id="passwordInput" class="w-full pl-4 pr-10 py-3 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Votre mot de passe" required>
                        <i class="ri-eye-line toggle-password" id="loginTogglePassword"></i>
                    </div>
                </div>
                <button id="loginWithPasswordBtn" class="w-full gold-button py-3 !rounded-button font-semibold mt-2" data-translate="login">
                    Se connecter
                </button>
            </div>
            
            <div class="tab-content" id="signupTab">
                <form id="createAccountForm">
                    <div class="mb-4">
                        <label for="lastName" class="block text-sm font-medium text-gray-700 mb-1" data-translate="last_name">Nom</label>
                        <input type="text" id="lastName" class="w-full p-3 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" required>
                    </div>
                    <div class="mb-4">
                        <label for="firstName" class="block text-sm font-medium text-gray-700 mb-1" data-translate="first_name">Prénom</label>
                        <input type="text" id="firstName" class="w-full p-3 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" required>
                    </div>
                    <div class="mb-4">
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-1" data-translate="email">Email</label>
                        <input type="email" id="email" class="w-full p-3 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" required>
                    </div>
                    <div class="mb-4">
                        <label for="phone" class="block text-sm font-medium text-gray-700 mb-1" data-translate="phone">Téléphone</label>
                        <div class="phone-input-container">
                            <div class="country-select-container">
                                <select id="countryCode" class="country-select">
                                    <option value="+509">HT (+509)</option>
                                    <option value="+33">FR (+33)</option>
                                    <option value="+1">US/CA (+1)</option>
                                    <option value="+44">UK (+44)</option>
                                    <option value="+34">ES (+34)</option>
                                    <!-- Ajouter d'autres pays au besoin -->
                                </select>
                            </div>
                            <input type="tel" id="phone" class="phone-input" placeholder="Numéro de téléphone" required>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-1" data-translate="password">Mot de passe</label>
                        <div class="password-container">
                            <input type="password" id="password" class="w-full pl-4 pr-10 py-3 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" required>
                            <i class="ri-eye-line toggle-password" id="passwordToggle"></i>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="confirmPassword" class="block text-sm font-medium text-gray-700 mb-1" data-translate="confirm_password">Confirmer le mot de passe</label>
                        <div class="password-container">
                            <input type="password" id="confirmPassword" class="w-full pl-4 pr-10 py-3 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" required>
                            <i class="ri-eye-line toggle-password" id="confirmPasswordToggle"></i>
                        </div>
                        <div id="passwordError" class="password-error" data-translate="password_error">Les mots de passe ne correspondent pas</div>
                    </div>
                    <div class="mb-4">
                        <label for="age" class="block text-sm font-medium text-gray-700 mb-1" data-translate="age">Âge</label>
                        <input type="number" id="age" min="18" max="100" class="w-full p-3 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" required>
                    </div>
                    <div class="mb-4 bg-blue-50 p-3 rounded-lg">
                        <p class="text-sm text-blue-700 font-medium" data-translate="unique_id">Votre ID unique</p>
                        <div class="flex items-center mt-1">
                            <span id="generatedUserId" class="text-xl font-bold text-primary">Génération en cours...</span>
                            <i class="ri-information-line text-blue-500 ml-2" id="modalIdInfoIcon"></i>
                        </div>
                        <p class="text-xs text-blue-600 mt-1" data-translate="save_id">Conservez cet ID pour accéder à votre compte depuis n'importe quel appareil</p>
                    </div>
                    <button type="submit" class="w-full gold-button py-3 !rounded-button font-semibold mt-2" data-translate="save">
                        Enregistrer
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Email Verification Modal -->
    <div id="emailVerificationModal" class="email-verification-modal">
        <div class="email-verification-content">
            <i class="ri-mail-check-line verification-icon"></i>
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Vérification d'email</h3>
            <p class="text-sm text-gray-600 mb-4">Nous avons envoyé un code de vérification à votre adresse email. Veuillez le saisir ci-dessous.</p>
            <input type="text" id="otpInput" class="verification-input" placeholder="XXXXXX" maxlength="6">
            <button id="verifyOtpBtn" class="w-full gold-button py-3 !rounded-button font-semibold mt-2">Vérifier</button>
            <a href="#" id="resendOtp" class="resend-otp">Renvoyer le code</a>
        </div>
    </div>

    <!-- Location Permission Modal -->
    <div id="locationPermissionModal" class="modal">
        <div class="modal-content">
            <div class="mb-4">
                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="ri-map-pin-line text-blue-600 text-2xl"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-800 text-center mb-2" data-translate="location_access">Accès à votre localisation</h3>
                <p class="text-sm text-gray-600 text-center" data-translate="location_desc">
                    Pour que votre chauffeur puisse vous prendre en charge à votre position exacte, nous avons besoin d'accéder à votre localisation. 
                    <br><br>
                    Si vous préférez ne pas partager votre position, activez l'option "Indiquer une adresse de départ différente" et saisissez manuellement votre adresse.
                </p>
            </div>
            <div class="flex gap-3 mt-6">
                <button id="closeLocationModalBtn" class="flex-1 bg-gray-100 text-gray-700 py-3 !rounded-button font-medium cursor-pointer hover:bg-gray-200 transition-colors" data-translate="close">
                    Fermer
                </button>
                <button id="acceptLocationBtn" class="flex-1 gold-button py-3 !rounded-button font-medium cursor-pointer" data-translate="accept">
                    Accepter
                </button>
            </div>
        </div>
    </div>

    <!-- Reviews Modal -->
    <div id="reviewsModal" class="reviews-modal">
        <div class="reviews-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-800" data-translate="driver_reviews">Avis sur le chauffeur</h3>
                <button class="close-reviews-modal text-gray-500 hover:text-gray-700">
                    <i class="ri-close-line ri-lg"></i>
                </button>
            </div>
            <div id="reviewsContainer">
            </div>
        </div>
    </div>

    

    <!-- Firebase scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    
    <script>
        // ===========================================
        // INITIALISATION ET CONFIGURATION
        // ===========================================
        
        // Service Worker Registration
        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register("sw.js");
        }

        // Initialisation de AOS
        AOS.init({
            duration: 500,
            easing: 'ease-in-out',
            once: true
        });

        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCdGFcwfzj8b5eJXcmrS0LGRIxnTXZ6zac",
            authDomain: "julmin-taxis.firebaseapp.com",
            projectId: "julmin-taxis",
            storageBucket: "julmin-taxis.appspot.com",
            messagingSenderId: "392925120550",
            appId: "1:392925120550:web:2935808aab4ead6d7d7ee7",
            measurementId: "G-H7SBNVWQ06"
        };

        // Initialisation Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Clés Mailjet
        const MJ_APIKEY_PUBLIC = "2bce58a1f64d55a702dff8d682825462";
        const MJ_APIKEY_PRIVATE = "742285c323ed6ab2f54fbe4427938fb4";

        // Variables globales
        let currentLanguage = 'ht'; // Langue par défaut : Kreyòl
        const displayedOrders = new Set();
        let unsubscribeUnconfirmedRequests = null;
        let unsubscribePendingRequests = null;

        // ===========================================
        // FONCTIONS UTILITAIRES
        // ===========================================

        // Génération d'OTP unique
        async function generateUniqueOTP() {
            let isUnique = false;
            let otp = '';
            
            while (!isUnique) {
                otp = Math.floor(100000 + Math.random() * 900000).toString();
                
                const saveMemberRef = database.ref('save_member');
                const snapshot = await saveMemberRef.orderByChild('otp').equalTo(otp).once('value');
                
                if (!snapshot.exists()) {
                    isUnique = true;
                }
            }
            
            return otp;
        }

        // Fonction pour envoyer l'OTP par email
        async function sendOTPEmail(email, otp) {
            // Construction du payload pour l'API Mailjet
            const payload = {
                Messages: [
                    {
                        From: {
                            Email: "info@julmintaxi.com",
                            Name: "Julmin Taxi"
                        },
                        To: [
                            {
                                Email: email,
                                Name: email.split('@')[0]
                            }
                        ],
                        Subject: "Votre code de vérification",
                        TextPart: `Votre code de vérification est : ${otp}`,
                        HTMLPart: `
                            <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
                                <h2 style="color: #3498db;">Votre code de vérification</h2>
                                <p>Bonjour,</p>
                                <p>Votre code OTP pour vérifier votre email est :</p>
                                <div style="text-align: center; margin: 30px 0;">
                                    <span style="font-size: 32px; font-weight: bold; letter-spacing: 5px; color: #2c3e50; background: #f8f9fa; padding: 10px 20px; border-radius: 5px;">
                                        ${otp}
                                    </span>
                                </div>
                                <p>Ce code est valable pendant 10 minutes.</p>
                                <p>Si vous n'avez pas demandé ce code, veuillez ignorer cet email.</p>
                                <hr style="border: none; border-top: 1px solid #eee; margin: 20px 0;">
                                <p style="font-size: 12px; color: #7f8c8d;">© ${new Date().getFullYear()} Julmin Taxi. Tous droits réservés.</p>
                            </div>
                        `
                    }
                ]
            };

            // Encodage des credentials pour l'authentification Basic
            const credentials = btoa(`${MJ_APIKEY_PUBLIC}:${MJ_APIKEY_PRIVATE}`);
            
            const response = await fetch("https://api.mailjet.com/v3.1/send", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Basic ${credentials}`
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.text();
                throw new Error(`Erreur ${response.status}: ${errorData}`);
            }

            return response.json();
        }

        // Fonction pour afficher l'interface de vérification
        function showEmailVerification(email) {
            document.getElementById('signupTab').style.display = 'none';
            document.getElementById('emailVerificationModal').style.display = 'flex';
            
            // Stocker l'email temporairement
            document.getElementById('emailVerificationModal').dataset.email = email;
        }

        // Fonction pour revenir au formulaire d'inscription
        function hideEmailVerification() {
            document.getElementById('signupTab').style.display = 'block';
            document.getElementById('emailVerificationModal').style.display = 'none';
        }

        // Récupérer l'IP utilisateur
        async function getUserIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                console.error("Erreur lors de la récupération de l'IP :", error);
                return null;
            }
        }

        // Sauvegarder l'IP en base de données
        async function saveIPToDatabase() {
            const ip = await getUserIP();
            if (ip) {
                // Vérifier si cette IP existe déjà dans la base de données
                const unsaveMemberRef = database.ref('unsave_member');
                const snapshot = await unsaveMemberRef.orderByChild('ip').equalTo(ip).once('value');
                
                if (!snapshot.exists()) {
                    // Si l'IP n'existe pas, on crée un nouvel enregistrement
                    const newMemberRef = unsaveMemberRef.push();
                    newMemberRef.set({
                        ip: ip,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    });
                }
            }
        }

        // Générer un ID utilisateur unique
        async function generateUniqueId() {
            let isUnique = false;
            let userId = '';
            
            while (!isUnique) {
                userId = Math.floor(1000 + Math.random() * 9000).toString();
                
                const saveMemberRef = database.ref('save_member');
                const snapshot = await saveMemberRef.orderByChild('userId').equalTo(userId).once('value');
                
                if (!snapshot.exists()) {
                    isUnique = true;
                }
            }
            
            return userId;
        }

        // Initialiser la date
        function initDate() {
            const today = new Date();
            const formattedDate = today.toISOString().split('T')[0];
            document.getElementById('bookingDate').value = formattedDate;
        }

        // Normaliser une chaîne pour les suggestions
        function normalizeString(str) {
            return str
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "")
                .toLowerCase();
        }

        // Générer une clé unique pour une commande
        function generateOrderKey(order) {
            return `${order.userId}_${order.pickup || ''}_${order.destination}_${order.description || ''}_${order.timestamp || ''}`;
        }

        // Afficher les étoiles selon la note
        function renderStars(rating) {
            let stars = '';
            const fullStars = Math.floor(rating);
            const halfStar = rating % 1 >= 0.5;
            
            for (let i = 0; i < 5; i++) {
                if (i < fullStars) {
                    stars += '<i class="ri-star-fill"></i>';
                } else if (i === fullStars && halfStar) {
                    stars += '<i class="ri-star-half-fill"></i>';
                } else {
                    stars += '<i class="ri-star-line"></i>';
                }
            }
            return stars;
        }

        // Calculer la note moyenne
        function calculateAverageRating(reviews) {
            if (!reviews || Object.keys(reviews).length === 0) {
                return 2.5;
            }
            
            let total = 0;
            let count = 0;
            
            for (const key in reviews) {
                total += reviews[key].rating;
                count++;
            }
            
            return total / count;
        }

        // ===========================================
        // GESTION DES TRADUCTIONS
        // ===========================================

        const translations = {
            fr: {
                order_taxi: "Commander votre taxi",
                different_address: "Indiquer une adresse de départ différente",
                address_explanation: "Si vous ne souhaitez pas être pris en charge à votre position actuelle, activez ce switch pour indiquer un autre lieu de départ.",
                one_way: "Allez simple",
                round_trip: "Allez retour",
                now: "Maintenant",
                later: "Plus tard",
                order_taxi_btn: "Commander un Taxi",
                top_drivers: "Meilleurs Chauffeurs de la Semaine",
                pending_orders: "Commandes en attente",
                discover_haiti: "Découvrez Haïti",
                citadelle_name: "Citadelle La Ferrière",
                citadelle_desc: "Forteresse historique perchée sur une montagne",
                labadee_name: "Labadee",
                labadee_desc: "Plages paradisiaques et eaux cristallines",
                verrieres_name: "Monuments de Vertière",
                verrieres_desc: "Mémorial historique de la bataille de Vertière",
                cathedrale_name: "Cathédrale de Cap-Haïtien",
                cathedrale_desc: "Joyau architectural du nord d'Haïti",
                palais_name: "Palais Sans Souci",
                palais_desc: "Ancien palais royal d'Henri Christophe",
                learn_more: "En savoir plus",
                services: "Services à bord",
                wifi_service: "Wifi gratuit",
                wifi_desc: "Vous trouverez internet à bord de nos véhicules pour rester connecté.",
                water_service: "Bouteille d'eau disponible",
                water_desc: "Une bouteille d'eau est disponible à bord pour vous rafraîchir durant votre trajet.",
                trip_history: "Historique des parcours",
                download_app: "Téléchargez notre application mobile",
                apk_description: "Disponible sur Android, téléchargez l'APK pour une expérience complète.",
                download_apk: "Télécharger l'APK",
                login: "Connexion",
                id_tab: "ID",
                password_tab: "Mot de passe",
                signup_tab: "Inscription",
                id_login_desc: "Connectez-vous avec votre unique ID pour accéder à votre compte permanent.",
                your_id: "Votre ID",
                login_with_id: "Se connecter avec mon ID",
                password_login_desc: "Connectez-vous avec votre email et mot de passe.",
                email: "Email",
                password: "Mot de passe",
                login: "Log in",
                create_account: "Créer un compte",
                last_name: "Nom",
                first_name: "Prénom",
                confirm_password: "Confirmer le mot de passe",
                age: "Âge",
                unique_id: "Votre Unique ID",
                save_id: "Conservez cet ID pour accéder à votre compte depuis n'importe quel appareil",
                save: "Enregistrer",
                password_error: "Passwords do not match",
                location_access: "Location Access",
                location_desc: "For your driver to pick you up at your exact location, we need access to your location. If you prefer not to share your location, enable the 'Specify a different pickup address' option and enter your address manually.",
                close: "Fermer",
                accept: "Accepter",
                driver_reviews: "Driver Reviews",
                download_modal_title: "Download our app",
                download_modal_desc: "For an optimal experience, download our mobile app. Order your rides faster and enjoy exclusive features!",
                download: "Télécharger",
                price_accepted: "Price accepted",
                waiting_driver: "Waiting for driver",
                driver_onway: "Driver on the way",
                accepted_message: "Vous avez accepté le prix pour votre trajet. Veuillez patienter pendant que l'administrateur vous réfère à un chauffeur.",
                transferring_message: "L'administrateur est en train de vous transférer à un chauffeur. Veuillez patienter.",
                onway_message: "Votre chauffeur a accepté, il sera là.",
                departure_placeholder: "Adresse de départ",
                destination_placeholder: "Adresse de destination",
                back: "Retour",
                order: "Commander",
                description: "Description",
                history: "Histoire",
                visit: "Visiter",
                visit_desc: "Commandez un taxi pour visiter ce lieu historique :",
                description_placeholder: "Description pour aider le chauffeur à vous repérer",
                no_pending: "Aucune commande en attente",
                no_history: "Vous n'avez encore terminé aucun trajet",
                phone: "Téléphone"
            },
            ht: {
                order_taxi: "Kòmande taksi ou",
                different_address: "Endike yon adrès diferan pou depa",
                address_explanation: "Si ou pa vle chofè a vini chèche ou kote ou ye, aktive switch sa a pou endike yon lòt kote depa.",
                one_way: "Ale senp",
                round_trip: "Ale retou",
                now: "Kounye a",
                later: "Pita",
                order_taxi_btn: "Kòmande Taksi",
                top_drivers: "Pi bon Chofè nan Semèn nan",
                pending_orders: "Kòmand ki ap tann",
                discover_haiti: "Dekouvri Ayiti",
                citadelle_name: "Sitadèl Laferyè",
                citadelle_desc: "Fò istorik sou tèt yon mòn",
                labadee_name: "Labadee",
                labadee_desc: "Plaj sab blan li yo, dlo tèk li yo ak aktivite nòtik li yo. Li se yon destinasyon popilè pou pasaje bato kwazyè ak vakansye.",
                verrieres_name: "Moniman Vètyè",
                verrieres_desc: "Memoryal istorik batay Vètyè",
                cathedrale_name: "Katredal Okap",
                cathedrale_desc: "Bijou achitekti nan nò Ayiti",
                palais_name: "Palè San Souci",
                palais_desc: "Ansyen palè wa Henri Christophe",
                learn_more: "Plis enfòmasyon",
                services: "Sèvis abò",
                wifi_service: "Wifi gratis",
                wifi_desc: "Ou jwenn entènèt nan machin nou yo pou rete konekte.",
                water_service: "Boutey dlo disponib",
                water_desc: "Gen yon boutey dlo nan machin pou rafrechi w pandan wap vwayaje.",
                trip_history: "Istwa vwayaj",
                download_app: "Telechaje aplikasyon mobil nou an",
                apk_description: "Disponib sou Android, telechaje APK la pou yon eksperyans konplè.",
                download_apk: "Telechaje APK",
                login: "Koneksyon",
                id_tab: "ID",
                password_tab: "Modpas",
                signup_tab: "Enskripsyon",
                id_login_desc: "Konekte ak ID inik ou pou jwenn aksè nan kont pèmanan ou.",
                your_id: "ID ou",
                login_with_id: "Konekte ak ID mwen",
                password_login_desc: "Konekte ak imèl ou ak modpas ou.",
                email: "Imèl",
                password: "Modpas",
                login: "Konekte",
                create_account: "Kreye yon kont",
                last_name: "Non",
                first_name: "Siyati",
                confirm_password: "Konfime modpas la",
                age: "Laj",
                unique_id: "ID inik ou",
                save_id: "Sere ID sa a pou jwenn aksè nan kont ou depi nenpòt aparèy",
                save: "Anrejistre",
                password_error: "Modpas yo pa matche",
                location_access: "Aksè nan kote ou ye",
                location_desc: "Pou chofè a ka vin chèche ou egzakteman kote ou ye, nou bezwen aksè nan pozisyon ou. Si ou pito pa pataje pozisyon ou, aktive opsyon 'Endike yon adrès diferan pou depa' epi antre adrès ou manyèlman.",
                close: "Fèmen",
                accept: "Aksepte",
                driver_reviews: "Avi sou chofè a",
                download_modal_title: "Telechaje aplikasyon nou an",
                download_modal_desc: "Pou yon eksperyans pi bon, telechaje aplikasyon mobil nou an. Kòmande wout ou pi vit epi benefisye de fonksyonalite eksklizif!",
                download: "Telechaje",
                price_accepted: "Pri aksepte",
                waiting_driver: "Ap tann chofè",
                driver_onway: "Chofè an aksepte, li ap vini",
                accepted_message: "Ou te aksepte pri pou vwayaj ou. Tanpri rete pasyan pandan administrate a ap refere w ak yon chofè.",
                transferring_message: "Administrate a ap transfere w ak yon chofè. Tanpri rete pasyan.",
                onway_message: "Chofè w la an wout pou vin jwenn ou.",
                departure_placeholder: "Adrès depa",
                destination_placeholder: "Adrès destinasyon",
                back: "Retounen",
                order: "Kòmande",
                description: "Deskripsyon",
                history: "Istwa",
                visit: "Vizite",
                visit_desc: "Kòmande yon taksi pou vizite kote istorik sa a :",
                description_placeholder: "Deskripsyon pou ede chofè a rekonèt ou",
                no_pending: "Pa gen kòmand ki ap tann",
                no_history: "Ou poko fini okenn vwayaj",
                phone: "Telefòn"
            },
            en: {
                order_taxi: "Order your taxi",
                different_address: "Specify a different pickup address",
                address_explanation: "If you don't want to be picked up at your current location, toggle this switch to specify another pickup location.",
                one_way: "One way",
                round_trip: "Round trip",
                now: "Now",
                later: "Later",
                order_taxi_btn: "Order Taxi",
                top_drivers: "Top Drivers of the Week",
                pending_orders: "Pending Orders",
                discover_haiti: "Discover Haiti",
                citadelle_name: "Citadelle La Ferrière",
                citadelle_desc: "Historic fortress perched on a mountain",
                labadee_name: "Labadee",
                labadee_desc: "Paradise beaches and crystal clear waters",
                verrieres_name: "Vertières Monuments",
                verrieres_desc: "Historic memorial of the Battle of Vertières",
                cathedrale_name: "Cathedral of Cap-Haïtien",
                cathedrale_desc: "Architectural jewel of northern Haiti",
                palais_name: "Sans-Souci Palace",
                palais_desc: "Former royal palace of Henri Christophe",
                learn_more: "Learn more",
                services: "Onboard Services",
                wifi_service: "Free Wifi",
                wifi_desc: "You'll find internet in our vehicles to stay connected.",
                water_service: "Water bottle available",
                water_desc: "A water bottle is available on board to refresh you during your trip.",
                trip_history: "Trip History",
                download_app: "Download our mobile app",
                apk_description: "Available on Android, download the APK for a complete experience.",
                download_apk: "Download APK",
                login: "Login",
                id_tab: "ID",
                password_tab: "Password",
                signup_tab: "Sign Up",
                id_login_desc: "Log in with your unique ID to access your permanent account.",
                your_id: "Your ID",
                login_with_id: "Log in with my ID",
                password_login_desc: "Log in with your email and password.",
                email: "Email",
                password: "Password",
                login: "Log in",
                create_account: "Create Account",
                last_name: "Last Name",
                first_name: "First Name",
                confirm_password: "Confirm Password",
                age: "Age",
                unique_id: "Your Unique ID",
                save_id: "Keep this ID to access your account from any device",
                save: "Save",
                password_error: "Passwords do not match",
                location_access: "Location Access",
                location_desc: "For your driver to pick you up at your exact location, we need access to your location. If you prefer not to share your location, enable the 'Specify a different pickup address' option and enter your address manually.",
                close: "Close",
                accept: "Accept",
                driver_reviews: "Driver Reviews",
                download_modal_title: "Download our app",
                download_modal_desc: "For an optimal experience, download our mobile app. Order your rides faster and enjoy exclusive features!",
                download: "Download",
                price_accepted: "Price accepted",
                waiting_driver: "Waiting for driver",
                driver_onway: "Driver on the way",
                accepted_message: "You have accepted the price for your trip. Please wait while the administrator refers you to a driver.",
                transferring_message: "The administrator is transferring you to a driver. Please wait.",
                onway_message: "Your driver is on the way to your location.",
                departure_placeholder: "Pickup address",
                destination_placeholder: "Destination address",
                back: "Back",
                order: "Order",
                description: "Description",
                history: "History",
                visit: "Visit",
                visit_desc: "Order a taxi to visit this historic site:",
                description_placeholder: "Description to help the driver recognize you",
                no_pending: "No pending orders",
                no_history: "You haven't completed any trips yet",
                phone: "Phone"
            },
            es: {
                order_taxi: "Ordenar su taxi",
                different_address: "Especificar una dirección de recogida diferente",
                address_explanation: "If you don't want to be picked up at your current location, toggle this switch to specify another pickup location.",
                one_way: "Solo ida",
                round_trip: "Ida y vuelta",
                now: "Ahora",
                later: "Más tarde",
                order_taxi_btn: "Ordenar Taxi",
                top_drivers: "Mejores Conductores de la Semana",
                pending_orders: "Órdenes Pendientes",
                discover_haiti: "Descubrir Haití",
                citadelle_name: "Ciudadela La Ferrière",
                citadelle_desc: "Fortaleza histórica en la cima de una montaña",
                labadee_name: "Labadee",
                labadee_desc: "Playas paradisíacas and aguas cristalinas",
                verrieres_name: "Monumentos de Vertières",
                verrieres_desc: "Memorial histórico de la Batalla de Vertières",
                cathedrale_name: "Catedral de Cap-Haïtien",
                cathedrale_desc: "Joya arquitectónica del norte de Haití",
                palais_name: "Palacio Sans Souci",
                palais_desc: "Antiguo palacio real de Henri Christophe",
                learn_more: "Saber más",
                services: "Servicios a bordo",
                wifi_service: "Wifi gratis",
                wifi_desc: "Encontrará internet en nuestros vehículos para mantenerse conectado.",
                water_service: "Botella de agua disponible",
                water_desc: "Una botella de agua está disponible a bordo para refrescarse durante su viaje.",
                trip_history: "Historial de Viajes",
                download_app: "Descargue nuestra aplicación móvil",
                apk_description: "Disponible en Android, descargue el APK para una experiencia completa.",
                download_apk: "Descargar APK",
                login: "Iniciar sesión",
                id_tab: "ID",
                password_tab: "Contraseña",
                signup_tab: "Registro",
                id_login_desc: "Inicie sesión con su ID único para acceder à su cuenta permanente.",
                your_id: "Su ID",
                login_with_id: "Iniciar sesión con mi ID",
                password_login_desc: "Inicie sesión con su correo electrónico and contraseña.",
                email: "Correo electrónico",
                password: "Contraseña",
                login: "Iniciar sesión",
                create_account: "Crear cuenta",
                last_name: "Apellido",
                first_name: "Nombre",
                confirm_password: "Confirmar contraseña",
                age: "Edad",
                unique_id: "Su ID único",
                save_id: "Guarde este ID para acceder a su cuenta desde cualquier dispositivo",
                save: "Guardar",
                password_error: "Las contraseñas no coinciden",
                location_access: "Acceso a la ubicación",
                location_desc: "Para que su conductor lo recoja en su ubicación exacta, necesitamos acceso a su ubicación. Si prefiere no compartir su ubicación, active la opción 'Especificar una dirección de recogida diferente' e ingrese su dirección manualmente.",
                close: "Cerrar",
                accept: "Aceptar",
                driver_reviews: "Opiniones del conductor",
                download_modal_title: "Descargue nuestra aplicación",
                download_modal_desc: "Para una experiencia óptima, descargue nuestra aplicación móvil. ¡Ordene sus viajes más rápido and disfrute de funciones exclusivas!",
                download: "Descargar",
                price_accepted: "Precio aceptado",
                waiting_driver: "Esperando al conductor",
                driver_onway: "Conductor en camino",
                accepted_message: "Ha aceptado el precio de su viaje. Por favor, espere mientras el administrador lo refiere a un conductor.",
                transferring_message: "El administrador lo está transfiriendo a un conductor. Por favor espere.",
                onway_message: "Su conductor está en camino a su ubicación.",
                departure_placeholder: "Dirección de recogida",
                destination_placeholder: "Dirección de destino",
                back: "Volver",
                order: "Ordenar",
                description: "Descripción",
                history: "Historia",
                visit: "Visitar",
                visit_desc: "Ordene un taxi para visitar este sitio histórico:",
                description_placeholder: "Descripción para ayudar al conductor a reconocerlo",
                no_pending: "No hay pedidos pendientes",
                no_history: "Aún no ha completado ningún viaje",
                phone: "Teléfono"
            }
        };

        // Mettre à jour les traductions
        function updateLanguage(lang) {
            currentLanguage = lang;
            document.querySelectorAll('[data-translate]').forEach(el => {
                const key = el.getAttribute('data-translate');
                if (translations[lang] && translations[lang][key]) {
                    if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                        el.placeholder = translations[lang][key];
                    } else {
                        el.textContent = translations[lang][key];
                    }
                }
            });
            
            localStorage.setItem('preferredLanguage', lang);
        }

        // ===========================================
        // GESTION DE L'INTERFACE UTILISATEUR
        // ===========================================

        // Afficher le nom d'utilisateur
        function displayUserName() {
            const userName = localStorage.getItem('userName');
            const userId = localStorage.getItem('userId');
            const userType = localStorage.getItem('userType');
            
            if (userName && userId) {
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('userDisplay').classList.remove('hidden');
                document.getElementById('userName').textContent = userName;
                document.getElementById('userId').textContent = userId;
                
                if (userType === 'unsave') {
                    document.getElementById('userName').textContent = 'Invité';
                }
                
                // Charger les commandes non confirmées après connexion
                loadUnconfirmedRequests();
                loadAllPendingRequests();
                loadTripHistory();
            }
        }

        // Déconnexion de l'utilisateur
        function logoutUser() {
            const userId = localStorage.getItem('userId');
            const userType = localStorage.getItem('userType');
            
            if (userType === 'unsave') {
                const unsaveMemberRef = database.ref('unsave_member');
                unsaveMemberRef.orderByChild('userId').equalTo(userId).once('value', snapshot => {
                    if (snapshot.exists()) {
                        snapshot.forEach(child => {
                            child.ref.remove();
                        });
                    }
                });
            }
            
            localStorage.removeItem('userName');
            localStorage.removeItem('userId');
            localStorage.removeItem('userType');
            
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('userDisplay').classList.add('hidden');
            
            // Vider les commandes non confirmées
            document.getElementById('unconfirmedRequestsContainer').innerHTML = '';
            document.getElementById('unconfirmed-request').style.display = 'none';
            
            // Cacher les sections historiques
            document.getElementById('all-pending-requests').style.display = 'none';
            document.getElementById('tripHistorySection').style.display = 'none';
        }

        // ===========================================
        // GÉNÉRATION DE CONTENU DYNAMIQUE
        // ===========================================

        // Générer le contenu pour une demande en attente
        function generatePendingContent(orderId, pickup, destination) {
            return `
                <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-8 h-8 flex items-center justify-center">
                                <i class="ri-time-line text-orange-500 ri-lg"></i>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-orange-800" data-translate="pending_request">Demande en attente</p>
                                <p class="text-xs text-orange-600" data-translate="searching_driver">Recherche d'un chauffeur disponible...</p>
                            </div>
                        </div>
                        <div>
                            <button id="cancelOrderBtn" class="bg-orange-500 text-white px-4 py-1 !rounded-button text-sm font-medium cursor-pointer" data-translate="cancel">
                                Annuler
                            </button>
                        </div>
                    </div>
                    <div class="order-details">
                        <p><strong data-translate="departure">Départ:</strong> ${pickup || 'Position actuelle'}</p>
                        <p><strong data-translate="destination">Destination:</strong> ${destination}</p>
                    </div>
                </div>
            `;
        }

        // Générer le contenu pour un prix proposé
        function generatePriceContent(orderId, price, pickup, destination) {
            return `
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-8 h-8 flex items-center">
                                                           <i class="ri-money-euro-circle-line text-blue-500 ri-lg"></i>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-blue-800" data-translate="proposed_price">Prix proposé</p>
                                <p class="text-lg font-bold text-blue-700">${price} $</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button id="acceptPriceBtn" class="gold-button px-4 py-1 !rounded-button font-medium cursor-pointer" data-translate="accept">
                                Accepter
                            </button>
                            <button id="rejectPriceBtn" class="bg-gray-200 text-gray-800 px-4 py-1 !rounded-button font-medium cursor-pointer" data-translate="reject">
                                Refuser
                            </button>
                        </div>
                    </div>
                    <div class="order-details mt-3">
                        <p class="mt-3"><strong data-translate="departure">Départ:</strong> ${pickup || 'Position actuelle'}</p>
                        <p><strong data-translate="destination">Destination:</strong> ${destination}</p>
                        <p class="text-sm text-gray-500 mt-2" data-translate="price_explanation">Un administrateur a fixé ce prix pour votre trajet.</p>
                    </div>
                </div>
            `;
        }

        // Générer le contenu pour un transfert en cours
        function generateTransferringContent(orderId, pickup, destination) {
            return `
                <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-8 h-8 flex items-center justify-center">
                                <i class="ri-user-search-line text-purple-500 ri-lg"></i>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-purple-800" data-translate="transferring_request">Transfert en cours</p>
                                <p class="text-xs text-purple-600" data-translate="transferring_driver">Recherche d'un chauffeur disponible...</p>
                            </div>
                        </div>
                    </div>
                    <div class="order-details mt-3">
                        <p><strong data-translate="departure">Départ:</strong> ${pickup || 'Position actuelle'}</p>
                        <p><strong data-translate="destination">Destination:</strong> ${destination}</p>
                        <p class="text-sm text-purple-500 mt-2" data-translate="transferring_message">L'administrateur est en train de vous transférer à un chauffeur.</p>
                    </div>
                </div>
            `;
        }

        // Générer le contenu pour une commande confirmée
        function generateConfirmedContent(orderId, pickup, destination, driverName, driverPhoto, driverPhone, status = 'pending') {
            let statusText, statusClass, statusIcon, statusDescription;
            
            switch (status) {
                case 'here':
                    statusText = 'Chauffeur arrivé !';
                    statusClass = 'status-here';
                    statusIcon = 'ri-checkbox-circle-line text-green-500';
                    statusDescription = 'Votre chauffeur est arrivé à votre position.';
                    break;
                case 'finished':
                    statusText = 'Trajet terminé';
                    statusClass = 'status-finished';
                    statusIcon = 'ri-checkbox-circle-line text-blue-500';
                    statusDescription = 'Votre trajet est terminé.';
                    break;
                case 'accepted':
                    statusText = 'Prix accepté';
                    statusClass = 'status-accepted';
                    statusIcon = 'ri-check-double-line text-green-500';
                    statusDescription = 'Vous avez accepté le prix. Nous vous référons à un chauffeur.';
                    break;
                case 'transferring':
                    statusText = 'Transfert en cours';
                    statusClass = 'status-transferring';
                    statusIcon = 'ri-user-search-line text-purple-500';
                    statusDescription = 'L\'administrateur est en train de vous transférer à un chauffeur.';
                    break;
                case 'onway':
                    statusText = 'Chauffeur en route';
                    statusClass = 'status-onway';
                    statusIcon = 'ri-roadster-line text-orange-500';
                    statusDescription = 'Votre chauffeur est en route vers votre position.';
                    break;
                default: // 'pending'
                    statusText = 'Commande confirmée !';
                    statusClass = 'status-pending';
                    statusIcon = 'ri-check-line text-green-500';
                    statusDescription = 'Votre chauffeur est en route.';
            }
            
            return `
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-8 h-8 flex items-center justify-center">
                                <i class="${statusIcon} ri-lg"></i>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-green-800">${statusText}</p>
                                <p class="text-xs text-green-600">${statusDescription}</p>
                            </div>
                        </div>
                        <div class="${statusClass} status-indicator">${statusText}</div>
                    </div>
                    <div class="order-details mt-3">
                        ${driverName ? `
                            <div class="driver-info">
                                <img src="${driverPhoto}" alt="Photo du chauffeur" class="driver-photo">
                                <div class="driver-details">
                                    <p class="driver-name">${driverName}</p>
                                    <p><strong data-translate="phone">Téléphone:</strong> ${driverPhone || "06 12 34 56 78"}</p>
                                </div>
                            </div>
                        ` : ''}
                        <p class="mt-3"><strong data-translate="departure">Départ:</strong> ${pickup || 'Position actuelle'}</p>
                        <p><strong data-translate="destination">Destination:</strong> ${destination || 'Destination inconnue'}</p>
                        <p class="text-sm text-gray-500 mt-2">${statusDescription}</p>
                        ${status === 'finished' ? `
                            <div class="mt-4">
                                <button id="closeFinishedBtn" class="w-full gold-button py-3 !rounded-button font-semibold" data-translate="close_finished">
                                    Fermer
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // ===========================================
        // GESTION DES COMMANDES
        // ===========================================

        // Charger toutes les commandes en attente
        async function loadAllPendingRequests() {
            const userId = localStorage.getItem('userId');
            if (!userId) {
                document.getElementById('all-pending-requests').style.display = 'none';
                return;
            }
            
            const pendingRequestsContainer = document.getElementById('pendingRequestsContainer');
            pendingRequestsContainer.innerHTML = '';
            
            const tables = ['commande', 'commande_unconfirmed', 'commande_transfered', 'commande_confirmed'];
            // Utiliser un Map pour stocker les commandes par leur clé unique
            const pendingRequestsMap = new Map();
            
            const promises = tables.map(table => {
                return database.ref(table).orderByChild('userId').equalTo(userId).once('value');
            });
            
            try {
                const snapshots = await Promise.all(promises);
                
                snapshots.forEach(snapshot => {
                    if (snapshot.exists()) {
                        snapshot.forEach(child => {
                            const order = child.val();
                            // Vérifier que la commande n'est pas terminée
                            if (order.status !== 'finished') {
                                const orderKey = generateOrderKey(order);
                                
                                // Si cette commande n'est pas déjà dans le Map, l'ajouter
                                if (!pendingRequestsMap.has(orderKey)) {
                                    pendingRequestsMap.set(orderKey, { ...order, key: child.key, table: table });
                                }
                            }
                        });
                    }
                });
                
                if (pendingRequestsMap.size > 0) {
                    document.getElementById('all-pending-requests').style.display = 'block';
                    // Afficher chaque commande du Map
                    pendingRequestsMap.forEach((order, orderKey) => {
                        let card;
                        if (order.table === 'commande') {
                            card = generatePendingContent(
                                order.key,
                                order.pickup,
                                order.destination
                            );
                        } else if (order.table === 'commande_unconfirmed') {
                            card = generatePriceContent(
                                order.key, 
                                order.price,
                                order.pickup,
                                order.destination
                            );
                        } else if (order.table === 'commande_transfered') {
                            card = generateTransferringContent(
                                order.key,
                                order.pickup,
                                order.destination
                            );
                        } else if (order.table === 'commande_confirmed') {
                            card = generateConfirmedContent(
                                order.key,
                                order.pickup,
                                order.destination,
                                order.driverName,
                                order.driverPhoto,
                                order.driverPhone || "06 12 34 56 78",
                                order.status
                            );
                        }
                        
                        const div = document.createElement('div');
                        div.setAttribute('data-order-id', order.key);
                        div.setAttribute('data-order-key', orderKey);
                        div.innerHTML = card;
                        pendingRequestsContainer.appendChild(div);
                    });
                } else {
                    document.getElementById('all-pending-requests').style.display = 'block';
                    pendingRequestsContainer.innerHTML = `
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-6 text-center">
                            <i class="ri-inbox-line text-gray-400 text-4xl mb-4"></i>
                            <p class="text-gray-600" data-translate="no_pending">${translations[currentLanguage].no_pending}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error("Erreur lors du chargement des commandes en attente :", error);
                document.getElementById('all-pending-requests').style.display = 'none';
            }
        }

        // Charger les demandes non confirmées
        function loadUnconfirmedRequests() {
            const userId = localStorage.getItem('userId');
            if (!userId) {
                document.getElementById('unconfirmed-request').style.display = 'none';
                return;
            }

            const unconfirmedRequestsContainer = document.getElementById('unconfirmedRequestsContainer');
            unconfirmedRequestsContainer.innerHTML = '';
            let hasUnconfirmed = false;

            database.ref('commande_unconfirmed').orderByChild('userId').equalTo(userId).once('value', snapshot => {
                if (snapshot.exists()) {
                    snapshot.forEach(child => {
                        const commandeData = child.val();
                        // Vérifier que le prix est défini avant d'afficher
                        if (typeof commandeData.price === 'number') {
                            hasUnconfirmed = true;
                            const card = generatePriceContent(
                                child.key, 
                                commandeData.price,
                                commandeData.pickup,
                                commandeData.destination
                            );
                            
                            const div = document.createElement('div');
                            div.setAttribute('data-order-id', child.key);
                            div.innerHTML = card;
                            unconfirmedRequestsContainer.appendChild(div);
                        }
                    });
                }
                
                if (hasUnconfirmed) {
                    document.getElementById('unconfirmed-request').style.display = 'block';
                } else {
                    document.getElementById('unconfirmed-request').style.display = 'none';
                }
            });
        }

        // Vérifier le statut d'une commande
        function checkOrderStatus(orderId) {
            const pendingSection = document.getElementById('pending-request');
            const userId = localStorage.getItem('userId');
            
            if (!userId) return;
            
            // Vérifier si la commande a été déplacée vers commande_unconfirmed
            database.ref('commande_unconfirmed').orderByChild('userId').equalTo(userId).once('value', snapshot => {
                if (snapshot.exists()) {
                    snapshot.forEach(child => {
                        const commandeData = child.val();
                        
                        // Vérifier si le prix a été ajouté par l'administrateur
                        if (commandeData.price) {
                            clearInterval(parseInt(pendingSection.dataset.intervalId));
                            
                            pendingSection.style.display = 'none';
                            
                            loadUnconfirmedRequests();
                            loadAllPendingRequests();
                        }
                    });
                }
            });
        }

        // Commander un taxi
        function handleTaxiOrder() {
            const orderBtn = document.getElementById('orderTaxiBtn');
            const destinationSwitch = document.getElementById('destinationSwitch');
            const destinationAddress = document.getElementById('destinationAddress');
            const destinationArrival = document.getElementById('destinationAddressArrival');
            const description = document.getElementById('bookingDescription');
            const pendingSection = document.getElementById('pending-request');
            const locationModal = document.getElementById('locationPermissionModal');
            const nowBtn = document.getElementById('nowBtn');
            const laterBtn = document.getElementById('laterBtn');
            const oneWayBtn = document.getElementById('oneWayBtn');
            const roundTripBtn = document.getElementById('roundTripBtn');
            
            orderBtn.addEventListener('click', async function() {
                if (!destinationArrival.value.trim()) {
                    alert('Veuillez saisir une adresse de destination');
                    return;
                }
                
                if (destinationSwitch.checked && !destinationAddress.value.trim()) {
                    alert('Veuillez saisir une adresse de départ');
                    return;
                }
                
                const isNow = nowBtn.classList.contains('active');
                const tripType = oneWayBtn.classList.contains('active') ? 
                    oneWayBtn.dataset.tripType : 
                    roundTripBtn.dataset.tripType;
                
                if (isNow && !destinationSwitch.checked) {
                    locationModal.style.display = 'flex';
                    
                    const userResponse = await new Promise((resolve) => {
                        document.getElementById('acceptLocationBtn').onclick = () => resolve(true);
                        document.getElementById('closeLocationModalBtn').onclick = () => resolve(false);
                    });
                    
                    if (!userResponse) {
                        destinationSwitch.checked = true;
                        document.getElementById('destinationField').classList.remove('hidden');
                        return;
                    }
                }
                
                if (isNow) {
                    if (navigator.geolocation && !destinationSwitch.checked) {
                        navigator.geolocation.getCurrentPosition(
                            async function(position) {
                                const ip = await getUserIP();
                                const userId = localStorage.getItem('userId') || 'guest';
                                const userType = localStorage.getItem('userType') || 'guest';
                                const pickupAddress = destinationSwitch.checked ? destinationAddress.value : "Position actuelle";
                                
                                // Enregistrement dans la table 'commande'
                                const commandeRef = database.ref('commande').push();
                                const orderId = commandeRef.key;
                                commandeRef.set({
                                    userId: userId,
                                    userType: userType,
                                    ip: ip,
                                    pickup: pickupAddress,
                                    destination: destinationArrival.value,
                                    description: description.value,
                                    tripType: tripType,
                                    latitude: position.coords.latitude,
                                    longitude: position.coords.longitude,
                                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                                    status: 'pending'
                                });
                                
                                pendingSection.style.display = 'block';
                                pendingSection.dataset.orderId = orderId;
                                pendingSection.innerHTML = generatePendingContent(
                                    orderId,
                                    pickupAddress,
                                    destinationArrival.value
                                );
                                
                                const intervalId = setInterval(() => checkOrderStatus(orderId), 2000);
                                pendingSection.dataset.intervalId = intervalId;
                                
                                pendingSection.scrollIntoView({ behavior: 'smooth' });
                                
                                // Mettre à jour la liste des commandes en attente
                                loadAllPendingRequests();
                            },
                            function(error) {
                                alert('Erreur de géolocalisation : ' + error.message);
                            }
                        );
                    } else {
                        const ip = await getUserIP();
                        const userId = localStorage.getItem('userId') || 'guest';
                        const userType = localStorage.getItem('userType') || 'guest';
                        const pickupAddress = destinationAddress.value;
                        
                        // Enregistrement dans la table 'commande'
                        const commandeRef = database.ref('commande').push();
                        const orderId = commandeRef.key;
                        commandeRef.set({
                            userId: userId,
                            userType: userType,
                            ip: ip,
                            pickup: pickupAddress,
                            destination: destinationArrival.value,
                            description: description.value,
                            tripType: tripType,
                            timestamp: firebase.database.ServerValue.TIMESTAMP,
                            status: 'pending'
                        });
                        
                        pendingSection.style.display = 'block';
                        pendingSection.dataset.orderId = orderId;
                        pendingSection.innerHTML = generatePendingContent(
                            orderId,
                            pickupAddress,
                            destinationArrival.value
                        );
                        
                        const intervalId = setInterval(() => checkOrderStatus(orderId), 2000);
                        pendingSection.dataset.intervalId = intervalId;
                        
                        pendingSection.scrollIntoView({ behavior: 'smooth' });
                        
                        // Mettre à jour la liste des commandes en attente
                        loadAllPendingRequests();
                    }
                } else {
                    const bookingDate = document.getElementById('bookingDate').value;
                    const bookingTime = document.getElementById('bookingTime').value;
                    
                    if (!bookingDate || !bookingTime) {
                        alert('Veuillez sélectionner une date et une heure');
                        return;
                    }
                    
                    const ip = await getUserIP();
                    const userId = localStorage.getItem('userId') || 'guest';
                    const userType = localStorage.getItem('userType') || 'guest';
                    const pickupAddress = destinationSwitch.checked ? destinationAddress.value : "Position actuelle";
                    
                    // Enregistrement dans la table 'commande'
                    const commandeRef = database.ref('commande').push();
                    commandeRef.set({
                        userId: userId,
                        userType: userType,
                        ip: ip,
                        pickup: pickupAddress,
                        destination: destinationArrival.value,
                        description: description.value,
                        tripType: tripType,
                        date: bookingDate,
                        time: bookingTime,
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        status: 'scheduled'
                    });
                    
                    alert('Votre réservation a été enregistrée!');
                }
            });
        }

        // Mettre à jour l'évaluation d'un chauffeur
        function updateDriverRating(driverId) {
            const reviewsRef = database.ref(`drivers/${driverId}/reviews`);
            reviewsRef.once('value', snapshot => {
                if (snapshot.exists()) {
                    let totalRating = 0;
                    let count = 0;
                    snapshot.forEach(child => {
                        const review = child.val();
                        totalRating += review.rating;
                        count++;
                    });

                    if (count > 0) {
                        const averageRating = totalRating / count;
                        database.ref('drivers/' + driverId).update({
                            rating: averageRating.toFixed(1)
                        });
                    }
                }
            });
        }

        // Gérer les actions sur les commandes
        function handleOrderActions() {
            const pendingSection = document.getElementById('pending-request');
            pendingSection.addEventListener('click', function(event) {
                const orderId = this.dataset.orderId;
                if (!orderId) return;
                
                if (event.target.id === 'cancelOrderBtn') {
                    database.ref('commande/' + orderId).remove()
                        .then(() => {
                            clearInterval(parseInt(this.dataset.intervalId));
                            this.style.display = 'none';
                            loadAllPendingRequests();
                        });
                }
            });
            
            const unconfirmedRequestsContainer = document.getElementById('unconfirmedRequestsContainer');
            unconfirmedRequestsContainer.addEventListener('click', function(event) {
                const cardElement = event.target.closest('[data-order-id]');
                if (!cardElement) return;
                
                const orderId = cardElement.dataset.orderId;
                
                if (event.target.id === 'acceptPriceBtn') {
                    database.ref('commande_unconfirmed/' + orderId).once('value', snapshot => {
                        if (snapshot.exists()) {
                            const commandeData = snapshot.val();
                            
                            // Mettre à jour priceConfirmed à true sans déplacer la commande
                            database.ref('commande_unconfirmed/' + orderId).update({
                                priceConfirmed: true
                            })
                            .then(() => {
                                cardElement.remove();
                                
                                if (unconfirmedRequestsContainer.children.length === 0) {
                                    document.getElementById('unconfirmed-request').style.display = 'none';
                                }
                                
                                const confirmedSection = document.getElementById('confirmed-request');
                                confirmedSection.style.display = 'block';
                                confirmedSection.dataset.orderId = orderId;
                                confirmedSection.innerHTML = generateConfirmedContent(
                                    orderId,
                                    commandeData.pickup,
                                    commandeData.destination,
                                    null,
                                    null,
                                    null,
                                    'accepted'
                                );
                                
                                const statusIntervalId = setInterval(() => checkConfirmedOrderStatus(orderId), 2000);
                                confirmedSection.dataset.intervalId = statusIntervalId;
                                
                                confirmedSection.scrollIntoView({ behavior: 'smooth' });
                                
                                loadAllPendingRequests();
                            });
                        }
                    });
                }
                
                if (event.target.id === 'rejectPriceBtn') {
                    database.ref('commande_unconfirmed/' + orderId).remove()
                        .then(() => {
                            cardElement.remove();
                            
                            if (unconfirmedRequestsContainer.children.length === 0) {
                                document.getElementById('unconfirmed-request').style.display = 'none';
                            }
                            
                            loadAllPendingRequests();
                        });
                }
            });
            
            const confirmedSection = document.getElementById('confirmed-request');
            confirmedSection.addEventListener('click', function(event) {
                const orderId = this.dataset.orderId;
                if (!orderId) return;
                
                if (event.target.id === 'closeFinishedBtn') {
                    this.style.display = 'none';
                    loadAllPendingRequests();
                }
            });
        }

        // Vérifier le statut d'une commande confirmée
        function checkConfirmedOrderStatus(orderId) {
            const confirmedSection = document.getElementById('confirmed-request');
            if (!confirmedSection || confirmedSection.dataset.orderId !== orderId) return;
            
            // Vérifier si la commande a été déplacée vers commande_transfered
            database.ref('commande_transfered/' + orderId).once('value', transferedSnapshot => {
                if (transferedSnapshot.exists()) {
                    const commandeData = transferedSnapshot.val();
                    
                    // Vérifier si la commande a été supprimée de commande_unconfirmed
                    database.ref('commande_unconfirmed/' + orderId).once('value', unconfirmedSnapshot => {
                        if (!unconfirmedSnapshot.exists()) {
                            // Mettre à jour l'affichage pour indiquer que l'administrateur est en train de transférer
                            confirmedSection.innerHTML = generateTransferringContent(
                                orderId,
                                commandeData.pickup,
                                commandeData.destination
                            );
                            
                            // Vérifier si la commande a été déplacée vers commande_confirmed
                            const transferIntervalId = setInterval(() => checkTransferedOrderStatus(orderId), 2000);
                            confirmedSection.dataset.intervalId = transferIntervalId;
                            
                            loadAllPendingRequests();
                        }
                    });
                }
            });
        }

        // Vérifier le statut d'une commande en transfert
        function checkTransferedOrderStatus(orderId) {
            const confirmedSection = document.getElementById('confirmed-request');
            if (!confirmedSection || confirmedSection.dataset.orderId !== orderId) return;
            
            // Vérifier si la commande a été déplacée vers commande_confirmed
            database.ref('commande_confirmed/' + orderId).once('value', confirmedSnapshot => {
                if (confirmedSnapshot.exists()) {
                    const commandeData = confirmedSnapshot.val();
                    
                    // Vérifier si la commande a été supprimée de commande_transfered
                    database.ref('commande_transfered/' + orderId).once('value', transferedSnapshot => {
                        if (!transferedSnapshot.exists()) {
                            clearInterval(parseInt(confirmedSection.dataset.intervalId));
                            
                            // Mettre à jour l'affichage pour indiquer que le chauffeur est en route
                            confirmedSection.innerHTML = generateConfirmedContent(
                                orderId,
                                commandeData.pickup,
                                commandeData.destination,
                                commandeData.driverName,
                                commandeData.driverPhoto,
                                commandeData.driverPhone || "06 12 34 56 78",
                                'onway'
                            );
                            
                            loadAllPendingRequests();
                        }
                    });
                }
            });
        }

        // ===========================================
        // GESTION DES CHAUFFEURS ET AVIS
        // ===========================================

        // Afficher les avis d'un chauffeur
        function showDriverReviews(driverId) {
            const modal = document.getElementById('reviewsModal');
            const container = document.getElementById('reviewsContainer');
            
            database.ref('drivers/' + driverId).once('value', snapshot => {
                if (snapshot.exists()) {
                    const driver = snapshot.val();
                    const rating = driver.rating || 0;
                    
                    container.innerHTML = `
                        <div class="flex items-center mb-6">
                            <img src="${driver.photoURL || 'https://via.placeholder.com/60x60?text=Driver'}" alt="Photo du chauffeur" class="w-16 h-16 rounded-full object-cover">
                            <div class="ml-4">
                                <h4 class="text-lg font-semibold">${driver.firstname} ${driver.lastname}</h4>
                                <div class="driver-rating mt-1">
                                    ${renderStars(rating)}
                                    <span class="text-sm text-gray-600 ml-2">${rating.toFixed(1)}</span>
                                </div>
                            </div>
                        </div>
                        <h5 class="font-medium text-gray-700 mb-3" data-translate="customer_reviews">Avis des clients :</h5>
                        <div id="reviewsList" class="space-y-4 mb-6">
                            <p class="text-gray-500 text-center py-4" data-translate="no_reviews">Aucun avis pour le moment</p>
                        </div>
                    `;
                    
                    database.ref(`drivers/${driverId}/reviews`).once('value', reviewsSnapshot => {
                        const reviewsList = document.getElementById('reviewsList');
                        reviewsList.innerHTML = '';
                        
                        if (reviewsSnapshot.exists()) {
                            reviewsSnapshot.forEach(review => {
                                const data = review.val();
                                reviewsList.innerHTML += `
                                    <div class="review-item">
                                        <div class="flex justify-between">
                                            <div class="font-medium">${data.userName || 'Anonyme'}</div>
                                            <div class="flex text-yellow-400">
                                                ${renderStars(data.rating)}
                                            </div>
                                        </div>
                                        <p class="text-gray-600 mt-2">${data.comment || 'Aucun commentaire'}</p>
                                        <div class="text-xs text-gray-400 mt-2">${new Date(data.timestamp).toLocaleDateString()}</div>
                                    </div>
                                `;
                            });
                        } else {
                            reviewsList.innerHTML = '<p class="text-gray-500 text-center py-4" data-translate="no_reviews">Aucun avis pour le moment</p>';
                        }
                    });
                    
                    modal.style.display = 'flex';
                }
            });
            
            document.querySelector('.close-reviews-modal').addEventListener('click', function() {
                modal.style.display = 'none';
            });
        }

        // Charger les chauffeurs
        function loadDrivers() {
            const driversRef = database.ref('drivers');
            driversRef.once('value', snapshot => {
                const drivers = snapshot.val() || {};
                const topDriversContainer = document.getElementById('topDriversContainer');
                
                if (drivers) {
                    const driversArray = [];
                    for (const key in drivers) {
                        driversArray.push({
                            id: key,
                            ...drivers[key]
                        });
                    }
                    
                    driversArray.forEach(driver => {
                        driver.averageRating = calculateAverageRating(driver.reviews);
                    });
                    
                    driversArray.sort((a, b) => b.averageRating - a.averageRating);
                    
                    topDriversContainer.innerHTML = '';
                    for (let i = 0; i < Math.min(3, driversArray.length); i++) {
                        const driver = driversArray[i];
                        const rating = driver.averageRating;
                        
                        topDriversContainer.innerHTML += `
                            <div class="bg-white rounded-lg p-4 text-center shadow-sm">
                                <div class="relative mb-3">
                                    <img src="${driver.photoURL}" alt="Chauffeur" class="w-16 h-16 rounded-full mx-auto object-cover">
                                    <div class="absolute -top-1 -right-1 ${i === 0 ? 'bg-yellow-400' : i === 1 ? 'bg-gray-400' : 'bg-orange-400'} text-white text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center">${i + 1}</div>
                                </div>
                                <h4 class="font-medium text-sm text-gray-800">${driver.lastname}</h4>
                                <h4 class="font-medium text-sm text-gray-800">${driver.firstname}</h4>
                                <div class="flex items-center justify-center mt-1">
                                    <div class="flex text-yellow-400 text-xs">
                                        ${renderStars(rating)}
                                    </div>
                                    <span class="text-xs text-gray-500 ml-1">${rating.toFixed(1)}</span>
                                </div>
                            </div>
                        `;
                    }
                } else {
                    topDriversContainer.innerHTML = '<p class="text-gray-500 text-center" data-translate="no_drivers">Aucun chauffeur disponible</p>';
                }
            });
        }

        // Charger l'historique des trajets
        function loadTripHistory() {
            const tripHistoryContainer = document.getElementById('tripHistoryContainer');
            const tripHistorySection = document.getElementById('tripHistorySection');
            const userId = localStorage.getItem('userId');
            
            if (!userId) {
                tripHistorySection.style.display = 'none';
                return;
            }
            
            const commandeRef = database.ref('commande_confirmed').orderByChild('userId').equalTo(userId);
            commandeRef.once('value', snapshot => {
                const trips = snapshot.val();
                const finishedTrips = {};
                let hasHistory = false;
                
                // Filtrer uniquement les trajets terminés (statut 'finished')
                if (trips) {
                    for (const key in trips) {
                        if (trips[key].status === 'finished') {
                            finishedTrips[key] = trips[key];
                        }
                    }
                }
                
                // Éviter les doublons avec des informations identiques
                const uniqueTrips = new Map();
                for (const key in finishedTrips) {
                    const trip = finishedTrips[key];
                    const tripKey = `${trip.pickup || ''}-${trip.destination || ''}-${trip.timestamp}-${trip.finishedAt || ''}`;
                    
                    if (!uniqueTrips.has(tripKey)) {
                        uniqueTrips.set(tripKey, { key, trip });
                    }
                }
                
                const uniqueTripArray = Array.from(uniqueTrips.values()).slice(0, 3);
                
                if (uniqueTripArray.length > 0) {
                    tripHistoryContainer.innerHTML = '';
                    const reviewPromises = [];
                    
                    for (const item of uniqueTripArray) {
                        const key = item.key;
                        const trip = item.trip;
                        const tripDate = new Date(trip.timestamp);
                        const finishDate = trip.finishedAt ? new Date(trip.finishedAt) : new Date();
                        const duration = Math.floor((finishDate - tripDate) / 60000);
                        
                        if (trip.driverId) {
                            const promise = new Promise(resolve => {
                                database.ref(`drivers/${trip.driverId}/reviews`)
                                    .orderByChild('tripId')
                                    .equalTo(key)
                                    .once('value', reviewSnapshot => {
                                        let userReview = null;
                                        if (reviewSnapshot.exists()) {
                                            reviewSnapshot.forEach(review => {
                                                const data = review.val();
                                                if (data.userId === userId) {
                                                    userReview = {
                                                        rating: data.rating,
                                                        reviewId: review.key,
                                                        comment: data.comment
                                                    };
                                                }
                                            });
                                        }
                                        resolve({ tripId: key, review: userReview });
                                    });
                            });
                            reviewPromises.push(promise);
                        }
                        
                        const card = document.createElement('div');
                        card.className = 'bg-white rounded-lg p-4 shadow-sm';
                        card.setAttribute('data-trip-id', key);
                        card.innerHTML = `
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center">
                                    <img src="${trip.driverPhoto || 'https://via.placeholder.com/50x50'}" alt="Chauffeur" class="w-10 h-10 rounded-full object-cover">
                                    <div class="ml-3">
                                        <h4 class="font-medium text-sm text-gray-800">${trip.driverName || 'Chauffeur #' + Math.floor(Math.random() * 100)}</h4>
                                        <p class="text-xs text-gray-500">${tripDate.toLocaleDateString()} • ${tripDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm font-medium text-gray-800">${trip.price || (Math.random() * 30 + 10).toFixed(2)} HTG</p>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="flex items-center text-sm text-gray-600">
                                    <div class="w-3 h-3 flex items-center justify-center">
                                        <i class="ri-record-circle-fill text-green-500 text-xs"></i>
                                    </div>
                                    <span class="ml-2">${trip.pickup || 'Position actuelle'}</span>
                                </div>
                                <div class="flex items-center text-sm text-gray-600 mt-1">
                                    <div class="w-3 h-3 flex items-center justify-center">
                                        <i class="ri-map-pin-fill text-primary text-xs"></i>
                                    </div>
                                    <span class="ml-2">${trip.destination || 'Destination inconnue'}</span>
                                </div>
                            </div>
                            <div id="ratingContainer-${key}">
                                <!-- Contenu dynamique pour l'évaluation -->
                            </div>
                        `;
                        
                        tripHistoryContainer.appendChild(card);
                    }
                    
                    Promise.all(reviewPromises).then(reviewResults => {
                        const reviewsMap = {};
                        reviewResults.forEach(result => {
                            reviewsMap[result.tripId] = result.review;
                        });
                        
                        for (const item of uniqueTripArray) {
                            const key = item.key;
                            const trip = item.trip;
                            const userReview = reviewsMap[key] || null;
                            const hasRated = userReview !== null;
                            const userRating = userReview ? userReview.rating : null;
                            const reviewId = userReview ? userReview.reviewId : null;
                            
                            const ratingContainer = document.querySelector(`#ratingContainer-${key}`);
                            
                            if (ratingContainer) {
                                if (hasRated || userRating) {
                                    ratingContainer.innerHTML = `
                                        <div class="mt-3">
                                            <p class="text-sm text-gray-700 mb-2" data-translate="your_rating">Votre note :</p>
                                            <div class="history-rating" data-trip-id="${key}" data-review-id="${reviewId}">
                                                <i class="${userRating >= 1 ? 'ri-star-fill active' : 'ri-star-line'}" data-value="1"></i>
                                                <i class="${userRating >= 2 ? 'ri-star-fill active' : 'ri-star-line'}" data-value="2"></i>
                                                <i class="${userRating >= 3 ? 'ri-star-fill active' : 'ri-star-line'}" data-value="3"></i>
                                                <i class="${userRating >= 4 ? 'ri-star-fill active' : 'ri-star-line'}" data-value="4"></i>
                                                <i class="${userRating >= 5 ? 'ri-star-fill active' : 'ri-star-line'}" data-value="5"></i>
                                            </div>
                                            <div class="review-actions">
                                                <button class="review-edit-btn" data-trip-id="${key}" data-review-id="${reviewId}">
                                                    <i class="ri-edit-line"></i> <span data-translate="edit">Modifier</span>
                                                </button>
                                            </div>
                                        </div>
                                    `;
                                } else {
                                    ratingContainer.innerHTML = `
                                        <div class="mt-3">
                                            <p class="text-sm text-gray-700 mb-2" data-translate="rate_trip">Notez ce trajet :</p>
                                            <div class="history-rating" data-trip-id="${key}">
                                                <i class="ri-star-line" data-value="1"></i>
                                                <i class="ri-star-line" data-value="2"></i>
                                                <i class="ri-star-line" data-value="3"></i>
                                                <i class="ri-star-line" data-value="4"></i>
                                                <i class="ri-star-line" data-value="5"></i>
                                            </div>
                                        </div>
                                    `;
                                }
                            }
                        }
                        
                        // Gestion des événements pour les étoiles
                        document.querySelectorAll('.history-rating:not([data-review-id])').forEach(ratingContainer => {
                            const stars = ratingContainer.querySelectorAll('i');
                            const tripId = ratingContainer.dataset.tripId;
                            
                            stars.forEach(star => {
                                star.addEventListener('click', function() {
                                    const value = parseInt(this.dataset.value);
                                    
                                    stars.forEach((s, index) => {
                                        if (index < value) {
                                            s.classList.remove('ri-star-line');
                                            s.classList.add('ri-star-fill', 'active');
                                        } else {
                                            s.classList.remove('ri-star-fill', 'active');
                                            s.classList.add('ri-star-line');
                                        }
                                    });
                                    
                                    const driverId = trips[tripId].driverId;
                                    if (driverId) {
                                        const reviewRef = database.ref(`drivers/${driverId}/reviews`).push();
                                        const userName = localStorage.getItem('userName') || 'Anonyme';
                                        
                                        reviewRef.set({
                                            driverId: driverId,
                                            userName: userName,
                                            userId: userId,
                                            rating: value,
                                            tripId: tripId,
                                            timestamp: firebase.database.ServerValue.TIMESTAMP
                                        }).then(() => {
                                            updateDriverRating(driverId);
                                            
                                            localStorage.setItem(`rated-${tripId}`, 'true');
                                            
                                            loadTripHistory();
                                        });
                                    }
                                });
                            });
                        });
                        
                        // Gestion de l'édition des avis
                        document.querySelectorAll('.review-edit-btn').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const tripId = this.dataset.tripId;
                                const reviewId = this.dataset.reviewId;
                                const driverId = trips[tripId].driverId;
                                
                                if (driverId && reviewId) {
                                    database.ref(`drivers/${driverId}/reviews/${reviewId}`).once('value', reviewSnapshot => {
                                        if (reviewSnapshot.exists()) {
                                            const review = reviewSnapshot.val();
                                            const rating = review.rating;
                                            
                                            const tripElement = document.querySelector(`[data-trip-id="${tripId}"]`);
                                            tripElement.innerHTML += `
                                                <div class="rating-form mt-4">
                                                    <h4 class="text-sm font-medium mb-2" data-translate="edit_review">Modifier votre avis</h4>
                                                    <div class="rating-input">
                                                        <i class="${rating >= 1 ? 'ri-star-fill active' : 'ri-star-line'}" data-value="1"></i>
                                                        <i class="${rating >= 2 ? 'ri-star-fill active' : 'ri-star-line'}" data-value="2"></i>
                                                        <i class="${rating >= 3 ? 'ri-star-fill active' : 'ri-star-line'}" data-value="3"></i>
                                                        <i class="${rating >= 4 ? 'ri-star-fill active' : 'ri-star-line'}" data-value="4"></i>
                                                        <i class="${rating >= 5 ? 'ri-star-fill active' : 'ri-star-line'}" data-value="5"></i>
                                                    </div>
                                                    <div class="flex gap-2 mt-3">
                                                        <button class="flex-1 bg-gray-100 text-gray-700 py-2 rounded-button cancel-edit-btn" data-translate="cancel">Annuler</button>
                                                        <button class="flex-1 gold-button py-2 rounded-button save-review-btn" data-review-id="${reviewId}" data-driver-id="${driverId}" data-translate="save">Enregistrer</button>
                                                    </div>
                                                </div>
                                            `;
                                            
                                            const ratingInput = tripElement.querySelector('.rating-input');
                                            const stars = ratingInput.querySelectorAll('i');
                                            let selectedRating = rating;
                                            
                                            stars.forEach(star => {
                                                star.addEventListener('click', function() {
                                                    const value = parseInt(this.dataset.value);
                                                    selectedRating = value;
                                                    
                                                    stars.forEach((s, index) => {
                                                        if (index < value) {
                                                            s.classList.remove('ri-star-line');
                                                            s.classList.add('ri-star-fill', 'active');
                                                        } else {
                                                            s.classList.remove('ri-star-fill', 'active');
                                                            s.classList.add('ri-star-line');
                                                        }
                                                    });
                                                });
                                            });
                                            
                                            tripElement.querySelector('.cancel-edit-btn').addEventListener('click', function() {
                                                loadTripHistory();
                                            });
                                            
                                            tripElement.querySelector('.save-review-btn').addEventListener('click', function() {
                                                const reviewId = this.dataset.reviewId;
                                                const driverId = this.dataset.driverId;
                                                
                                                database.ref(`drivers/${driverId}/reviews/${reviewId}`).update({
                                                    rating: selectedRating
                                                }).then(() => {
                                                    updateDriverRating(driverId);
                                                    
                                                    loadTripHistory();
                                                });
                                            });
                                        }
                                    });
                                }
                            });
                        });
                    });
                } else {
                    tripHistoryContainer.innerHTML = `
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-6 text-center">
                            <i class="ri-history-line text-gray-400 text-4xl mb-4"></i>
                            <p class="text-gray-600" data-translate="no_history">${translations[currentLanguage].no_history}</p>
                        </div>
                    `;
                }
                
                // Afficher la section dans tous les cas
                tripHistorySection.style.display = 'block';
            });
        }

        // ===========================================
        // GESTION DES ATTRACTIONS TOURISTIQUES
        // ===========================================

        function handleTouristAttractions() {
            const attractions = {
                citadelle: {
                    fr: {
                        name: "Citadelle La Ferrière",
                        description: "La Citadelle La Ferrière est une forteresse monumentale située au sommet de la montagne Bonnet à l'Évêque, dans le Nord d'Haiti. Construite entre 1805 et 1820 sous les ordres du roi Henri Christophe, elle représente l'un des plus beaux exemples d'architecture militaire du XIXe siècle.",
                        history: "Érigée après l'indépendance d'Haiti, la Citadelle avait pour but de défendre la nouvelle nation contre un éventuel retour des Français. With its walls over 40 meters high and 365 cannons, it is the largest fortress in the Americas, classified as a UNESCO World Heritage Site."
                    },
                    ht: {
                        name: "Sitadèl Laferyè",
                        description: "Sitadèl Laferyè se yon fò monimantal ki chita sou tèt mòn Bonnet a l'Evek, nan Nò Ayiti. Li te konstwi ant 1805 ak 1820 sou lòd wa Henri Christophe, e li reprezante youn nan pi bèl egzanp achitekti militè nan syèk la 19.",
                        history: "Li te bati apre endepandans Ayiti, Sitadèl la te gen objektif pou defann nouvo nasyon an kont yon evantyèl retounen Fransè yo. Avèk mi ki pi wo pase 40 mèt ak 365 kanon, li se pi gwo fò nan Amerik yo, klase nan patrimwàn mondyal UNESCO."
                    },
                    en: {
                        name: "Citadelle La Ferrière",
                        description: "The Citadelle La Ferrière is a monumental fortress located atop Bonnet à l'Évêque mountain in northern Haiti. Built between 1805 and 1820 under King Henri Christophe, it represents one of the finest examples of 19th-century military architecture.",
                        history: "Erected after Haiti's independence, the Citadel was intended to defend the new nation against a possible French return. With walls over 40 meters high and 365 cannons, it is the largest fortress in the Americas, classified as a UNESCO World Heritage Site."
                    },
                    es: {
                        name: "Ciudadela La Ferrière",
                        description: "La Ciudadela La Ferrière es una fortaleza monumental ubicada en la cima de la montaña Bonnet à l'Évêque, en el norte de Haití. Construida entre 1805 and 1820 bajo las órdenes del rey Henri Christophe, representa uno de los mejores ejemplos de arquitectura militar del siglo XIX.",
                        history: "Erigida después de la independencia de Haití, la Ciudadela tenía como objetivo defender la nueva nación contra un posible regreso de los franceses. Con sus muros de más de 40 metros de altura and sus 365 cañones, es la fortaleza más grande de las Américas, clasificada como Patrimonio de la Humanidad por la UNESCO."
                    }
                },
                labadee: {
                    fr: {
                        name: "Labadee",
                        description: "Labadee est une station balnéaire privée située sur la côte nord d'Haïti. Connue pour ses plages de sable blanc, ses eaux turquoises et ses activités nautiques, c'est une destination de choix pour les croisiéristes et les vacanciers.",
                        history: "Nommée d'après le marquis de La Badie, un colon français du XVIIe siècle, la région a été développée en station touristique dans les années 1980. Aujourd'hui, elle offre une combinaison unique de paysages paradisiaques et de culture haïtienne authentique."
                    },
                    ht: {
                        name: "Labadee",
                        description: "Labadee se yon estasyon balyè prive ki sitiye sou kòt nò Ayiti. Li konnen pou plaj sab blan li yo, dlo tèk li yo ak aktivite nòtik li yo. Li se yon destinasyon popilè pou pasaje bato kwazyè ak vakansye.",
                        history: "Yo te rele li apre Markis La Badie, yon kolon franse nan syèk la 17, rejyon an te devlope kòm estasyon touris nan ane 1980 yo. Jodi a, li ofri yon konbinezon inik nan peyizaj paradi ak kilti ayisyèn otantik."
                    },
                    en: {
                        name: "Labadee",
                        description: "Labadee is a private beach resort located on Haiti's northern coast. Known for its white sand beaches, turquoise waters and water activities, it's a popular destination for cruise passengers and vacationers.",
                        history: "Named after the Marquis de La Badie, a 17th-century French colonist, the area was developed as a tourist resort in the 1980s. Today, it offers a unique combination of paradise landscapes and authentic Haitian culture."
                    },
                    es: {
                        name: "Labadee",
                        description: "Labadee es un complejo turístico privado ubicado en la costa norte de Haití. Conocido por sus playas de arena blanca, aguas turquesas and actividades acuáticas, es un destino popular para pasajeros de cruceros and vacacionistas.",
                        history: "Nombrado en honor al Marqués de La Badie, un colono francés del siglo XVII, el área se desarrolló como complejo turístico en la década de 1980. Hoy ofrece una combinación única de paisajes paradisíacos and cultura haitiana auténtica."
                    }
                },
                verrieres: {
                    fr: {
                        name: "Monument de Vertières",
                        description: "Le Monument de Vertières commémore la célèbre bataille de Vertières qui a scellé l'indépendance d'Haïti le 18 novembre 1803. Situé près de Cap-Haïtien, il rend hommage aux héros de la révolution haïtienne.",
                        history: "Érigé en 1953 pour le 150e anniversaire de la bataille, ce monument symbolise la résistance et la victoire des esclaves insurgés contre l'armée napoléonienne. C'est un lieu de pèlerinage historique pour tous les Haïtiens."
                    },
                    ht: {
                        name: "Moniman Vètyè",
                        description: "Moniman Vètyè komemore batay Vètyè ki te sele endepandans Ayiti sou 18 novanm 1803. Li sitiye toupre Okap, e li rann omaj bay ewo revolisyon ayisyèn yo.",
                        history: "Li te bati an 1953 pou 150yèm anivèsè batay la, moniman sa a senbolize rezistans ak viktwa esklav rebèl yo kont lame Napoleon an. Li se yon kote pelrenaj istorik pou tout Ayisyen."
                    },
                    en: {
                        name: "Vertières Monument",
                        description: "The Vertières Monument commemorates the famous Battle of Vertières that sealed Haiti's independence on November 18, 1803. Located near Cap-Haïtien, it pays tribute to the heroes of the Haitian revolution.",
                        history: "Erected in 1953 for the 150th anniversary of the battle, this monument symbolizes the resistance and victory of insurgent slaves against Napoleon's army. It is a historical pilgrimage site for all Haitians."
                    },
                    es: {
                        name: "Monumento de Vertières",
                        description: "El Monumento de Vertières conmemora la famosa Batalla de Vertières que selló la independencia de Haití el 18 de noviembre de 1803. Ubicado cerca de Cap-Haïtien, rinde homenaje a los héroes de la revolución haitiana.",
                        history: "Erigido en 1953 para el 150 aniversario de la batalla, este monumento simboliza la resistencia and victoria de los esclavos insurgentes contra el ejército napoleónico. Es un lugar de peregrinación histórica para todos los haitianos."
                    }
                },
                cathedrale: {
                    fr: {
                        name: "Cathédrale de Cap-Haïtien",
                        description: "La Cathédrale Notre-Dame de l'Assomption de Cap-Haïtien est un joyau architectural de style néo-classique. Construite au XVIIIe siècle, elle domine la place d'Armes avec son imposante façade blanche.",
                        history: "Édifiée pendant la période coloniale, la cathédrale a survécu au tremblement de terre de 1842 et a été restaurée plusieurs fois. Elle témoigne de la riche histoire religieuse et culturelle de la région."
                    },
                    ht: {
                        name: "Katredal Okap",
                        description: "Katredal Notre-Dame de l'Assomption nan Okap se yon bijou achitekti nan style neo-klasik. Li te konstwi nan syèk la 18, e li domine Plas d'Armes ak fasad blan enpòtan li.",
                        history: "Bati pandan peryòd kolonyal la, katredal la te siviv tranbleman tè 1842 la e li te retabli plizyè fwa. Li temwaye rich istwa relijye ak kiltirèl rejyon an."
                    },
                    en: {
                        name: "Cathedral of Cap-Haïtien",
                        description: "The Notre-Dame de l'Assomption Cathedral in Cap-Haïtien is an architectural gem in neoclassical style. Built in the 18th century, it dominates Place d'Armes with its imposing white facade.",
                        history: "Built during the colonial period, the cathedral survived the 1842 earthquake and has been restored several times. It testifies to the region's rich religious and cultural history."
                    },
                    es: {
                        name: "Catedral de Cap-Haïtien",
                        description: "La Catedral de Notre-Dame de l'Assomption en Cap-Haïtien es una joya arquitectónica de estilo neoclásico. Construida en el siglo XVIII, domina la Place d'Armes con su imponente fachada blanca.",
                        history: "Edificada durante el período colonial, la catedral sobrevivió al terremoto de 1842 and ha sido restaurada varias veces. Testimonia la rica historia religiosa and cultural de la región."
                    }
                },
                palais: {
                    fr: {
                        name: "Palais Sans Souci",
                        description: "Le Palais Sans Souci fut la résidence royale du roi Henri Christophe au début du XIXe siècle. Situé à Milot, près de la Citadelle, ce palais somptueux était surnommé le 'Versailles des Caraïbes'.",
                        history: "Construit entre 1810 et 1813, le palais fut le centre du royaume d'Haïti jusqu'au suicide du roi en 1820. Détruit par un tremblement de terre en 1842, ses ruines majestueuses sont aujourd'hui classées au patrimoine mondial de l'UNESCO."
                    },
                    ht: {
                        name: "Palè San Souci",
                        description: "Palè San Souci te rezidans wa Henri Christophe nan kòmansman syèk la 19. Li sitiye nan Milò, toupre Sitadèl la. Yo te rele li 'Vèsay Karayib la'.",
                        history: "Konstwi ant 1810 ak 1813, palè a te sant wayòm Ayiti jouk lè wa a te komèt swisid an 1820. Detwi pa yon tranbleman tè an 1842, demajè li yo klasè kòm patrimwàn mondyal UNESCO jodi a."
                    },
                    en: {
                        name: "Sans-Souci Palace",
                        description: "The Sans-Souci Palace was the royal residence of King Henri Christophe in the early 19th century. Located in Milot near the Citadel, this sumptuous palace was nicknamed the 'Versailles of the Caribbean'.",
                        history: "Built between 1810 and 1813, the palace was the center of the Kingdom of Haiti until the king's suicide in 1820. Destroyed by an earthquake in 1842, its majestic ruins are now classified as a UNESCO World Heritage Site."
                    },
                    es: {
                        name: "Palacio Sans Souci",
                        description: "El Palacio Sans Souci fue la residencia real del rey Henri Christophe a principios del siglo XIX. Ubicado en Milot, cerca de la Ciudadela, este suntuoso palacio fue apodado el 'Versalles del Caribe'.",
                        history: "Construido entre 1810 and 1813, el palacio fue el centro del Reino de Haití hasta el suicidio del rey en 1820. Destruido por un terremoto en 1842, sus majestuosas ruinas están clasificadas hoy como Patrimonio de la Humanidad por la UNESCO."
                    }
                }
            };
            
            function showMainPage() {
                document.querySelectorAll('main > section, main > div').forEach(el => {
                    if (!el.classList.contains('attraction-detail')) {
                        el.style.display = 'block';
                    }
                });
                
                document.querySelectorAll('.attraction-detail').forEach(detail => {
                    detail.style.display = 'none';
                });
            }

            document.querySelectorAll('.learn-more-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const attractionId = this.dataset.attraction;
                    const attraction = attractions[attractionId][currentLanguage] || attractions[attractionId]['fr'];
                    const detailContainer = document.getElementById(`${attractionId}-detail`);
                    
                    document.querySelectorAll('main > section, main > div').forEach(el => {
                        if (!el.classList.contains('attraction-detail')) {
                            el.style.display = 'none';
                        }
                    });
                    
                    detailContainer.style.display = 'block';
                    detailContainer.innerHTML = `
                        <button id="backToMain" class="mb-6 bg-gray-100 text-gray-700 px-4 py-2 !rounded-button font-medium cursor-pointer back-to-main-btn">
                            <i class="ri-arrow-left-line"></i> <span data-translate="back">Retour</span>
                        </button>
                        
                        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                            <div class="h-64 bg-cover bg-center" style="background-image: url('${attractionId === 'citadelle' ? 'img12.jpg' : 
                                                                                          attractionId === 'labadee' ? 'img9.webp.jpg' : 
                                                                                          attractionId === 'verrieres' ? 'img11.jpg' : 
                                                                                          attractionId === 'cathedrale' ? 'img4.jpg' : 'img10.jpg'}')"></div>
                            <div class="p-6">
                                <h2 class="text-3xl font-bold text-gray-800 mb-4">${attraction.name}</h2>
                                
                                <div class="mb-6">
                                    <h3 class="text-xl font-semibold text-gray-800 mb-2" data-translate="description">Description</h3>
                                    <p class="text-gray-600">${attraction.description}</p>
                                </div>
                                
                                <div class="mb-6">
                                    <h3 class="text-xl font-semibold text-gray-800 mb-2" data-translate="history">Histoire</h3>
                                    <p class="text-gray-600">${attraction.history}</p>
                                </div>
                                
                                <div class="mb-6">
                                    <h3 class="text-xl font-semibold text-gray-800 mb-2" data-translate="visit">Visiter</h3>
                                    <p class="text-gray-600 mb-4" data-translate="visit_desc">Commandez un taxi pour visiter ce lieu historique :</p>
                                    <div class="double-button-container">
                                        <button id="backToMainBottom" class="bg-gray-100 text-gray-700 px-6 py-3 !rounded-button font-medium cursor-pointer back-to-main-btn">
                                            <i class="ri-arrow-left-line"></i> <span data-translate="back">Retour</span>
                                        </button>
                                        <button class="gold-button px-6 py-3 !rounded-button font-semibold visit-btn" data-attraction="${attraction.name}">
                                            <span data-translate="order">Commander</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Traduire les éléments dynamiques dans la page de détail
                    updateLanguage(currentLanguage);
                    
                    document.querySelectorAll('.back-to-main-btn').forEach(btn => {
                        btn.addEventListener('click', showMainPage);
                    });
                    
                    const visitButton = detailContainer.querySelector('.visit-btn');
                    visitButton.addEventListener('click', function() {
                        const attractionName = this.dataset.attraction;
                        
                        document.getElementById('destinationAddressArrival').value = attractionName;
                        
                        document.getElementById('destinationSwitch').checked = false;
                        document.getElementById('destinationField').classList.add('hidden');
                        document.getElementById('nowBtn').classList.add('active');
                        document.getElementById('laterBtn').classList.remove('active');
                        document.getElementById('dateTimeSection').classList.add('hidden');
                        document.getElementById('bookingDescription').value = '';
                        
                        showMainPage();
                        
                        document.getElementById('bookingSection').scrollIntoView({ behavior: 'smooth' });
                    });
                });
            });
        }

        // ===========================================
        // GESTION DES INTERACTIONS UTILISATEUR
        // ===========================================

        // Gérer la visibilité des mots de passe
        function handlePasswordVisibility() {
            const togglePassword = (inputId, iconId) => {
                const passwordInput = document.getElementById(inputId);
                const icon = document.getElementById(iconId);
                
                icon.addEventListener('click', function() {
                    if (passwordInput.type === 'password') {
                        passwordInput.type = 'text';
                        icon.classList.remove('ri-eye-line');
                        icon.classList.add('ri-eye-off-line');
                    } else {
                        passwordInput.type = 'password';
                        icon.classList.remove('ri-eye-off-line');
                        icon.classList.add('ri-eye-line');
                    }
                });
            };
            
            togglePassword('passwordInput', 'loginTogglePassword');
            togglePassword('password', 'passwordToggle');
            togglePassword('confirmPassword', 'confirmPasswordToggle');
        }

        // Vérifier le statut de téléchargement de l'application
        async function checkAppDownloadStatus() {
            const appDownloadModal = document.getElementById('appDownloadModal');
            
            const userId = localStorage.getItem('userId');
            const ip = await getUserIP();
            
            let hasDownloaded = false;
            
            if (userId) {
                const userRef = database.ref(`app_download/users/${userId}`);
                const snapshot = await userRef.once('value');
                if (snapshot.exists() && snapshot.val().apk_downloaded) {
                    hasDownloaded = true;
                }
            }
            
            if (!hasDownloaded && ip) {
                const ipRef = database.ref(`app_download/ips/${ip.replace(/\./g, '_')}`);
                const snapshot = await ipRef.once('value');
                if (snapshot.exists() && snapshot.val().apk_downloaded) {
                    hasDownloaded = true;
                }
            }
            
            if (!hasDownloaded) {
                appDownloadModal.style.display = 'flex';
            }
        }

        // Marquer l'application comme téléchargée
        async function markAppAsDownloaded() {
            const userId = localStorage.getItem('userId');
            const ip = await getUserIP();
            
            if (userId) {
                const userRef = database.ref(`app_download/users/${userId}`);
                userRef.set({
                    apk_downloaded: true,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
            }
            
            if (ip) {
                const ipKey = ip.replace(/\./g, '_');
                const ipRef = database.ref(`app_download/ips/${ipKey}`);
                ipRef.set({
                    apk_downloaded: true,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
            }
        }

        // Gérer la modale de téléchargement d'application
        function handleAppDownloadModal() {
            const modal = document.getElementById('appDownloadModal');
            const closeBtns = document.querySelectorAll('.close-app-modal, #closeAppModalBtn');
            const downloadBtn = document.getElementById('downloadAppBtn');
            const downloadApkBtn = document.getElementById('downloadApkBtn');
            
            closeBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    modal.style.display = 'none';
                });
            });
            
            downloadBtn.addEventListener('click', async function() {
                await markAppAsDownloaded();
                modal.style.display = 'none';
            });
            
            downloadApkBtn.addEventListener('click', function() {
                window.location.href = 'Julmin Taxi.apk';
                markAppAsDownloaded();
            });
        }

        // Gérer le changement de langue
        function handleLanguageChange() {
            const languageSelect = document.getElementById('languageSelect');
            
            // Charger la langue préférée depuis localStorage
            const savedLanguage = localStorage.getItem('preferredLanguage');
            if (savedLanguage) {
                languageSelect.value = savedLanguage;
                updateLanguage(savedLanguage);
            } else {
                // Définir la langue par défaut sur Kreyòl si aucune préférence
                languageSelect.value = 'ht';
                updateLanguage('ht');
            }
            
            languageSelect.addEventListener('change', function() {
                updateLanguage(this.value);
            });
        }

        // Configurer les suggestions d'adresses
        function setupAddressSuggestions(inputId) {
            const inputElement = document.getElementById(inputId);
            const suggestionsContainer = document.getElementById(`${inputId}Suggestions`);
            
            // Liste de tous les lieux disponibles
            const allPlaces = [];
            
            // Génération des rues
            for (let i = 0; i <= 24; i++) {
                for (let j = 0; j < 16; j++) {
                    const letter = String.fromCharCode(65 + j);
                    allPlaces.push(`Rue ${i} ${letter}`);
                }
            }
            
            // Ajout des autres lieux
            allPlaces.push(
                'Collège Notre-Dame du Perpétuel Secours',
                'Lycée Philippe Guerrier',
                'Collège Regina Assumpta',
                'École des Frères de l’Instruction Chrétienne',
                'École Saint‑Joseph de Cluny',
                'Université Publique du Nord (UPNCH)',
                'Université Chrétienne du Nord (UCN)',
                'Campus Henri-Christophe (Limonade)',
                'Académie Chrétienne du Cap‑Haïtien',
                'École Universelle de Jésus‑Christ',
                'Centre de Formation Classique (CFC)',
                'Faculté d’Agronomie (UPNCH campus)',
                'École Mixte Classique',
                'École Mixte de la Grâce',
                'École Professionnelle INUKA',
                'École Technique Sobenaire',
                'École Sainte‑Catherine',
                'Collège Pierre‐Lussier',
                'Institut Technique Saint‑Louis',
                'Académie du Peuple',
                'Fondation Culturelle Cap‑Haïtien',
                'Cathédrale Notre‑Dame de l’Assomption',
                'Église Baptiste de la Foi',
                'Temple Adventiste du 7ᵉ jour',
                'Église Synagogue de Jésus‑Christ',
                'Église de L’Espoir',
                'Église Méthodiste Libre',
                'Église Evangélique des Frères Unis',
                'Église de Dieu',
                'Église Tabernacle de Gloire',
                'Église Wesleyenne',
                'Église Saint‑Pierre (quartier)',
                'Centre Spirituel Gospel',
                'Chapelle Sainte‑Marie',
                'Temple Pentecôte de Cap‑Haïtien',
                'Assemblée de Dieu Cap‑Haïtien',
                'Église zioniste des Nations',
                'Église de la Jérémie Divine',
                'Place d’Armes (place de la cathédrale)',
                'Parc Saint‑Victor (stade)',
                'Square Dessalines / statue Dessalines',
                'Palindrome José Martí Square',
                'Parc central du boulevard',
                'Jardins publics près du port',
                'Stade scolaire Collège Notre-Dame',
                'Parc municipal des sports',
                'Espaces verts du quartier La Fossette',
                'Aire de jeux Plaine‑du‑Nord',
                'Morne Jean (promontoire naturel)',
                'Satama Hôtel',
                'Hôtel Cormier Plage',
                'Residence Royale Hotel',
                'Les Alizés Hotel',
                'Auberge du Picolet (hôtel + restaurant)',
                'Hotel Hostellerie du Roi Henri',
                'Hôtel Mont‑Fort',
                'Mont-Joli Hôtel',
                'Hôtel Imperial',
                'Résidence Royale (villa/hôtel)',
                'Visa Lodge',
                'Karibe',
                'El Rancho Luxembourg',
                'Habitation Des Lauriers',
                'Du Roi Christophe',
                'Le Paradis S. Hotel',
                'J&G Villa Hotel',
                'Vue Apartment Hotel',
                'Metro Residences Hotel',
                'Three Kings Hotel (Vertières)',
                'Villa Prosper Guest House',
                'Lakay Restaurant (Boulevard du Carénage)',
                'Cap Deli',
                'Boukanye',
                'Auberge du Picolet Restaurant',
                'Café colonial centre-ville',
                'Snack Riz & Pois La Fossette',
                'Restaurant Panorama (Vue port)',
                'Le Petit Café du Rivière',
                'La Terrasse du Carré',
                'Le Griot du Cap',
                'Café Vertières',
                'Brasserie Place d’Armes',
                'Snack Pâtisserie Cap‑Haïtien',
                'Restaurant l’Ananas',
                'Bar‑restaurant Rivière',
                'Citadelle Laferrière (Milot)',
                'Palais Sans‑Souci (Milot)',
                'Fort Picolet (cap‑haïtien)',
                'Fort Saint‑Joseph',
                'Monument des Héros de Vertières (statue)',
                'Musée des Beaux‑Arts du Cap‑Haïtien',
                'Cathédrale Notre‑Dame',
                'Palais de Justice de Cap‑Haïtien',
                'Bois Caïman (lieu révolutionnaire)',
                'Plage de Labadee',
                'Plage de Cormier',
                'Plage du Camp-Louise',
                'Plage de Rival',
                'Plage de la Ducrroix (ou Du Croix Est)'
            );
            
            inputElement.addEventListener('input', function() {
                const value = this.value.trim();
                suggestionsContainer.innerHTML = '';
                
                if (value.length > 0) {
                    const normalizedValue = normalizeString(value);
                    const filteredPlaces = allPlaces.filter(place => 
                        normalizeString(place).includes(normalizedValue)
                    );
                    
                    const topSuggestions = filteredPlaces.slice(0, 5);
                    
                    if (topSuggestions.length > 0) {
                        suggestionsContainer.classList.remove('hidden');
                        topSuggestions.forEach(place => {
                            const suggestionItem = document.createElement('div');
                            suggestionItem.className = 'suggestion-item';
                            suggestionItem.textContent = place;
                            suggestionsContainer.appendChild(suggestionItem);
                        });
                    } else {
                        suggestionsContainer.classList.add('hidden');
                    }
                } else {
                    suggestionsContainer.classList.add('hidden');
                }
            });
            
            suggestionsContainer.addEventListener('click', function(e) {
                if (e.target.classList.contains('suggestion-item')) {
                    inputElement.value = e.target.textContent;
                    suggestionsContainer.classList.add('hidden');
                }
            });
            
            document.addEventListener('click', function(e) {
                if (e.target !== inputElement) {
                    suggestionsContainer.classList.add('hidden');
                }
            });
        }

        // Détection iOS et affichage de la bannière d'installation
        function handleIOSInstallBanner() {
            const isIOS = /iphone|ipad|ipod/.test(window.navigator.userAgent.toLowerCase());
            const isInStandaloneMode = ('standalone' in window.navigator) && window.navigator.standalone;
            
            if (isIOS && !isInStandaloneMode) {
                document.getElementById("installBanner").style.display = "block";
                
                document.getElementById("installBtn").addEventListener("click", () => {
                    alert("Pour installer l'app :\n\n Cliquez sur le bouton PARTAGER (icône en bas au milieu)\n Choisissez 'Ajouter à l'écran d'accueil'");
                });
            }
        }

        // Gérer la destination switch
        function handleDestinationSwitch() {
            const destinationSwitch = document.getElementById('destinationSwitch');
            const destinationField = document.getElementById('destinationField');
            
            destinationSwitch.addEventListener('change', function() {
                if (this.checked) {
                    destinationField.classList.remove('hidden');
                } else {
                    destinationField.classList.add('hidden');
                }
            });
        }

        // Gérer les boutons de sélection de temps
        function handleTimeSelectionButtons() {
            const nowBtn = document.getElementById('nowBtn');
            const laterBtn = document.getElementById('laterBtn');
            const dateTimeSection = document.getElementById('dateTimeSection');
            const destinationSwitch = document.getElementById('destinationSwitch');
            
            nowBtn.addEventListener('click', function() {
                nowBtn.classList.add('active');
                laterBtn.classList.remove('active');
                dateTimeSection.classList.add('hidden');
            });
            
            laterBtn.addEventListener('click', function() {
                laterBtn.classList.add('active');
                nowBtn.classList.remove('active');
                dateTimeSection.classList.remove('hidden');
                
                destinationSwitch.checked = true;
                document.getElementById('destinationField').classList.remove('hidden');
            });
        }

        // Gérer les boutons de type de trajet
        function handleTripTypeButtons() {
            const oneWayBtn = document.getElementById('oneWayBtn');
            const roundTripBtn = document.getElementById('roundTripBtn');
            
            oneWayBtn.addEventListener('click', function() {
                oneWayBtn.classList.add('active');
                roundTripBtn.classList.remove('active');
            });
            
            roundTripBtn.addEventListener('click', function() {
                roundTripBtn.classList.add('active');
                oneWayBtn.classList.remove('active');
            });
        }

        // Gérer la modale de connexion
        function handleLoginModal() {
            const modal = document.getElementById('loginModal');
            const openBtn = document.getElementById('loginBtn');
            const closeBtns = document.querySelectorAll('.close-modal, #closeAppModalBtn');
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            openBtn.addEventListener('click', function() {
                modal.style.display = 'flex';
            });
            
            closeBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.modal').forEach(modal => {
                        modal.style.display = 'none';
                    });
                });
            });
            
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.dataset.tab;
                    
                    tabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    tabContents.forEach(content => content.classList.remove('active'));
                    document.getElementById(`${tabId}Tab`).classList.add('active');
                    
                    // Générer un ID unique si on est sur l'onglet inscription
                    if (tabId === 'signup') {
                        generateUniqueId().then(userId => {
                            document.getElementById('generatedUserId').textContent = userId;
                        });
                    }
                });
            });
            
            document.getElementById('loginWithIdBtn').addEventListener('click', function() {
                const userId = document.getElementById('userIdInput').value.trim();
                
                if (!userId || userId.length !== 4 || isNaN(userId)) {
                    alert('Veuillez entrer un ID valide à 4 chiffres');
                    return;
                }
                
                const saveMemberRef = database.ref('save_member');
                saveMemberRef.orderByChild('userId').equalTo(userId).once('value', snapshot => {
                    if (snapshot.exists()) {
                        snapshot.forEach(child => {
                            const user = child.val();
                            
                            const fullName = `${user.prenom} ${user.nom}`;
                            localStorage.setItem('userName', fullName);
                            localStorage.setItem('userId', userId);
                            localStorage.setItem('userType', 'save');
                            
                            displayUserName();
                            modal.style.display = 'none';
                        });
                    } else {
                        alert('Aucun compte trouvé avec cet ID');
                    }
                });
            });
            
            document.getElementById('loginWithPasswordBtn').addEventListener('click', function() {
                const email = document.getElementById('emailInput').value.trim();
                const password = document.getElementById('passwordInput').value;
                
                if (!email || !password) {
                    alert('Veuillez remplir tous les champs');
                    return;
                }
                
                const saveMemberRef = database.ref('save_member');
                saveMemberRef.orderByChild('email').equalTo(email).once('value', snapshot => {
                    if (snapshot.exists()) {
                        let userFound = false;
                        snapshot.forEach(child => {
                            const user = child.val();
                            if (user.password === password) {
                                userFound = true;
                                
                                const fullName = `${user.prenom} ${user.nom}`;
                                localStorage.setItem('userName', fullName);
                                localStorage.setItem('userId', user.userId);
                                localStorage.setItem('userType', 'save');
                                
                                displayUserName();
                                modal.style.display = 'none';
                            }
                        });
                        
                        if (!userFound) {
                            alert('Mot de passe incorrect');
                        }
                    } else {
                        alert('Aucun compte trouvé avec cet email');
                    }
                });
            });
            
            // Gestion de la création de compte dans la modale
            const form = document.getElementById('createAccountForm');
            const modalIdInfoIcon = document.getElementById('modalIdInfoIcon');
            
            modalIdInfoIcon.addEventListener('click', function() {
                alert("Votre ID unique est nécessaire pour accéder à votre compte depuis un autre appareil. Conservez-le précieusement.");
            });
            
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const lastName = document.getElementById('lastName').value;
                const firstName = document.getElementById('firstName').value;
                const email = document.getElementById('email').value;
                const countryCode = document.getElementById('countryCode').value;
                const phone = document.getElementById('phone').value;
                const fullPhone = countryCode + phone;
                const password = document.getElementById('password').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                const age = document.getElementById('age').value;
                const ip = await getUserIP();
                const userId = document.getElementById('generatedUserId').textContent;
                
                if (password !== confirmPassword) {
                    document.getElementById('passwordError').style.display = 'block';
                    return;
                } else {
                    document.getElementById('passwordError').style.display = 'none';
                }
                
                // Générer un OTP
                const otp = await generateUniqueOTP();
                
                if (ip) {
                    // Sauvegarder l'utilisateur avec email non vérifié
                    const saveMemberRef = database.ref('save_member').push();
                    const orderId = saveMemberRef.key;
                    saveMemberRef.set({
                        nom: lastName,
                        prenom: firstName,
                        email: email,
                        phone: fullPhone,
                        password: password,
                        age: age,
                        ip: ip,
                        userId: userId,
                        emailVerified: false,
                        otp: otp,
                        date_inscription: new Date().toISOString()
                    });
                    
                    // Envoyer l'email avec l'OTP
                    try {
                        await sendOTPEmail(email, otp);
                        
                        // Afficher la modale de vérification
                        showEmailVerification(email);
                        document.getElementById('loginModal').style.display = 'none';
                        
                        // Stocker temporairement les infos utilisateur
                        sessionStorage.setItem('tempUser', JSON.stringify({
                            nom: lastName,
                            prenom: firstName,
                            email: email,
                            phone: fullPhone,
                            password: password,
                            age: age,
                            ip: ip,
                            userId: userId
                        }));
                        
                    } catch (error) {
                        console.error("Erreur lors de l'envoi de l'email:", error);
                        alert("Erreur lors de l'envoi de l'email de vérification. Veuillez réessayer.");
                    }
                } else {
                    alert('Erreur lors de la création du compte. Veuillez réessayer.');
                }
            });
        }

        // Gérer la vérification d'email
        function handleEmailVerification() {
            const verifyBtn = document.getElementById('verifyOtpBtn');
            const resendLink = document.getElementById('resendOtp');
            const otpInput = document.getElementById('otpInput');
            
            verifyBtn.addEventListener('click', async function() {
                const otp = otpInput.value.trim();
                const tempUser = JSON.parse(sessionStorage.getItem('tempUser'));
                
                if (!otp || otp.length !== 6) {
                    alert('Veuillez entrer un code de vérification valide');
                    return;
                }
                
                // Vérifier l'OTP dans la base de données
                const saveMemberRef = database.ref('save_member');
                const snapshot = await saveMemberRef.orderByChild('userId').equalTo(tempUser.userId).once('value');
                
                if (snapshot.exists()) {
                    let otpValid = false;
                    snapshot.forEach(child => {
                        const user = child.val();
                        if (user.otp === otp) {
                            otpValid = true;
                            
                            // Mettre à jour le statut de vérification
                            child.ref.update({
                                emailVerified: true,
                                otp: null
                            });
                            
                            const fullName = `${tempUser.prenom} ${tempUser.nom}`;
                            localStorage.setItem('userName', fullName);
                            localStorage.setItem('userId', tempUser.userId);
                            localStorage.setItem('userType', 'save');
                            
                            displayUserName();
                            document.getElementById('emailVerificationModal').style.display = 'none';
                            sessionStorage.removeItem('tempUser');
                            
                            alert('Compte créé et vérifié avec succès!');
                        }
                    });
                    
                    if (!otpValid) {
                        alert('Code de vérification incorrect');
                    }
                } else {
                    alert('Erreur de vérification. Veuillez réessayer.');
                }
            });
            
            resendLink.addEventListener('click', async function() {
                const tempUser = JSON.parse(sessionStorage.getItem('tempUser'));
                
                // Générer un nouveau OTP
                const newOtp = await generateUniqueOTP();
                
                // Mettre à jour l'OTP dans la base de données
                const saveMemberRef = database.ref('save_member');
                const snapshot = await saveMemberRef.orderByChild('userId').equalTo(tempUser.userId).once('value');
                
                if (snapshot.exists()) {
                    snapshot.forEach(child => {
                        child.ref.update({
                            otp: newOtp
                        });
                    });
                    
                    // Renvoyer l'email
                    try {
                        await sendOTPEmail(tempUser.email, newOtp);
                        alert('Nouveau code de vérification envoyé!');
                    } catch (error) {
                        console.error("Erreur lors de l'envoi de l'email:", error);
                        alert("Erreur lors de l'envoi de l'email de vérification. Veuillez réessayer.");
                    }
                }
            });
        }

        // Gérer le bouton de déconnexion
        function handleLogoutButton() {
            document.getElementById('logoutBtn').addEventListener('click', function() {
                logoutUser();
            });
        }

        // Gérer l'icône d'information sur l'ID
        function handleIdInfoIcon() {
            const infoIcon = document.getElementById('idInfoIcon');
            const infoMessage = document.getElementById('idInfoMessage');
            
            infoIcon.addEventListener('click', function() {
                infoMessage.classList.remove('hidden');
                
                setTimeout(() => {
                    infoMessage.classList.add('hidden');
                }, 5000);
            });
        }

        // Gérer la modale de permission de localisation
        function handleLocationPermissionModal() {
            const modal = document.getElementById('locationPermissionModal');
            const closeBtn = document.getElementById('closeLocationModalBtn');
            const acceptBtn = document.getElementById('acceptLocationBtn');
            
            closeBtn.addEventListener('click', function() {
                modal.style.display = 'none';
            });
            
            acceptBtn.addEventListener('click', function() {
                modal.style.display = 'none';
                return true;
            });
            
            return modal;
        }

        // ===========================================
        // GESTION SPÉCIALE iOS
        // ===========================================

        // Détecter si l'utilisateur est sur iOS
        function isIOS() {
            return [
                'iPad Simulator',
                'iPhone Simulator',
                'iPod Simulator',
                'iPad',
                'iPhone',
                'iPod'
            ].includes(navigator.platform) || 
            (navigator.userAgent.includes("Mac") && "ontouchend" in document);
        }

        // Gérer l'affichage des boutons de téléchargement selon l'appareil
        function handleDownloadButtons() {
            const downloadApkBtn = document.getElementById('downloadApkBtn');
            const iosInstallBtn = document.getElementById('iosInstallBtn');
            
            if (isIOS()) {
                // Cacher le bouton APK Android et afficher le bouton iOS
                downloadApkBtn.style.display = 'none';
                iosInstallBtn.style.display = 'inline-flex';
                
                // Gérer le clic sur le bouton iOS
                iosInstallBtn.addEventListener('click', function() {
                    document.getElementById('iosInstallModal').style.display = 'flex';
                });
            } else {
                // Cacher le bouton iOS et afficher le bouton APK Android
                downloadApkBtn.style.display = 'inline-flex';
                iosInstallBtn.style.display = 'none';
            }
        }

        // Gérer la modale d'installation iOS
        function handleIOSInstallModal() {
            const modal = document.getElementById('iosInstallModal');
            const closeBtns = document.querySelectorAll('#closeIosModalBtn, #closeIosModalConfirmBtn');
            
            closeBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    modal.style.display = 'none';
                });
            });
        }

        // ===========================================
        // INITIALISATION DE L'APPLICATION
        // ===========================================

        document.addEventListener('DOMContentLoaded', function() {
            // Initialisation des différentes fonctionnalités
            saveIPToDatabase();
            initDate();
            handleDestinationSwitch();
            handleTimeSelectionButtons();
            handleTripTypeButtons();
            displayUserName();
            handleLoginModal();
            handleEmailVerification();
            handleTaxiOrder();
            handleOrderActions();
            handleLogoutButton();
            handleAppDownloadModal();
            loadDrivers();
            loadTripHistory();
            handleTouristAttractions();
            handlePasswordVisibility();
            handleIdInfoIcon();
            checkAppDownloadStatus();
            handleLanguageChange();
            handleIOSInstallBanner();
            
            // Gestion spéciale iOS
            handleDownloadButtons();
            handleIOSInstallModal();
            
            // Initialiser les suggestions d'adresses
            setupAddressSuggestions('destinationAddress');
            setupAddressSuggestions('destinationAddressArrival');
            
            // Initialiser les écouteurs
            const userId = localStorage.getItem('userId');
            if (userId) {
                if (unsubscribeUnconfirmedRequests) {
                    unsubscribeUnconfirmedRequests();
                }
                
                if (unsubscribePendingRequests) {
                    unsubscribePendingRequests();
                }
            }
            
            // Intervalle global pour les mises à jour
            setInterval(() => {
                const userId = localStorage.getItem('userId');
                if (!userId) return;
                
                database.ref('commande').orderByChild('userId').equalTo(userId).once('value', snapshot => {
                    if (snapshot.exists()) {
                        snapshot.forEach(child => {
                            const pendingSection = document.getElementById('pending-request');
                            
                            if (pendingSection.dataset.orderId !== child.key) {
                                pendingSection.style.display = 'block';
                                pendingSection.dataset.orderId = child.key;
                                pendingSection.innerHTML = generatePendingContent(
                                    child.key,
                                    child.val().pickup,
                                    child.val().destination
                                );
                                
                                if (pendingSection.dataset.intervalId) {
                                    clearInterval(parseInt(pendingSection.dataset.intervalId));
                                }
                                
                                const intervalId = setInterval(() => checkOrderStatus(child.key), 2000);
                                pendingSection.dataset.intervalId = intervalId;
                            }
                        });
                    }
                });
                
                loadDrivers();
            }, 2000);
        });
    </script>
</body>
</html>